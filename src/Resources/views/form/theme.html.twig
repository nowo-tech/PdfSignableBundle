{#
  Form theme: SignatureCoordinatesType (PDF + boxes), SignatureBoxType, AcroFormEditorType (viewer + panel).
  Registers blocks: signature_box_widget, signature_box_row, signature_coordinates_widget, acroform_editor_widget, form_errors.
  Requires: form_div_layout.html.twig, PDF.js (CDN), pdf-signable.js.

  CSS and JS (pdf-signable.css, PDF.js, pdf-signable.js) are included only once per request
  via nowo_pdf_signable_include_assets() so multiple widgets on the same page do not duplicate assets.
#}
{% use "form_div_layout.html.twig" %}

{#
  Block: form_errors
  Renders validation errors in red so they are visible (Bootstrap-friendly).
#}
{% block form_errors %}
  {% if errors|length > 0 %}
    <div class="invalid-feedback d-block text-danger small">
      <ul class="list-unstyled mb-0">
        {% for error in errors %}
          <li>{{ error.message }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
{% endblock %}

{#
  Block: widget_attributes
  Uses attr.id when present so form fields can force specific IDs (e.g. AcroFormFieldEditType needs acroform-edit-* for JS).
#}
{% block widget_attributes %}
{% set _id = attr.id is defined ? attr.id : id %}
{% set _attr = attr|default({})|filter((v, k) => k != 'id') %}
 id="{{ _id }}" name="{{ full_name }}"
 {%- if disabled %} disabled="disabled"{% endif -%}
 {%- if required %} required="required"{% endif -%}
 {% with { attr: _attr } %}{{ block('attributes') }}{% endwith %}
{% endblock %}

{#
  Block: form_row
  Adds is-invalid to the widget when the field has errors (Bootstrap red border).
#}
{% block form_row %}
  {% set row_attr = row_attr|default({}) %}
  <div{% if row_attr.class is defined %} class="{{ row_attr.class }}"{% endif %}{% if row_attr.style is defined %} style="{{ row_attr.style }}"{% endif %}>
    {{ form_label(form) }}
    {{ form_widget(form, { attr: (form.vars.attr|default({}))|merge({ class: ((form.vars.attr.class|default('')) ~ (form.vars.errors|length > 0 ? ' is-invalid' : ''))|trim }) }) }}
    {{ form_errors(form) }}
  </div>
{% endblock %}

{#
  Block: signature_box_widget
  Renders a single signature box (name, page, width, height, x, y).
  Override in app: {% block signature_box_widget %} ... {% endblock %}
#}
{% block signature_box_widget %}
  {% include "@NowoPdfSignable/form/_signature_box_type_widget.html.twig" with { form: form } %}
{% endblock %}

{% block signature_box_row %}
  {{ form_widget(form) }}
{% endblock %}

{#
  Block: acroform_editor_widget
  Full widget: PDF viewer (left) + AcroForm editor panel (right). Independent from signature coordinates.
  Structure: row with col-8 viewer, col-4 panel (editor_root). Uses _pdf_viewer_partial for viewer.
#}
{% block acroform_editor_widget %}
  {% set opts = form.vars.acroform_editor_options|default({}) %}
  {% set show_url_row = opts.url_field is not defined or (opts.url_field is not same as(false) and opts.url_field is not same as('false')) %}
  {% set show_load_btn = opts.show_load_pdf_button is not defined or (opts.show_load_pdf_button is not same as(false) and opts.show_load_pdf_button is not same as('false')) %}
  {% set _include_assets = nowo_pdf_signable_include_assets() %}
  {% if _include_assets %}
  <link rel="stylesheet" href="{{ asset('bundles/nowopdfsignable/js/pdf-signable.css') }}">
  {% endif %}
  <div class="row g-4 nowo-pdf-signable-widget" data-viewer-lazy-load="{{ opts.viewer_lazy_load|default(false) ? '1' : '0' }}" data-show-acroform="{{ opts.show_acroform|default(true) ? '1' : '0' }}" data-acroform-interactive="{{ opts.acroform_interactive|default(true) ? '1' : '0' }}" data-pdfjs-source="{{ opts.pdfjs_source|default('npm') }}" data-pdfjs-url="{{ opts.pdfjs_source|default('npm') == 'cdn' ? 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js' : '' }}" data-pdfjs-worker-url="{{ opts.pdfjs_source|default('npm') == 'npm' ? asset('bundles/nowopdfsignable/js/pdf.worker.min.js') : 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js' }}" data-pdf-signable-js="{{ asset('bundles/nowopdfsignable/js/pdf-signable.js') }}">
    <div class="col-lg-8">
      {% include '@NowoPdfSignable/form/_pdf_viewer_partial.html.twig' with {
        pdf_url_form: form.pdfUrl,
        show_url_row: show_url_row,
        show_load_btn: show_load_btn,
        signing_legal_disclaimer: null,
        signing_legal_disclaimer_url: null,
        signing_consent_form: null,
      } %}
    </div>
    <div class="col-lg-4">
      {% set _config = { field_name_mode: opts.field_name_mode|default('input'), field_name_choices: opts.field_name_choices|default([]), field_name_other_text: opts.field_name_other_text|default(''), show_field_rect: opts.show_field_rect ?? true, font_sizes: opts.font_sizes|default([]), font_families: opts.font_families|default([]), min_field_width: opts.min_field_width|default(12), min_field_height: opts.min_field_height|default(12) } %}
      {{ include('@NowoPdfSignable/acroform/editor_root.html.twig', {
        load_url: opts.load_url|default(''),
        post_url: opts.post_url|default(''),
        document_key: opts.document_key|default(''),
        apply_url: opts.apply_url|default(''),
        process_url: opts.process_url|default(''),
        debug: opts.debug|default(false),
        config: _config,
        acroform_edit_form: opts.acroform_edit_form|default(null),
      }) }}
    </div>
  </div>
  <script src="{{ asset('bundles/nowopdfsignable/js/acroform-editor.js') }}"></script>
  {% if _include_assets %}
  <script>
    window.NowoPdfSignableConfig = window.NowoPdfSignableConfig || {
      proxyUrl: {{ path('nowo_pdf_signable_proxy')|json_encode|raw }},
      debug: {{ (opts.debug|default(false)) ? 'true' : 'false' }},
      pdfjsSource: {{ (opts.pdfjs_source|default('npm'))|json_encode|raw }},
      pdfjsWorkerUrl: {{ (opts.pdfjs_worker_url|default(asset('bundles/nowopdfsignable/js/pdf.worker.min.js')))|json_encode|raw }},
      strings: {
        error_load_pdf: {{ 'js.error_load_pdf'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        pdf_not_found: {{ 'js.pdf_not_found'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        alert_url_required: {{ 'js.alert_url_required'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        alert_submit_error: {{ 'js.alert_submit_error'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        loading_state: {{ 'js.loading_state'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        load_pdf_btn: {{ 'js.load_pdf_btn'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        default_box_name: {{ 'js.default_box_name'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        zoom_in: {{ 'js.zoom_in'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        zoom_out: {{ 'js.zoom_out'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        zoom_fit: {{ 'js.zoom_fit'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        fit_width: {{ 'js.fit_width'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        fit_page: {{ 'js.fit_page'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        no_overlap_message: {{ 'signature_coordinates_type.signature_boxes.no_overlap_message'|trans({}, 'nowo_pdf_signable')|json_encode|raw }}
      }
    };
  </script>
  {% if opts.viewer_lazy_load|default(false) %}
  <script>
  (function(){
    var w = document.querySelector('.nowo-pdf-signable-widget[data-viewer-lazy-load="1"]');
    if (!w || w.dataset.nowoPdfSignableLoaded) return;
    var bundleUrl = w.dataset.pdfSignableJs || '';
    if (!bundleUrl) return;
    var loaded = false;
    function loadScripts() {
      if (loaded) return;
      loaded = true;
      w.dataset.nowoPdfSignableLoaded = '1';
      var s = document.createElement('script');
      s.src = bundleUrl;
      document.body.appendChild(s);
    }
    if (typeof IntersectionObserver !== 'undefined') {
      var obs = new IntersectionObserver(function(entries) {
        if (entries[0].isIntersecting) { loadScripts(); obs.disconnect(); }
      }, { rootMargin: '100px', threshold: 0 });
      obs.observe(w);
    } else {
      loadScripts();
    }
  })();
  </script>
  {% else %}
  <script src="{{ asset('bundles/nowopdfsignable/js/pdf-signable.js') }}"></script>
  {% endif %}
  {% endif %}
{% endblock %}

{#
  Block: signature_coordinates_widget
  Full widget: PDF viewer card (left) + signature boxes card (right).
  Structure:
  - .nowo-pdf-signable-widget: root
  - #pdf-viewer-container: scrollable area, contains #pdf-placeholder and #pdf-canvas-wrapper
  - #loadPdfBtn, .pdf-url-input: URL load controls
  - #signature-boxes-list: collection container, data-prototype for JS add
  - .unit-selector, .origin-selector: coordinate system
  - #addBoxBtn, .remove-box: add/remove boxes
  - PDF.js and pdf-signable.js loaded at end (once per request via nowo_pdf_signable_include_assets())
#}
{% block signature_coordinates_widget %}
  {% set opts = form.vars.signature_coordinates_options|default({}) %}
  {# Visibility: treat false and "false" as hidden (config may come as bool or string) #}
  {% set show_url_row = opts.url_field is not defined or (opts.url_field is not same as(false) and opts.url_field is not same as('false')) %}
  {% set show_load_btn = opts.show_load_pdf_button is not defined or (opts.show_load_pdf_button is not same as(false) and opts.show_load_pdf_button is not same as('false')) %}
  {% set show_unit = opts.unit_field is not defined or (opts.unit_field is not same as(false) and opts.unit_field is not same as('false')) %}
  {% set show_origin = opts.origin_field is not defined or (opts.origin_field is not same as(false) and opts.origin_field is not same as('false')) %}
  {% set show_signature_boxes = opts.show_signature_boxes is not defined or (opts.show_signature_boxes is not same as(false) and opts.show_signature_boxes is not same as('false')) %}
  {# Include CSS and JS only once per request when multiple widgets are on the same page. #}
  {% set _include_assets = nowo_pdf_signable_include_assets() %}
  {% if _include_assets %}
  <link rel="stylesheet" href="{{ asset('bundles/nowopdfsignable/js/pdf-signable.css') }}">
  {% endif %}
  {# Main layout: 7/12 PDF viewer, 5/12 boxes list #}
  <div class="row g-4 nowo-pdf-signable-widget" data-unit-default="{{ opts.unit_default|default('mm') }}" data-origin-default="{{ opts.origin_default|default('bottom_left') }}" data-prevent-box-overlap="{{ opts.prevent_box_overlap|default(true) ? '1' : '0' }}" data-box-defaults-by-name="{{ (opts.box_defaults_by_name|default({}))|json_encode|e('html_attr') }}" data-enable-rotation="{{ opts.enable_rotation|default(false) ? '1' : '0' }}" data-lock-box-width="{{ opts.lock_box_width|default(false) ? '1' : '0' }}" data-lock-box-height="{{ opts.lock_box_height|default(false) ? '1' : '0' }}" data-default-box-width="{{ opts.default_box_width is defined and opts.default_box_width is not null ? opts.default_box_width : '' }}" data-default-box-height="{{ opts.default_box_height is defined and opts.default_box_height is not null ? opts.default_box_height : '' }}" data-min-box-width="{{ opts.min_box_width is defined and opts.min_box_width is not null ? opts.min_box_width : '' }}" data-min-box-height="{{ opts.min_box_height is defined and opts.min_box_height is not null ? opts.min_box_height : '' }}" data-snap-grid="{{ opts.snap_to_grid|default(0) }}" data-snap-to-boxes="{{ opts.snap_to_boxes|default(true) ? '1' : '0' }}" data-show-grid="{{ opts.show_grid|default(false) ? '1' : '0' }}" data-grid-step="{{ opts.grid_step|default(10) }}" data-viewer-lazy-load="{{ opts.viewer_lazy_load|default(false) ? '1' : '0' }}" data-show-acroform="{{ opts.show_acroform|default(true) ? '1' : '0' }}" data-acroform-interactive="{{ opts.acroform_interactive|default(true) ? '1' : '0' }}" data-pdfjs-source="{{ opts.pdfjs_source|default('npm') }}" data-pdfjs-url="{{ opts.pdfjs_source|default('npm') == 'cdn' ? 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js' : '' }}" data-pdfjs-worker-url="{{ opts.pdfjs_worker_url|default(opts.pdfjs_source|default('npm') == 'npm' ? asset('bundles/nowopdfsignable/js/pdf.worker.min.js') : 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js') }}" data-pdf-signable-js="{{ asset('bundles/nowopdfsignable/js/pdf-signable.js') }}">
    {# PDF viewer card (full width when signature boxes are hidden) #}
    <div class="{{ show_signature_boxes ? 'col-lg-7' : 'col-12' }}">
      {% include '@NowoPdfSignable/form/_pdf_viewer_partial.html.twig' with {
        pdf_url_form: form.pdfUrl,
        show_url_row: show_url_row,
        show_load_btn: show_load_btn,
        signing_legal_disclaimer: opts.signing_legal_disclaimer|default(null),
        signing_legal_disclaimer_url: opts.signing_legal_disclaimer_url|default(null),
        signing_consent_form: form.signingConsent is defined ? form.signingConsent : null,
      } %}
    </div>
    {# Signature boxes card: unit/origin selectors, list, add/remove (hidden when show_signature_boxes is false; unit/origin/boxes still rendered hidden for form submit) #}
    {% if show_signature_boxes %}
    <div class="col-lg-5">
      <div class="card">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0">{{ 'page.signature_boxes'|trans({}, 'nowo_pdf_signable') }}</h6>
          {% if not (opts.signing_only|default(false)) %}
          <button type="button" class="btn btn-outline-primary btn-sm" id="addBoxBtn" data-max-entries="{{ opts.max_entries is defined and opts.max_entries is not null ? opts.max_entries : '' }}">{{ 'page.add'|trans({}, 'nowo_pdf_signable') }}</button>
          {% endif %}
        </div>
        <div class="card-body">
          {% if opts.signing_only|default(false) %}
          <div class="d-none" aria-hidden="true">
            {{ form_widget(form.unit) }}
            {{ form_widget(form.origin) }}
          </div>
          {% endif %}
          {% if not (opts.signing_only|default(false)) %}
          {% if show_unit or show_origin %}
          <div class="row align-items-center mb-3 g-2">
            {% if show_unit %}
            <div class="col-auto">
              <label class="form-label small text-muted mb-0 me-2">{{ 'page.units_label'|trans({}, 'nowo_pdf_signable') }}</label>
            </div>
            <div class="col-auto">
              {{ form_widget(form.unit, { attr: { class: 'unit-selector form-select form-select-sm w-auto' ~ (form.unit.vars.errors|length > 0 ? ' is-invalid' : '') } }) }}
              {{ form_errors(form.unit) }}
            </div>
            <div class="col-auto"><span class="badge bg-secondary" id="unitBadge">mm</span></div>
            {% else %}
            <div class="d-none" aria-hidden="true">{{ form_widget(form.unit) }}</div>
            {% endif %}
            {% if show_origin %}
            <div class="col-auto ms-md-3">
              <label class="form-label small text-muted mb-0 me-2">{{ 'page.origin_label'|trans({}, 'nowo_pdf_signable') }}</label>
            </div>
            <div class="col-auto">
              {{ form_widget(form.origin, { attr: { class: 'origin-selector form-select form-select-sm w-auto' ~ (form.origin.vars.errors|length > 0 ? ' is-invalid' : '') } }) }}
              {{ form_errors(form.origin) }}
            </div>
            {% else %}
            <div class="d-none" aria-hidden="true">{{ form_widget(form.origin) }}</div>
            {% endif %}
          </div>
          {% else %}
          <div class="d-none" aria-hidden="true">
            {{ form_widget(form.unit) }}
            {{ form_widget(form.origin) }}
          </div>
          {% endif %}
          <p class="small text-muted mb-3">{{ 'page.help_text'|trans({}, 'nowo_pdf_signable') }}</p>
          {% endif %}
          {# Prototype for JS: used when adding new boxes via #addBoxBtn #}
          {% set boxPrototype %}
            <div class="signature-box-item" data-index="__name__">
              {{ form_row(form.signatureBoxes.vars.prototype) }}
              <div class="mt-2 pt-2 border-top">
                <button type="button" class="btn btn-sm btn-outline-danger remove-box">{{ 'page.delete'|trans({}, 'nowo_pdf_signable') }}</button>
              </div>
            </div>
          {% endset %}
          {% if form.signatureBoxes.vars.errors|length > 0 %}
            <div class="alert alert-danger py-2 mb-3" role="alert">
              <strong>{{ 'page.errors_collection'|trans({}, 'nowo_pdf_signable') }}</strong>
              {{ form_errors(form.signatureBoxes) }}
            </div>
          {% endif %}
          <div id="signature-boxes-list" data-prototype="{{ boxPrototype|e('html_attr') }}" data-min-entries="{{ opts.min_entries|default(0) }}" data-max-entries="{{ opts.max_entries is defined and opts.max_entries is not null ? opts.max_entries : '' }}">
            {% for box in form.signatureBoxes %}
              <div class="signature-box-item {% if box.vars.errors|length > 0 %}border-danger{% endif %}" data-index="{{ loop.index0 }}">
                {{ form_row(box) }}
                {% if not (opts.signing_only|default(false)) %}
                <div class="mt-2 pt-2 border-top">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-box">{{ 'page.delete'|trans({}, 'nowo_pdf_signable') }}</button>
                </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          <div id="signature-boxes-empty" class="text-center text-muted py-4 {% if form.signatureBoxes|length > 0 %}d-none{% endif %}">
            <p class="small mb-0">{{ 'page.empty_state'|trans({}, 'nowo_pdf_signable') }}</p>
          </div>
          <hr class="my-4">
          <div class="d-grid gap-2">
            {% if opts.batch_sign_enabled|default(false) %}
            <button type="submit" name="batch_sign" value="1" class="btn btn-primary btn-lg">{{ 'page.sign_all'|trans({}, 'nowo_pdf_signable') }}</button>
            {% endif %}
            <button type="submit" class="btn btn-success btn-lg">{{ 'page.save_coordinates'|trans({}, 'nowo_pdf_signable') }}</button>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="d-none" aria-hidden="true">
      {{ form_widget(form.unit) }}
      {{ form_widget(form.origin) }}
      <div id="signature-boxes-list" data-prototype="" data-min-entries="{{ opts.min_entries|default(0) }}" data-max-entries="{{ opts.max_entries is defined and opts.max_entries is not null ? opts.max_entries : '' }}">
        {% for box in form.signatureBoxes %}
          <div class="signature-box-item" data-index="{{ loop.index0 }}">{{ form_row(box) }}</div>
        {% endfor %}
      </div>
    </div>
    <div class="col-12 mt-2">
      <button type="submit" class="btn btn-success">{{ 'page.save_coordinates'|trans({}, 'nowo_pdf_signable') }}</button>
    </div>
    {% endif %}
  </div>
  {% if _include_assets %}
  {# Config is always output so lazy loader or pdf-signable.js can use it #}
  <script>
    window.NowoPdfSignableConfig = {
      proxyUrl: {{ path('nowo_pdf_signable_proxy')|json_encode|raw }},
      debug: {{ (opts.debug|default(false)) ? 'true' : 'false' }},
      pdfjsSource: {{ (opts.pdfjs_source|default('npm'))|json_encode|raw }},
      pdfjsWorkerUrl: {{ (opts.pdfjs_worker_url|default(asset('bundles/nowopdfsignable/js/pdf.worker.min.js')))|json_encode|raw }},
      strings: {
        error_load_pdf: {{ 'js.error_load_pdf'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        pdf_not_found: {{ 'js.pdf_not_found'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        alert_url_required: {{ 'js.alert_url_required'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        alert_submit_error: {{ 'js.alert_submit_error'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        loading_state: {{ 'js.loading_state'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        load_pdf_btn: {{ 'js.load_pdf_btn'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        default_box_name: {{ 'js.default_box_name'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        zoom_in: {{ 'js.zoom_in'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        zoom_out: {{ 'js.zoom_out'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        zoom_fit: {{ 'js.zoom_fit'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        fit_width: {{ 'js.fit_width'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        fit_page: {{ 'js.fit_page'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        no_overlap_message: {{ 'signature_coordinates_type.signature_boxes.no_overlap_message'|trans({}, 'nowo_pdf_signable')|json_encode|raw }}
      }
    };
  </script>
  {% if opts.viewer_lazy_load|default(false) %}
  {# Lazy load: load PDF.js and pdf-signable.js only when the widget is visible (IntersectionObserver) #}
  <script>
  (function(){
    var w = document.querySelector('.nowo-pdf-signable-widget[data-viewer-lazy-load="1"]');
    if (!w || w.dataset.nowoPdfSignableLoaded) return;
    var cdnPdfJs = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
    var cdnWorker = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    var pdfjsUrl = w.dataset.pdfjsUrl || '';
    var workerUrl = w.dataset.pdfjsWorkerUrl || '';
    var bundleUrl = w.dataset.pdfSignableJs || '';
    if (!bundleUrl) return;
    var loaded = false;
    function loadScripts() {
      if (loaded) return;
      loaded = true;
      w.dataset.nowoPdfSignableLoaded = '1';
      var useNpm = (w.dataset.pdfjsSource || 'npm') === 'npm';
      if (useNpm) {
        var s3 = document.createElement('script');
        s3.src = bundleUrl;
        document.body.appendChild(s3);
      } else {
        var s1 = document.createElement('script');
        s1.src = pdfjsUrl || cdnPdfJs;
        s1.onload = function() {
          var s2 = document.createElement('script');
          s2.textContent = "if (typeof pdfjsLib !== 'undefined') pdfjsLib.GlobalWorkerOptions.workerSrc = '" + (workerUrl || cdnWorker).replace(/'/g, "\\'") + "';";
          document.body.appendChild(s2);
          var s3 = document.createElement('script');
          s3.src = bundleUrl;
          document.body.appendChild(s3);
        };
        document.body.appendChild(s1);
      }
    }
    if (typeof IntersectionObserver !== 'undefined') {
      var obs = new IntersectionObserver(function(entries) {
        if (entries[0].isIntersecting) { loadScripts(); obs.disconnect(); }
      }, { rootMargin: '100px', threshold: 0 });
      obs.observe(w);
    } else {
      loadScripts();
    }
  })();
  </script>
  {% else %}
  {# PDF.js from npm (pdfjs-dist); worker from bundle asset. Set pdfjs_source to 'cdn' only if you need legacy CDN 3.x. #}
  {% if opts.pdfjs_source|default('npm') == 'npm' %}
  <script src="{{ asset('bundles/nowopdfsignable/js/pdf-signable.js') }}"></script>
  {% else %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <script src="{{ asset('bundles/nowopdfsignable/js/pdf-signable.js') }}"></script>
  {% endif %}
  {% endif %}
  {% endif %}
{% endblock %}
