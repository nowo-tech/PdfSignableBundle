{#
  Form theme: SignatureCoordinatesType (PDF + boxes) and SignatureBoxType.
  Registers blocks: signature_box_widget, signature_box_row, signature_coordinates_widget, form_errors.
  Requires: form_div_layout.html.twig, PDF.js (CDN), pdf-signable.js.

  CSS and JS (pdf-signable.css, PDF.js, pdf-signable.js) are included only once per request
  via nowo_pdf_signable_include_assets() so multiple widgets on the same page do not duplicate assets.
#}
{% use "form_div_layout.html.twig" %}

{#
  Block: form_errors
  Renders validation errors in red so they are visible (Bootstrap-friendly).
#}
{% block form_errors %}
  {% if errors|length > 0 %}
    <div class="invalid-feedback d-block text-danger small">
      <ul class="list-unstyled mb-0">
        {% for error in errors %}
          <li>{{ error.message }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
{% endblock %}

{#
  Block: form_row
  Adds is-invalid to the widget when the field has errors (Bootstrap red border).
#}
{% block form_row %}
  {% set row_attr = row_attr|default({}) %}
  <div{% if row_attr.class is defined %} class="{{ row_attr.class }}"{% endif %}>
    {{ form_label(form) }}
    {{ form_widget(form, { attr: (form.vars.attr|default({}))|merge({ class: ((form.vars.attr.class|default('')) ~ (form.vars.errors|length > 0 ? ' is-invalid' : ''))|trim }) }) }}
    {{ form_errors(form) }}
  </div>
{% endblock %}

{#
  Block: signature_box_widget
  Renders a single signature box (name, page, width, height, x, y).
  Override in app: {% block signature_box_widget %} ... {% endblock %}
#}
{% block signature_box_widget %}
  {% include "@NowoPdfSignable/form/_signature_box_type_widget.html.twig" with { form: form } %}
{% endblock %}

{% block signature_box_row %}
  {{ form_widget(form) }}
{% endblock %}

{#
  Block: signature_coordinates_widget
  Full widget: PDF viewer card (left) + signature boxes card (right).
  Structure:
  - .nowo-pdf-signable-widget: root
  - #pdf-viewer-container: scrollable area, contains #pdf-placeholder and #pdf-canvas-wrapper
  - #loadPdfBtn, .pdf-url-input: URL load controls
  - #signature-boxes-list: collection container, data-prototype for JS add
  - .unit-selector, .origin-selector: coordinate system
  - #addBoxBtn, .remove-box: add/remove boxes
  - PDF.js and pdf-signable.js loaded at end (once per request via nowo_pdf_signable_include_assets())
#}
{% block signature_coordinates_widget %}
  {% set opts = form.vars.signature_coordinates_options|default({}) %}
  {# Include CSS and JS only once per request when multiple widgets are on the same page. #}
  {% set _include_assets = nowo_pdf_signable_include_assets() %}
  {% if _include_assets %}
  <link rel="stylesheet" href="{{ asset('bundles/nowopdfsignable/js/pdf-signable.css') }}">
  {% endif %}
  {# Main layout: 7/12 PDF viewer, 5/12 boxes list #}
  <div class="row g-4 nowo-pdf-signable-widget" data-prevent-box-overlap="{{ opts.prevent_box_overlap|default(true) ? '1' : '0' }}" data-box-defaults-by-name="{{ (opts.box_defaults_by_name|default({}))|json_encode|e('html_attr') }}" data-enable-rotation="{{ opts.enable_rotation|default(false) ? '1' : '0' }}" data-snap-grid="{{ opts.snap_to_grid|default(0) }}" data-snap-to-boxes="{{ opts.snap_to_boxes|default(true) ? '1' : '0' }}" data-show-grid="{{ opts.show_grid|default(false) ? '1' : '0' }}" data-grid-step="{{ opts.grid_step|default(10) }}" data-viewer-lazy-load="{{ opts.viewer_lazy_load|default(false) ? '1' : '0' }}" data-pdfjs-url="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" data-pdfjs-worker-url="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js" data-pdf-signable-js="{{ asset('bundles/nowopdfsignable/js/pdf-signable.js') }}">
    {# PDF viewer card #}
    <div class="col-lg-7">
      <div class="card h-100">
        <div class="card-header py-3">
          <h6 class="card-title mb-0">{{ 'page.pdf_viewer'|trans({}, 'nowo_pdf_signable') }}</h6>
        </div>
        <div class="card-body">
          {% if opts.url_field|default(true) %}
            <label class="form-label small text-uppercase fw-semibold text-muted mb-2">{{ form.pdfUrl.vars.label is defined ? form.pdfUrl.vars.label : ('page.url_label'|trans({}, 'nowo_pdf_signable')) }}</label>
            <div class="input-group input-group-lg mb-3">
              {{ form_widget(form.pdfUrl, { attr: { class: (form.pdfUrl.vars.attr.class|default('') ~ (form.pdfUrl.vars.errors|length > 0 ? ' is-invalid' : ''))|trim } }) }}
              <button type="button" class="btn btn-primary px-4" id="loadPdfBtn">{{ 'page.load'|trans({}, 'nowo_pdf_signable') }}</button>
            </div>
            {{ form_errors(form.pdfUrl) }}
          {% else %}
            {{ form_widget(form.pdfUrl, { attr: { class: (form.pdfUrl.vars.attr.class|default('') ~ (form.pdfUrl.vars.errors|length > 0 ? ' is-invalid' : ''))|trim } }) }}
            {{ form_errors(form.pdfUrl) }}
          {% endif %}
          {% if opts.signing_legal_disclaimer is defined and opts.signing_legal_disclaimer is not null and opts.signing_legal_disclaimer != '' %}
          <div class="signing-legal-disclaimer alert alert-info small py-2 mb-3" role="note">
            {{ opts.signing_legal_disclaimer|raw }}
            {% if opts.signing_legal_disclaimer_url is defined and opts.signing_legal_disclaimer_url is not null and opts.signing_legal_disclaimer_url != '' %}
            <a href="{{ opts.signing_legal_disclaimer_url }}" target="_blank" rel="noopener noreferrer" class="alert-link">{{ 'signing.terms_link'|trans({}, 'nowo_pdf_signable') }}</a>
            {% endif %}
          </div>
          {% endif %}
          {% if form.signingConsent is defined %}
          <div class="signing-consent-row mb-3">
            {{ form_row(form.signingConsent) }}
          </div>
          {% endif %}
          <div class="pdf-viewer-outer">
            <div id="pdf-viewer-container">
              <div class="pdf-zoom-toolbar" role="toolbar" aria-label="{{ 'js.zoom_fit'|trans({}, 'nowo_pdf_signable') }}">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="pdfZoomOut" title="{{ 'js.zoom_out'|trans({}, 'nowo_pdf_signable') }}" aria-label="{{ 'js.zoom_out'|trans({}, 'nowo_pdf_signable') }}">âˆ’</button>
                <span class="pdf-zoom-value small text-muted" id="pdfZoomValue">100%</span>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="pdfZoomIn" title="{{ 'js.zoom_in'|trans({}, 'nowo_pdf_signable') }}" aria-label="{{ 'js.zoom_in'|trans({}, 'nowo_pdf_signable') }}">+</button>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="pdfFitWidth" title="{{ 'js.fit_width'|trans({}, 'nowo_pdf_signable') }}" aria-label="{{ 'js.fit_width'|trans({}, 'nowo_pdf_signable') }}">{{ 'js.fit_width'|trans({}, 'nowo_pdf_signable') }}</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="pdfFitPage" title="{{ 'js.fit_page'|trans({}, 'nowo_pdf_signable') }}" aria-label="{{ 'js.fit_page'|trans({}, 'nowo_pdf_signable') }}">{{ 'js.fit_page'|trans({}, 'nowo_pdf_signable') }}</button>
              </div>
              <div id="pdf-placeholder" class="text-center text-muted py-5">
                <p class="mb-0">{{ 'page.placeholder_intro'|trans({}, 'nowo_pdf_signable') }}</p>
              </div>
              <div id="pdf-canvas-wrapper" style="display: none;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {# Signature boxes card: unit/origin selectors, list, add/remove #}
    <div class="col-lg-5 ps-lg-4">
      <div class="card">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0">{{ 'page.signature_boxes'|trans({}, 'nowo_pdf_signable') }}</h6>
          {% if not (opts.signing_only|default(false)) %}
          <button type="button" class="btn btn-outline-primary btn-sm" id="addBoxBtn" data-max-entries="{{ opts.max_entries is defined and opts.max_entries is not null ? opts.max_entries : '' }}">{{ 'page.add'|trans({}, 'nowo_pdf_signable') }}</button>
          {% endif %}
        </div>
        <div class="card-body">
          {% if opts.signing_only|default(false) %}
          <div class="d-none" aria-hidden="true">
            {{ form_widget(form.unit) }}
            {{ form_widget(form.origin) }}
          </div>
          {% endif %}
          {% if not (opts.signing_only|default(false)) %}
          <div class="row align-items-center mb-3 g-2">
            <div class="col-auto">
              <label class="form-label small text-muted mb-0 me-2">{{ 'page.units_label'|trans({}, 'nowo_pdf_signable') }}</label>
            </div>
            <div class="col-auto">
              {{ form_widget(form.unit, { attr: { class: 'unit-selector form-select form-select-sm w-auto' ~ (form.unit.vars.errors|length > 0 ? ' is-invalid' : '') } }) }}
              {{ form_errors(form.unit) }}
            </div>
            <div class="col-auto"><span class="badge bg-secondary" id="unitBadge">mm</span></div>
            <div class="col-auto ms-md-3">
              <label class="form-label small text-muted mb-0 me-2">{{ 'page.origin_label'|trans({}, 'nowo_pdf_signable') }}</label>
            </div>
            <div class="col-auto">
              {{ form_widget(form.origin, { attr: { class: 'origin-selector form-select form-select-sm w-auto' ~ (form.origin.vars.errors|length > 0 ? ' is-invalid' : '') } }) }}
              {{ form_errors(form.origin) }}
            </div>
          </div>
          <p class="small text-muted mb-3">{{ 'page.help_text'|trans({}, 'nowo_pdf_signable') }}</p>
          {% endif %}
          {# Prototype for JS: used when adding new boxes via #addBoxBtn #}
          {% set boxPrototype %}
            <div class="signature-box-item" data-index="__name__">
              {{ form_row(form.signatureBoxes.vars.prototype) }}
              <div class="mt-2 pt-2 border-top">
                <button type="button" class="btn btn-sm btn-outline-danger remove-box">{{ 'page.delete'|trans({}, 'nowo_pdf_signable') }}</button>
              </div>
            </div>
          {% endset %}
          {% if form.signatureBoxes.vars.errors|length > 0 %}
            <div class="alert alert-danger py-2 mb-3" role="alert">
              <strong>{{ 'page.errors_collection'|trans({}, 'nowo_pdf_signable') }}</strong>
              {{ form_errors(form.signatureBoxes) }}
            </div>
          {% endif %}
          <div id="signature-boxes-list" data-prototype="{{ boxPrototype|e('html_attr') }}" data-min-entries="{{ opts.min_entries|default(0) }}" data-max-entries="{{ opts.max_entries is defined and opts.max_entries is not null ? opts.max_entries : '' }}">
            {% for box in form.signatureBoxes %}
              <div class="signature-box-item {% if box.vars.errors|length > 0 %}border-danger{% endif %}" data-index="{{ loop.index0 }}">
                {{ form_row(box) }}
                {% if not (opts.signing_only|default(false)) %}
                <div class="mt-2 pt-2 border-top">
                  <button type="button" class="btn btn-sm btn-outline-danger remove-box">{{ 'page.delete'|trans({}, 'nowo_pdf_signable') }}</button>
                </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          <div id="signature-boxes-empty" class="text-center text-muted py-4 {% if form.signatureBoxes|length > 0 %}d-none{% endif %}">
            <p class="small mb-0">{{ 'page.empty_state'|trans({}, 'nowo_pdf_signable') }}</p>
          </div>
          <hr class="my-4">
          <div class="d-grid gap-2">
            {% if opts.batch_sign_enabled|default(false) %}
            <button type="submit" name="batch_sign" value="1" class="btn btn-primary btn-lg">{{ 'page.sign_all'|trans({}, 'nowo_pdf_signable') }}</button>
            {% endif %}
            <button type="submit" class="btn btn-success btn-lg">{{ 'page.save_coordinates'|trans({}, 'nowo_pdf_signable') }}</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% if _include_assets %}
  {# Config is always output so lazy loader or pdf-signable.js can use it #}
  <script>
    window.NowoPdfSignableConfig = {
      proxyUrl: {{ path('nowo_pdf_signable_proxy')|json_encode|raw }},
      debug: {{ (opts.debug|default(false)) ? 'true' : 'false' }},
      strings: {
        error_load_pdf: {{ 'js.error_load_pdf'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        alert_url_required: {{ 'js.alert_url_required'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        alert_submit_error: {{ 'js.alert_submit_error'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        loading_state: {{ 'js.loading_state'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        load_pdf_btn: {{ 'js.load_pdf_btn'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        default_box_name: {{ 'js.default_box_name'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        zoom_in: {{ 'js.zoom_in'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        zoom_out: {{ 'js.zoom_out'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        zoom_fit: {{ 'js.zoom_fit'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        fit_width: {{ 'js.fit_width'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        fit_page: {{ 'js.fit_page'|trans({}, 'nowo_pdf_signable')|json_encode|raw }},
        no_overlap_message: {{ 'signature_coordinates_type.signature_boxes.no_overlap_message'|trans({}, 'nowo_pdf_signable')|json_encode|raw }}
      }
    };
  </script>
  {% if opts.viewer_lazy_load|default(false) %}
  {# Lazy load: load PDF.js and pdf-signable.js only when the widget is visible (IntersectionObserver) #}
  <script>
  (function(){
    var w = document.querySelector('.nowo-pdf-signable-widget[data-viewer-lazy-load="1"]');
    if (!w || w.dataset.nowoPdfSignableLoaded) return;
    var pdfjsUrl = w.dataset.pdfjsUrl || 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
    var workerUrl = w.dataset.pdfjsWorkerUrl || 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    var bundleUrl = w.dataset.pdfSignableJs || '';
    if (!bundleUrl) return;
    var loaded = false;
    function loadScripts() {
      if (loaded) return;
      loaded = true;
      w.dataset.nowoPdfSignableLoaded = '1';
      var s1 = document.createElement('script');
      s1.src = pdfjsUrl;
      s1.onload = function() {
        var s2 = document.createElement('script');
        s2.textContent = "if (typeof pdfjsLib !== 'undefined') pdfjsLib.GlobalWorkerOptions.workerSrc = '" + workerUrl.replace(/'/g, "\\'") + "';";
        document.body.appendChild(s2);
        var s3 = document.createElement('script');
        s3.src = bundleUrl;
        document.body.appendChild(s3);
      };
      document.body.appendChild(s1);
    }
    if (typeof IntersectionObserver !== 'undefined') {
      var obs = new IntersectionObserver(function(entries) {
        if (entries[0].isIntersecting) { loadScripts(); obs.disconnect(); }
      }, { rootMargin: '100px', threshold: 0 });
      obs.observe(w);
    } else {
      loadScripts();
    }
  })();
  </script>
  {% else %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <script src="{{ asset('bundles/nowopdfsignable/js/pdf-signable.js') }}"></script>
  {% endif %}
  {% endif %}
{% endblock %}
