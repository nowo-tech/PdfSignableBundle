(function(){"use strict";typeof console<"u"&&console.debug("[PdfSignable] loaded: acroform-editor/config.ts");const ne="__other__";function Ge(s){if(!s||typeof s!="string")return[];try{const F=JSON.parse(s);return Array.isArray(F)?F.map(m=>{if(typeof m=="string"){const v=m.indexOf("|");return v>=0?{value:m.slice(0,v).trim(),label:m.slice(v+1).trim()}:{value:m.trim(),label:m.trim()}}if(m&&typeof m=="object"&&"value"in m){const v=m.value,f=m.label;return{value:typeof v=="string"?v:"",label:typeof f=="string"?f:void 0}}return{value:"",label:""}}).filter(m=>m.value!==""):[]}catch{return[]}}function Ke(s){var P;const F=s.dataset.loadUrl??"",m=s.dataset.postUrl??"",v=s.dataset.documentKey??"",f=s.dataset.applyUrl??"",h=s.dataset.processUrl??"",ie=s.dataset.debug==="1"||s.dataset.debug==="true",le=s.dataset.fieldNameMode==="choice"?"choice":"input",ae=Ge(s.dataset.fieldNameChoices),se=((P=s.dataset.fieldNameOtherText)==null?void 0:P.trim())??"",ce=s.dataset.showFieldRect!=="0"&&s.dataset.showFieldRect!=="false",de=We(s.dataset.fontSizes),D=Ze(s.dataset.fontFamilies);return{loadUrl:F,postUrl:m,documentKey:v,applyUrl:f,processUrl:h,debug:ie,fieldNameMode:le,fieldNameChoices:ae,fieldNameOtherText:se,showFieldRect:ce,fontSizes:de,fontFamilies:D}}function We(s){if(!s||typeof s!="string")return[];try{const F=JSON.parse(s);return Array.isArray(F)?F.map(m=>typeof m=="number"&&Number.isFinite(m)?Math.max(1,Math.round(m)):typeof m=="string"?parseInt(m,10):NaN).filter(m=>!Number.isNaN(m)&&m>=1):[]}catch{return[]}}function Ze(s){if(!s||typeof s!="string")return[];try{const F=JSON.parse(s);return Array.isArray(F)?F.map(m=>{if(typeof m=="string"){const v=m.indexOf("|");return v>=0?{value:m.slice(0,v).trim(),label:m.slice(v+1).trim()}:{value:m.trim(),label:m.trim()}}if(m&&typeof m=="object"&&"value"in m){const v=m.value,f=m.label;return{value:typeof v=="string"?v:"",label:typeof f=="string"?f:void 0}}return{value:"",label:""}}).filter(m=>m.value!==""):[]}catch{return[]}}typeof console<"u"&&console.debug("[PdfSignable] loaded: acroform-editor/strings.ts");const qe={};function k(s){return String(s).replace(/&/g,"&amp;").replace(/"/g,"&quot;")}typeof console<"u"&&console.debug("[PdfSignable] loaded: acroform-editor/acroform-move-resize.ts"),typeof console<"u"&&console.debug("[PdfSignable] loaded: acroform-editor/index.ts"),typeof console<"u"&&console.debug("[PdfSignable] loaded: acroform-editor.ts");const Qe='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',Xe='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>',Ye='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',et='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 9l-3 3 3 3"/><path d="M9 5l3-3 3 3"/><path d="M15 19l-3 3-3-3"/><path d="M19 9l3 3-3 3"/><path d="M2 12h20"/><path d="M12 2v20"/></svg>';function tt(s){var $e,Re,De,He;const F=window,m=s.querySelector("#acroform-editor-strings");let v={...qe};if(m!=null&&m.textContent)try{const e=JSON.parse(m.textContent);e&&typeof e=="object"&&(v={...v,...e})}catch{}v={...v,...F.NowoPdfSignableAcroFormEditorStrings??{}};const f=(e,t)=>{let o=v[e]??qe[e]??e;if(t)for(const[n,r]of Object.entries(t))o=o.replace(new RegExp("%"+n+"%","g"),r);return o},h=Ke(s),ie=s.querySelector("#acroform-document-key"),le=s.querySelector("#acroform-overrides-json"),ae=s.querySelector("#acroform-overrides-message"),se=s.querySelector("#acroform-fields-section"),ce=s.querySelector("#acroform-fields-list"),de=s.querySelector("#acroform-load-btn"),D=s.querySelector("#acroform-save-btn"),P=s.querySelector("#acroform-clear-btn"),L=s.querySelector("#acroform-add-field-mode-btn"),fe=s.querySelector("#acroform-refresh-inputs-btn");if(!ie||!le||!ae||!se||!ce||!de||!D||!P)return;const Le=s.querySelector("#acroform-json-section");Le&&!h.debug&&(Le.style.display="none"),fe&&!h.debug&&(fe.style.display="none");const ge=window;if(ge.__pdfSignableAcroFormEditMode=!0,ge.__pdfSignableAcroFormAddFieldMode=!1,window.dispatchEvent(new CustomEvent("pdf-signable-acroform-edit-mode",{detail:{active:!0}})),!s.querySelector("#acroform-editor-styles")){const e=document.createElement("style");e.id="acroform-editor-styles",e.textContent=".acroform-btn-icon{display:inline-flex;align-items:center;justify-content:center;min-width:1.75rem}.acroform-btn-icon svg{display:block}.acroform-list-row:hover{background-color:rgba(13,110,253,0.08)}.acroform-list-row.acroform-list-row--focused,.acroform-list-row.acroform-list-row--move-resize{background-color:rgba(220,53,69,0.15);border-left:3px solid #dc3545}",s.appendChild(e)}const ye=h.fieldNameMode==="choice"&&h.fieldNameChoices.length>0,H="data-np-autofill-field-type";function be(e){const t=e.querySelector("#acroform-edit-field-name-select"),o=e.querySelectorAll("#acroform-edit-field-name-other"),n=e.querySelector("#acroform-edit-field-name");[t,...o,n].filter(Boolean).forEach(r=>{r!=null&&r.hasAttribute(H)&&r.removeAttribute(H)})}const A=s.querySelector("#acroform-edit-modal"),ve=s.querySelector(".acroform-edit-modal-backdrop");A&&(ve==null||ve.addEventListener("click",J),($e=A.querySelector("#acroform-edit-close"))==null||$e.addEventListener("click",J),(Re=A.querySelector("#acroform-edit-cancel"))==null||Re.addEventListener("click",J),(De=A.querySelector("#acroform-edit-save"))==null||De.addEventListener("click",rt),(He=A.querySelector("#acroform-edit-font-auto-size"))==null||He.addEventListener("change",Se),A.addEventListener("change",t=>{const o=t.target;o instanceof HTMLSelectElement&&o.id==="acroform-edit-control-type"?(h.debug&&console.debug("[AcroForm edit modal] valor seleccionado: control type =",o.value),Ie(o.value)):o instanceof HTMLSelectElement&&o.id==="acroform-edit-field-name-select"&&(h.debug&&console.debug("[AcroForm edit modal] valor seleccionado: field name =",o.value),ue(A))}),ye&&ue(A),new MutationObserver(t=>{const o=[];let n=!1;for(const r of t)r.type==="attributes"&&r.attributeName===H&&r.target instanceof HTMLElement&&r.target.getAttribute(H)&&(n=!0,h.debug&&r.oldValue==null&&o.push({targetId:r.target.id||null,targetTag:r.target.tagName}));n&&(be(A),ue(A)),h.debug&&o.length&&console.debug("[AcroForm edit modal] extensión añadió",H,"→ quitando en",o.length,"elemento(s)",o)}).observe(A,{attributes:!0,attributeFilter:[H],subtree:!0,attributeOldValue:!0}));function Se(){const e=s.querySelector("#acroform-edit-modal");if(!e)return;const t=e.querySelector("#acroform-edit-font-size"),o=e.querySelector("#acroform-edit-font-auto-size");t&&o&&(t.disabled=o.checked)}function Ie(e){const t=s.querySelector("#acroform-edit-modal");if(!t)return;const o=t.querySelector(".acroform-edit-group-options"),n=t.querySelector(".acroform-edit-group-default-text"),r=t.querySelector(".acroform-edit-group-default-checkbox"),c=t.querySelector(".acroform-edit-group-checkbox-options"),a=t.querySelector(".acroform-edit-group-font"),l=t.querySelector(".acroform-edit-group-max-len"),i=e==="select"||e==="choice";o&&(o.style.display=i?"block":"none"),n&&(n.style.display=e==="text"||e==="textarea"||i?"block":"none"),r&&(r.style.display=e==="checkbox"?"block":"none"),c&&(c.style.display=e==="checkbox"?"block":"none"),a&&(a.style.display=e==="text"||e==="textarea"?"block":"none"),l&&(l.style.display=e==="text"||e==="textarea"?"block":"none"),(e==="text"||e==="textarea")&&Se()}function J(){const e=s.querySelector("#acroform-edit-modal"),t=s.querySelector(".acroform-edit-modal-backdrop");e&&(e.classList.remove("show"),e.style.display="none",e.setAttribute("aria-hidden","true")),t&&(t.classList.remove("show"),t.style.display="none")}function ue(e){const t=e.querySelector("#acroform-edit-field-name-select"),o=!!t,n=ye||o;if(h.debug&&console.debug("[AcroForm field name other] syncFieldNameOtherVisibility llamada",{modalId:e.id,useFieldNameSelect:ye,hasSelectInModal:o,useSelectMode:n}),!n){h.debug&&console.debug("[AcroForm field name other] salida: ni config choice ni select en modal");return}const r=e.querySelectorAll("#acroform-edit-field-name-other");if(h.debug&&console.debug("[AcroForm field name other] elementos en modal",{tieneSelect:!!t,selectId:(t==null?void 0:t.id)??null,numInputsById:r.length,inputsPorName:e.querySelectorAll('input[name="acro_form_field_edit[fieldNameOther]"]').length}),!t){h.debug&&console.debug("[AcroForm field name other] salida: no se encontró #acroform-edit-field-name-select");return}if(r.length===0&&h.debug){const i=e.querySelectorAll('input[name="acro_form_field_edit[fieldNameOther]"]');console.debug("[AcroForm field name other] ningún input con id acroform-edit-field-name-other; por name encontrados:",i.length,i.length?Array.from(i).map(u=>({id:u.id,name:u.getAttribute("name")})):[])}const c=t.value,a=c===ne;h.debug&&console.debug("[AcroForm field name other] syncFieldNameOtherVisibility",{selectValue:c,FIELD_NAME_VALUE_OTHER:ne,showOther:a,fieldNameOtherCount:r.length});const l=a?"block":"none";r.forEach(i=>{const u=i.closest(".acroform-edit-group"),p=(u==null?void 0:u.querySelector("#acroform-edit-field-name-select"))??null;u&&!p&&(u.style.display=l,h.debug&&console.debug("[AcroForm edit modal] campo field name other: grupo oculto/visible",{display:l,grupo:u.tagName,grupoClass:u.className,selected:c})),i.style.display=l,h.debug&&console.debug("[AcroForm edit modal] campo field name other: input oculto/visible",{display:l,id:i.id,selected:c})}),h.debug&&r.length&&console.debug("[AcroForm edit modal] campo field name other",a?"visible":"oculto","(selected =",c+")")}function ot(e){const t=e.querySelector("#acroform-edit-field-name-select");if(t){const n=e.querySelector("#acroform-edit-field-name-other");return t.value===ne&&n?n.value.trim():t.value.trim()}const o=e.querySelector("#acroform-edit-field-name");return(o==null?void 0:o.value.trim())??""}function rt(){var te,oe,re;const e=s.querySelector("#acroform-edit-modal");if(!e)return;const t=e.querySelector("#acroform-edit-field-id"),o=e.querySelector("#acroform-edit-rect"),n=e.querySelector("#acroform-edit-control-type"),r=e.querySelector("#acroform-edit-options"),c=e.querySelector("#acroform-edit-default-value"),a=e.querySelector("#acroform-edit-default-checked"),l=!!e.querySelector("#acroform-edit-field-name-select")||!!e.querySelector("#acroform-edit-field-name");if(!t||!n||!r||!l||!c)return;const i=t.value.trim();if(!i)return;const u=ot(e);if(!!e.querySelector("#acroform-edit-field-name-select")&&u===""){S(f("msg_field_name_required"),!0);return}const y=parseInt(((te=t.dataset)==null?void 0:te.fieldPage)??"1",10),_=n.value||"text";let q;if(o){const b=o.value.split(/[\s,]+/).map(Q=>parseFloat(Q.trim())),x=b[0]??0,B=b[1]??0,Z=Math.max(0,b[2]??100),R=Math.max(0,b[3]??20);q=[x,B,x+Z,B+R]}const M=_==="select"||_==="choice"?r.value.trim():"",g=M?M.split(/\n/).map(b=>{const x=b.indexOf("|");return x>=0?{value:b.slice(0,x).trim(),label:b.slice(x+1).trim()}:{value:b.trim(),label:b.trim()}}):[],$=_==="checkbox"&&a?a.checked?"1":"0":c.value,O=e.querySelector("#acroform-edit-font-size"),V=e.querySelector("#acroform-edit-font-family"),C=e.querySelector("#acroform-edit-font-auto-size"),K=O!=null&&O.value.trim()?parseInt(O.value,10):NaN,he=((oe=V==null?void 0:V.value)==null?void 0:oe.trim())??"",W=(C==null?void 0:C.checked)??!1;d[i]||(d[i]={}),q&&(d[i].rect=q),d[i].page=y,d[i].controlType=_,d[i].options=g.length?g:void 0,u!==""&&(d[i].fieldName=u);const j=e.querySelector("#acroform-edit-max-len");if(j&&j.value.trim()!==""){const b=parseInt(j.value,10);!Number.isNaN(b)&&b>=0&&(d[i].maxLen=b)}const Y=e.querySelector("#acroform-edit-hidden");Y&&(d[i].hidden=Y.checked);const ee=e.querySelector("#acroform-edit-create-if-missing");if(ee&&(d[i].createIfMissing=ee.checked),d[i].defaultValue=$,_==="text"||_==="textarea"){const x="sans-serif";d[i].fontSize=!Number.isNaN(K)&&K>0?K:11,d[i].fontFamily=he||x,d[i].fontAutoSize=W}if(_==="checkbox"){const b=e.querySelector("#acroform-edit-checkbox-value-on"),x=e.querySelector("#acroform-edit-checkbox-value-off"),B=e.querySelector("#acroform-edit-checkbox-icon"),Z=(b==null?void 0:b.value.trim())??"",R=(x==null?void 0:x.value.trim())??"",Q=((re=B==null?void 0:B.value)==null?void 0:re.trim())||"check";d[i].checkboxValueOn=Z!==""?Z:"1",d[i].checkboxValueOff=R!==""?R:"0",d[i].checkboxIcon=Q}T(),z(I.length?I:N(),d),U(),J()}const Me=ae,we=le,X=ie,_e=se,E=ce,xe=de;h.documentKey&&(X.value=h.documentKey);let d={},I=[],Oe=null,Te=0;function nt(){const e=[];return Object.keys(d).forEach(t=>{const o=d[t];if(!o||typeof o!="object")return;const n={fieldId:t};Array.isArray(o.rect)&&o.rect.length>=4&&(n.rect=o.rect),o.defaultValue!==void 0&&(n.defaultValue=String(o.defaultValue)),(o.hidden===!0||o.hidden==="true")&&(n.hidden=!0),o.fieldName!==void 0&&String(o.fieldName).trim()!==""&&(n.fieldName=String(o.fieldName).trim()),o.controlType!==void 0&&String(o.controlType)&&(n.controlType=String(o.controlType)),o.fieldType!==void 0&&String(o.fieldType)&&(n.fieldType=String(o.fieldType)),Array.isArray(o.options)&&o.options.length&&(n.options=o.options.map(r=>typeof r=="string"?{value:r,label:r}:r&&typeof r=="object"&&"value"in r?{value:String(r.value),label:r.label}:{value:"",label:""}).filter(r=>r.value!=="")),o.page!==void 0&&Number.isFinite(Number(o.page))&&(n.page=Number(o.page)),(o.createIfMissing===!0||o.createIfMissing==="true")&&(n.createIfMissing=!0),t.startsWith("new-")&&n.rect&&n.page&&(n.createIfMissing=!0),o.maxLen!==void 0&&Number.isFinite(Number(o.maxLen))&&(n.maxLen=Number(o.maxLen)),o.fontSize!==void 0&&Number.isFinite(Number(o.fontSize))&&(n.fontSize=Number(o.fontSize)),o.fontFamily!==void 0&&String(o.fontFamily).trim()!==""&&(n.fontFamily=String(o.fontFamily).trim()),e.push(n)}),e}function S(e,t){Me.textContent=e,Me.className="small mb-2 "+(t?"text-danger":"text-success")}function T(){we.value=JSON.stringify(d,null,2)}function ke(){try{const e=(we.value||"").trim(),t=e?JSON.parse(e):{};d=typeof t=="object"&&t!==null?t:{}}catch{return!1}return!0}function N(){const e=window;return e.__pdfSignableAcroFormFields&&Array.isArray(e.__pdfSignableAcroFormFields)&&e.__pdfSignableAcroFormFields.length?e.__pdfSignableAcroFormFields.map(t=>({id:t.id,rect:t.rect,width:t.width,height:t.height,fieldType:t.fieldType??"",value:t.value,page:t.page,subtype:t.subtype,flags:t.flags,fieldName:t.fieldName,maxLen:t.maxLen,fontSize:t.fontSize})):[]}function G(){const e={};return document.querySelectorAll(".acroform-field-input").forEach(t=>{var n;const o=(n=t.dataset)==null?void 0:n.fieldId;o!=null&&(e[o]=t.value??"")}),e}function me(e,t,o){const n={};e.forEach(a=>{n[String(a.id)]=a});const r={};return new Set([...Object.keys(t||{}),...e.map(a=>String(a.id??""))]).forEach(a=>{const l=n[a]??{},i={id:l.id,rect:l.rect,width:l.width,height:l.height,fieldType:l.fieldType,value:l.value,page:l.page,subtype:l.subtype,flags:l.flags,fieldName:l.fieldName,maxLen:l.maxLen,fontSize:l.fontSize},u=t[a]??{};let p=o[a];p===void 0&&(p=u.defaultValue),p===void 0&&(p=l.value),r[a]={...i,...u,defaultValue:p}}),r}function U(){const e=window;e.__pdfSignableAcroFormOverrides=d,window.dispatchEvent(new CustomEvent("pdf-signable-acroform-overrides-updated",{detail:{overrides:d}}))}function Fe(){const e=G();for(const t of Object.keys(e))d[t]||(d[t]={}),d[t].defaultValue=e[t]}function ze(e,t){d[e]||(d[e]={}),d[e].hidden=t,T(),z(I.length?I:N(),d),U()}function it(e,t){const o=String(e.id??""),n=t.rect??e.rect,r=n&&n.length>=4?n:e.rect&&e.rect.length>=4?e.rect:[0,0,100,20],c=r[0],a=r[1],l=r[2],i=r[3],u=t.width??e.width??Math.max(0,l-c),p=t.height??e.height??Math.max(0,i-a),y=t.controlType??(e.fieldType==="Ch"?"choice":e.fieldType==="Btn"?"checkbox":"text"),q=(t.options??[]).map(w=>(w.value??"")+(w.label?"|"+w.label:"")).join(`
`),M=t.defaultValue??e.value??"",g=s.querySelector("#acroform-edit-modal");if(!g)return;const $=g.querySelector("#acroform-edit-field-id"),O=g.querySelector("#acroform-edit-rect"),V=g.querySelector("#acroform-edit-control-type"),C=g.querySelector("#acroform-edit-options"),K=g.querySelector("#acroform-edit-default-value"),he=g.querySelector("#acroform-edit-default-checked");if(!$||!V||!C||!K)return;$.value=o,$.dataset.fieldPage=String(e.page??1);const W=t.fieldName??e.fieldName??o??"",j=g.querySelector("#acroform-edit-field-name-select"),Y=g.querySelector("#acroform-edit-field-name");if(j){const w=g.querySelector("#acroform-edit-field-name-other");Array.from(j.options).map(st=>st.value).includes(W)?(j.value=W,w&&(w.value="")):(j.value=ne,w&&(w.value=W))}else Y&&(Y.value=W);ue(g),V.value=y,O&&(O.value=[c.toFixed(1),a.toFixed(1),u.toFixed(1),p.toFixed(1)].join(", ")),C.value=q,K.value=y==="checkbox"?"":M,he&&(he.checked=/^(1|true|yes|on)$/i.test(M.trim()));const ee=g.querySelector("#acroform-edit-checkbox-value-on"),te=g.querySelector("#acroform-edit-checkbox-value-off"),oe=g.querySelector("#acroform-edit-checkbox-icon");if(ee&&(ee.value=t.checkboxValueOn??"1"),te&&(te.value=t.checkboxValueOff??"0"),oe){const w=t.checkboxIcon||"check";oe.value=w==="cross"||w==="dot"?w:"check"}const re=g.querySelector("#acroform-edit-font-size"),b=g.querySelector("#acroform-edit-font-family"),x=g.querySelector("#acroform-edit-font-auto-size"),B=11,Z="sans-serif";if(re){const w=typeof t.fontSize=="number"&&t.fontSize>0?t.fontSize:B;re.value=String(w)}b&&(b.value=typeof t.fontFamily=="string"&&t.fontFamily?t.fontFamily:Z),x&&(x.checked=t.fontAutoSize===!0);const R=g.querySelector("#acroform-edit-max-len");if(R){const w=typeof t.maxLen=="number"&&t.maxLen>=0?t.maxLen:e.maxLen??void 0;R.value=w!=null?String(w):""}const Q=g.querySelector("#acroform-edit-hidden");Q&&(Q.checked=t.hidden===!0);const Je=g.querySelector("#acroform-edit-create-if-missing");Je&&(Je.checked=t.createIfMissing===!0),Ie(y),Se(),be(g),g.classList.add("show"),g.style.display="block",g.setAttribute("aria-hidden","false");const Ae=s.querySelector(".acroform-edit-modal-backdrop");Ae&&(Ae.classList.add("show"),Ae.style.display="block"),requestAnimationFrame(()=>be(g))}function z(e,t){if(!e.length){_e.style.display="none";return}_e.style.display="block";const o=[...e].sort((l,i)=>{const u=Number(l.page??1),p=Number(i.page??1);if(u!==p)return u-p;const y=l.rect,_=i.rect;if(y&&_&&y.length>=4&&_.length>=4){const q=Math.max(y[1],y[3]);return Math.max(_[1],_[3])-q}return 0});I=o;const n=t??d,r=G(),c=o.map(l=>{const i=String(l.id??""),u=n[i]??{},p=!!u.hidden,y=r[i]??l.value??"",_=String(u.fieldName??l.fieldName??l.label??"-"),q=[f("list_field_name")+_,f("list_type")+(l.fieldType??"-"),f("list_page")+(l.page??"")];y!==void 0&&y!==""&&q.push(f("list_current_value")+y),u.defaultValue&&q.push("defaultValue: "+String(u.defaultValue));const M=l.page??1,g=p?`<button type="button" class="btn btn-sm btn-outline-success acroform-btn-icon py-0 px-1 acroform-btn-restore" data-field-id="${k(i)}" title="${k(f("btn_restore_title"))}">${Ye}</button>`:`<button type="button" class="btn btn-sm btn-outline-danger acroform-btn-icon py-0 px-1 acroform-btn-hide" data-field-id="${k(i)}" title="${k(f("btn_hide_title"))}">${Xe}</button>`,$=`<button type="button" class="btn btn-sm btn-outline-primary acroform-btn-icon py-0 px-1 acroform-btn-edit" data-field-id="${k(i)}" title="${k(f("btn_edit_title"))}">${Qe}</button>`,O=`<button type="button" class="btn btn-sm btn-outline-secondary acroform-btn-icon py-0 px-1 acroform-btn-move-resize" data-field-id="${k(i)}" data-page="${M}" title="${k(f("btn_move_resize_title"))}">${et}</button>`,V="acroform-list-row border-bottom pb-1 mb-1 d-flex justify-content-between align-items-center gap-2 "+(p?"text-muted bg-light":"cursor-pointer"),C=(q.join(" · ")||"-")+(p?f("list_hidden_suffix"):"");return`<div class="${V}" data-field-id="${k(i)}" data-page="${M}" role="button" tabindex="0" title="${k(f("row_click_highlight"))}"><span class="acroform-row-text flex-grow-1 text-truncate">${k(C)}</span><span class="acroform-row-actions d-flex gap-1 flex-shrink-0">${$}${O}${g}</span></div>`});E.innerHTML=c.join("")||'<span class="text-muted">'+k(f("list_no_fields"))+"</span>",E.querySelectorAll(".acroform-btn-hide").forEach(l=>{l.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),ze(String(i.currentTarget.dataset.fieldId||""),!0)})}),E.querySelectorAll(".acroform-btn-restore").forEach(l=>{l.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),ze(String(i.currentTarget.dataset.fieldId||""),!1)})}),E.querySelectorAll(".acroform-btn-edit").forEach(l=>{l.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),lt(),Ee(void 0);const u=i.currentTarget.dataset.fieldId||"",p=e.find(y=>String(y.id)===u);p&&it(p,n[u]??{})})}),E.querySelectorAll(".acroform-btn-move-resize").forEach(l=>{l.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),J();const u=i.currentTarget,p=u.dataset.fieldId||"",y=u.dataset.page||"1";window.__pdfSignableAcroFormMoveResizeFieldId=p,window.dispatchEvent(new CustomEvent("pdf-signable-acroform-move-resize",{detail:{fieldId:p,page:y}})),pe(p,y),Ee(p)})}),Ee(window.__pdfSignableAcroFormMoveResizeFieldId)}function lt(){window.__pdfSignableAcroFormMoveResizeFieldId=void 0,window.dispatchEvent(new CustomEvent("pdf-signable-acroform-move-resize-close"))}function Ee(e){E.querySelectorAll(".acroform-list-row").forEach(t=>{const o=t;e!=null&&o.dataset.fieldId===e?o.classList.add("acroform-list-row--move-resize"):o.classList.remove("acroform-list-row--move-resize")})}function pe(e,t){const r=(s.closest(".nowo-pdf-signable-widget")??document).querySelectorAll(".acroform-field-outline");let c=null;for(let a=0;a<r.length;a++){const l=r[a];if(l.classList.remove("acroform-field-outline--highlight"),l.dataset.fieldId===e){const i=l.closest(".pdf-page-wrapper");(i==null?void 0:i.getAttribute("data-page"))===t&&(c=l)}}if(c!==null){const a=c;a.classList.add("acroform-field-outline--highlight");const l=a.closest(".pdf-page-wrapper");l&&l.scrollIntoView({behavior:"smooth",block:"center"})}}E.addEventListener("click",e=>{const t=e.target;if(t.closest("button")||t.closest(".acroform-row-actions"))return;const o=t.closest(".acroform-list-row");if(!o)return;const n=String(o.dataset.fieldId??""),r=String(o.dataset.page??"1");pe(n,r),!window.__pdfSignableAcroFormMoveResizeFieldId&&E.querySelectorAll(".acroform-list-row").forEach(a=>{const l=a;l.dataset.fieldId===n?l.classList.add("acroform-list-row--focused"):l.classList.remove("acroform-list-row--focused")})}),E.addEventListener("keydown",e=>{if(e.key!=="Enter"&&e.key!==" ")return;const t=e.target;if(t.closest("button")||t.closest(".acroform-row-actions"))return;const o=t.closest(".acroform-list-row");o&&(e.preventDefault(),pe(String(o.dataset.fieldId??""),String(o.dataset.page??"1")))}),window.addEventListener("pdf-signable-acroform-field-focused",(e=>{const t=e.detail??{},o=t.fieldId,n=t.page!=null?String(t.page):"1";o&&(pe(o,n),E.querySelectorAll(".acroform-list-row").forEach(r=>{const c=r;c.dataset.fieldId===o?(c.classList.add("acroform-list-row--focused"),c.scrollIntoView({behavior:"smooth",block:"nearest"})):c.classList.remove("acroform-list-row--focused")}))}));function Ve(){const e=document.querySelector(".pdf-url-input");return((e==null?void 0:e.value)??"").trim()}function Ce(e){const t=new Uint8Array(e),o=8192;let n="";for(let r=0;r<t.length;r+=o){const c=t.subarray(r,Math.min(r+o,t.length));n+=String.fromCharCode.apply(null,c)}return btoa(n)}function je(){const e=(X.value??"").trim();if(!e){S(f("msg_enter_document_key"),!0);return}const t=Ve();if(!t){S(f("msg_load_pdf_first_load"),!0);return}const o=N(),n={document_key:e,pdf_url:t};o.length&&(n.fields=o),xe.disabled=!0,fetch(h.loadUrl,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(n)}).then(r=>r.ok?r.json():r.json().then(c=>{throw new Error(c.error??r.statusText)})).then(r=>{var a;r.fields_extractor_error&&S(r.fields_extractor_error,!0);const c=(a=r.fields)!=null&&a.length?r.fields:N();if(d=me(c,r.overrides??{},G()),T(),z(c,d),!r.fields_extractor_error){const l=r.overrides&&Object.keys(r.overrides).length>0;S(l?f("msg_draft_loaded",{count:String(c.length)}):f("msg_no_data_server",{count:String(c.length)}),!1)}U()}).catch(r=>S(f("error_prefix")+r.message,!0)).finally(()=>{xe.disabled=!1})}xe.addEventListener("click",je),D.addEventListener("click",()=>{const e=(X.value??"").trim();if(!e){S(f("msg_enter_document_key"),!0);return}if(!ke()){S(f("msg_invalid_json"),!0);return}Fe();const t=N(),o={document_key:e,overrides:me(t,d,G()),...t.length?{fields:t}:{}};D.disabled=!0,fetch(h.postUrl,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(o)}).then(n=>n.ok?n.json():n.json().then(r=>{throw new Error(r.error??n.statusText)})).then(()=>{S(f("msg_draft_saved"),!1),U()}).catch(n=>S(f("error_prefix")+n.message,!0)).finally(()=>{D.disabled=!1})}),P.addEventListener("click",()=>{d={},T(),E.innerHTML="",_e.style.display="none",S(f("msg_draft_cleared"),!1),U()});let Be=!1;function at(e){Be=e,ge.__pdfSignableAcroFormAddFieldMode=e,L&&(e?(L.classList.remove("btn-outline-success"),L.classList.add("btn-success"),L.textContent=f("add_field_mode_btn_done")):(L.classList.remove("btn-success"),L.classList.add("btn-outline-success"),L.textContent=f("add_field_mode_btn")))}L&&L.addEventListener("click",()=>{at(!Be)});let Pe=null;if(h.applyUrl){const e=document.createElement("button");e.id="acroform-apply-btn",e.type="button",e.className="btn btn-sm btn-outline-info",e.textContent=f("btn_apply_pdf"),e.title=f("btn_apply_pdf_title"),P.after(e),Pe=e,e.addEventListener("click",()=>{const t=Ve();if(!t){S(f("msg_apply_pdf_first"),!0);return}Fe();const o=nt();e.setAttribute("disabled","");const n=c=>(h.debug&&console.debug("[AcroForm apply] request",{validateOnly:c,patchesCount:o.length,fieldIds:o.map(a=>a.fieldId)}),fetch(t,{method:"GET",headers:{Accept:"application/pdf,*/*"}}).then(a=>{if(!a.ok)throw new Error(`Failed to load PDF: ${a.status}`);return a.arrayBuffer()}).then(a=>{const l={pdf_content:Ce(a),patches:o};return c&&(l.validate_only=!0),fetch(h.applyUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)})}).then(a=>{const i=(a.headers.get("Content-Type")??"").includes("application/json");return a.ok?c&&i?a.json().then(u=>{if(h.debug&&console.debug("[AcroForm apply] response (validate_only)",u),u.success!==!0)throw new Error(u.error??"Validation failed");return null}):a.blob().then(u=>{const p=u.arrayBuffer();return h.debug&&p.then(y=>{console.debug("[AcroForm apply] response (PDF)",{contentType:a.headers.get("Content-Type"),size:y.byteLength,ok:a.ok})}),p}):a.json().then(u=>{const p=u.error??a.statusText,y=u.detail?`
${u.detail}`:"";throw new Error(p+y)})}));(h.debug?n(!0).then(()=>n(!1)):n(!1)).then(c=>{if(c){Oe=c,S(f("msg_pdf_modified_received"),!1);const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([c],{type:"application/pdf"})),a.download=f("download_filename"),a.click(),URL.revokeObjectURL(a.href)}}).catch(c=>S(f("error_prefix")+c.message,!0)).finally(()=>e.removeAttribute("disabled"))})}if(h.processUrl){const e=document.createElement("button");e.type="button",e.className="btn btn-sm btn-info",e.textContent=f("btn_process"),e.title=f("btn_process_title"),(Pe??P).after(e),e.addEventListener("click",()=>{const t=Oe;if(!t||t.byteLength===0){S(f("msg_process_first"),!0);return}const o=Ce(t),n=(X.value??"").trim();e.setAttribute("disabled",""),fetch(h.processUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pdf_content:o,document_key:n||void 0})}).then(r=>r.ok?r.json():r.json().then(c=>{throw new Error(c.error??c.detail??r.statusText)})).then(r=>{S(r.success!==!1?f("msg_process_success"):f("msg_processed"),!1)}).catch(r=>S(f("error_prefix")+r.message,!0)).finally(()=>e.removeAttribute("disabled"))})}fe&&fe.addEventListener("click",()=>{const e=N();if(!e.length){S(f("msg_refresh_load_first"),!0);return}ke(),Fe(),d=me(e,d,G()),T(),z(e,d),S(f("msg_draft_updated"),!1)}),we.addEventListener("blur",()=>{if(ke()){const e=I.length?I:N();d=me(e,d,G()),T(),z(e,d)}});let Ue=!1;window.addEventListener("pdf-signable-acroform-fields-updated",()=>{const e=(X.value??"").trim(),t=N();t.length&&(z(t,d),e&&!Ue&&(Ue=!0,je()))}),window.addEventListener("pdf-signable-acroform-move-resize-opened",()=>{J()}),window.addEventListener("pdf-signable-acroform-rect-changed",(e=>{const{fieldId:t,rect:o}=e.detail??{};!t||!Array.isArray(o)||o.length<4||(d[t]||(d[t]={}),d[t].rect=o,T(),z(I.length?I:N(),d),U())})),window.addEventListener("pdf-signable-acroform-add-field-place",(e=>{const t=e.detail??{},{page:o,llx:n,lly:r,width:c=100,height:a=20}=t;if(typeof o!="number"||typeof n!="number"||typeof r!="number")return;Te+=1;const l="new-"+Date.now(),i=n+c,u=r+a,p=f("new_field_name_pattern").replace(/%n/g,String(Te));d[l]={page:o,rect:[n,r,i,u],controlType:"text",defaultValue:"",fieldName:p},T(),U(),setTimeout(()=>{z(N(),d);const y=E.querySelector(`.acroform-list-row[data-field-id="${CSS.escape(l)}"]`);y&&(y.classList.add("acroform-list-row--focused"),y.scrollIntoView({behavior:"smooth",block:"nearest"}))},150)}))}const Ne=document.getElementById("acroform-editor-root");Ne&&tt(Ne)})();
