(function(){"use strict";typeof console<"u"&&console.debug("[PdfSignable] loaded: acroform-editor/config.ts");const re="__other__";function He(s){if(!s||typeof s!="string")return[];try{const F=JSON.parse(s);return Array.isArray(F)?F.map(m=>{if(typeof m=="string"){const v=m.indexOf("|");return v>=0?{value:m.slice(0,v).trim(),label:m.slice(v+1).trim()}:{value:m.trim(),label:m.trim()}}if(m&&typeof m=="object"&&"value"in m){const v=m.value,u=m.label;return{value:typeof v=="string"?v:"",label:typeof u=="string"?u:void 0}}return{value:"",label:""}}).filter(m=>m.value!==""):[]}catch{return[]}}function Je(s){var B;const F=s.dataset.loadUrl??"",m=s.dataset.postUrl??"",v=s.dataset.documentKey??"",u=s.dataset.applyUrl??"",h=s.dataset.processUrl??"",ne=s.dataset.debug==="1"||s.dataset.debug==="true",ie=s.dataset.fieldNameMode==="choice"?"choice":"input",ae=He(s.dataset.fieldNameChoices),le=((B=s.dataset.fieldNameOtherText)==null?void 0:B.trim())??"",se=s.dataset.showFieldRect!=="0"&&s.dataset.showFieldRect!=="false",ce=Ge(s.dataset.fontSizes),$=Ke(s.dataset.fontFamilies);return{loadUrl:F,postUrl:m,documentKey:v,applyUrl:u,processUrl:h,debug:ne,fieldNameMode:ie,fieldNameChoices:ae,fieldNameOtherText:le,showFieldRect:se,fontSizes:ce,fontFamilies:$}}function Ge(s){if(!s||typeof s!="string")return[];try{const F=JSON.parse(s);return Array.isArray(F)?F.map(m=>typeof m=="number"&&Number.isFinite(m)?Math.max(1,Math.round(m)):typeof m=="string"?parseInt(m,10):NaN).filter(m=>!Number.isNaN(m)&&m>=1):[]}catch{return[]}}function Ke(s){if(!s||typeof s!="string")return[];try{const F=JSON.parse(s);return Array.isArray(F)?F.map(m=>{if(typeof m=="string"){const v=m.indexOf("|");return v>=0?{value:m.slice(0,v).trim(),label:m.slice(v+1).trim()}:{value:m.trim(),label:m.trim()}}if(m&&typeof m=="object"&&"value"in m){const v=m.value,u=m.label;return{value:typeof v=="string"?v:"",label:typeof u=="string"?u:void 0}}return{value:"",label:""}}).filter(m=>m.value!==""):[]}catch{return[]}}typeof console<"u"&&console.debug("[PdfSignable] loaded: acroform-editor/strings.ts");const qe={};function k(s){return String(s).replace(/&/g,"&amp;").replace(/"/g,"&quot;")}typeof console<"u"&&console.debug("[PdfSignable] loaded: acroform-editor/acroform-move-resize.ts"),typeof console<"u"&&console.debug("[PdfSignable] loaded: acroform-editor/index.ts"),typeof console<"u"&&console.debug("[PdfSignable] loaded: acroform-editor.ts");const We='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',Ze='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>',Qe='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',Xe='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M5 9l-3 3 3 3"/><path d="M9 5l3-3 3 3"/><path d="M15 19l-3 3-3-3"/><path d="M19 9l3 3-3 3"/><path d="M2 12h20"/><path d="M12 2v20"/></svg>';function Ye(s){var Pe,Ue,Re,$e;const F=window,m=s.querySelector("#acroform-editor-strings");let v={...qe};if(m!=null&&m.textContent)try{const e=JSON.parse(m.textContent);e&&typeof e=="object"&&(v={...v,...e})}catch{}v={...v,...F.NowoPdfSignableAcroFormEditorStrings??{}};const u=(e,t)=>{let o=v[e]??qe[e]??e;if(t)for(const[n,r]of Object.entries(t))o=o.replace(new RegExp("%"+n+"%","g"),r);return o},h=Je(s),ne=s.querySelector("#acroform-document-key"),ie=s.querySelector("#acroform-overrides-json"),ae=s.querySelector("#acroform-overrides-message"),le=s.querySelector("#acroform-fields-section"),se=s.querySelector("#acroform-fields-list"),ce=s.querySelector("#acroform-load-btn"),$=s.querySelector("#acroform-save-btn"),B=s.querySelector("#acroform-clear-btn"),de=s.querySelector("#acroform-refresh-inputs-btn");if(!ne||!ie||!ae||!le||!se||!ce||!$||!B)return;const Ae=s.querySelector("#acroform-json-section");if(Ae&&!h.debug&&(Ae.style.display="none"),de&&!h.debug&&(de.style.display="none"),window.__pdfSignableAcroFormEditMode=!0,window.dispatchEvent(new CustomEvent("pdf-signable-acroform-edit-mode",{detail:{active:!0}})),!s.querySelector("#acroform-editor-styles")){const e=document.createElement("style");e.id="acroform-editor-styles",e.textContent=".acroform-btn-icon{display:inline-flex;align-items:center;justify-content:center;min-width:1.75rem}.acroform-btn-icon svg{display:block}.acroform-list-row:hover{background-color:rgba(13,110,253,0.08)}.acroform-list-row.acroform-list-row--focused,.acroform-list-row.acroform-list-row--move-resize{background-color:rgba(220,53,69,0.15);border-left:3px solid #dc3545}",s.appendChild(e)}const he=h.fieldNameMode==="choice"&&h.fieldNameChoices.length>0,D="data-np-autofill-field-type";function ge(e){const t=e.querySelector("#acroform-edit-field-name-select"),o=e.querySelectorAll("#acroform-edit-field-name-other"),n=e.querySelector("#acroform-edit-field-name");[t,...o,n].filter(Boolean).forEach(r=>{r!=null&&r.hasAttribute(D)&&r.removeAttribute(D)})}const E=s.querySelector("#acroform-edit-modal"),ye=s.querySelector(".acroform-edit-modal-backdrop");E&&(ye==null||ye.addEventListener("click",H),(Pe=E.querySelector("#acroform-edit-close"))==null||Pe.addEventListener("click",H),(Ue=E.querySelector("#acroform-edit-cancel"))==null||Ue.addEventListener("click",H),(Re=E.querySelector("#acroform-edit-save"))==null||Re.addEventListener("click",tt),($e=E.querySelector("#acroform-edit-font-auto-size"))==null||$e.addEventListener("change",be),E.addEventListener("change",t=>{const o=t.target;o instanceof HTMLSelectElement&&o.id==="acroform-edit-control-type"?(h.debug&&console.debug("[AcroForm edit modal] valor seleccionado: control type =",o.value),Le(o.value)):o instanceof HTMLSelectElement&&o.id==="acroform-edit-field-name-select"&&(h.debug&&console.debug("[AcroForm edit modal] valor seleccionado: field name =",o.value),fe(E))}),he&&fe(E),new MutationObserver(t=>{const o=[];let n=!1;for(const r of t)r.type==="attributes"&&r.attributeName===D&&r.target instanceof HTMLElement&&r.target.getAttribute(D)&&(n=!0,h.debug&&r.oldValue==null&&o.push({targetId:r.target.id||null,targetTag:r.target.tagName}));n&&(ge(E),fe(E)),h.debug&&o.length&&console.debug("[AcroForm edit modal] extensión añadió",D,"→ quitando en",o.length,"elemento(s)",o)}).observe(E,{attributes:!0,attributeFilter:[D],subtree:!0,attributeOldValue:!0}));function be(){const e=s.querySelector("#acroform-edit-modal");if(!e)return;const t=e.querySelector("#acroform-edit-font-size"),o=e.querySelector("#acroform-edit-font-auto-size");t&&o&&(t.disabled=o.checked)}function Le(e){const t=s.querySelector("#acroform-edit-modal");if(!t)return;const o=t.querySelector(".acroform-edit-group-options"),n=t.querySelector(".acroform-edit-group-default-text"),r=t.querySelector(".acroform-edit-group-default-checkbox"),c=t.querySelector(".acroform-edit-group-checkbox-options"),l=t.querySelector(".acroform-edit-group-font"),a=t.querySelector(".acroform-edit-group-max-len"),i=e==="select"||e==="choice";o&&(o.style.display=i?"block":"none"),n&&(n.style.display=e==="text"||e==="textarea"||i?"block":"none"),r&&(r.style.display=e==="checkbox"?"block":"none"),c&&(c.style.display=e==="checkbox"?"block":"none"),l&&(l.style.display=e==="text"||e==="textarea"?"block":"none"),a&&(a.style.display=e==="text"||e==="textarea"?"block":"none"),(e==="text"||e==="textarea")&&be()}function H(){const e=s.querySelector("#acroform-edit-modal"),t=s.querySelector(".acroform-edit-modal-backdrop");e&&(e.classList.remove("show"),e.style.display="none",e.setAttribute("aria-hidden","true")),t&&(t.classList.remove("show"),t.style.display="none")}function fe(e){const t=e.querySelector("#acroform-edit-field-name-select"),o=!!t,n=he||o;if(h.debug&&console.debug("[AcroForm field name other] syncFieldNameOtherVisibility llamada",{modalId:e.id,useFieldNameSelect:he,hasSelectInModal:o,useSelectMode:n}),!n){h.debug&&console.debug("[AcroForm field name other] salida: ni config choice ni select en modal");return}const r=e.querySelectorAll("#acroform-edit-field-name-other");if(h.debug&&console.debug("[AcroForm field name other] elementos en modal",{tieneSelect:!!t,selectId:(t==null?void 0:t.id)??null,numInputsById:r.length,inputsPorName:e.querySelectorAll('input[name="acro_form_field_edit[fieldNameOther]"]').length}),!t){h.debug&&console.debug("[AcroForm field name other] salida: no se encontró #acroform-edit-field-name-select");return}if(r.length===0&&h.debug){const i=e.querySelectorAll('input[name="acro_form_field_edit[fieldNameOther]"]');console.debug("[AcroForm field name other] ningún input con id acroform-edit-field-name-other; por name encontrados:",i.length,i.length?Array.from(i).map(f=>({id:f.id,name:f.getAttribute("name")})):[])}const c=t.value,l=c===re;h.debug&&console.debug("[AcroForm field name other] syncFieldNameOtherVisibility",{selectValue:c,FIELD_NAME_VALUE_OTHER:re,showOther:l,fieldNameOtherCount:r.length});const a=l?"block":"none";r.forEach(i=>{const f=i.closest(".acroform-edit-group"),p=(f==null?void 0:f.querySelector("#acroform-edit-field-name-select"))??null;f&&!p&&(f.style.display=a,h.debug&&console.debug("[AcroForm edit modal] campo field name other: grupo oculto/visible",{display:a,grupo:f.tagName,grupoClass:f.className,selected:c})),i.style.display=a,h.debug&&console.debug("[AcroForm edit modal] campo field name other: input oculto/visible",{display:a,id:i.id,selected:c})}),h.debug&&r.length&&console.debug("[AcroForm edit modal] campo field name other",l?"visible":"oculto","(selected =",c+")")}function et(e){const t=e.querySelector("#acroform-edit-field-name-select");if(t){const n=e.querySelector("#acroform-edit-field-name-other");return t.value===re&&n?n.value.trim():t.value.trim()}const o=e.querySelector("#acroform-edit-field-name");return(o==null?void 0:o.value.trim())??""}function tt(){var ee,te,oe;const e=s.querySelector("#acroform-edit-modal");if(!e)return;const t=e.querySelector("#acroform-edit-field-id"),o=e.querySelector("#acroform-edit-rect"),n=e.querySelector("#acroform-edit-control-type"),r=e.querySelector("#acroform-edit-options"),c=e.querySelector("#acroform-edit-default-value"),l=e.querySelector("#acroform-edit-default-checked"),a=!!e.querySelector("#acroform-edit-field-name-select")||!!e.querySelector("#acroform-edit-field-name");if(!t||!n||!r||!a||!c)return;const i=t.value.trim();if(!i)return;const f=et(e);if(!!e.querySelector("#acroform-edit-field-name-select")&&f===""){S(u("msg_field_name_required"),!0);return}const y=parseInt(((ee=t.dataset)==null?void 0:ee.fieldPage)??"1",10),_=n.value||"text";let A;if(o){const b=o.value.split(/[\s,]+/).map(Z=>parseFloat(Z.trim())),x=b[0]??0,j=b[1]??0,W=Math.max(0,b[2]??100),R=Math.max(0,b[3]??20);A=[x,j,x+W,j+R]}const I=_==="select"||_==="choice"?r.value.trim():"",g=I?I.split(/\n/).map(b=>{const x=b.indexOf("|");return x>=0?{value:b.slice(0,x).trim(),label:b.slice(x+1).trim()}:{value:b.trim(),label:b.trim()}}):[],U=_==="checkbox"&&l?l.checked?"1":"0":c.value,O=e.querySelector("#acroform-edit-font-size"),z=e.querySelector("#acroform-edit-font-family"),V=e.querySelector("#acroform-edit-font-auto-size"),G=O!=null&&O.value.trim()?parseInt(O.value,10):NaN,pe=((te=z==null?void 0:z.value)==null?void 0:te.trim())??"",K=(V==null?void 0:V.checked)??!1;d[i]||(d[i]={}),A&&(d[i].rect=A),d[i].page=y,d[i].controlType=_,d[i].options=g.length?g:void 0,f!==""&&(d[i].fieldName=f);const C=e.querySelector("#acroform-edit-max-len");if(C&&C.value.trim()!==""){const b=parseInt(C.value,10);!Number.isNaN(b)&&b>=0&&(d[i].maxLen=b)}const X=e.querySelector("#acroform-edit-hidden");X&&(d[i].hidden=X.checked);const Y=e.querySelector("#acroform-edit-create-if-missing");if(Y&&(d[i].createIfMissing=Y.checked),d[i].defaultValue=U,_==="text"||_==="textarea"){const x="sans-serif";d[i].fontSize=!Number.isNaN(G)&&G>0?G:11,d[i].fontFamily=pe||x,d[i].fontAutoSize=K}if(_==="checkbox"){const b=e.querySelector("#acroform-edit-checkbox-value-on"),x=e.querySelector("#acroform-edit-checkbox-value-off"),j=e.querySelector("#acroform-edit-checkbox-icon"),W=(b==null?void 0:b.value.trim())??"",R=(x==null?void 0:x.value.trim())??"",Z=((oe=j==null?void 0:j.value)==null?void 0:oe.trim())||"check";d[i].checkboxValueOn=W!==""?W:"1",d[i].checkboxValueOff=R!==""?R:"0",d[i].checkboxIcon=Z}M(),T(q.length?q:N(),d),P(),H()}const Ie=ae,ve=ie,Q=ne,Se=le,L=se,we=ce;h.documentKey&&(Q.value=h.documentKey);let d={},q=[],Oe=null,Me=0;function ot(){const e=[];return Object.keys(d).forEach(t=>{const o=d[t];if(!o||typeof o!="object")return;const n={fieldId:t};Array.isArray(o.rect)&&o.rect.length>=4&&(n.rect=o.rect),o.defaultValue!==void 0&&(n.defaultValue=String(o.defaultValue)),(o.hidden===!0||o.hidden==="true")&&(n.hidden=!0),o.fieldName!==void 0&&String(o.fieldName).trim()!==""&&(n.fieldName=String(o.fieldName).trim()),o.controlType!==void 0&&String(o.controlType)&&(n.controlType=String(o.controlType)),o.fieldType!==void 0&&String(o.fieldType)&&(n.fieldType=String(o.fieldType)),Array.isArray(o.options)&&o.options.length&&(n.options=o.options.map(r=>typeof r=="string"?{value:r,label:r}:r&&typeof r=="object"&&"value"in r?{value:String(r.value),label:r.label}:{value:"",label:""}).filter(r=>r.value!=="")),o.page!==void 0&&Number.isFinite(Number(o.page))&&(n.page=Number(o.page)),(o.createIfMissing===!0||o.createIfMissing==="true")&&(n.createIfMissing=!0),t.startsWith("new-")&&n.rect&&n.page&&(n.createIfMissing=!0),o.maxLen!==void 0&&Number.isFinite(Number(o.maxLen))&&(n.maxLen=Number(o.maxLen)),o.fontSize!==void 0&&Number.isFinite(Number(o.fontSize))&&(n.fontSize=Number(o.fontSize)),o.fontFamily!==void 0&&String(o.fontFamily).trim()!==""&&(n.fontFamily=String(o.fontFamily).trim()),e.push(n)}),e}function S(e,t){Ie.textContent=e,Ie.className="small mb-2 "+(t?"text-danger":"text-success")}function M(){ve.value=JSON.stringify(d,null,2)}function _e(){try{const e=(ve.value||"").trim(),t=e?JSON.parse(e):{};d=typeof t=="object"&&t!==null?t:{}}catch{return!1}return!0}function N(){const e=window;return e.__pdfSignableAcroFormFields&&Array.isArray(e.__pdfSignableAcroFormFields)&&e.__pdfSignableAcroFormFields.length?e.__pdfSignableAcroFormFields.map(t=>({id:t.id,rect:t.rect,width:t.width,height:t.height,fieldType:t.fieldType??"",value:t.value,page:t.page,subtype:t.subtype,flags:t.flags,fieldName:t.fieldName,maxLen:t.maxLen,fontSize:t.fontSize})):[]}function J(){const e={};return document.querySelectorAll(".acroform-field-input").forEach(t=>{var n;const o=(n=t.dataset)==null?void 0:n.fieldId;o!=null&&(e[o]=t.value??"")}),e}function ue(e,t,o){const n={};e.forEach(l=>{n[String(l.id)]=l});const r={};return new Set([...Object.keys(t||{}),...e.map(l=>String(l.id??""))]).forEach(l=>{const a=n[l]??{},i={id:a.id,rect:a.rect,width:a.width,height:a.height,fieldType:a.fieldType,value:a.value,page:a.page,subtype:a.subtype,flags:a.flags,fieldName:a.fieldName,maxLen:a.maxLen,fontSize:a.fontSize},f=t[l]??{};let p=o[l];p===void 0&&(p=f.defaultValue),p===void 0&&(p=a.value),r[l]={...i,...f,defaultValue:p}}),r}function P(){const e=window;e.__pdfSignableAcroFormOverrides=d,window.dispatchEvent(new CustomEvent("pdf-signable-acroform-overrides-updated",{detail:{overrides:d}}))}function xe(){const e=J();for(const t of Object.keys(e))d[t]||(d[t]={}),d[t].defaultValue=e[t]}function Te(e,t){d[e]||(d[e]={}),d[e].hidden=t,M(),T(q.length?q:N(),d),P()}function ke(e,t){const o=String(e.id??""),n=t.rect??e.rect,r=n&&n.length>=4?n:e.rect&&e.rect.length>=4?e.rect:[0,0,100,20],c=r[0],l=r[1],a=r[2],i=r[3],f=t.width??e.width??Math.max(0,a-c),p=t.height??e.height??Math.max(0,i-l),y=t.controlType??(e.fieldType==="Ch"?"choice":e.fieldType==="Btn"?"checkbox":"text"),A=(t.options??[]).map(w=>(w.value??"")+(w.label?"|"+w.label:"")).join(`
`),I=t.defaultValue??e.value??"",g=s.querySelector("#acroform-edit-modal");if(!g)return;const U=g.querySelector("#acroform-edit-field-id"),O=g.querySelector("#acroform-edit-rect"),z=g.querySelector("#acroform-edit-control-type"),V=g.querySelector("#acroform-edit-options"),G=g.querySelector("#acroform-edit-default-value"),pe=g.querySelector("#acroform-edit-default-checked");if(!U||!z||!V||!G)return;U.value=o,U.dataset.fieldPage=String(e.page??1);const K=t.fieldName??e.fieldName??o??"",C=g.querySelector("#acroform-edit-field-name-select"),X=g.querySelector("#acroform-edit-field-name");if(C){const w=g.querySelector("#acroform-edit-field-name-other");Array.from(C.options).map(nt=>nt.value).includes(K)?(C.value=K,w&&(w.value="")):(C.value=re,w&&(w.value=K))}else X&&(X.value=K);fe(g),z.value=y,O&&(O.value=[c.toFixed(1),l.toFixed(1),f.toFixed(1),p.toFixed(1)].join(", ")),V.value=A,G.value=y==="checkbox"?"":I,pe&&(pe.checked=/^(1|true|yes|on)$/i.test(I.trim()));const Y=g.querySelector("#acroform-edit-checkbox-value-on"),ee=g.querySelector("#acroform-edit-checkbox-value-off"),te=g.querySelector("#acroform-edit-checkbox-icon");if(Y&&(Y.value=t.checkboxValueOn??"1"),ee&&(ee.value=t.checkboxValueOff??"0"),te){const w=t.checkboxIcon||"check";te.value=w==="cross"||w==="dot"?w:"check"}const oe=g.querySelector("#acroform-edit-font-size"),b=g.querySelector("#acroform-edit-font-family"),x=g.querySelector("#acroform-edit-font-auto-size"),j=11,W="sans-serif";if(oe){const w=typeof t.fontSize=="number"&&t.fontSize>0?t.fontSize:j;oe.value=String(w)}b&&(b.value=typeof t.fontFamily=="string"&&t.fontFamily?t.fontFamily:W),x&&(x.checked=t.fontAutoSize===!0);const R=g.querySelector("#acroform-edit-max-len");if(R){const w=typeof t.maxLen=="number"&&t.maxLen>=0?t.maxLen:e.maxLen??void 0;R.value=w!=null?String(w):""}const Z=g.querySelector("#acroform-edit-hidden");Z&&(Z.checked=t.hidden===!0);const De=g.querySelector("#acroform-edit-create-if-missing");De&&(De.checked=t.createIfMissing===!0),Le(y),be(),ge(g),g.classList.add("show"),g.style.display="block",g.setAttribute("aria-hidden","false");const Ee=s.querySelector(".acroform-edit-modal-backdrop");Ee&&(Ee.classList.add("show"),Ee.style.display="block"),requestAnimationFrame(()=>ge(g))}function T(e,t){if(!e.length){Se.style.display="none";return}Se.style.display="block";const o=[...e].sort((a,i)=>{const f=Number(a.page??1),p=Number(i.page??1);if(f!==p)return f-p;const y=a.rect,_=i.rect;if(y&&_&&y.length>=4&&_.length>=4){const A=Math.max(y[1],y[3]);return Math.max(_[1],_[3])-A}return 0});q=o;const n=t??d,r=J(),c=o.map(a=>{const i=String(a.id??""),f=n[i]??{},p=!!f.hidden,y=r[i]??a.value??"",_=String(f.fieldName??a.fieldName??a.label??"-"),A=[u("list_field_name")+_,u("list_type")+(a.fieldType??"-"),u("list_page")+(a.page??"")];y!==void 0&&y!==""&&A.push(u("list_current_value")+y),f.defaultValue&&A.push("defaultValue: "+String(f.defaultValue));const I=a.page??1,g=p?`<button type="button" class="btn btn-sm btn-outline-success acroform-btn-icon py-0 px-1 acroform-btn-restore" data-field-id="${k(i)}" title="${k(u("btn_restore_title"))}">${Qe}</button>`:`<button type="button" class="btn btn-sm btn-outline-danger acroform-btn-icon py-0 px-1 acroform-btn-hide" data-field-id="${k(i)}" title="${k(u("btn_hide_title"))}">${Ze}</button>`,U=`<button type="button" class="btn btn-sm btn-outline-primary acroform-btn-icon py-0 px-1 acroform-btn-edit" data-field-id="${k(i)}" title="${k(u("btn_edit_title"))}">${We}</button>`,O=`<button type="button" class="btn btn-sm btn-outline-secondary acroform-btn-icon py-0 px-1 acroform-btn-move-resize" data-field-id="${k(i)}" data-page="${I}" title="${k(u("btn_move_resize_title"))}">${Xe}</button>`,z="acroform-list-row border-bottom pb-1 mb-1 d-flex justify-content-between align-items-center gap-2 "+(p?"text-muted bg-light":"cursor-pointer"),V=(A.join(" · ")||"-")+(p?u("list_hidden_suffix"):"");return`<div class="${z}" data-field-id="${k(i)}" data-page="${I}" role="button" tabindex="0" title="${k(u("row_click_highlight"))}"><span class="acroform-row-text flex-grow-1 text-truncate">${k(V)}</span><span class="acroform-row-actions d-flex gap-1 flex-shrink-0">${U}${O}${g}</span></div>`});L.innerHTML=c.join("")||'<span class="text-muted">'+k(u("list_no_fields"))+"</span>",L.querySelectorAll(".acroform-btn-hide").forEach(a=>{a.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),Te(String(i.currentTarget.dataset.fieldId||""),!0)})}),L.querySelectorAll(".acroform-btn-restore").forEach(a=>{a.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),Te(String(i.currentTarget.dataset.fieldId||""),!1)})}),L.querySelectorAll(".acroform-btn-edit").forEach(a=>{a.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),rt(),Fe(void 0);const f=i.currentTarget.dataset.fieldId||"",p=e.find(y=>String(y.id)===f);p&&ke(p,n[f]??{})})}),L.querySelectorAll(".acroform-btn-move-resize").forEach(a=>{a.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),H();const f=i.currentTarget,p=f.dataset.fieldId||"",y=f.dataset.page||"1";window.__pdfSignableAcroFormMoveResizeFieldId=p,window.dispatchEvent(new CustomEvent("pdf-signable-acroform-move-resize",{detail:{fieldId:p,page:y}})),me(p,y),Fe(p)})}),Fe(window.__pdfSignableAcroFormMoveResizeFieldId)}function rt(){window.__pdfSignableAcroFormMoveResizeFieldId=void 0,window.dispatchEvent(new CustomEvent("pdf-signable-acroform-move-resize-close"))}function Fe(e){L.querySelectorAll(".acroform-list-row").forEach(t=>{const o=t;e!=null&&o.dataset.fieldId===e?o.classList.add("acroform-list-row--move-resize"):o.classList.remove("acroform-list-row--move-resize")})}function me(e,t){const r=(s.closest(".nowo-pdf-signable-widget")??document).querySelectorAll(".acroform-field-outline");let c=null;for(let l=0;l<r.length;l++){const a=r[l];if(a.classList.remove("acroform-field-outline--highlight"),a.dataset.fieldId===e){const i=a.closest(".pdf-page-wrapper");(i==null?void 0:i.getAttribute("data-page"))===t&&(c=a)}}if(c!==null){const l=c;l.classList.add("acroform-field-outline--highlight");const a=l.closest(".pdf-page-wrapper");a&&a.scrollIntoView({behavior:"smooth",block:"center"})}}L.addEventListener("click",e=>{const t=e.target;if(t.closest("button")||t.closest(".acroform-row-actions"))return;const o=t.closest(".acroform-list-row");if(!o)return;const n=String(o.dataset.fieldId??""),r=String(o.dataset.page??"1");if(me(n,r),window.__pdfSignableAcroFormMoveResizeFieldId)return;const a=(q.length?q:N()).find(i=>String(i.id)===n);a&&ke(a,d[n]??{})}),L.addEventListener("keydown",e=>{if(e.key!=="Enter"&&e.key!==" ")return;const t=e.target;if(t.closest("button")||t.closest(".acroform-row-actions"))return;const o=t.closest(".acroform-list-row");o&&(e.preventDefault(),me(String(o.dataset.fieldId??""),String(o.dataset.page??"1")))}),window.addEventListener("pdf-signable-acroform-field-focused",(e=>{const t=e.detail??{},o=t.fieldId,n=t.page!=null?String(t.page):"1";o&&(me(o,n),L.querySelectorAll(".acroform-list-row").forEach(r=>{const c=r;c.dataset.fieldId===o?(c.classList.add("acroform-list-row--focused"),c.scrollIntoView({behavior:"smooth",block:"nearest"})):c.classList.remove("acroform-list-row--focused")}))}));function ze(){const e=document.querySelector(".pdf-url-input");return((e==null?void 0:e.value)??"").trim()}function Ve(e){const t=new Uint8Array(e),o=8192;let n="";for(let r=0;r<t.length;r+=o){const c=t.subarray(r,Math.min(r+o,t.length));n+=String.fromCharCode.apply(null,c)}return btoa(n)}function Ce(){const e=(Q.value??"").trim();if(!e){S(u("msg_enter_document_key"),!0);return}const t=ze();if(!t){S(u("msg_load_pdf_first_load"),!0);return}const o=N(),n={document_key:e,pdf_url:t};o.length&&(n.fields=o),we.disabled=!0,fetch(h.loadUrl,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(n)}).then(r=>r.ok?r.json():r.json().then(c=>{throw new Error(c.error??r.statusText)})).then(r=>{var l;r.fields_extractor_error&&S(r.fields_extractor_error,!0);const c=(l=r.fields)!=null&&l.length?r.fields:N();if(d=ue(c,r.overrides??{},J()),M(),T(c,d),!r.fields_extractor_error){const a=r.overrides&&Object.keys(r.overrides).length>0;S(a?u("msg_draft_loaded",{count:String(c.length)}):u("msg_no_data_server",{count:String(c.length)}),!1)}P()}).catch(r=>S(u("error_prefix")+r.message,!0)).finally(()=>{we.disabled=!1})}we.addEventListener("click",Ce),$.addEventListener("click",()=>{const e=(Q.value??"").trim();if(!e){S(u("msg_enter_document_key"),!0);return}if(!_e()){S(u("msg_invalid_json"),!0);return}xe();const t=N(),o={document_key:e,overrides:ue(t,d,J()),...t.length?{fields:t}:{}};$.disabled=!0,fetch(h.postUrl,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(o)}).then(n=>n.ok?n.json():n.json().then(r=>{throw new Error(r.error??n.statusText)})).then(()=>{S(u("msg_draft_saved"),!1),P()}).catch(n=>S(u("error_prefix")+n.message,!0)).finally(()=>{$.disabled=!1})}),B.addEventListener("click",()=>{d={},M(),L.innerHTML="",Se.style.display="none",S(u("msg_draft_cleared"),!1),P()});let je=null;if(h.applyUrl){const e=document.createElement("button");e.id="acroform-apply-btn",e.type="button",e.className="btn btn-sm btn-outline-info",e.textContent=u("btn_apply_pdf"),e.title=u("btn_apply_pdf_title"),B.after(e),je=e,e.addEventListener("click",()=>{const t=ze();if(!t){S(u("msg_apply_pdf_first"),!0);return}xe();const o=ot();e.setAttribute("disabled","");const n=c=>(h.debug&&console.debug("[AcroForm apply] request",{validateOnly:c,patchesCount:o.length,fieldIds:o.map(l=>l.fieldId)}),fetch(t,{method:"GET",headers:{Accept:"application/pdf,*/*"}}).then(l=>{if(!l.ok)throw new Error(`Failed to load PDF: ${l.status}`);return l.arrayBuffer()}).then(l=>{const a={pdf_content:Ve(l),patches:o};return c&&(a.validate_only=!0),fetch(h.applyUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}).then(l=>{const i=(l.headers.get("Content-Type")??"").includes("application/json");return l.ok?c&&i?l.json().then(f=>{if(h.debug&&console.debug("[AcroForm apply] response (validate_only)",f),f.success!==!0)throw new Error(f.error??"Validation failed");return null}):l.blob().then(f=>{const p=f.arrayBuffer();return h.debug&&p.then(y=>{console.debug("[AcroForm apply] response (PDF)",{contentType:l.headers.get("Content-Type"),size:y.byteLength,ok:l.ok})}),p}):l.json().then(f=>{const p=f.error??l.statusText,y=f.detail?`
${f.detail}`:"";throw new Error(p+y)})}));(h.debug?n(!0).then(()=>n(!1)):n(!1)).then(c=>{if(c){Oe=c,S(u("msg_pdf_modified_received"),!1);const l=document.createElement("a");l.href=URL.createObjectURL(new Blob([c],{type:"application/pdf"})),l.download=u("download_filename"),l.click(),URL.revokeObjectURL(l.href)}}).catch(c=>S(u("error_prefix")+c.message,!0)).finally(()=>e.removeAttribute("disabled"))})}if(h.processUrl){const e=document.createElement("button");e.type="button",e.className="btn btn-sm btn-info",e.textContent=u("btn_process"),e.title=u("btn_process_title"),(je??B).after(e),e.addEventListener("click",()=>{const t=Oe;if(!t||t.byteLength===0){S(u("msg_process_first"),!0);return}const o=Ve(t),n=(Q.value??"").trim();e.setAttribute("disabled",""),fetch(h.processUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pdf_content:o,document_key:n||void 0})}).then(r=>r.ok?r.json():r.json().then(c=>{throw new Error(c.error??c.detail??r.statusText)})).then(r=>{S(r.success!==!1?u("msg_process_success"):u("msg_processed"),!1)}).catch(r=>S(u("error_prefix")+r.message,!0)).finally(()=>e.removeAttribute("disabled"))})}de&&de.addEventListener("click",()=>{const e=N();if(!e.length){S(u("msg_refresh_load_first"),!0);return}_e(),xe(),d=ue(e,d,J()),M(),T(e,d),S(u("msg_draft_updated"),!1)}),ve.addEventListener("blur",()=>{if(_e()){const e=q.length?q:N();d=ue(e,d,J()),M(),T(e,d)}});let Be=!1;window.addEventListener("pdf-signable-acroform-fields-updated",()=>{const e=(Q.value??"").trim(),t=N();t.length&&(T(t,d),e&&!Be&&(Be=!0,Ce()))}),window.addEventListener("pdf-signable-acroform-move-resize-opened",()=>{H()}),window.addEventListener("pdf-signable-acroform-rect-changed",(e=>{const{fieldId:t,rect:o}=e.detail??{};!t||!Array.isArray(o)||o.length<4||(d[t]||(d[t]={}),d[t].rect=o,M(),T(q.length?q:N(),d),P())})),window.addEventListener("pdf-signable-acroform-add-field-place",(e=>{const t=e.detail??{},{page:o,llx:n,lly:r,width:c=100,height:l=20}=t;if(typeof o!="number"||typeof n!="number"||typeof r!="number")return;Me+=1;const a="new-"+Date.now(),i=n+c,f=r+l,p=u("new_field_name_pattern").replace(/%n/g,String(Me));d[a]={page:o,rect:[n,r,i,f],controlType:"text",defaultValue:"",fieldName:p},M(),P();const y={id:a,page:o,rect:[n,r,i,f],width:c,height:l,fieldType:"Tx",value:""};setTimeout(()=>{T(N(),d)},150),window.__pdfSignableAcroFormMoveResizeFieldId||ke(y,d[a])}))}const Ne=document.getElementById("acroform-editor-root");Ne&&Ye(Ne)})();
