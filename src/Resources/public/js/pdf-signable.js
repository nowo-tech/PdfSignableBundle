(function(){"use strict";const Me={pt:1,mm:.35277777777777775,cm:.035277777777777776,in:.013888888888888888,px:1.3333333333333333};function D(b,G){return b*(Me[G]??1)}function H(b,G){return b/(Me[G]??1)}function $e(b){return String(b).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const Ue=220,ze=37,Ve=65,je=48;function Ke(b,G,L){b=b%360,b<0&&(b+=360);const v=G/100,$=L/100,U=(1-Math.abs(2*$-1))*v,V=U*(1-Math.abs(b/60%2-1)),ge=$-U/2;let P=0,le=0,ce=0;b<60?(P=U,le=V):b<120?(P=V,le=U):b<180?(le=U,ce=V):b<240?(le=V,ce=U):b<300?(P=V,ce=U):(P=U,ce=V);const J=Q=>{const ie=Math.round((Q+ge)*255);return(ie<16?"0":"")+Math.min(255,Math.max(0,ie)).toString(16)};return"#"+J(P)+J(le)+J(ce)}function Ge(b){const G=(Ue+b*ze)%360,L=Ke(G,Ve,je),v=parseInt(L.slice(1,3),16),$=parseInt(L.slice(3,5),16),U=parseInt(L.slice(5,7),16);return{border:L,background:`rgba(${v}, ${$}, ${U}, 0.15)`,color:L,handle:L}}function Je(){console.log("[PdfSignable] Script loaded");const b=window.NowoPdfSignableConfig;if(!b){console.warn("[PdfSignable] NowoPdfSignableConfig not found, skipping init");return}const{proxyUrl:G,strings:L}=b,v=document.querySelector(".nowo-pdf-signable-widget"),$=v==null?void 0:v.closest("form");if(!$){console.warn("[PdfSignable] .nowo-pdf-signable-widget or form not found, skipping init");return}const U=(v==null?void 0:v.dataset.preventBoxOverlap)==="1",V=(v==null?void 0:v.dataset.enableRotation)==="1";let ge={};try{const e=(v==null?void 0:v.dataset.boxDefaultsByName)??"{}";ge=typeof e=="string"?JSON.parse(e):{}}catch{ge={}}const P=Math.max(0,parseFloat((v==null?void 0:v.dataset.snapGrid)??"0")||0),le=(v==null?void 0:v.dataset.snapToBoxes)==="1",ce=10;console.log("[PdfSignable] Initialized");const J=$.querySelector(".pdf-url-input"),Q=document.getElementById("loadPdfBtn"),ie=document.getElementById("pdf-placeholder"),Le=document.getElementById("pdf-canvas-wrapper"),Ie=document.getElementById("signature-boxes-list"),ne=document.getElementById("addBoxBtn"),he=$.querySelector(".unit-selector"),ye=$.querySelector(".origin-selector"),m=document.getElementById("pdf-viewer-container");if(!Le||!Ie)return;const q=Le,y=Ie;let ue=1,oe={x:0,y:0},S=null;const Qe=80;function Ze(){if(!F||!m)return;const e=m.querySelector("#pdf-thumbnails-strip"),t=m.querySelector(".pdf-viewer-scroll");!e||!t||(async()=>{for(let s=1;s<=F.numPages;s++){const o=await F.getPage(s),r=o.getViewport({scale:1}),a=Qe/r.width,u=o.getViewport({scale:a}),c=document.createElement("canvas");c.width=u.width,c.height=u.height;const i=c.getContext("2d");if(!i)continue;await o.render({canvasContext:i,viewport:u}).promise;const l=document.createElement("button");l.type="button",l.className="pdf-thumb",l.dataset.page=String(s),l.setAttribute("aria-label","Page "+s),l.appendChild(c),l.addEventListener("click",()=>{const d=q.querySelector('.pdf-page-wrapper[data-page="'+s+'"]');d&&(d.scrollIntoView({behavior:"smooth",block:"start"}),e.querySelectorAll(".pdf-thumb.current").forEach(p=>p.classList.remove("current")),l.classList.add("current"))}),e.appendChild(l)}const n=()=>{const s=e,o=q.querySelectorAll(".pdf-page-wrapper");if(o.length===0)return;const r=t.getBoundingClientRect(),a=r.top+r.height/2;let u=1,c=1/0;o.forEach(l=>{const d=parseInt(l.dataset.page??"1",10),p=l.getBoundingClientRect(),g=p.top+p.height/2,f=Math.abs(g-a);f<c&&(c=f,u=d)}),s.querySelectorAll(".pdf-thumb.current").forEach(l=>l.classList.remove("current"));const i=s.querySelector('.pdf-thumb[data-page="'+u+'"]');i&&i.classList.add("current")};t.addEventListener("scroll",n),requestAnimationFrame(n),e.firstElementChild&&e.firstElementChild.classList.add("current")})()}function et(){S||!m||(S=document.createElement("div"),S.id="pdf-touch-wrapper",S.style.transformOrigin="0 0",S.style.transform=`translate(${oe.x}px, ${oe.y}px) scale(${ue})`,m.insertBefore(S,q),S.appendChild(q),tt())}function tt(){if(!S)return;let e=0,t=1,n={x:0,y:0},s=0,o=0;S.addEventListener("touchstart",r=>{if(r.touches.length===2){r.preventDefault();const a=r.touches[0],u=r.touches[1];e=Math.hypot(u.clientX-a.clientX,u.clientY-a.clientY),t=ue,n={...oe},s=(a.clientX+u.clientX)/2,o=(a.clientY+u.clientY)/2}},{passive:!1}),S.addEventListener("touchmove",r=>{if(r.touches.length===2&&S){r.preventDefault();const a=r.touches[0],u=r.touches[1],c=Math.hypot(u.clientX-a.clientX,u.clientY-a.clientY),i=Math.max(.25,Math.min(4,t*c/e)),l=(a.clientX+u.clientX)/2,d=(a.clientY+u.clientY)/2;oe.x=n.x+(l-s),oe.y=n.y+(d-o),ue=i,S.style.transform=`translate(${oe.x}px, ${oe.y}px) scale(${ue})`}},{passive:!1})}function Z(){return(he==null?void 0:he.value)??"mm"}function me(){return(ye==null?void 0:ye.value)??"bottom_left"}function Ee(e,t,n,s,o,r){const a=e.scale||1.5,u=e.width/a,c=e.height/a;let i,l;switch(r){case"top_left":i=t,l=c-n-o;break;case"top_right":i=u-t-s,l=c-n-o;break;case"bottom_right":i=u-t-s,l=n;break;default:i=t,l=n;break}return{vpX:i*a,vpY:e.height-(l+o)*a}}function Pe(e,t,n,s,o,r){const a=e.scale||1.5,u=e.width/a,c=e.height/a,i=e.convertToPdfPoint(t,n+o*a),l=i[0],d=i[1];let p,g;switch(r){case"top_left":p=l,g=c-d-o;break;case"top_right":p=u-l-s,g=c-d-o;break;case"bottom_right":p=u-l-s,g=d;break;default:p=l,g=d;break}return{xPt:p,yPt:g}}let F=null;const R={};let se=null,qe=!1;function nt(e){try{return new URL(e,window.location.origin).origin===window.location.origin?e:G+"?url="+encodeURIComponent(e)}catch{return G+"?url="+encodeURIComponent(e)}}function ot(){if(!m||!S||m.querySelector(".pdf-viewer-scroll"))return;const t=document.createElement("div");t.id="pdf-thumbnails-strip",t.setAttribute("aria-label","Page thumbnails");const n=document.createElement("div");n.className="pdf-viewer-scroll",n.appendChild(S),m.appendChild(n),m.insertBefore(t,n)}async function Be(){if(!F||!m)return 1.5;const t=(await F.getPage(1)).getViewport({scale:1}),n=m.querySelector(".pdf-viewer-scroll"),s=n?n.clientWidth-24:m.clientWidth-24,o=Math.max(0,s);return o<=0?1.5:Math.max(.5,o/t.width)}async function _e(){var r;const e=((r=J==null?void 0:J.value)==null?void 0:r.trim())??"";if(!e){console.warn("[PdfSignable] Load PDF: URL required"),alert(L.alert_url_required);return}const t=nt(e);console.log("[PdfSignable] Loading PDF",{url:e,viaProxy:t!==e}),Q&&(Q.setAttribute("disabled",""),Q.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> '+L.loading_state),ie&&(ie.style.display="block"),q.style.display="none",q.innerHTML="";const n=m==null?void 0:m.querySelector("#pdf-thumbnails-strip"),s=m==null?void 0:m.querySelector(".pdf-viewer-scroll");s&&S&&S.parentElement===s&&(s.removeChild(S),m==null||m.appendChild(S)),n==null||n.remove(),s==null||s.remove(),ue=1,oe={x:0,y:0},S&&(S.style.transform="translate(0px, 0px) scale(1)");const o=document.createElement("div");o.className="pdf-signable-loading-overlay",o.setAttribute("aria-live","polite"),o.setAttribute("aria-busy","true"),o.innerHTML='<div class="text-center"><div class="spinner-border text-primary mb-2" role="status"><span class="visually-hidden">'+L.loading_state+'</span></div><p class="text-muted small mb-0">'+L.loading_state+"</p></div>",m&&m.appendChild(o);try{F=await pdfjsLib.getDocument(t).promise,Object.keys(R).forEach(c=>delete R[Number(c)]),et(),ot();const a=await Be();for(let c=1;c<=F.numPages;c++){se&&await se;const i=await F.getPage(c),l=i.getViewport({scale:a});R[c]=l;const d=document.createElement("div");d.className="pdf-page-wrapper",d.dataset.page=String(c);const p=document.createElement("canvas"),g=p.getContext("2d");if(!g)continue;p.height=l.height,p.width=l.width,p.dataset.page=String(c);const f=document.createElement("div");f.className="signature-overlays",d.appendChild(p),d.appendChild(f),se=i.render({canvasContext:g,viewport:l}).promise,await se,q.appendChild(d)}ie&&(ie.style.display="none"),q.style.display="block",Ze(),requestAnimationFrame(()=>{A(),setTimeout(A,100),setTimeout(A,350),setTimeout(A,700)}),console.log("[PdfSignable] PDF loaded",{pages:F.numPages,scale:a})}catch(a){console.error("[PdfSignable] PDF load failed",a),alert(L.error_load_pdf+(a instanceof Error?a.message:String(a)))}finally{o.remove(),Q&&(Q.removeAttribute("disabled"),Q.innerHTML=L.load_pdf_btn)}}function A(){if(qe||Object.keys(R).length===0)return;const e=Z(),t=me();q.querySelectorAll(".signature-overlays").forEach(a=>{a.innerHTML=""});const n=y.querySelectorAll(":scope > .signature-box-item"),s={},o={};let r=0;if(n.forEach((a,u)=>{var re,de,fe,X,pe;const c=parseInt(((re=a.querySelector(".signature-box-page"))==null?void 0:re.value)??"1",10),i=parseFloat(((de=a.querySelector(".signature-box-x"))==null?void 0:de.value)??"0"),l=parseFloat(((fe=a.querySelector(".signature-box-y"))==null?void 0:fe.value)??"0"),d=parseFloat(((X=a.querySelector(".signature-box-width"))==null?void 0:X.value)??"150"),p=parseFloat(((pe=a.querySelector(".signature-box-height"))==null?void 0:pe.value)??"40"),g=a.querySelector(".signature-box-angle"),f=V&&g?parseFloat(g.value??"0"):0,T=a.querySelector(".signature-box-name"),w=((T==null?void 0:T.value)??"").trim(),B=w===""?"__empty__":w;B in o||(o[B]=r++);const te=o[B];s[w]=(s[w]??0)+1;const Y=s[w],_=w===""?"":w+(Y>1?` (${Y})`:""),j=q.querySelector(`.pdf-page-wrapper[data-page="${c}"] .signature-overlays`),k=R[c];if(!j||!k)return;const K=k.scale||1.5,O=H(i,e),N=H(l,e),z=H(d,e),M=H(p,e),C=Ee(k,O,N,z,M,t),E=z*K,x=M*K,h=document.createElement("div");h.className="signature-box-overlay",h.dataset.boxIndex=String(u),h.style.left=C.vpX+"px",h.style.top=C.vpY+"px",h.style.width=Math.max(E,20)+"px",h.style.height=Math.max(x,14)+"px";const W=Ge(te);h.style.borderColor=W.border,h.style.backgroundColor=W.background,h.style.color=W.color,h.style.setProperty("--box-color",W.handle),h.style.transformOrigin="50% 50%",V&&(h.style.transform=`rotate(${f}deg)`);const ae=V?'<span class="rotate-handle" title="Rotate"></span>':"";h.innerHTML=(_?'<span class="overlay-label">'+$e(_)+"</span>":"")+ae+'<span class="resize-handle nw" data-handle="nw"></span><span class="resize-handle ne" data-handle="ne"></span><span class="resize-handle sw" data-handle="sw"></span><span class="resize-handle se" data-handle="se"></span>',j.appendChild(h)}),ee!==null){const a=q.querySelector(`.signature-box-overlay[data-box-index="${ee}"]`);a&&a.classList.add("selected")}}function Ce(){const e=y.dataset.maxEntries??(ne==null?void 0:ne.dataset.maxEntries)??"";if(e==="")return null;const t=parseInt(e,10);return Number.isNaN(t)?null:t}function xe(){if(!ne)return;const e=Ce(),t=y.querySelectorAll(":scope > .signature-box-item").length;e!==null&&t>=e?ne.style.display="none":ne.style.display=""}function we(e,t,n,s,o){const r=Ce(),a=y.querySelectorAll(":scope > .signature-box-item").length;if(r!==null&&a>=r){console.log("[PdfSignable] Box add skipped: max_entries reached",{max:r,currentCount:a});return}const u=s??150,c=o??40,i=document.getElementById("signature-boxes-empty");i&&i.classList.add("d-none");const l=y.dataset.prototype??"",d=y.querySelectorAll(":scope > .signature-box-item").length,p=l.replace(/__name__/g,String(d)),g=document.createElement("div");g.innerHTML=p;const f=g.firstElementChild;if(!f)return;f.dataset.index=String(d);const T=f.querySelector(".signature-box-page");T&&(T.value=String(e));const w=R[e],B=Z(),te=me(),Y=u,_=c,j=w?w.scale:1.5,k=w?w.width/j:595,K=w?w.height/j:842;let O,N;switch(te){case"top_left":O=t,N=K-n-_;break;case"top_right":O=k-t-Y,N=K-n-_;break;case"bottom_right":O=k-t-Y,N=n;break;default:O=t,N=n;break}const z=E=>Math.round(E*100)/100,M=f.querySelector(".signature-box-name");for(const E of["x","y","width","height"]){const x=f.querySelector(".signature-box-"+E);x&&(E==="x"?x.value=String(z(D(O,B))):E==="y"?x.value=String(z(D(N,B))):E==="width"?x.value=String(z(D(Y,B))):E==="height"&&(x.value=String(z(D(_,B)))))}const C=f.querySelector(".signature-box-angle");C&&(C.value="0"),M&&(M.value=L.default_box_name),y.appendChild(f),f.scrollIntoView({behavior:"smooth"}),A(),xe(),console.log("[PdfSignable] Box added",{page:e,x:O,y:N,width:u,height:c,unit:B})}Q&&Q.addEventListener("click",()=>_e());const Fe=document.getElementById("unitBadge"),st={pt:"pt",mm:"mm",cm:"cm",px:"px",in:"in"};function Ae(){Fe&&(Fe.textContent=st[Z()]??Z())}Ae();let Te=Z();if(he&&he.addEventListener("change",()=>{const e=Te,t=Z();Ae(),y.querySelectorAll(":scope > .signature-box-item").forEach(n=>{for(const s of["x","y","width","height"]){const o=n.querySelector(".signature-box-"+s);if(o!=null&&o.value){const r=parseFloat(o.value);o.value=String(Math.round(D(H(r,e),t)*100)/100)}}}),Te=t,A()}),y.addEventListener("input",A),y.addEventListener("change",e=>{const t=e.target.closest(".signature-box-item"),n=t==null?void 0:t.querySelector(".signature-box-name");if(n&&e.target===n&&Object.keys(ge).length>0){const s=(n.value??"").trim(),o=s?ge[s]:null;if(o){const r=(a,u)=>{const c=t==null?void 0:t.querySelector(".signature-box-"+a);c&&u!==void 0&&(c.value=String(u))};r("width",o.width),r("height",o.height),r("x",o.x),r("y",o.y),r("angle",o.angle)}}A()}),ye&&ye.addEventListener("change",A),y.addEventListener("click",e=>{if(!e.target.closest(".remove-box"))return;const t=e.target.closest(".signature-box-item");if(t){let n=t;for(;n!=null&&n.parentElement&&n.parentElement!==y;)n=n.parentElement;if(n){const s=Array.from(y.querySelectorAll(":scope > .signature-box-item")).indexOf(n);n.remove(),console.log("[PdfSignable] Box removed",{index:s})}}if(y.querySelectorAll(":scope > .signature-box-item").length===0){const n=document.getElementById("signature-boxes-empty");n&&n.classList.remove("d-none")}A(),xe()}),m){let e,t=!1,n=0;new ResizeObserver(()=>{if(t)return;const o=(m==null?void 0:m.clientWidth)??0;Math.abs(o-n)<10||(n=o,clearTimeout(e),e=setTimeout(async()=>{if(!(!F||q.style.display==="none")&&!t){t=!0;try{const r=await Be();q.innerHTML="",Object.keys(R).forEach(a=>delete R[Number(a)]);for(let a=1;a<=F.numPages;a++){se&&await se;const u=await F.getPage(a),c=u.getViewport({scale:r});R[a]=c;const i=document.createElement("div");i.className="pdf-page-wrapper",i.dataset.page=String(a);const l=document.createElement("canvas"),d=l.getContext("2d");if(!d)continue;l.height=c.height,l.width=c.width,l.dataset.page=String(a);const p=document.createElement("div");p.className="signature-overlays",i.appendChild(l),i.appendChild(p),se=u.render({canvasContext:d,viewport:c}).promise,await se,q.appendChild(i)}A(),m&&(n=m.clientWidth)}finally{t=!1}}},200))}).observe(m)}function ke(){var e;(e=J==null?void 0:J.value)!=null&&e.trim()&&(console.log("[PdfSignable] Auto-loading PDF (preset URL)"),_e())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ke):ke(),q.addEventListener("click",e=>{if(e.target.closest(".signature-box-overlay"))return;ve(null);const t=e.target.closest(".pdf-page-wrapper"),n=t==null?void 0:t.querySelector("canvas");if(!n||!F)return;const s=parseInt(n.dataset.page??"1",10),o=R[s];if(!o)return;const r=n.getBoundingClientRect(),a=n.width/r.width,u=n.height/r.height,c=(e.clientX-r.left)*a,i=(e.clientY-r.top)*u,l=40,d=l*(o.scale||1.5),p=o.convertToPdfPoint(c,i+d);we(s,p[0],p[1],150,l)});function at(e,t){if(e.page!==t.page)return!1;const n=e.x+e.w,s=t.x+t.w,o=e.y+e.h,r=t.y+t.h;return e.x<s&&t.x<n&&e.y<r&&t.y<o}function Oe(){const e=y.querySelectorAll(":scope > .signature-box-item"),t=[];return e.forEach(n=>{var i,l,d,p;const s=n.querySelector(".signature-box-page"),o=parseInt((s==null?void 0:s.value)??"1",10),r=parseFloat(((i=n.querySelector(".signature-box-x"))==null?void 0:i.value)??"0"),a=parseFloat(((l=n.querySelector(".signature-box-y"))==null?void 0:l.value)??"0"),u=parseFloat(((d=n.querySelector(".signature-box-width"))==null?void 0:d.value)??"150"),c=parseFloat(((p=n.querySelector(".signature-box-height"))==null?void 0:p.value)??"40");t.push({page:o,x:r,y:a,w:u,h:c})}),t}function rt(e,t){const n=R[e];if(!n)return[];const s=Z(),o=me(),r=n.scale||1.5,a=Oe(),u=[];return a.forEach((c,i)=>{if(i===t||c.page!==e)return;const l=H(c.x,s),d=H(c.y,s),p=H(c.w,s),g=H(c.h,s),{vpX:f,vpY:T}=Ee(n,l,d,p,g,o);u.push({left:f,top:T,right:f+p*r,bottom:T+g*r})}),u}let I=null,ee=null;function ve(e){if(ee=e,q.querySelectorAll(".signature-box-overlay.selected").forEach(t=>t.classList.remove("selected")),e!==null){const t=q.querySelector(`.signature-box-overlay[data-box-index="${e}"]`);t&&t.classList.add("selected")}}let be=null;function Xe(e){if(!be)return;const{overlay:t,item:n,centerX:s,centerY:o,startAngle:r,startMouseAngle:a}=be;let c=(Math.atan2(e.clientY-o,e.clientX-s)-a)*180/Math.PI,i=r+c;for(;i>180;)i-=360;for(;i<-180;)i+=360;const l=n.querySelector(".signature-box-angle");l&&(l.value=String(Math.round(i*100)/100)),t.style.transform=`rotate(${i}deg)`}function De(){be&&(document.removeEventListener("mousemove",Xe),document.removeEventListener("mouseup",De),be=null)}function lt(e){var B,te;const t=e.target.closest(".signature-box-overlay");if(!((B=t==null?void 0:t.dataset)!=null&&B.boxIndex))return;e.preventDefault(),e.stopPropagation();const n=e.target.closest(".rotate-handle");if(V&&n){const Y=parseInt(t.dataset.boxIndex,10),_=y.querySelectorAll(":scope > .signature-box-item")[Y];if(!_)return;const j=_.querySelector(".signature-box-angle");if(!j)return;const k=t.getBoundingClientRect(),K=k.left+k.width/2,O=k.top+k.height/2,N=parseFloat(j.value)||0,z=Math.atan2(e.clientY-O,e.clientX-K);be={overlay:t,item:_,centerX:K,centerY:O,startAngle:N,startMouseAngle:z},document.addEventListener("mousemove",Xe),document.addEventListener("mouseup",De);return}const s=e.target.closest(".resize-handle"),o=parseInt(t.dataset.boxIndex,10),r=y.querySelectorAll(":scope > .signature-box-item")[o];if(!r)return;const a=t.closest(".pdf-page-wrapper"),u=parseInt(((te=a==null?void 0:a.dataset)==null?void 0:te.page)??"1",10),c=R[u];if(!c)return;const i=parseFloat(t.style.width)||20,l=parseFloat(t.style.height)||14,d=parseFloat(t.style.left)||0,p=parseFloat(t.style.top)||0,g=r.querySelector(".signature-box-x"),f=r.querySelector(".signature-box-y"),T=r.querySelector(".signature-box-width"),w=r.querySelector(".signature-box-height");I={mode:s?"resize":"move",handle:s?s.dataset.handle??null:null,overlay:t,item:r,boxIndex:o,viewport:c,startX:e.clientX,startY:e.clientY,startLeft:d,startTop:p,startRight:d+i,startBottom:p+l,startFormX:g&&parseFloat(g.value)||0,startFormY:f&&parseFloat(f.value)||0,startFormW:T&&parseFloat(T.value)||150,startFormH:w&&parseFloat(w.value)||40},t.classList.add("dragging"),qe=!0,I.mode==="move"&&ve(o),document.addEventListener("mousemove",He),document.addEventListener("mouseup",Re)}function He(e){var N,z;if(!I)return;const{overlay:t,viewport:n,startLeft:s,startTop:o,startRight:r,startBottom:a}=I,u=(e.clientX-I.startX)/ue,c=(e.clientY-I.startY)/ue,i=20;let l,d,p,g;if(I.mode==="move")l=Math.max(0,Math.min(n.width-(r-s),s+u)),d=Math.max(0,Math.min(n.height-(a-o),o+c)),p=r-s,g=a-o;else{const M=I.handle;let C=s,E=o,x=r,h=a;M==="se"?(x=Math.min(n.width,Math.max(s+i,r+u)),h=Math.min(n.height,Math.max(o+i,a+c))):M==="sw"?(C=Math.max(0,Math.min(r-i,s+u)),h=Math.min(n.height,Math.max(o+i,a+c))):M==="ne"?(x=Math.min(n.width,Math.max(s+i,r+u)),E=Math.max(0,Math.min(a-i,o+c))):M==="nw"&&(C=Math.max(0,Math.min(r-i,s+u)),E=Math.max(0,Math.min(a-i,o+c))),l=C,d=E,p=x-C,g=h-E}const f=n.scale||1.5,T=parseInt(((z=(N=t.closest(".pdf-page-wrapper"))==null?void 0:N.dataset)==null?void 0:z.page)??"1",10);if(P>0){const M=p/f,C=g/f,E=Pe(n,l,d,M,C,me()),x=Z();let h=D(E.xPt,x),W=D(E.yPt,x),ae=D(M,x),re=D(C,x);h=Math.round(h/P)*P,W=Math.round(W/P)*P,ae=Math.round(ae/P)*P,re=Math.max(P,Math.round(re/P)*P);const de=H(h,x),fe=H(W,x),X=H(ae,x),pe=H(re,x),Se=Ee(n,de,fe,X,pe,me());l=Se.vpX,d=Se.vpY,p=X*f,g=pe*f}if(le){const M=rt(T,I.boxIndex),C=l+p,E=d+g,x=M.flatMap(X=>[X.left,X.right]),h=M.flatMap(X=>[X.top,X.bottom]),W=(X,pe)=>{let Se=X,Ye=ce;for(const Ne of pe){const We=Math.abs(X-Ne);We<Ye&&(Ye=We,Se=Ne)}return Se},ae=W(l,x),re=W(C,x),de=W(d,h),fe=W(E,h);l=ae,d=de,p=Math.max(i,re-ae),g=Math.max(i,fe-de)}t.style.left=l+"px",t.style.top=d+"px",t.style.width=p+"px",t.style.height=g+"px";const w=p/f,B=g/f,te=Pe(n,l,d,w,B,me()),Y=Z(),_=M=>Math.round(M*100)/100,j=I.item.querySelector(".signature-box-x"),k=I.item.querySelector(".signature-box-y"),K=I.item.querySelector(".signature-box-width"),O=I.item.querySelector(".signature-box-height");j&&(j.value=String(_(D(te.xPt,Y)))),k&&(k.value=String(_(D(te.yPt,Y)))),K&&(K.value=String(_(D(w,Y)))),O&&(O.value=String(_(D(B,Y))))}function Re(){if(!I)return;const e=I;if(I.overlay.classList.remove("dragging"),qe=!1,document.removeEventListener("mousemove",He),document.removeEventListener("mouseup",Re),U){const t=Oe(),n=t[e.boxIndex];if(n&&t.some((o,r)=>r!==e.boxIndex&&at(n,o))){const o=l=>Math.round(l*100)/100,r=e.item.querySelector(".signature-box-x"),a=e.item.querySelector(".signature-box-y"),u=e.item.querySelector(".signature-box-width"),c=e.item.querySelector(".signature-box-height");r&&(r.value=String(o(e.startFormX))),a&&(a.value=String(o(e.startFormY))),u&&(u.value=String(o(e.startFormW))),c&&(c.value=String(o(e.startFormH)));const i=L.no_overlap_message??"Signature boxes on the same page cannot overlap.";alert(i)}}I=null,A()}q.addEventListener("mousedown",lt),ne&&ne.addEventListener("click",()=>we(1,0,0)),xe(),$.addEventListener("keydown",e=>{const t=e.target;if(!(t!=null&&t.closest("input, select, textarea"))){if(e.ctrlKey&&e.key==="z"){e.preventDefault();const n=y.querySelectorAll(":scope > .signature-box-item");if(n.length>0){const s=n[n.length-1],o=Array.from(y.querySelectorAll(":scope > .signature-box-item")).indexOf(s);if(s.remove(),ee===o?ve(null):ee!==null&&ee>o&&ve(ee-1),y.querySelectorAll(":scope > .signature-box-item").length===0){const r=document.getElementById("signature-boxes-empty");r&&r.classList.remove("d-none")}A(),xe()}return}if(e.key==="Delete"||e.key==="Backspace"){if(ee===null)return;const s=y.querySelectorAll(":scope > .signature-box-item")[ee];if(s){if(e.preventDefault(),s.remove(),ve(null),y.querySelectorAll(":scope > .signature-box-item").length===0){const o=document.getElementById("signature-boxes-empty");o&&o.classList.remove("d-none")}A(),xe()}return}if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==="a"){if(e.preventDefault(),!F)return;const n=1,s=R[n];if(s){const o=s.scale||1.5,r=s.width/o,a=s.height/o;we(n,(r-150)/2,(a-40)/2,150,40)}else we(1,0,0)}}}),$.addEventListener("submit",e=>{e.preventDefault(),y.querySelectorAll(":scope > .signature-box-item").forEach((n,s)=>{n.querySelectorAll("input, select, textarea").forEach(o=>{o.name=o.name.replace(/(\])\[\d+\](\[)/,`$1[${s}]$2`)})}),$.submit()})}Je()})();
