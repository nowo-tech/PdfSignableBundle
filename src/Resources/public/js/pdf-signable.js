(function(){"use strict";const ae={pt:1,mm:.35277777777777775,cm:.035277777777777776,in:.013888888888888888,px:1.3333333333333333};function D(p,F){return p*(ae[F]??1)}function Z(p,F){return p/(ae[F]??1)}function be(p){return String(p).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}const we=220,Se=37,Ee=65,Le=48;function Me(p,F,w){p=p%360,p<0&&(p+=360);const $=F/100,I=w/100,y=(1-Math.abs(2*I-1))*$,b=y*(1-Math.abs(p/60%2-1)),Q=I-y/2;let X=0,W=0,S=0;p<60?(X=y,W=b):p<120?(X=b,W=y):p<180?(W=y,S=b):p<240?(W=b,S=y):p<300?(X=b,S=y):(X=y,S=b);const N=j=>{const _=Math.round((j+Q)*255);return(_<16?"0":"")+Math.min(255,Math.max(0,_)).toString(16)};return"#"+N(X)+N(W)+N(S)}function _e(p){const F=(we+p*Se)%360,w=Me(F,Ee,Le),$=parseInt(w.slice(1,3),16),I=parseInt(w.slice(3,5),16),y=parseInt(w.slice(5,7),16);return{border:w,background:`rgba(${$}, ${I}, ${y}, 0.15)`,color:w,handle:w}}function Pe(){console.log("[PdfSignable] Script loaded");const p=window.NowoPdfSignableConfig;if(!p){console.warn("[PdfSignable] NowoPdfSignableConfig not found, skipping init");return}const{proxyUrl:F,strings:w}=p,$=document.querySelector(".nowo-pdf-signable-widget"),I=$==null?void 0:$.closest("form");if(!I){console.warn("[PdfSignable] .nowo-pdf-signable-widget or form not found, skipping init");return}console.log("[PdfSignable] Initialized");const y=I.querySelector(".pdf-url-input"),b=document.getElementById("loadPdfBtn"),Q=document.getElementById("pdf-placeholder"),X=document.getElementById("pdf-canvas-wrapper"),W=document.getElementById("signature-boxes-list"),S=document.getElementById("addBoxBtn"),N=I.querySelector(".unit-selector"),j=I.querySelector(".origin-selector"),_=document.getElementById("pdf-viewer-container");if(!X||!W)return;const C=X,v=W;function K(){return(N==null?void 0:N.value)??"mm"}function te(){return(j==null?void 0:j.value)??"bottom_left"}function qe(t,n,e,s,a,r){const o=t.scale||1.5,d=t.width/o,l=t.height/o;let i,c;switch(r){case"top_left":i=n,c=l-e-a;break;case"top_right":i=d-n-s,c=l-e-a;break;case"bottom_right":i=d-n-s,c=e;break;default:i=n,c=e;break}return{vpX:i*o,vpY:t.height-(c+a)*o}}function Ie(t,n,e,s,a,r){const o=t.scale||1.5,d=t.width/o,l=t.height/o,i=t.convertToPdfPoint(n,e+a*o),c=i[0],u=i[1];let g,m;switch(r){case"top_left":g=c,m=l-u-a;break;case"top_right":g=d-c-s,m=l-u-a;break;case"bottom_right":g=d-c-s,m=u;break;default:g=c,m=u;break}return{xPt:g,yPt:m}}let A=null;const k={};let V=null,ne=!1;function Ce(t){try{return new URL(t,window.location.origin).origin===window.location.origin?t:F+"?url="+encodeURIComponent(t)}catch{return F+"?url="+encodeURIComponent(t)}}async function se(){if(!A||!_)return 1.5;const n=(await A.getPage(1)).getViewport({scale:1}),e=_.clientWidth-24;return e<=0?1.5:Math.max(.5,e/n.width)}async function re(){var e;const t=((e=y==null?void 0:y.value)==null?void 0:e.trim())??"";if(!t){console.warn("[PdfSignable] Load PDF: URL required"),alert(w.alert_url_required);return}const n=Ce(t);console.log("[PdfSignable] Loading PDF",{url:t,viaProxy:n!==t}),b&&(b.setAttribute("disabled",""),b.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> '+w.loading_state),Q&&(Q.style.display="block"),C.style.display="none",C.innerHTML="";try{A=await pdfjsLib.getDocument(n).promise,Object.keys(k).forEach(r=>delete k[Number(r)]);const s=await se();for(let r=1;r<=A.numPages;r++){V&&await V;const o=await A.getPage(r),d=o.getViewport({scale:s});k[r]=d;const l=document.createElement("div");l.className="pdf-page-wrapper",l.dataset.page=String(r);const i=document.createElement("canvas"),c=i.getContext("2d");if(!c)continue;i.height=d.height,i.width=d.width,i.dataset.page=String(r);const u=document.createElement("div");u.className="signature-overlays",l.appendChild(i),l.appendChild(u),V=o.render({canvasContext:c,viewport:d}).promise,await V,C.appendChild(l)}Q&&(Q.style.display="none"),C.style.display="block",requestAnimationFrame(()=>{P(),setTimeout(P,100),setTimeout(P,350),setTimeout(P,700)}),console.log("[PdfSignable] PDF loaded",{pages:A.numPages,scale:s})}catch(s){console.error("[PdfSignable] PDF load failed",s),alert(w.error_load_pdf+(s instanceof Error?s.message:String(s)))}finally{b&&(b.removeAttribute("disabled"),b.innerHTML=w.load_pdf_btn)}}function P(){if(ne||Object.keys(k).length===0)return;const t=K(),n=te();C.querySelectorAll(".signature-overlays").forEach(o=>{o.innerHTML=""});const e=v.querySelectorAll(":scope > .signature-box-item"),s={},a={};let r=0;e.forEach((o,d)=>{var fe,he,ye,ve,xe;const l=parseInt(((fe=o.querySelector(".signature-box-page"))==null?void 0:fe.value)??"1",10),i=parseFloat(((he=o.querySelector(".signature-box-x"))==null?void 0:he.value)??"0"),c=parseFloat(((ye=o.querySelector(".signature-box-y"))==null?void 0:ye.value)??"0"),u=parseFloat(((ve=o.querySelector(".signature-box-width"))==null?void 0:ve.value)??"150"),g=parseFloat(((xe=o.querySelector(".signature-box-height"))==null?void 0:xe.value)??"40"),m=o.querySelector(".signature-box-name"),f=((m==null?void 0:m.value)??"").trim(),U=f===""?"__empty__":f;U in a||(a[U]=r++);const B=a[U];s[f]=(s[f]??0)+1;const T=s[f],R=f===""?"":f+(T>1?` (${T})`:""),O=C.querySelector(`.pdf-page-wrapper[data-page="${l}"] .signature-overlays`),H=k[l];if(!O||!H)return;const z=H.scale||1.5,G=Z(i,t),J=Z(c,t),x=Z(u,t),L=Z(g,t),q=qe(H,G,J,x,L,n),Y=x*z,M=L*z,h=document.createElement("div");h.className="signature-box-overlay",h.dataset.boxIndex=String(d),h.style.left=q.vpX+"px",h.style.top=q.vpY+"px",h.style.width=Math.max(Y,20)+"px",h.style.height=Math.max(M,14)+"px";const ee=_e(B);h.style.borderColor=ee.border,h.style.backgroundColor=ee.background,h.style.color=ee.color,h.style.setProperty("--box-color",ee.handle),h.innerHTML=(R?'<span class="overlay-label">'+be(R)+"</span>":"")+'<span class="resize-handle nw" data-handle="nw"></span><span class="resize-handle ne" data-handle="ne"></span><span class="resize-handle sw" data-handle="sw"></span><span class="resize-handle se" data-handle="se"></span>',O.appendChild(h)})}function ie(){const t=v.dataset.maxEntries??(S==null?void 0:S.dataset.maxEntries)??"";if(t==="")return null;const n=parseInt(t,10);return Number.isNaN(n)?null:n}function oe(){if(!S)return;const t=ie(),n=v.querySelectorAll(":scope > .signature-box-item").length;t!==null&&n>=t?S.style.display="none":S.style.display=""}function ce(t,n,e,s,a){const r=ie(),o=v.querySelectorAll(":scope > .signature-box-item").length;if(r!==null&&o>=r){console.log("[PdfSignable] Box add skipped: max_entries reached",{max:r,currentCount:o});return}const d=s??150,l=a??40,i=document.getElementById("signature-boxes-empty");i&&i.classList.add("d-none");const c=v.dataset.prototype??"",u=v.querySelectorAll(":scope > .signature-box-item").length,g=c.replace(/__name__/g,String(u)),m=document.createElement("div");m.innerHTML=g;const f=m.firstElementChild;if(!f)return;f.dataset.index=String(u);const U=f.querySelector(".signature-box-page");U&&(U.value=String(t));const B=k[t],T=K(),R=te(),O=d,H=l,z=B?B.scale:1.5,G=B?B.width/z:595,J=B?B.height/z:842;let x,L;switch(R){case"top_left":x=n,L=J-e-H;break;case"top_right":x=G-n-O,L=J-e-H;break;case"bottom_right":x=G-n-O,L=e;break;default:x=n,L=e;break}const q=M=>Math.round(M*100)/100,Y=f.querySelector(".signature-box-name");for(const M of["x","y","width","height"]){const h=f.querySelector(".signature-box-"+M);h&&(M==="x"?h.value=String(q(D(x,T))):M==="y"?h.value=String(q(D(L,T))):M==="width"?h.value=String(q(D(O,T))):M==="height"&&(h.value=String(q(D(H,T)))))}Y&&(Y.value=w.default_box_name),v.appendChild(f),f.scrollIntoView({behavior:"smooth"}),P(),oe(),console.log("[PdfSignable] Box added",{page:t,x,y:L,width:d,height:l,unit:T})}b&&b.addEventListener("click",()=>re());const le=document.getElementById("unitBadge"),ke={pt:"pt",mm:"mm",cm:"cm",px:"px",in:"in"};function de(){le&&(le.textContent=ke[K()]??K())}de();let ue=K();if(N&&N.addEventListener("change",()=>{const t=ue,n=K();de(),v.querySelectorAll(":scope > .signature-box-item").forEach(e=>{for(const s of["x","y","width","height"]){const a=e.querySelector(".signature-box-"+s);if(a!=null&&a.value){const r=parseFloat(a.value);a.value=String(Math.round(D(Z(r,t),n)*100)/100)}}}),ue=n,P()}),v.addEventListener("input",P),v.addEventListener("change",P),j&&j.addEventListener("change",P),v.addEventListener("click",t=>{if(!t.target.closest(".remove-box"))return;const n=t.target.closest(".signature-box-item");if(n){let e=n;for(;e!=null&&e.parentElement&&e.parentElement!==v;)e=e.parentElement;if(e){const s=Array.from(v.querySelectorAll(":scope > .signature-box-item")).indexOf(e);e.remove(),console.log("[PdfSignable] Box removed",{index:s})}}if(v.querySelectorAll(":scope > .signature-box-item").length===0){const e=document.getElementById("signature-boxes-empty");e&&e.classList.remove("d-none")}P(),oe()}),_){let t,n=!1,e=0;new ResizeObserver(()=>{if(n)return;const a=(_==null?void 0:_.clientWidth)??0;Math.abs(a-e)<10||(e=a,clearTimeout(t),t=setTimeout(async()=>{if(!(!A||C.style.display==="none")&&!n){n=!0;try{const r=await se();C.innerHTML="",Object.keys(k).forEach(o=>delete k[Number(o)]);for(let o=1;o<=A.numPages;o++){V&&await V;const d=await A.getPage(o),l=d.getViewport({scale:r});k[o]=l;const i=document.createElement("div");i.className="pdf-page-wrapper",i.dataset.page=String(o);const c=document.createElement("canvas"),u=c.getContext("2d");if(!u)continue;c.height=l.height,c.width=l.width,c.dataset.page=String(o);const g=document.createElement("div");g.className="signature-overlays",i.appendChild(c),i.appendChild(g),V=d.render({canvasContext:u,viewport:l}).promise,await V,C.appendChild(i)}P(),_&&(e=_.clientWidth)}finally{n=!1}}},200))}).observe(_)}function ge(){var t;(t=y==null?void 0:y.value)!=null&&t.trim()&&(console.log("[PdfSignable] Auto-loading PDF (preset URL)"),re())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ge):ge(),C.addEventListener("click",t=>{if(t.target.closest(".signature-box-overlay"))return;const n=t.target.closest(".pdf-page-wrapper"),e=n==null?void 0:n.querySelector("canvas");if(!e||!A)return;const s=parseInt(e.dataset.page??"1",10),a=k[s];if(!a)return;const r=e.getBoundingClientRect(),o=e.width/r.width,d=e.height/r.height,l=(t.clientX-r.left)*o,i=(t.clientY-r.top)*d,c=40,u=c*(a.scale||1.5),g=a.convertToPdfPoint(l,i+u);ce(s,g[0],g[1],150,c)});let E=null;function Be(t){var g,m;const n=t.target.closest(".resize-handle"),e=t.target.closest(".signature-box-overlay");if(!((g=e==null?void 0:e.dataset)!=null&&g.boxIndex))return;t.preventDefault(),t.stopPropagation();const s=parseInt(e.dataset.boxIndex,10),a=v.querySelectorAll(":scope > .signature-box-item")[s];if(!a)return;const r=e.closest(".pdf-page-wrapper"),o=parseInt(((m=r==null?void 0:r.dataset)==null?void 0:m.page)??"1",10),d=k[o];if(!d)return;const l=parseFloat(e.style.width)||20,i=parseFloat(e.style.height)||14,c=parseFloat(e.style.left)||0,u=parseFloat(e.style.top)||0;E={mode:n?"resize":"move",handle:n?n.dataset.handle??null:null,overlay:e,item:a,viewport:d,startX:t.clientX,startY:t.clientY,startLeft:c,startTop:u,startRight:c+l,startBottom:u+i},e.classList.add("dragging"),ne=!0,document.addEventListener("mousemove",pe),document.addEventListener("mouseup",me)}function pe(t){if(!E)return;const{overlay:n,viewport:e,startLeft:s,startTop:a,startRight:r,startBottom:o}=E,d=t.clientX-E.startX,l=t.clientY-E.startY,i=20;let c,u,g,m;if(E.mode==="move")c=Math.max(0,Math.min(e.width-(r-s),s+d)),u=Math.max(0,Math.min(e.height-(o-a),a+l)),g=r-s,m=o-a;else{const x=E.handle;let L=s,q=a,Y=r,M=o;x==="se"?(Y=Math.min(e.width,Math.max(s+i,r+d)),M=Math.min(e.height,Math.max(a+i,o+l))):x==="sw"?(L=Math.max(0,Math.min(r-i,s+d)),M=Math.min(e.height,Math.max(a+i,o+l))):x==="ne"?(Y=Math.min(e.width,Math.max(s+i,r+d)),q=Math.max(0,Math.min(o-i,a+l))):x==="nw"&&(L=Math.max(0,Math.min(r-i,s+d)),q=Math.max(0,Math.min(o-i,a+l))),c=L,u=q,g=Y-L,m=M-q}n.style.left=c+"px",n.style.top=u+"px",n.style.width=g+"px",n.style.height=m+"px";const f=e.scale||1.5,U=g/f,B=m/f,T=Ie(e,c,u,U,B,te()),R=K(),O=x=>Math.round(x*100)/100,H=E.item.querySelector(".signature-box-x"),z=E.item.querySelector(".signature-box-y"),G=E.item.querySelector(".signature-box-width"),J=E.item.querySelector(".signature-box-height");H&&(H.value=String(O(D(T.xPt,R)))),z&&(z.value=String(O(D(T.yPt,R)))),G&&(G.value=String(O(D(U,R)))),J&&(J.value=String(O(D(B,R))))}function me(){E&&(E.overlay.classList.remove("dragging"),ne=!1,document.removeEventListener("mousemove",pe),document.removeEventListener("mouseup",me),E=null,P())}C.addEventListener("mousedown",Be),S&&S.addEventListener("click",()=>ce(1,0,0)),oe(),I.addEventListener("submit",t=>{t.preventDefault(),v.querySelectorAll(":scope > .signature-box-item").forEach((e,s)=>{e.querySelectorAll("input, select, textarea").forEach(a=>{a.name=a.name.replace(/(\])\[\d+\](\[)/,`$1[${s}]$2`)})}),I.submit()})}Pe()})();
