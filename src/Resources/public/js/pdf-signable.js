(function(){"use strict";const se={pt:1,mm:.35277777777777775,cm:.035277777777777776,in:.013888888888888888,px:1.3333333333333333};function R(p,T){return p*(se[T]??1)}function ee(p,T){return p/(se[T]??1)}function Se(p){return String(p).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const we=220,Ee=37,qe=65,Le=48;function Ie(p,T,v){p=p%360,p<0&&(p+=360);const H=T/100,B=v/100,I=(1-Math.abs(2*B-1))*H,q=I*(1-Math.abs(p/60%2-1)),A=B-I/2;let D=0,V=0,Y=0;p<60?(D=I,V=q):p<120?(D=q,V=I):p<180?(V=I,Y=q):p<240?(V=q,Y=I):p<300?(D=q,Y=I):(D=I,Y=q);const M=G=>{const z=Math.round((G+A)*255);return(z<16?"0":"")+Math.min(255,Math.max(0,z)).toString(16)};return"#"+M(D)+M(V)+M(Y)}function Me(p){const T=(we+p*Ee)%360,v=Ie(T,qe,Le),H=parseInt(v.slice(1,3),16),B=parseInt(v.slice(3,5),16),I=parseInt(v.slice(5,7),16);return{border:v,background:`rgba(${H}, ${B}, ${I}, 0.15)`,color:v,handle:v}}function _e(){console.log("[PdfSignable] Script loaded");const p=window.NowoPdfSignableConfig;if(!p){console.warn("[PdfSignable] NowoPdfSignableConfig not found, skipping init");return}const{proxyUrl:T,strings:v}=p,H=document.querySelector(".nowo-pdf-signable-widget"),B=H==null?void 0:H.closest("form");if(!B){console.warn("[PdfSignable] .nowo-pdf-signable-widget or form not found, skipping init");return}const I=(H==null?void 0:H.dataset.preventBoxOverlap)==="1";console.log("[PdfSignable] Initialized");const q=B.querySelector(".pdf-url-input"),A=document.getElementById("loadPdfBtn"),D=document.getElementById("pdf-placeholder"),V=document.getElementById("pdf-canvas-wrapper"),Y=document.getElementById("signature-boxes-list"),M=document.getElementById("addBoxBtn"),G=B.querySelector(".unit-selector"),z=B.querySelector(".origin-selector"),X=document.getElementById("pdf-viewer-container");if(!V||!Y)return;const C=V,y=Y;function J(){return(G==null?void 0:G.value)??"mm"}function ne(){return(z==null?void 0:z.value)??"bottom_left"}function Fe(e,n,t,s,o,r){const a=e.scale||1.5,u=e.width/a,l=e.height/a;let i,c;switch(r){case"top_left":i=n,c=l-t-o;break;case"top_right":i=u-n-s,c=l-t-o;break;case"bottom_right":i=u-n-s,c=t;break;default:i=n,c=t;break}return{vpX:i*a,vpY:e.height-(c+o)*a}}function Pe(e,n,t,s,o,r){const a=e.scale||1.5,u=e.width/a,l=e.height/a,i=e.convertToPdfPoint(n,t+o*a),c=i[0],d=i[1];let g,f;switch(r){case"top_left":g=c,f=l-d-o;break;case"top_right":g=u-c-s,f=l-d-o;break;case"bottom_right":g=u-c-s,f=d;break;default:g=c,f=d;break}return{xPt:g,yPt:f}}let N=null;const k={};let $=null,oe=!1;function Be(e){try{return new URL(e,window.location.origin).origin===window.location.origin?e:T+"?url="+encodeURIComponent(e)}catch{return T+"?url="+encodeURIComponent(e)}}async function re(){if(!N||!X)return 1.5;const n=(await N.getPage(1)).getViewport({scale:1}),t=X.clientWidth-24;return t<=0?1.5:Math.max(.5,t/n.width)}async function ie(){var t;const e=((t=q==null?void 0:q.value)==null?void 0:t.trim())??"";if(!e){console.warn("[PdfSignable] Load PDF: URL required"),alert(v.alert_url_required);return}const n=Be(e);console.log("[PdfSignable] Loading PDF",{url:e,viaProxy:n!==e}),A&&(A.setAttribute("disabled",""),A.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> '+v.loading_state),D&&(D.style.display="block"),C.style.display="none",C.innerHTML="";try{N=await pdfjsLib.getDocument(n).promise,Object.keys(k).forEach(r=>delete k[Number(r)]);const s=await re();for(let r=1;r<=N.numPages;r++){$&&await $;const a=await N.getPage(r),u=a.getViewport({scale:s});k[r]=u;const l=document.createElement("div");l.className="pdf-page-wrapper",l.dataset.page=String(r);const i=document.createElement("canvas"),c=i.getContext("2d");if(!c)continue;i.height=u.height,i.width=u.width,i.dataset.page=String(r);const d=document.createElement("div");d.className="signature-overlays",l.appendChild(i),l.appendChild(d),$=a.render({canvasContext:c,viewport:u}).promise,await $,C.appendChild(l)}D&&(D.style.display="none"),C.style.display="block",requestAnimationFrame(()=>{_(),setTimeout(_,100),setTimeout(_,350),setTimeout(_,700)}),console.log("[PdfSignable] PDF loaded",{pages:N.numPages,scale:s})}catch(s){console.error("[PdfSignable] PDF load failed",s),alert(v.error_load_pdf+(s instanceof Error?s.message:String(s)))}finally{A&&(A.removeAttribute("disabled"),A.innerHTML=v.load_pdf_btn)}}function _(){if(oe||Object.keys(k).length===0)return;const e=J(),n=ne();C.querySelectorAll(".signature-overlays").forEach(a=>{a.innerHTML=""});const t=y.querySelectorAll(":scope > .signature-box-item"),s={},o={};let r=0;t.forEach((a,u)=>{var he,ye,xe,ve,be;const l=parseInt(((he=a.querySelector(".signature-box-page"))==null?void 0:he.value)??"1",10),i=parseFloat(((ye=a.querySelector(".signature-box-x"))==null?void 0:ye.value)??"0"),c=parseFloat(((xe=a.querySelector(".signature-box-y"))==null?void 0:xe.value)??"0"),d=parseFloat(((ve=a.querySelector(".signature-box-width"))==null?void 0:ve.value)??"150"),g=parseFloat(((be=a.querySelector(".signature-box-height"))==null?void 0:be.value)??"40"),f=a.querySelector(".signature-box-name"),m=((f==null?void 0:f.value)??"").trim(),F=m===""?"__empty__":m;F in o||(o[F]=r++);const S=o[F];s[m]=(s[m]??0)+1;const w=s[m],W=m===""?"":m+(w>1?` (${w})`:""),O=C.querySelector(`.pdf-page-wrapper[data-page="${l}"] .signature-overlays`),U=k[l];if(!O||!U)return;const j=U.scale||1.5,Q=ee(i,e),Z=ee(c,e),x=ee(d,e),E=ee(g,e),P=Fe(U,Q,Z,x,E,n),K=x*j,L=E*j,h=document.createElement("div");h.className="signature-box-overlay",h.dataset.boxIndex=String(u),h.style.left=P.vpX+"px",h.style.top=P.vpY+"px",h.style.width=Math.max(K,20)+"px",h.style.height=Math.max(L,14)+"px";const te=Me(S);h.style.borderColor=te.border,h.style.backgroundColor=te.background,h.style.color=te.color,h.style.setProperty("--box-color",te.handle),h.innerHTML=(W?'<span class="overlay-label">'+Se(W)+"</span>":"")+'<span class="resize-handle nw" data-handle="nw"></span><span class="resize-handle ne" data-handle="ne"></span><span class="resize-handle sw" data-handle="sw"></span><span class="resize-handle se" data-handle="se"></span>',O.appendChild(h)})}function ce(){const e=y.dataset.maxEntries??(M==null?void 0:M.dataset.maxEntries)??"";if(e==="")return null;const n=parseInt(e,10);return Number.isNaN(n)?null:n}function ae(){if(!M)return;const e=ce(),n=y.querySelectorAll(":scope > .signature-box-item").length;e!==null&&n>=e?M.style.display="none":M.style.display=""}function le(e,n,t,s,o){const r=ce(),a=y.querySelectorAll(":scope > .signature-box-item").length;if(r!==null&&a>=r){console.log("[PdfSignable] Box add skipped: max_entries reached",{max:r,currentCount:a});return}const u=s??150,l=o??40,i=document.getElementById("signature-boxes-empty");i&&i.classList.add("d-none");const c=y.dataset.prototype??"",d=y.querySelectorAll(":scope > .signature-box-item").length,g=c.replace(/__name__/g,String(d)),f=document.createElement("div");f.innerHTML=g;const m=f.firstElementChild;if(!m)return;m.dataset.index=String(d);const F=m.querySelector(".signature-box-page");F&&(F.value=String(e));const S=k[e],w=J(),W=ne(),O=u,U=l,j=S?S.scale:1.5,Q=S?S.width/j:595,Z=S?S.height/j:842;let x,E;switch(W){case"top_left":x=n,E=Z-t-U;break;case"top_right":x=Q-n-O,E=Z-t-U;break;case"bottom_right":x=Q-n-O,E=t;break;default:x=n,E=t;break}const P=L=>Math.round(L*100)/100,K=m.querySelector(".signature-box-name");for(const L of["x","y","width","height"]){const h=m.querySelector(".signature-box-"+L);h&&(L==="x"?h.value=String(P(R(x,w))):L==="y"?h.value=String(P(R(E,w))):L==="width"?h.value=String(P(R(O,w))):L==="height"&&(h.value=String(P(R(U,w)))))}K&&(K.value=v.default_box_name),y.appendChild(m),m.scrollIntoView({behavior:"smooth"}),_(),ae(),console.log("[PdfSignable] Box added",{page:e,x,y:E,width:u,height:l,unit:w})}A&&A.addEventListener("click",()=>ie());const ue=document.getElementById("unitBadge"),Ce={pt:"pt",mm:"mm",cm:"cm",px:"px",in:"in"};function de(){ue&&(ue.textContent=Ce[J()]??J())}de();let ge=J();if(G&&G.addEventListener("change",()=>{const e=ge,n=J();de(),y.querySelectorAll(":scope > .signature-box-item").forEach(t=>{for(const s of["x","y","width","height"]){const o=t.querySelector(".signature-box-"+s);if(o!=null&&o.value){const r=parseFloat(o.value);o.value=String(Math.round(R(ee(r,e),n)*100)/100)}}}),ge=n,_()}),y.addEventListener("input",_),y.addEventListener("change",_),z&&z.addEventListener("change",_),y.addEventListener("click",e=>{if(!e.target.closest(".remove-box"))return;const n=e.target.closest(".signature-box-item");if(n){let t=n;for(;t!=null&&t.parentElement&&t.parentElement!==y;)t=t.parentElement;if(t){const s=Array.from(y.querySelectorAll(":scope > .signature-box-item")).indexOf(t);t.remove(),console.log("[PdfSignable] Box removed",{index:s})}}if(y.querySelectorAll(":scope > .signature-box-item").length===0){const t=document.getElementById("signature-boxes-empty");t&&t.classList.remove("d-none")}_(),ae()}),X){let e,n=!1,t=0;new ResizeObserver(()=>{if(n)return;const o=(X==null?void 0:X.clientWidth)??0;Math.abs(o-t)<10||(t=o,clearTimeout(e),e=setTimeout(async()=>{if(!(!N||C.style.display==="none")&&!n){n=!0;try{const r=await re();C.innerHTML="",Object.keys(k).forEach(a=>delete k[Number(a)]);for(let a=1;a<=N.numPages;a++){$&&await $;const u=await N.getPage(a),l=u.getViewport({scale:r});k[a]=l;const i=document.createElement("div");i.className="pdf-page-wrapper",i.dataset.page=String(a);const c=document.createElement("canvas"),d=c.getContext("2d");if(!d)continue;c.height=l.height,c.width=l.width,c.dataset.page=String(a);const g=document.createElement("div");g.className="signature-overlays",i.appendChild(c),i.appendChild(g),$=u.render({canvasContext:d,viewport:l}).promise,await $,C.appendChild(i)}_(),X&&(t=X.clientWidth)}finally{n=!1}}},200))}).observe(X)}function pe(){var e;(e=q==null?void 0:q.value)!=null&&e.trim()&&(console.log("[PdfSignable] Auto-loading PDF (preset URL)"),ie())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",pe):pe(),C.addEventListener("click",e=>{if(e.target.closest(".signature-box-overlay"))return;const n=e.target.closest(".pdf-page-wrapper"),t=n==null?void 0:n.querySelector("canvas");if(!t||!N)return;const s=parseInt(t.dataset.page??"1",10),o=k[s];if(!o)return;const r=t.getBoundingClientRect(),a=t.width/r.width,u=t.height/r.height,l=(e.clientX-r.left)*a,i=(e.clientY-r.top)*u,c=40,d=c*(o.scale||1.5),g=o.convertToPdfPoint(l,i+d);le(s,g[0],g[1],150,c)});function ke(e,n){if(e.page!==n.page)return!1;const t=e.x+e.w,s=n.x+n.w,o=e.y+e.h,r=n.y+n.h;return e.x<s&&n.x<t&&e.y<r&&n.y<o}function Oe(){const e=y.querySelectorAll(":scope > .signature-box-item"),n=[];return e.forEach(t=>{var i,c,d,g;const s=t.querySelector(".signature-box-page"),o=parseInt((s==null?void 0:s.value)??"1",10),r=parseFloat(((i=t.querySelector(".signature-box-x"))==null?void 0:i.value)??"0"),a=parseFloat(((c=t.querySelector(".signature-box-y"))==null?void 0:c.value)??"0"),u=parseFloat(((d=t.querySelector(".signature-box-width"))==null?void 0:d.value)??"150"),l=parseFloat(((g=t.querySelector(".signature-box-height"))==null?void 0:g.value)??"40");n.push({page:o,x:r,y:a,w:u,h:l})}),n}let b=null;function Te(e){var S,w;const n=e.target.closest(".resize-handle"),t=e.target.closest(".signature-box-overlay");if(!((S=t==null?void 0:t.dataset)!=null&&S.boxIndex))return;e.preventDefault(),e.stopPropagation();const s=parseInt(t.dataset.boxIndex,10),o=y.querySelectorAll(":scope > .signature-box-item")[s];if(!o)return;const r=t.closest(".pdf-page-wrapper"),a=parseInt(((w=r==null?void 0:r.dataset)==null?void 0:w.page)??"1",10),u=k[a];if(!u)return;const l=parseFloat(t.style.width)||20,i=parseFloat(t.style.height)||14,c=parseFloat(t.style.left)||0,d=parseFloat(t.style.top)||0,g=o.querySelector(".signature-box-x"),f=o.querySelector(".signature-box-y"),m=o.querySelector(".signature-box-width"),F=o.querySelector(".signature-box-height");b={mode:n?"resize":"move",handle:n?n.dataset.handle??null:null,overlay:t,item:o,boxIndex:s,viewport:u,startX:e.clientX,startY:e.clientY,startLeft:c,startTop:d,startRight:c+l,startBottom:d+i,startFormX:g&&parseFloat(g.value)||0,startFormY:f&&parseFloat(f.value)||0,startFormW:m&&parseFloat(m.value)||150,startFormH:F&&parseFloat(F.value)||40},t.classList.add("dragging"),oe=!0,document.addEventListener("mousemove",me),document.addEventListener("mouseup",fe)}function me(e){if(!b)return;const{overlay:n,viewport:t,startLeft:s,startTop:o,startRight:r,startBottom:a}=b,u=e.clientX-b.startX,l=e.clientY-b.startY,i=20;let c,d,g,f;if(b.mode==="move")c=Math.max(0,Math.min(t.width-(r-s),s+u)),d=Math.max(0,Math.min(t.height-(a-o),o+l)),g=r-s,f=a-o;else{const x=b.handle;let E=s,P=o,K=r,L=a;x==="se"?(K=Math.min(t.width,Math.max(s+i,r+u)),L=Math.min(t.height,Math.max(o+i,a+l))):x==="sw"?(E=Math.max(0,Math.min(r-i,s+u)),L=Math.min(t.height,Math.max(o+i,a+l))):x==="ne"?(K=Math.min(t.width,Math.max(s+i,r+u)),P=Math.max(0,Math.min(a-i,o+l))):x==="nw"&&(E=Math.max(0,Math.min(r-i,s+u)),P=Math.max(0,Math.min(a-i,o+l))),c=E,d=P,g=K-E,f=L-P}n.style.left=c+"px",n.style.top=d+"px",n.style.width=g+"px",n.style.height=f+"px";const m=t.scale||1.5,F=g/m,S=f/m,w=Pe(t,c,d,F,S,ne()),W=J(),O=x=>Math.round(x*100)/100,U=b.item.querySelector(".signature-box-x"),j=b.item.querySelector(".signature-box-y"),Q=b.item.querySelector(".signature-box-width"),Z=b.item.querySelector(".signature-box-height");U&&(U.value=String(O(R(w.xPt,W)))),j&&(j.value=String(O(R(w.yPt,W)))),Q&&(Q.value=String(O(R(F,W)))),Z&&(Z.value=String(O(R(S,W))))}function fe(){if(!b)return;const e=b;if(b.overlay.classList.remove("dragging"),oe=!1,document.removeEventListener("mousemove",me),document.removeEventListener("mouseup",fe),I){const n=Oe(),t=n[e.boxIndex];if(t&&n.some((o,r)=>r!==e.boxIndex&&ke(t,o))){const o=c=>Math.round(c*100)/100,r=e.item.querySelector(".signature-box-x"),a=e.item.querySelector(".signature-box-y"),u=e.item.querySelector(".signature-box-width"),l=e.item.querySelector(".signature-box-height");r&&(r.value=String(o(e.startFormX))),a&&(a.value=String(o(e.startFormY))),u&&(u.value=String(o(e.startFormW))),l&&(l.value=String(o(e.startFormH)));const i=v.no_overlap_message??"Signature boxes on the same page cannot overlap.";alert(i)}}b=null,_()}C.addEventListener("mousedown",Te),M&&M.addEventListener("click",()=>le(1,0,0)),ae(),B.addEventListener("submit",e=>{e.preventDefault(),y.querySelectorAll(":scope > .signature-box-item").forEach((t,s)=>{t.querySelectorAll("input, select, textarea").forEach(o=>{o.name=o.name.replace(/(\])\[\d+\](\[)/,`$1[${s}]$2`)})}),B.submit()})}_e()})();
