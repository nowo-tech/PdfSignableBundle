(function(){"use strict";const ue={pt:1,mm:.35277777777777775,cm:.035277777777777776,in:.013888888888888888,px:1.3333333333333333};function V(p,U){return p*(ue[U]??1)}function te(p,U){return p/(ue[U]??1)}function _e(p){return String(p).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const Fe=220,Pe=37,Be=65,Ce=48;function Oe(p,U,b){p=p%360,p<0&&(p+=360);const x=U/100,k=b/100,P=(1-Math.abs(2*k-1))*x,T=P*(1-Math.abs(p/60%2-1)),Z=k-P/2;let B=0,q=0,Y=0;p<60?(B=P,q=T):p<120?(B=T,q=P):p<180?(q=P,Y=T):p<240?(q=T,Y=P):p<300?(B=T,Y=P):(B=P,Y=T);const ee=se=>{const A=Math.round((se+Z)*255);return(A<16?"0":"")+Math.min(255,Math.max(0,A)).toString(16)};return"#"+ee(B)+ee(q)+ee(Y)}function ke(p){const U=(Fe+p*Pe)%360,b=Oe(U,Be,Ce),x=parseInt(b.slice(1,3),16),k=parseInt(b.slice(3,5),16),P=parseInt(b.slice(5,7),16);return{border:b,background:`rgba(${x}, ${k}, ${P}, 0.15)`,color:b,handle:b}}function Te(){console.log("[PdfSignable] Script loaded");const p=window.NowoPdfSignableConfig;if(!p){console.warn("[PdfSignable] NowoPdfSignableConfig not found, skipping init");return}const{proxyUrl:U,strings:b}=p,x=document.querySelector(".nowo-pdf-signable-widget"),k=x==null?void 0:x.closest("form");if(!k){console.warn("[PdfSignable] .nowo-pdf-signable-widget or form not found, skipping init");return}const P=(x==null?void 0:x.dataset.preventBoxOverlap)==="1",T=(x==null?void 0:x.dataset.enableRotation)==="1";let Z={};try{const e=(x==null?void 0:x.dataset.boxDefaultsByName)??"{}";Z=typeof e=="string"?JSON.parse(e):{}}catch{Z={}}console.log("[PdfSignable] Initialized");const B=k.querySelector(".pdf-url-input"),q=document.getElementById("loadPdfBtn"),Y=document.getElementById("pdf-placeholder"),ee=document.getElementById("pdf-canvas-wrapper"),se=document.getElementById("signature-boxes-list"),A=document.getElementById("addBoxBtn"),ne=k.querySelector(".unit-selector"),oe=k.querySelector(".origin-selector"),z=document.getElementById("pdf-viewer-container");if(!ee||!se)return;const H=ee,h=se;function G(){return(ne==null?void 0:ne.value)??"mm"}function ie(){return(oe==null?void 0:oe.value)??"bottom_left"}function Ae(e,t,n,r,o,a){const s=e.scale||1.5,u=e.width/s,l=e.height/s;let i,c;switch(a){case"top_left":i=t,c=l-n-o;break;case"top_right":i=u-t-r,c=l-n-o;break;case"bottom_right":i=u-t-r,c=n;break;default:i=t,c=n;break}return{vpX:i*s,vpY:e.height-(c+o)*s}}function He(e,t,n,r,o,a){const s=e.scale||1.5,u=e.width/s,l=e.height/s,i=e.convertToPdfPoint(t,n+o*s),c=i[0],d=i[1];let g,f;switch(a){case"top_left":g=c,f=l-d-o;break;case"top_right":g=u-c-r,f=l-d-o;break;case"bottom_right":g=u-c-r,f=d;break;default:g=c,f=d;break}return{xPt:g,yPt:f}}let W=null;const D={};let K=null,le=!1;function De(e){try{return new URL(e,window.location.origin).origin===window.location.origin?e:U+"?url="+encodeURIComponent(e)}catch{return U+"?url="+encodeURIComponent(e)}}async function de(){if(!W||!z)return 1.5;const t=(await W.getPage(1)).getViewport({scale:1}),n=z.clientWidth-24;return n<=0?1.5:Math.max(.5,n/t.width)}async function ge(){var n;const e=((n=B==null?void 0:B.value)==null?void 0:n.trim())??"";if(!e){console.warn("[PdfSignable] Load PDF: URL required"),alert(b.alert_url_required);return}const t=De(e);console.log("[PdfSignable] Loading PDF",{url:e,viaProxy:t!==e}),q&&(q.setAttribute("disabled",""),q.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> '+b.loading_state),Y&&(Y.style.display="block"),H.style.display="none",H.innerHTML="";try{W=await pdfjsLib.getDocument(t).promise,Object.keys(D).forEach(a=>delete D[Number(a)]);const r=await de();for(let a=1;a<=W.numPages;a++){K&&await K;const s=await W.getPage(a),u=s.getViewport({scale:r});D[a]=u;const l=document.createElement("div");l.className="pdf-page-wrapper",l.dataset.page=String(a);const i=document.createElement("canvas"),c=i.getContext("2d");if(!c)continue;i.height=u.height,i.width=u.width,i.dataset.page=String(a);const d=document.createElement("div");d.className="signature-overlays",l.appendChild(i),l.appendChild(d),K=s.render({canvasContext:c,viewport:u}).promise,await K,H.appendChild(l)}Y&&(Y.style.display="none"),H.style.display="block",requestAnimationFrame(()=>{C(),setTimeout(C,100),setTimeout(C,350),setTimeout(C,700)}),console.log("[PdfSignable] PDF loaded",{pages:W.numPages,scale:r})}catch(r){console.error("[PdfSignable] PDF load failed",r),alert(b.error_load_pdf+(r instanceof Error?r.message:String(r)))}finally{q&&(q.removeAttribute("disabled"),q.innerHTML=b.load_pdf_btn)}}function C(){if(le||Object.keys(D).length===0)return;const e=G(),t=ie();H.querySelectorAll(".signature-overlays").forEach(s=>{s.innerHTML=""});const n=h.querySelectorAll(":scope > .signature-box-item"),r={},o={};let a=0;n.forEach((s,u)=>{var Ee,qe,Me,Ie,Le;const l=parseInt(((Ee=s.querySelector(".signature-box-page"))==null?void 0:Ee.value)??"1",10),i=parseFloat(((qe=s.querySelector(".signature-box-x"))==null?void 0:qe.value)??"0"),c=parseFloat(((Me=s.querySelector(".signature-box-y"))==null?void 0:Me.value)??"0"),d=parseFloat(((Ie=s.querySelector(".signature-box-width"))==null?void 0:Ie.value)??"150"),g=parseFloat(((Le=s.querySelector(".signature-box-height"))==null?void 0:Le.value)??"40"),f=s.querySelector(".signature-box-angle"),v=T&&f?parseFloat(f.value??"0"):0,O=s.querySelector(".signature-box-name"),m=((O==null?void 0:O.value)??"").trim(),w=m===""?"__empty__":m;w in o||(o[w]=a++);const N=o[w];r[m]=(r[m]??0)+1;const _=r[m],F=m===""?"":m+(_>1?` (${_})`:""),R=H.querySelector(`.pdf-page-wrapper[data-page="${l}"] .signature-overlays`),M=D[l];if(!R||!M)return;const X=M.scale||1.5,y=te(i,e),E=te(c,e),I=te(d,e),$=te(g,e),j=Ae(M,y,E,I,$,t),J=I*X,Q=$*X,L=document.createElement("div");L.className="signature-box-overlay",L.dataset.boxIndex=String(u),L.style.left=j.vpX+"px",L.style.top=j.vpY+"px",L.style.width=Math.max(J,20)+"px",L.style.height=Math.max(Q,14)+"px";const re=ke(N);L.style.borderColor=re.border,L.style.backgroundColor=re.background,L.style.color=re.color,L.style.setProperty("--box-color",re.handle),L.style.transformOrigin="50% 50%",T&&(L.style.transform=`rotate(${v}deg)`);const Ye=T?'<span class="rotate-handle" title="Rotate"></span>':"";L.innerHTML=(F?'<span class="overlay-label">'+_e(F)+"</span>":"")+Ye+'<span class="resize-handle nw" data-handle="nw"></span><span class="resize-handle ne" data-handle="ne"></span><span class="resize-handle sw" data-handle="sw"></span><span class="resize-handle se" data-handle="se"></span>',R.appendChild(L)})}function pe(){const e=h.dataset.maxEntries??(A==null?void 0:A.dataset.maxEntries)??"";if(e==="")return null;const t=parseInt(e,10);return Number.isNaN(t)?null:t}function ce(){if(!A)return;const e=pe(),t=h.querySelectorAll(":scope > .signature-box-item").length;e!==null&&t>=e?A.style.display="none":A.style.display=""}function me(e,t,n,r,o){const a=pe(),s=h.querySelectorAll(":scope > .signature-box-item").length;if(a!==null&&s>=a){console.log("[PdfSignable] Box add skipped: max_entries reached",{max:a,currentCount:s});return}const u=r??150,l=o??40,i=document.getElementById("signature-boxes-empty");i&&i.classList.add("d-none");const c=h.dataset.prototype??"",d=h.querySelectorAll(":scope > .signature-box-item").length,g=c.replace(/__name__/g,String(d)),f=document.createElement("div");f.innerHTML=g;const v=f.firstElementChild;if(!v)return;v.dataset.index=String(d);const O=v.querySelector(".signature-box-page");O&&(O.value=String(e));const m=D[e],w=G(),N=ie(),_=u,F=l,R=m?m.scale:1.5,M=m?m.width/R:595,X=m?m.height/R:842;let y,E;switch(N){case"top_left":y=t,E=X-n-F;break;case"top_right":y=M-t-_,E=X-n-F;break;case"bottom_right":y=M-t-_,E=n;break;default:y=t,E=n;break}const I=J=>Math.round(J*100)/100,$=v.querySelector(".signature-box-name");for(const J of["x","y","width","height"]){const Q=v.querySelector(".signature-box-"+J);Q&&(J==="x"?Q.value=String(I(V(y,w))):J==="y"?Q.value=String(I(V(E,w))):J==="width"?Q.value=String(I(V(_,w))):J==="height"&&(Q.value=String(I(V(F,w)))))}const j=v.querySelector(".signature-box-angle");j&&(j.value="0"),$&&($.value=b.default_box_name),h.appendChild(v),v.scrollIntoView({behavior:"smooth"}),C(),ce(),console.log("[PdfSignable] Box added",{page:e,x:y,y:E,width:u,height:l,unit:w})}q&&q.addEventListener("click",()=>ge());const fe=document.getElementById("unitBadge"),Ne={pt:"pt",mm:"mm",cm:"cm",px:"px",in:"in"};function he(){fe&&(fe.textContent=Ne[G()]??G())}he();let ye=G();if(ne&&ne.addEventListener("change",()=>{const e=ye,t=G();he(),h.querySelectorAll(":scope > .signature-box-item").forEach(n=>{for(const r of["x","y","width","height"]){const o=n.querySelector(".signature-box-"+r);if(o!=null&&o.value){const a=parseFloat(o.value);o.value=String(Math.round(V(te(a,e),t)*100)/100)}}}),ye=t,C()}),h.addEventListener("input",C),h.addEventListener("change",e=>{const t=e.target.closest(".signature-box-item"),n=t==null?void 0:t.querySelector(".signature-box-name");if(n&&e.target===n&&Object.keys(Z).length>0){const r=(n.value??"").trim(),o=r?Z[r]:null;if(o){const a=(s,u)=>{const l=t==null?void 0:t.querySelector(".signature-box-"+s);l&&u!==void 0&&(l.value=String(u))};a("width",o.width),a("height",o.height),a("x",o.x),a("y",o.y),a("angle",o.angle)}}C()}),oe&&oe.addEventListener("change",C),h.addEventListener("click",e=>{if(!e.target.closest(".remove-box"))return;const t=e.target.closest(".signature-box-item");if(t){let n=t;for(;n!=null&&n.parentElement&&n.parentElement!==h;)n=n.parentElement;if(n){const r=Array.from(h.querySelectorAll(":scope > .signature-box-item")).indexOf(n);n.remove(),console.log("[PdfSignable] Box removed",{index:r})}}if(h.querySelectorAll(":scope > .signature-box-item").length===0){const n=document.getElementById("signature-boxes-empty");n&&n.classList.remove("d-none")}C(),ce()}),z){let e,t=!1,n=0;new ResizeObserver(()=>{if(t)return;const o=(z==null?void 0:z.clientWidth)??0;Math.abs(o-n)<10||(n=o,clearTimeout(e),e=setTimeout(async()=>{if(!(!W||H.style.display==="none")&&!t){t=!0;try{const a=await de();H.innerHTML="",Object.keys(D).forEach(s=>delete D[Number(s)]);for(let s=1;s<=W.numPages;s++){K&&await K;const u=await W.getPage(s),l=u.getViewport({scale:a});D[s]=l;const i=document.createElement("div");i.className="pdf-page-wrapper",i.dataset.page=String(s);const c=document.createElement("canvas"),d=c.getContext("2d");if(!d)continue;c.height=l.height,c.width=l.width,c.dataset.page=String(s);const g=document.createElement("div");g.className="signature-overlays",i.appendChild(c),i.appendChild(g),K=u.render({canvasContext:d,viewport:l}).promise,await K,H.appendChild(i)}C(),z&&(n=z.clientWidth)}finally{t=!1}}},200))}).observe(z)}function xe(){var e;(e=B==null?void 0:B.value)!=null&&e.trim()&&(console.log("[PdfSignable] Auto-loading PDF (preset URL)"),ge())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",xe):xe(),H.addEventListener("click",e=>{if(e.target.closest(".signature-box-overlay"))return;const t=e.target.closest(".pdf-page-wrapper"),n=t==null?void 0:t.querySelector("canvas");if(!n||!W)return;const r=parseInt(n.dataset.page??"1",10),o=D[r];if(!o)return;const a=n.getBoundingClientRect(),s=n.width/a.width,u=n.height/a.height,l=(e.clientX-a.left)*s,i=(e.clientY-a.top)*u,c=40,d=c*(o.scale||1.5),g=o.convertToPdfPoint(l,i+d);me(r,g[0],g[1],150,c)});function Re(e,t){if(e.page!==t.page)return!1;const n=e.x+e.w,r=t.x+t.w,o=e.y+e.h,a=t.y+t.h;return e.x<r&&t.x<n&&e.y<a&&t.y<o}function Xe(){const e=h.querySelectorAll(":scope > .signature-box-item"),t=[];return e.forEach(n=>{var i,c,d,g;const r=n.querySelector(".signature-box-page"),o=parseInt((r==null?void 0:r.value)??"1",10),a=parseFloat(((i=n.querySelector(".signature-box-x"))==null?void 0:i.value)??"0"),s=parseFloat(((c=n.querySelector(".signature-box-y"))==null?void 0:c.value)??"0"),u=parseFloat(((d=n.querySelector(".signature-box-width"))==null?void 0:d.value)??"150"),l=parseFloat(((g=n.querySelector(".signature-box-height"))==null?void 0:g.value)??"40");t.push({page:o,x:a,y:s,w:u,h:l})}),t}let S=null,ae=null;function ve(e){if(!ae)return;const{overlay:t,item:n,centerX:r,centerY:o,startAngle:a,startMouseAngle:s}=ae;let l=(Math.atan2(e.clientY-o,e.clientX-r)-s)*180/Math.PI,i=a+l;for(;i>180;)i-=360;for(;i<-180;)i+=360;const c=n.querySelector(".signature-box-angle");c&&(c.value=String(Math.round(i*100)/100)),t.style.transform=`rotate(${i}deg)`}function be(){ae&&(document.removeEventListener("mousemove",ve),document.removeEventListener("mouseup",be),ae=null)}function Ue(e){var w,N;const t=e.target.closest(".signature-box-overlay");if(!((w=t==null?void 0:t.dataset)!=null&&w.boxIndex))return;e.preventDefault(),e.stopPropagation();const n=e.target.closest(".rotate-handle");if(T&&n){const _=parseInt(t.dataset.boxIndex,10),F=h.querySelectorAll(":scope > .signature-box-item")[_];if(!F)return;const R=F.querySelector(".signature-box-angle");if(!R)return;const M=t.getBoundingClientRect(),X=M.left+M.width/2,y=M.top+M.height/2,E=parseFloat(R.value)||0,I=Math.atan2(e.clientY-y,e.clientX-X);ae={overlay:t,item:F,centerX:X,centerY:y,startAngle:E,startMouseAngle:I},document.addEventListener("mousemove",ve),document.addEventListener("mouseup",be);return}const r=e.target.closest(".resize-handle"),o=parseInt(t.dataset.boxIndex,10),a=h.querySelectorAll(":scope > .signature-box-item")[o];if(!a)return;const s=t.closest(".pdf-page-wrapper"),u=parseInt(((N=s==null?void 0:s.dataset)==null?void 0:N.page)??"1",10),l=D[u];if(!l)return;const i=parseFloat(t.style.width)||20,c=parseFloat(t.style.height)||14,d=parseFloat(t.style.left)||0,g=parseFloat(t.style.top)||0,f=a.querySelector(".signature-box-x"),v=a.querySelector(".signature-box-y"),O=a.querySelector(".signature-box-width"),m=a.querySelector(".signature-box-height");S={mode:r?"resize":"move",handle:r?r.dataset.handle??null:null,overlay:t,item:a,boxIndex:o,viewport:l,startX:e.clientX,startY:e.clientY,startLeft:d,startTop:g,startRight:d+i,startBottom:g+c,startFormX:f&&parseFloat(f.value)||0,startFormY:v&&parseFloat(v.value)||0,startFormW:O&&parseFloat(O.value)||150,startFormH:m&&parseFloat(m.value)||40},t.classList.add("dragging"),le=!0,document.addEventListener("mousemove",Se),document.addEventListener("mouseup",we)}function Se(e){if(!S)return;const{overlay:t,viewport:n,startLeft:r,startTop:o,startRight:a,startBottom:s}=S,u=e.clientX-S.startX,l=e.clientY-S.startY,i=20;let c,d,g,f;if(S.mode==="move")c=Math.max(0,Math.min(n.width-(a-r),r+u)),d=Math.max(0,Math.min(n.height-(s-o),o+l)),g=a-r,f=s-o;else{const y=S.handle;let E=r,I=o,$=a,j=s;y==="se"?($=Math.min(n.width,Math.max(r+i,a+u)),j=Math.min(n.height,Math.max(o+i,s+l))):y==="sw"?(E=Math.max(0,Math.min(a-i,r+u)),j=Math.min(n.height,Math.max(o+i,s+l))):y==="ne"?($=Math.min(n.width,Math.max(r+i,a+u)),I=Math.max(0,Math.min(s-i,o+l))):y==="nw"&&(E=Math.max(0,Math.min(a-i,r+u)),I=Math.max(0,Math.min(s-i,o+l))),c=E,d=I,g=$-E,f=j-I}t.style.left=c+"px",t.style.top=d+"px",t.style.width=g+"px",t.style.height=f+"px";const v=n.scale||1.5,O=g/v,m=f/v,w=He(n,c,d,O,m,ie()),N=G(),_=y=>Math.round(y*100)/100,F=S.item.querySelector(".signature-box-x"),R=S.item.querySelector(".signature-box-y"),M=S.item.querySelector(".signature-box-width"),X=S.item.querySelector(".signature-box-height");F&&(F.value=String(_(V(w.xPt,N)))),R&&(R.value=String(_(V(w.yPt,N)))),M&&(M.value=String(_(V(O,N)))),X&&(X.value=String(_(V(m,N))))}function we(){if(!S)return;const e=S;if(S.overlay.classList.remove("dragging"),le=!1,document.removeEventListener("mousemove",Se),document.removeEventListener("mouseup",we),P){const t=Xe(),n=t[e.boxIndex];if(n&&t.some((o,a)=>a!==e.boxIndex&&Re(n,o))){const o=c=>Math.round(c*100)/100,a=e.item.querySelector(".signature-box-x"),s=e.item.querySelector(".signature-box-y"),u=e.item.querySelector(".signature-box-width"),l=e.item.querySelector(".signature-box-height");a&&(a.value=String(o(e.startFormX))),s&&(s.value=String(o(e.startFormY))),u&&(u.value=String(o(e.startFormW))),l&&(l.value=String(o(e.startFormH)));const i=b.no_overlap_message??"Signature boxes on the same page cannot overlap.";alert(i)}}S=null,C()}H.addEventListener("mousedown",Ue),A&&A.addEventListener("click",()=>me(1,0,0)),ce(),k.addEventListener("submit",e=>{e.preventDefault(),h.querySelectorAll(":scope > .signature-box-item").forEach((n,r)=>{n.querySelectorAll("input, select, textarea").forEach(o=>{o.name=o.name.replace(/(\])\[\d+\](\[)/,`$1[${r}]$2`)})}),k.submit()})}Te()})();
