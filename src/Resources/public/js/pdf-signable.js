(function(){"use strict";const Be={pt:1,mm:.35277777777777775,cm:.035277777777777776,in:.013888888888888888,px:1.3333333333333333};function D(b,K){return b*(Be[K]??1)}function H(b,K){return b/(Be[K]??1)}function Ve(b){return String(b).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const je=220,Ke=37,Ge=65,Je=48;function Qe(b,K,L){b=b%360,b<0&&(b+=360);const pe=K/100,R=L/100,Y=(1-Math.abs(2*R-1))*pe,f=Y*(1-Math.abs(b/60%2-1)),Q=R-Y/2;let le=0,G=0,J=0;b<60?(le=Y,G=f):b<120?(le=f,G=Y):b<180?(G=Y,J=f):b<240?(G=f,J=Y):b<300?(le=f,J=Y):(le=Y,J=f);const F=Me=>{const we=Math.round((Me+Q)*255);return(we<16?"0":"")+Math.min(255,Math.max(0,we)).toString(16)};return"#"+F(le)+F(G)+F(J)}function Ze(b){const K=(je+b*Ke)%360,L=Qe(K,Ge,Je),pe=parseInt(L.slice(1,3),16),R=parseInt(L.slice(3,5),16),Y=parseInt(L.slice(5,7),16);return{border:L,background:`rgba(${pe}, ${R}, ${Y}, 0.15)`,color:L,handle:L}}function et(){const b=window.NowoPdfSignableConfig;if(!b){console.warn("[PdfSignable] NowoPdfSignableConfig not found, skipping init");return}const{proxyUrl:K,strings:L,debug:pe=!1}=b,R=(...e)=>{pe&&console.log("[PdfSignable]",...e)},Y=(...e)=>{pe&&console.warn("[PdfSignable]",...e)},f=document.querySelector(".nowo-pdf-signable-widget"),Q=f==null?void 0:f.closest("form");if(!Q){Y(".nowo-pdf-signable-widget or form not found, skipping init");return}const le=(f==null?void 0:f.dataset.preventBoxOverlap)==="1",G=(f==null?void 0:f.dataset.enableRotation)==="1";let J={};try{const e=(f==null?void 0:f.dataset.boxDefaultsByName)??"{}";J=typeof e=="string"?JSON.parse(e):{}}catch{J={}}const F=Math.max(0,parseFloat((f==null?void 0:f.dataset.snapGrid)??"0")||0),Me=(f==null?void 0:f.dataset.snapToBoxes)==="1",we=10;R("Initialized");const ge=Q.querySelector(".pdf-url-input"),ne=document.getElementById("loadPdfBtn"),Ee=document.getElementById("pdf-placeholder"),_e=document.getElementById("pdf-canvas-wrapper"),Ce=document.getElementById("signature-boxes-list"),oe=document.getElementById("addBoxBtn"),fe=Q.querySelector(".unit-selector"),ye=Q.querySelector(".origin-selector"),m=document.getElementById("pdf-viewer-container");if(!_e||!Ce)return;const q=_e,x=Ce;let ie=1,se={x:0,y:0},S=null;const tt=80;function nt(){if(!P||!m)return;const e=m.querySelector("#pdf-thumbnails-strip"),t=m.querySelector(".pdf-viewer-scroll");!e||!t||(async()=>{for(let s=1;s<=P.numPages;s++){const o=await P.getPage(s),r=o.getViewport({scale:1}),a=tt/r.width,u=o.getViewport({scale:a}),l=document.createElement("canvas");l.width=u.width,l.height=u.height;const i=l.getContext("2d");if(!i)continue;await o.render({canvasContext:i,viewport:u}).promise;const c=document.createElement("button");c.type="button",c.className="pdf-thumb",c.dataset.page=String(s),c.setAttribute("aria-label","Page "+s),c.appendChild(l),c.addEventListener("click",()=>{const d=q.querySelector('.pdf-page-wrapper[data-page="'+s+'"]');d&&(d.scrollIntoView({behavior:"smooth",block:"start"}),e.querySelectorAll(".pdf-thumb.current").forEach(p=>p.classList.remove("current")),c.classList.add("current"))}),e.appendChild(c)}const n=()=>{const s=e,o=q.querySelectorAll(".pdf-page-wrapper");if(o.length===0)return;const r=t.getBoundingClientRect(),a=r.top+r.height/2;let u=1,l=1/0;o.forEach(c=>{const d=parseInt(c.dataset.page??"1",10),p=c.getBoundingClientRect(),g=p.top+p.height/2,h=Math.abs(g-a);h<l&&(l=h,u=d)}),s.querySelectorAll(".pdf-thumb.current").forEach(c=>c.classList.remove("current"));const i=s.querySelector('.pdf-thumb[data-page="'+u+'"]');i&&i.classList.add("current")};t.addEventListener("scroll",n),requestAnimationFrame(n),e.firstElementChild&&e.firstElementChild.classList.add("current")})()}function ot(){S||!m||(S=document.createElement("div"),S.id="pdf-touch-wrapper",S.style.transformOrigin="0 0",S.style.transform=`translate(${se.x}px, ${se.y}px) scale(${ie})`,m.insertBefore(S,q),S.appendChild(q),st())}function st(){if(!S)return;let e=0,t=1,n={x:0,y:0},s=0,o=0;S.addEventListener("touchstart",r=>{if(r.touches.length===2){r.preventDefault();const a=r.touches[0],u=r.touches[1];e=Math.hypot(u.clientX-a.clientX,u.clientY-a.clientY),t=ie,n={...se},s=(a.clientX+u.clientX)/2,o=(a.clientY+u.clientY)/2}},{passive:!1}),S.addEventListener("touchmove",r=>{if(r.touches.length===2&&S){r.preventDefault();const a=r.touches[0],u=r.touches[1],l=Math.hypot(u.clientX-a.clientX,u.clientY-a.clientY),i=Math.max(.25,Math.min(4,t*l/e)),c=(a.clientX+u.clientX)/2,d=(a.clientY+u.clientY)/2;se.x=n.x+(c-s),se.y=n.y+(d-o),ie=i,S.style.transform=`translate(${se.x}px, ${se.y}px) scale(${ie})`}},{passive:!1})}function Z(){return(fe==null?void 0:fe.value)??"mm"}function me(){return(ye==null?void 0:ye.value)??"bottom_left"}function Le(e,t,n,s,o,r){const a=e.scale||1.5,u=e.width/a,l=e.height/a;let i,c;switch(r){case"top_left":i=t,c=l-n-o;break;case"top_right":i=u-t-s,c=l-n-o;break;case"bottom_right":i=u-t-s,c=n;break;default:i=t,c=n;break}return{vpX:i*a,vpY:e.height-(c+o)*a}}function Fe(e,t,n,s,o,r){const a=e.scale||1.5,u=e.width/a,l=e.height/a,i=e.convertToPdfPoint(t,n+o*a),c=i[0],d=i[1];let p,g;switch(r){case"top_left":p=c,g=l-d-o;break;case"top_right":p=u-c-s,g=l-d-o;break;case"bottom_right":p=u-c-s,g=d;break;default:p=c,g=d;break}return{xPt:p,yPt:g}}let P=null;const N={};let ae=null,Ie=!1;function at(e){try{return new URL(e,window.location.origin).origin===window.location.origin?e:K+"?url="+encodeURIComponent(e)}catch{return K+"?url="+encodeURIComponent(e)}}function rt(){if(!m||!S||m.querySelector(".pdf-viewer-scroll"))return;const t=document.createElement("div");t.id="pdf-thumbnails-strip",t.setAttribute("aria-label","Page thumbnails");const n=document.createElement("div");n.className="pdf-viewer-scroll",n.appendChild(S),m.appendChild(n),m.insertBefore(t,n)}async function Pe(){if(!P||!m)return 1.5;const t=(await P.getPage(1)).getViewport({scale:1}),n=m.querySelector(".pdf-viewer-scroll"),s=n?n.clientWidth-24:m.clientWidth-24,o=Math.max(0,s);return o<=0?1.5:Math.max(.5,o/t.width)}async function Ae(){var r;const e=((r=ge==null?void 0:ge.value)==null?void 0:r.trim())??"";if(!e){Y("Load PDF: URL required"),alert(L.alert_url_required);return}const t=at(e);R("Loading PDF",{url:e,viaProxy:t!==e}),ne&&(ne.setAttribute("disabled",""),ne.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> '+L.loading_state),Ee&&(Ee.style.display="block"),q.style.display="none",q.innerHTML="";const n=m==null?void 0:m.querySelector("#pdf-thumbnails-strip"),s=m==null?void 0:m.querySelector(".pdf-viewer-scroll");s&&S&&S.parentElement===s&&(s.removeChild(S),m==null||m.appendChild(S)),n==null||n.remove(),s==null||s.remove(),ie=1,se={x:0,y:0},S&&(S.style.transform="translate(0px, 0px) scale(1)");const o=document.createElement("div");o.className="pdf-signable-loading-overlay",o.setAttribute("aria-live","polite"),o.setAttribute("aria-busy","true"),o.innerHTML='<div class="text-center"><div class="spinner-border text-primary mb-2" role="status"><span class="visually-hidden">'+L.loading_state+'</span></div><p class="text-muted small mb-0">'+L.loading_state+"</p></div>",m&&m.appendChild(o);try{P=await pdfjsLib.getDocument(t).promise,Object.keys(N).forEach(l=>delete N[Number(l)]),ot(),rt();const a=await Pe();for(let l=1;l<=P.numPages;l++){ae&&await ae;const i=await P.getPage(l),c=i.getViewport({scale:a});N[l]=c;const d=document.createElement("div");d.className="pdf-page-wrapper",d.dataset.page=String(l);const p=document.createElement("canvas"),g=p.getContext("2d");if(!g)continue;p.height=c.height,p.width=c.width,p.dataset.page=String(l);const h=document.createElement("div");h.className="signature-overlays",d.appendChild(p),d.appendChild(h),ae=i.render({canvasContext:g,viewport:c}).promise,await ae,q.appendChild(d)}Ee&&(Ee.style.display="none"),q.style.display="block",nt(),requestAnimationFrame(()=>{A(),setTimeout(A,100),setTimeout(A,350),setTimeout(A,700)}),R("PDF loaded",{pages:P.numPages,scale:a})}catch(a){R("PDF load failed",a),alert(L.error_load_pdf+(a instanceof Error?a.message:String(a)))}finally{o.remove(),ne&&(ne.removeAttribute("disabled"),ne.innerHTML=L.load_pdf_btn)}}function A(){if(Ie||Object.keys(N).length===0)return;const e=Z(),t=me();q.querySelectorAll(".signature-overlays").forEach(a=>{a.innerHTML=""});const n=x.querySelectorAll(":scope > .signature-box-item"),s={},o={};let r=0;if(n.forEach((a,u)=>{var ce,ue,he,X,de;const l=parseInt(((ce=a.querySelector(".signature-box-page"))==null?void 0:ce.value)??"1",10),i=parseFloat(((ue=a.querySelector(".signature-box-x"))==null?void 0:ue.value)??"0"),c=parseFloat(((he=a.querySelector(".signature-box-y"))==null?void 0:he.value)??"0"),d=parseFloat(((X=a.querySelector(".signature-box-width"))==null?void 0:X.value)??"150"),p=parseFloat(((de=a.querySelector(".signature-box-height"))==null?void 0:de.value)??"40"),g=a.querySelector(".signature-box-angle"),h=G&&g?parseFloat(g.value??"0"):0,T=a.querySelector(".signature-box-name"),w=((T==null?void 0:T.value)??"").trim(),B=w===""?"__empty__":w;B in o||(o[B]=r++);const te=o[B];s[w]=(s[w]??0)+1;const W=s[w],_=w===""?"":w+(W>1?` (${W})`:""),V=q.querySelector(`.pdf-page-wrapper[data-page="${l}"] .signature-overlays`),k=N[l];if(!V||!k)return;const j=k.scale||1.5,O=H(i,e),$=H(c,e),z=H(d,e),M=H(p,e),C=Le(k,O,$,z,M,t),E=z*j,v=M*j,y=document.createElement("div");y.className="signature-box-overlay",y.dataset.boxIndex=String(u),y.style.left=C.vpX+"px",y.style.top=C.vpY+"px",y.style.width=Math.max(E,20)+"px",y.style.height=Math.max(v,14)+"px";const U=Ze(te);y.style.borderColor=U.border,y.style.backgroundColor=U.background,y.style.color=U.color,y.style.setProperty("--box-color",U.handle),y.style.transformOrigin="50% 50%",G&&(y.style.transform=`rotate(${h}deg)`);const re=G?'<span class="rotate-handle" title="Rotate"></span>':"";y.innerHTML=(_?'<span class="overlay-label">'+Ve(_)+"</span>":"")+re+'<span class="resize-handle nw" data-handle="nw"></span><span class="resize-handle ne" data-handle="ne"></span><span class="resize-handle sw" data-handle="sw"></span><span class="resize-handle se" data-handle="se"></span>',V.appendChild(y)}),ee!==null){const a=q.querySelector(`.signature-box-overlay[data-box-index="${ee}"]`);a&&a.classList.add("selected")}}function Te(){const e=x.dataset.maxEntries??(oe==null?void 0:oe.dataset.maxEntries)??"";if(e==="")return null;const t=parseInt(e,10);return Number.isNaN(t)?null:t}function xe(){if(!oe)return;const e=Te(),t=x.querySelectorAll(":scope > .signature-box-item").length;e!==null&&t>=e?oe.style.display="none":oe.style.display=""}function qe(e,t,n,s,o){const r=Te(),a=x.querySelectorAll(":scope > .signature-box-item").length;if(r!==null&&a>=r){R("Box add skipped: max_entries reached",{max:r,currentCount:a});return}const u=s??150,l=o??40,i=document.getElementById("signature-boxes-empty");i&&i.classList.add("d-none");const c=x.dataset.prototype??"",d=x.querySelectorAll(":scope > .signature-box-item").length,p=c.replace(/__name__/g,String(d)),g=document.createElement("div");g.innerHTML=p;const h=g.firstElementChild;if(!h)return;h.dataset.index=String(d);const T=h.querySelector(".signature-box-page");T&&(T.value=String(e));const w=N[e],B=Z(),te=me(),W=u,_=l,V=w?w.scale:1.5,k=w?w.width/V:595,j=w?w.height/V:842;let O,$;switch(te){case"top_left":O=t,$=j-n-_;break;case"top_right":O=k-t-W,$=j-n-_;break;case"bottom_right":O=k-t-W,$=n;break;default:O=t,$=n;break}const z=E=>Math.round(E*100)/100,M=h.querySelector(".signature-box-name");for(const E of["x","y","width","height"]){const v=h.querySelector(".signature-box-"+E);v&&(E==="x"?v.value=String(z(D(O,B))):E==="y"?v.value=String(z(D($,B))):E==="width"?v.value=String(z(D(W,B))):E==="height"&&(v.value=String(z(D(_,B)))))}const C=h.querySelector(".signature-box-angle");C&&(C.value="0"),M&&(M.value=L.default_box_name),x.appendChild(h),h.scrollIntoView({behavior:"smooth"}),A(),xe(),R("Box added",{page:e,x:O,y:$,width:u,height:l,unit:B})}ne&&ne.addEventListener("click",()=>Ae());const ke=document.getElementById("unitBadge"),ct={pt:"pt",mm:"mm",cm:"cm",px:"px",in:"in"};function Oe(){ke&&(ke.textContent=ct[Z()]??Z())}Oe();let Xe=Z();if(fe&&fe.addEventListener("change",()=>{const e=Xe,t=Z();Oe(),x.querySelectorAll(":scope > .signature-box-item").forEach(n=>{for(const s of["x","y","width","height"]){const o=n.querySelector(".signature-box-"+s);if(o!=null&&o.value){const r=parseFloat(o.value);o.value=String(Math.round(D(H(r,e),t)*100)/100)}}}),Xe=t,A()}),x.addEventListener("input",A),x.addEventListener("change",e=>{const t=e.target.closest(".signature-box-item"),n=t==null?void 0:t.querySelector(".signature-box-name");if(n&&e.target===n&&Object.keys(J).length>0){const s=(n.value??"").trim(),o=s?J[s]:null;if(o){const r=(a,u)=>{const l=t==null?void 0:t.querySelector(".signature-box-"+a);l&&u!==void 0&&(l.value=String(u))};r("width",o.width),r("height",o.height),r("x",o.x),r("y",o.y),r("angle",o.angle)}}A()}),ye&&ye.addEventListener("change",A),x.addEventListener("click",e=>{if(!e.target.closest(".remove-box"))return;const t=e.target.closest(".signature-box-item");if(t){let n=t;for(;n!=null&&n.parentElement&&n.parentElement!==x;)n=n.parentElement;if(n){const s=Array.from(x.querySelectorAll(":scope > .signature-box-item")).indexOf(n);n.remove(),R("Box removed",{index:s})}}if(x.querySelectorAll(":scope > .signature-box-item").length===0){const n=document.getElementById("signature-boxes-empty");n&&n.classList.remove("d-none")}A(),xe()}),m){let e,t=!1,n=0;new ResizeObserver(()=>{if(t)return;const o=(m==null?void 0:m.clientWidth)??0;Math.abs(o-n)<10||(n=o,clearTimeout(e),e=setTimeout(async()=>{if(!(!P||q.style.display==="none")&&!t){t=!0;try{const r=await Pe();q.innerHTML="",Object.keys(N).forEach(a=>delete N[Number(a)]);for(let a=1;a<=P.numPages;a++){ae&&await ae;const u=await P.getPage(a),l=u.getViewport({scale:r});N[a]=l;const i=document.createElement("div");i.className="pdf-page-wrapper",i.dataset.page=String(a);const c=document.createElement("canvas"),d=c.getContext("2d");if(!d)continue;c.height=l.height,c.width=l.width,c.dataset.page=String(a);const p=document.createElement("div");p.className="signature-overlays",i.appendChild(c),i.appendChild(p),ae=u.render({canvasContext:d,viewport:l}).promise,await ae,q.appendChild(i)}A(),m&&(n=m.clientWidth)}finally{t=!1}}},200))}).observe(m)}function De(){var e;(e=ge==null?void 0:ge.value)!=null&&e.trim()&&(R("Auto-loading PDF (preset URL)"),Ae())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",De):De(),q.addEventListener("click",e=>{if(e.target.closest(".signature-box-overlay"))return;ve(null);const t=e.target.closest(".pdf-page-wrapper"),n=t==null?void 0:t.querySelector("canvas");if(!n||!P)return;const s=parseInt(n.dataset.page??"1",10),o=N[s];if(!o)return;const r=n.getBoundingClientRect(),a=n.width/r.width,u=n.height/r.height,l=(e.clientX-r.left)*a,i=(e.clientY-r.top)*u,c=40,d=c*(o.scale||1.5),p=o.convertToPdfPoint(l,i+d);qe(s,p[0],p[1],150,c)});function lt(e,t){if(e.page!==t.page)return!1;const n=e.x+e.w,s=t.x+t.w,o=e.y+e.h,r=t.y+t.h;return e.x<s&&t.x<n&&e.y<r&&t.y<o}function He(){const e=x.querySelectorAll(":scope > .signature-box-item"),t=[];return e.forEach(n=>{var i,c,d,p;const s=n.querySelector(".signature-box-page"),o=parseInt((s==null?void 0:s.value)??"1",10),r=parseFloat(((i=n.querySelector(".signature-box-x"))==null?void 0:i.value)??"0"),a=parseFloat(((c=n.querySelector(".signature-box-y"))==null?void 0:c.value)??"0"),u=parseFloat(((d=n.querySelector(".signature-box-width"))==null?void 0:d.value)??"150"),l=parseFloat(((p=n.querySelector(".signature-box-height"))==null?void 0:p.value)??"40");t.push({page:o,x:r,y:a,w:u,h:l})}),t}function it(e,t){const n=N[e];if(!n)return[];const s=Z(),o=me(),r=n.scale||1.5,a=He(),u=[];return a.forEach((l,i)=>{if(i===t||l.page!==e)return;const c=H(l.x,s),d=H(l.y,s),p=H(l.w,s),g=H(l.h,s),{vpX:h,vpY:T}=Le(n,c,d,p,g,o);u.push({left:h,top:T,right:h+p*r,bottom:T+g*r})}),u}let I=null,ee=null;function ve(e){if(ee=e,q.querySelectorAll(".signature-box-overlay.selected").forEach(t=>t.classList.remove("selected")),e!==null){const t=q.querySelector(`.signature-box-overlay[data-box-index="${e}"]`);t&&t.classList.add("selected")}}let be=null;function Re(e){if(!be)return;const{overlay:t,item:n,centerX:s,centerY:o,startAngle:r,startMouseAngle:a}=be;let l=(Math.atan2(e.clientY-o,e.clientX-s)-a)*180/Math.PI,i=r+l;for(;i>180;)i-=360;for(;i<-180;)i+=360;const c=n.querySelector(".signature-box-angle");c&&(c.value=String(Math.round(i*100)/100)),t.style.transform=`rotate(${i}deg)`}function Ye(){be&&(document.removeEventListener("mousemove",Re),document.removeEventListener("mouseup",Ye),be=null)}function ut(e){var B,te;const t=e.target.closest(".signature-box-overlay");if(!((B=t==null?void 0:t.dataset)!=null&&B.boxIndex))return;e.preventDefault(),e.stopPropagation();const n=e.target.closest(".rotate-handle");if(G&&n){const W=parseInt(t.dataset.boxIndex,10),_=x.querySelectorAll(":scope > .signature-box-item")[W];if(!_)return;const V=_.querySelector(".signature-box-angle");if(!V)return;const k=t.getBoundingClientRect(),j=k.left+k.width/2,O=k.top+k.height/2,$=parseFloat(V.value)||0,z=Math.atan2(e.clientY-O,e.clientX-j);be={overlay:t,item:_,centerX:j,centerY:O,startAngle:$,startMouseAngle:z},document.addEventListener("mousemove",Re),document.addEventListener("mouseup",Ye);return}const s=e.target.closest(".resize-handle"),o=parseInt(t.dataset.boxIndex,10),r=x.querySelectorAll(":scope > .signature-box-item")[o];if(!r)return;const a=t.closest(".pdf-page-wrapper"),u=parseInt(((te=a==null?void 0:a.dataset)==null?void 0:te.page)??"1",10),l=N[u];if(!l)return;const i=parseFloat(t.style.width)||20,c=parseFloat(t.style.height)||14,d=parseFloat(t.style.left)||0,p=parseFloat(t.style.top)||0,g=r.querySelector(".signature-box-x"),h=r.querySelector(".signature-box-y"),T=r.querySelector(".signature-box-width"),w=r.querySelector(".signature-box-height");I={mode:s?"resize":"move",handle:s?s.dataset.handle??null:null,overlay:t,item:r,boxIndex:o,viewport:l,startX:e.clientX,startY:e.clientY,startLeft:d,startTop:p,startRight:d+i,startBottom:p+c,startFormX:g&&parseFloat(g.value)||0,startFormY:h&&parseFloat(h.value)||0,startFormW:T&&parseFloat(T.value)||150,startFormH:w&&parseFloat(w.value)||40},t.classList.add("dragging"),Ie=!0,I.mode==="move"&&ve(o),document.addEventListener("mousemove",Ne),document.addEventListener("mouseup",We)}function Ne(e){var $,z;if(!I)return;const{overlay:t,viewport:n,startLeft:s,startTop:o,startRight:r,startBottom:a}=I,u=(e.clientX-I.startX)/ie,l=(e.clientY-I.startY)/ie,i=20;let c,d,p,g;if(I.mode==="move")c=Math.max(0,Math.min(n.width-(r-s),s+u)),d=Math.max(0,Math.min(n.height-(a-o),o+l)),p=r-s,g=a-o;else{const M=I.handle;let C=s,E=o,v=r,y=a;M==="se"?(v=Math.min(n.width,Math.max(s+i,r+u)),y=Math.min(n.height,Math.max(o+i,a+l))):M==="sw"?(C=Math.max(0,Math.min(r-i,s+u)),y=Math.min(n.height,Math.max(o+i,a+l))):M==="ne"?(v=Math.min(n.width,Math.max(s+i,r+u)),E=Math.max(0,Math.min(a-i,o+l))):M==="nw"&&(C=Math.max(0,Math.min(r-i,s+u)),E=Math.max(0,Math.min(a-i,o+l))),c=C,d=E,p=v-C,g=y-E}const h=n.scale||1.5,T=parseInt(((z=($=t.closest(".pdf-page-wrapper"))==null?void 0:$.dataset)==null?void 0:z.page)??"1",10);if(F>0){const M=p/h,C=g/h,E=Fe(n,c,d,M,C,me()),v=Z();let y=D(E.xPt,v),U=D(E.yPt,v),re=D(M,v),ce=D(C,v);y=Math.round(y/F)*F,U=Math.round(U/F)*F,re=Math.round(re/F)*F,ce=Math.max(F,Math.round(ce/F)*F);const ue=H(y,v),he=H(U,v),X=H(re,v),de=H(ce,v),Se=Le(n,ue,he,X,de,me());c=Se.vpX,d=Se.vpY,p=X*h,g=de*h}if(Me){const M=it(T,I.boxIndex),C=c+p,E=d+g,v=M.flatMap(X=>[X.left,X.right]),y=M.flatMap(X=>[X.top,X.bottom]),U=(X,de)=>{let Se=X,$e=we;for(const Ue of de){const ze=Math.abs(X-Ue);ze<$e&&($e=ze,Se=Ue)}return Se},re=U(c,v),ce=U(C,v),ue=U(d,y),he=U(E,y);c=re,d=ue,p=Math.max(i,ce-re),g=Math.max(i,he-ue)}t.style.left=c+"px",t.style.top=d+"px",t.style.width=p+"px",t.style.height=g+"px";const w=p/h,B=g/h,te=Fe(n,c,d,w,B,me()),W=Z(),_=M=>Math.round(M*100)/100,V=I.item.querySelector(".signature-box-x"),k=I.item.querySelector(".signature-box-y"),j=I.item.querySelector(".signature-box-width"),O=I.item.querySelector(".signature-box-height");V&&(V.value=String(_(D(te.xPt,W)))),k&&(k.value=String(_(D(te.yPt,W)))),j&&(j.value=String(_(D(w,W)))),O&&(O.value=String(_(D(B,W))))}function We(){if(!I)return;const e=I;if(I.overlay.classList.remove("dragging"),Ie=!1,document.removeEventListener("mousemove",Ne),document.removeEventListener("mouseup",We),le){const t=He(),n=t[e.boxIndex];if(n&&t.some((o,r)=>r!==e.boxIndex&&lt(n,o))){const o=c=>Math.round(c*100)/100,r=e.item.querySelector(".signature-box-x"),a=e.item.querySelector(".signature-box-y"),u=e.item.querySelector(".signature-box-width"),l=e.item.querySelector(".signature-box-height");r&&(r.value=String(o(e.startFormX))),a&&(a.value=String(o(e.startFormY))),u&&(u.value=String(o(e.startFormW))),l&&(l.value=String(o(e.startFormH)));const i=L.no_overlap_message??"Signature boxes on the same page cannot overlap.";alert(i)}}I=null,A()}q.addEventListener("mousedown",ut),oe&&oe.addEventListener("click",()=>qe(1,0,0)),xe(),Q.addEventListener("keydown",e=>{const t=e.target;if(!(t!=null&&t.closest("input, select, textarea"))){if(e.ctrlKey&&e.key==="z"){e.preventDefault();const n=x.querySelectorAll(":scope > .signature-box-item");if(n.length>0){const s=n[n.length-1],o=Array.from(x.querySelectorAll(":scope > .signature-box-item")).indexOf(s);if(s.remove(),ee===o?ve(null):ee!==null&&ee>o&&ve(ee-1),x.querySelectorAll(":scope > .signature-box-item").length===0){const r=document.getElementById("signature-boxes-empty");r&&r.classList.remove("d-none")}A(),xe()}return}if(e.key==="Delete"||e.key==="Backspace"){if(ee===null)return;const s=x.querySelectorAll(":scope > .signature-box-item")[ee];if(s){if(e.preventDefault(),s.remove(),ve(null),x.querySelectorAll(":scope > .signature-box-item").length===0){const o=document.getElementById("signature-boxes-empty");o&&o.classList.remove("d-none")}A(),xe()}return}if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==="a"){if(e.preventDefault(),!P)return;const n=1,s=N[n];if(s){const o=s.scale||1.5,r=s.width/o,a=s.height/o;qe(n,(r-150)/2,(a-40)/2,150,40)}else qe(1,0,0)}}}),Q.addEventListener("submit",e=>{e.preventDefault(),x.querySelectorAll(":scope > .signature-box-item").forEach((n,s)=>{n.querySelectorAll("input, select, textarea").forEach(o=>{o.name=o.name.replace(/(\])\[\d+\](\[)/,`$1[${s}]$2`)})}),Q.submit()})}et()})();
