(function(){"use strict";const te={pt:1,mm:.35277777777777775,cm:.035277777777777776,in:.013888888888888888,px:1.3333333333333333};function I(C,R){return C*(te[R]??1)}function X(C,R){return C/(te[R]??1)}function me(C){return String(C).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function fe(){console.log("[PdfSignable] Script loaded");const C=window.NowoPdfSignableConfig;if(!C){console.warn("[PdfSignable] NowoPdfSignableConfig not found, skipping init");return}const{proxyUrl:R,strings:Y}=C,K=document.querySelector(".nowo-pdf-signable-widget"),V=K==null?void 0:K.closest("form");if(!V){console.warn("[PdfSignable] .nowo-pdf-signable-widget or form not found, skipping init");return}console.log("[PdfSignable] Initialized");const z=V.querySelector(".pdf-url-input"),F=document.getElementById("loadPdfBtn"),J=document.getElementById("pdf-placeholder"),ne=document.getElementById("pdf-canvas-wrapper"),oe=document.getElementById("signature-boxes-list"),A=document.getElementById("addBoxBtn"),j=V.querySelector(".unit-selector"),$=V.querySelector(".origin-selector"),T=document.getElementById("pdf-viewer-container");if(!ne||!oe)return;const S=ne,m=oe;function U(){return(j==null?void 0:j.value)??"mm"}function Q(){return($==null?void 0:$.value)??"bottom_left"}function he(t,n,e,o,a,s){const i=t.scale||1.5,d=t.width/i,c=t.height/i;let r,l;switch(s){case"top_left":r=n,l=c-e-a;break;case"top_right":r=d-n-o,l=c-e-a;break;case"bottom_right":r=d-n-o,l=e;break;default:r=n,l=e;break}return{vpX:r*i,vpY:t.height-(l+a)*i}}function ye(t,n,e,o,a,s){const i=t.scale||1.5,d=t.width/i,c=t.height/i,r=t.convertToPdfPoint(n,e+a*i),l=r[0],u=r[1];let g,p;switch(s){case"top_left":g=l,p=c-u-a;break;case"top_right":g=d-l-o,p=c-u-a;break;case"bottom_right":g=d-l-o,p=u;break;default:g=l,p=u;break}return{xPt:g,yPt:p}}let k=null;const E={};let D=null,Z=!1;function ve(t){try{return new URL(t,window.location.origin).origin===window.location.origin?t:R+"?url="+encodeURIComponent(t)}catch{return R+"?url="+encodeURIComponent(t)}}async function ae(){if(!k||!T)return 1.5;const n=(await k.getPage(1)).getViewport({scale:1}),e=T.clientWidth-24;return e<=0?1.5:Math.max(.5,e/n.width)}async function se(){var e;const t=((e=z==null?void 0:z.value)==null?void 0:e.trim())??"";if(!t){console.warn("[PdfSignable] Load PDF: URL required"),alert(Y.alert_url_required);return}const n=ve(t);console.log("[PdfSignable] Loading PDF",{url:t,viaProxy:n!==t}),F&&(F.setAttribute("disabled",""),F.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> '+Y.loading_state),J&&(J.style.display="block"),S.style.display="none",S.innerHTML="";try{k=await pdfjsLib.getDocument(n).promise,Object.keys(E).forEach(s=>delete E[Number(s)]);const o=await ae();for(let s=1;s<=k.numPages;s++){D&&await D;const i=await k.getPage(s),d=i.getViewport({scale:o});E[s]=d;const c=document.createElement("div");c.className="pdf-page-wrapper",c.dataset.page=String(s);const r=document.createElement("canvas"),l=r.getContext("2d");if(!l)continue;r.height=d.height,r.width=d.width,r.dataset.page=String(s);const u=document.createElement("div");u.className="signature-overlays",c.appendChild(r),c.appendChild(u),D=i.render({canvasContext:l,viewport:d}).promise,await D,S.appendChild(c)}J&&(J.style.display="none"),S.style.display="block",requestAnimationFrame(()=>{b(),setTimeout(b,100),setTimeout(b,350),setTimeout(b,700)}),console.log("[PdfSignable] PDF loaded",{pages:k.numPages,scale:o})}catch(o){console.error("[PdfSignable] PDF load failed",o),alert(Y.error_load_pdf+(o instanceof Error?o.message:String(o)))}finally{F&&(F.removeAttribute("disabled"),F.innerHTML=Y.load_pdf_btn)}}function b(){if(Z||Object.keys(E).length===0)return;const t=U(),n=Q();S.querySelectorAll(".signature-overlays").forEach(o=>{o.innerHTML=""}),m.querySelectorAll(":scope > .signature-box-item").forEach((o,a)=>{var H,f,v,w,B;const s=parseInt(((H=o.querySelector(".signature-box-page"))==null?void 0:H.value)??"1",10),i=parseFloat(((f=o.querySelector(".signature-box-x"))==null?void 0:f.value)??"0"),d=parseFloat(((v=o.querySelector(".signature-box-y"))==null?void 0:v.value)??"0"),c=parseFloat(((w=o.querySelector(".signature-box-width"))==null?void 0:w.value)??"150"),r=parseFloat(((B=o.querySelector(".signature-box-height"))==null?void 0:B.value)??"40"),l=o.querySelector(".signature-box-name"),u=(l==null?void 0:l.value)??"",g=S.querySelector(`.pdf-page-wrapper[data-page="${s}"] .signature-overlays`),p=E[s];if(!g||!p)return;const x=p.scale||1.5,O=X(i,t),L=X(d,t),M=X(c,t),_=X(r,t),P=he(p,O,L,M,_,n),N=M*x,W=_*x,y=document.createElement("div");y.className="signature-box-overlay",y.dataset.boxIndex=String(a),y.style.left=P.vpX+"px",y.style.top=P.vpY+"px",y.style.width=Math.max(N,20)+"px",y.style.height=Math.max(W,14)+"px",y.innerHTML=(u?'<span class="overlay-label">'+me(u)+"</span>":"")+'<span class="resize-handle nw" data-handle="nw"></span><span class="resize-handle ne" data-handle="ne"></span><span class="resize-handle sw" data-handle="sw"></span><span class="resize-handle se" data-handle="se"></span>',g.appendChild(y)})}function re(){const t=m.dataset.maxEntries??(A==null?void 0:A.dataset.maxEntries)??"";if(t==="")return null;const n=parseInt(t,10);return Number.isNaN(n)?null:n}function ee(){if(!A)return;const t=re(),n=m.querySelectorAll(":scope > .signature-box-item").length;t!==null&&n>=t?A.style.display="none":A.style.display=""}function ie(t,n,e,o,a){const s=re(),i=m.querySelectorAll(":scope > .signature-box-item").length;if(s!==null&&i>=s){console.log("[PdfSignable] Box add skipped: max_entries reached",{max:s,currentCount:i});return}const d=o??150,c=a??40,r=document.getElementById("signature-boxes-empty");r&&r.classList.add("d-none");const l=m.dataset.prototype??"",u=m.querySelectorAll(":scope > .signature-box-item").length,g=l.replace(/__name__/g,String(u)),p=document.createElement("div");p.innerHTML=g;const x=p.firstElementChild;if(!x)return;x.dataset.index=String(u);const O=x.querySelector(".signature-box-page");O&&(O.value=String(t));const L=E[t],M=U(),_=Q(),P=d,N=c,W=L?L.scale:1.5,y=L?L.width/W:595,H=L?L.height/W:842;let f,v;switch(_){case"top_left":f=n,v=H-e-N;break;case"top_right":f=y-n-P,v=H-e-N;break;case"bottom_right":f=y-n-P,v=e;break;default:f=n,v=e;break}const w=q=>Math.round(q*100)/100,B=x.querySelector(".signature-box-name");for(const q of["x","y","width","height"]){const G=x.querySelector(".signature-box-"+q);G&&(q==="x"?G.value=String(w(I(f,M))):q==="y"?G.value=String(w(I(v,M))):q==="width"?G.value=String(w(I(P,M))):q==="height"&&(G.value=String(w(I(N,M)))))}B&&(B.value=Y.default_box_name),m.appendChild(x),x.scrollIntoView({behavior:"smooth"}),b(),ee(),console.log("[PdfSignable] Box added",{page:t,x:f,y:v,width:d,height:c,unit:M})}F&&F.addEventListener("click",()=>se());const le=document.getElementById("unitBadge"),xe={pt:"pt",mm:"mm",cm:"cm",px:"px",in:"in"};function ce(){le&&(le.textContent=xe[U()]??U())}ce();let de=U();if(j&&j.addEventListener("change",()=>{const t=de,n=U();ce(),m.querySelectorAll(":scope > .signature-box-item").forEach(e=>{for(const o of["x","y","width","height"]){const a=e.querySelector(".signature-box-"+o);if(a!=null&&a.value){const s=parseFloat(a.value);a.value=String(Math.round(I(X(s,t),n)*100)/100)}}}),de=n,b()}),m.addEventListener("input",b),m.addEventListener("change",b),$&&$.addEventListener("change",b),m.addEventListener("click",t=>{if(!t.target.closest(".remove-box"))return;const n=t.target.closest(".signature-box-item");if(n){let e=n;for(;e!=null&&e.parentElement&&e.parentElement!==m;)e=e.parentElement;if(e){const o=Array.from(m.querySelectorAll(":scope > .signature-box-item")).indexOf(e);e.remove(),console.log("[PdfSignable] Box removed",{index:o})}}if(m.querySelectorAll(":scope > .signature-box-item").length===0){const e=document.getElementById("signature-boxes-empty");e&&e.classList.remove("d-none")}b(),ee()}),T){let t,n=!1,e=0;new ResizeObserver(()=>{if(n)return;const a=(T==null?void 0:T.clientWidth)??0;Math.abs(a-e)<10||(e=a,clearTimeout(t),t=setTimeout(async()=>{if(!(!k||S.style.display==="none")&&!n){n=!0;try{const s=await ae();S.innerHTML="",Object.keys(E).forEach(i=>delete E[Number(i)]);for(let i=1;i<=k.numPages;i++){D&&await D;const d=await k.getPage(i),c=d.getViewport({scale:s});E[i]=c;const r=document.createElement("div");r.className="pdf-page-wrapper",r.dataset.page=String(i);const l=document.createElement("canvas"),u=l.getContext("2d");if(!u)continue;l.height=c.height,l.width=c.width,l.dataset.page=String(i);const g=document.createElement("div");g.className="signature-overlays",r.appendChild(l),r.appendChild(g),D=d.render({canvasContext:u,viewport:c}).promise,await D,S.appendChild(r)}b(),T&&(e=T.clientWidth)}finally{n=!1}}},200))}).observe(T)}function ue(){var t;(t=z==null?void 0:z.value)!=null&&t.trim()&&(console.log("[PdfSignable] Auto-loading PDF (preset URL)"),se())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ue):ue(),S.addEventListener("click",t=>{if(t.target.closest(".signature-box-overlay"))return;const n=t.target.closest(".pdf-page-wrapper"),e=n==null?void 0:n.querySelector("canvas");if(!e||!k)return;const o=parseInt(e.dataset.page??"1",10),a=E[o];if(!a)return;const s=e.getBoundingClientRect(),i=e.width/s.width,d=e.height/s.height,c=(t.clientX-s.left)*i,r=(t.clientY-s.top)*d,l=40,u=l*(a.scale||1.5),g=a.convertToPdfPoint(c,r+u);ie(o,g[0],g[1],150,l)});let h=null;function be(t){var g,p;const n=t.target.closest(".resize-handle"),e=t.target.closest(".signature-box-overlay");if(!((g=e==null?void 0:e.dataset)!=null&&g.boxIndex))return;t.preventDefault(),t.stopPropagation();const o=parseInt(e.dataset.boxIndex,10),a=m.querySelectorAll(":scope > .signature-box-item")[o];if(!a)return;const s=e.closest(".pdf-page-wrapper"),i=parseInt(((p=s==null?void 0:s.dataset)==null?void 0:p.page)??"1",10),d=E[i];if(!d)return;const c=parseFloat(e.style.width)||20,r=parseFloat(e.style.height)||14,l=parseFloat(e.style.left)||0,u=parseFloat(e.style.top)||0;h={mode:n?"resize":"move",handle:n?n.dataset.handle??null:null,overlay:e,item:a,viewport:d,startX:t.clientX,startY:t.clientY,startLeft:l,startTop:u,startRight:l+c,startBottom:u+r},e.classList.add("dragging"),Z=!0,document.addEventListener("mousemove",ge),document.addEventListener("mouseup",pe)}function ge(t){if(!h)return;const{overlay:n,viewport:e,startLeft:o,startTop:a,startRight:s,startBottom:i}=h,d=t.clientX-h.startX,c=t.clientY-h.startY,r=20;let l,u,g,p;if(h.mode==="move")l=Math.max(0,Math.min(e.width-(s-o),o+d)),u=Math.max(0,Math.min(e.height-(i-a),a+c)),g=s-o,p=i-a;else{const f=h.handle;let v=o,w=a,B=s,q=i;f==="se"?(B=Math.min(e.width,Math.max(o+r,s+d)),q=Math.min(e.height,Math.max(a+r,i+c))):f==="sw"?(v=Math.max(0,Math.min(s-r,o+d)),q=Math.min(e.height,Math.max(a+r,i+c))):f==="ne"?(B=Math.min(e.width,Math.max(o+r,s+d)),w=Math.max(0,Math.min(i-r,a+c))):f==="nw"&&(v=Math.max(0,Math.min(s-r,o+d)),w=Math.max(0,Math.min(i-r,a+c))),l=v,u=w,g=B-v,p=q-w}n.style.left=l+"px",n.style.top=u+"px",n.style.width=g+"px",n.style.height=p+"px";const x=e.scale||1.5,O=g/x,L=p/x,M=ye(e,l,u,O,L,Q()),_=U(),P=f=>Math.round(f*100)/100,N=h.item.querySelector(".signature-box-x"),W=h.item.querySelector(".signature-box-y"),y=h.item.querySelector(".signature-box-width"),H=h.item.querySelector(".signature-box-height");N&&(N.value=String(P(I(M.xPt,_)))),W&&(W.value=String(P(I(M.yPt,_)))),y&&(y.value=String(P(I(O,_)))),H&&(H.value=String(P(I(L,_))))}function pe(){h&&(h.overlay.classList.remove("dragging"),Z=!1,document.removeEventListener("mousemove",ge),document.removeEventListener("mouseup",pe),h=null,b())}S.addEventListener("mousedown",be),A&&A.addEventListener("click",()=>ie(1,0,0)),ee(),V.addEventListener("submit",t=>{t.preventDefault(),m.querySelectorAll(":scope > .signature-box-item").forEach((e,o)=>{e.querySelectorAll("input, select, textarea").forEach(a=>{a.name=a.name.replace(/(\])\[\d+\](\[)/,`$1[${o}]$2`)})}),V.submit()})}fe()})();
