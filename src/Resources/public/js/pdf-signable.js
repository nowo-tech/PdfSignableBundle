(function(){"use strict";const ke={pt:1,mm:.35277777777777775,cm:.035277777777777776,in:.013888888888888888,px:1.3333333333333333};function H(L,Z){return L*(ke[Z]??1)}function W(L,Z){return L/(ke[Z]??1)}function Je(L){return String(L).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const Qe=220,et=37,tt=65,nt=48;function ot(L,Z,b){L=L%360,L<0&&(L+=360);const ge=Z/100,U=b/100,$=(1-Math.abs(2*U-1))*ge,v=$*(1-Math.abs(L/60%2-1)),ne=U-$/2;let ue=0,K=0,J=0;L<60?(ue=$,K=v):L<120?(ue=v,K=$):L<180?(K=$,J=v):L<240?(K=v,J=$):L<300?(ue=v,J=$):(ue=$,J=v);const N=Be=>{const Me=Math.round((Be+ne)*255);return(Me<16?"0":"")+Math.min(255,Math.max(0,Me)).toString(16)};return"#"+N(ue)+N(K)+N(J)}function st(L){const Z=(Qe+L*et)%360,b=ot(Z,tt,nt),ge=parseInt(b.slice(1,3),16),U=parseInt(b.slice(3,5),16),$=parseInt(b.slice(5,7),16);return{border:b,background:`rgba(${ge}, ${U}, ${$}, 0.15)`,color:b,handle:b}}function rt(){const L=window.NowoPdfSignableConfig;if(!L){console.warn("[PdfSignable] NowoPdfSignableConfig not found, skipping init");return}const{proxyUrl:Z,strings:b,debug:ge=!1}=L,U=(...t)=>{ge&&console.log("[PdfSignable]",...t)},$=(...t)=>{ge&&console.warn("[PdfSignable]",...t)},v=document.querySelector(".nowo-pdf-signable-widget"),ne=v==null?void 0:v.closest("form");if(!ne){$(".nowo-pdf-signable-widget or form not found, skipping init");return}const ue=(v==null?void 0:v.dataset.preventBoxOverlap)==="1",K=(v==null?void 0:v.dataset.enableRotation)==="1";let J={};try{const t=(v==null?void 0:v.dataset.boxDefaultsByName)??"{}";J=typeof t=="string"?JSON.parse(t):{}}catch{J={}}const N=Math.max(0,parseFloat((v==null?void 0:v.dataset.snapGrid)??"0")||0),Be=(v==null?void 0:v.dataset.snapToBoxes)==="1",Me=10;U("Initialized");const me=ne.querySelector(".pdf-url-input"),re=document.getElementById("loadPdfBtn"),Ie=document.getElementById("pdf-placeholder"),Oe=document.getElementById("pdf-canvas-wrapper"),De=document.getElementById("signature-boxes-list"),ae=document.getElementById("addBoxBtn"),xe=ne.querySelector(".unit-selector"),be=ne.querySelector(".origin-selector"),m=document.getElementById("pdf-viewer-container");if(!Oe||!De)return;const C=Oe,E=De;let de=1,ie={x:0,y:0},M=null;const at=80;function it(){if(!j||!m)return;const t=m.querySelector("#pdf-thumbnails-strip"),e=m.querySelector(".pdf-viewer-scroll");!t||!e||(async()=>{for(let s=1;s<=j.numPages;s++){const o=await j.getPage(s),r=o.getViewport({scale:1}),a=at/r.width,i=o.getViewport({scale:a}),u=document.createElement("canvas");u.width=i.width,u.height=i.height;const c=u.getContext("2d");if(!c)continue;await o.render({canvasContext:c,viewport:i}).promise;const l=document.createElement("button");l.type="button",l.className="pdf-thumb",l.dataset.page=String(s),l.setAttribute("aria-label","Page "+s),l.appendChild(u),l.addEventListener("click",()=>{const p=C.querySelector('.pdf-page-wrapper[data-page="'+s+'"]');p&&(p.scrollIntoView({behavior:"smooth",block:"start"}),t.querySelectorAll(".pdf-thumb.current").forEach(h=>h.classList.remove("current")),l.classList.add("current"))}),t.appendChild(l)}const n=()=>{const s=t,o=C.querySelectorAll(".pdf-page-wrapper");if(o.length===0)return;const r=e.getBoundingClientRect(),a=r.top+r.height/2;let i=1,u=1/0;o.forEach(l=>{const p=parseInt(l.dataset.page??"1",10),h=l.getBoundingClientRect(),f=h.top+h.height/2,x=Math.abs(f-a);x<u&&(u=x,i=p)}),s.querySelectorAll(".pdf-thumb.current").forEach(l=>l.classList.remove("current"));const c=s.querySelector('.pdf-thumb[data-page="'+i+'"]');c&&c.classList.add("current")};e.addEventListener("scroll",n),requestAnimationFrame(n),t.firstElementChild&&t.firstElementChild.classList.add("current")})()}function lt(){M||!m||(M=document.createElement("div"),M.id="pdf-touch-wrapper",M.style.transformOrigin="0 0",M.style.transform=`translate(${ie.x}px, ${ie.y}px) scale(${de})`,m.insertBefore(M,C),M.appendChild(C),ct())}function ct(){if(!M)return;let t=0,e=1,n={x:0,y:0},s=0,o=0;M.addEventListener("touchstart",r=>{if(r.touches.length===2){r.preventDefault();const a=r.touches[0],i=r.touches[1];t=Math.hypot(i.clientX-a.clientX,i.clientY-a.clientY),e=de,n={...ie},s=(a.clientX+i.clientX)/2,o=(a.clientY+i.clientY)/2}},{passive:!1}),M.addEventListener("touchmove",r=>{if(r.touches.length===2&&M){r.preventDefault();const a=r.touches[0],i=r.touches[1],u=Math.hypot(i.clientX-a.clientX,i.clientY-a.clientY),c=Math.max(.25,Math.min(4,e*u/t)),l=(a.clientX+i.clientX)/2,p=(a.clientY+i.clientY)/2;ie.x=n.x+(l-s),ie.y=n.y+(p-o),de=c,M.style.transform=`translate(${ie.x}px, ${ie.y}px) scale(${de})`}},{passive:!1})}function oe(){return(xe==null?void 0:xe.value)??"mm"}function he(){return(be==null?void 0:be.value)??"bottom_left"}function Fe(t,e,n,s,o,r){const a=t.scale||1.5,i=t.width/a,u=t.height/a;let c,l;switch(r){case"top_left":c=e,l=u-n-o;break;case"top_right":c=i-e-s,l=u-n-o;break;case"bottom_right":c=i-e-s,l=n;break;default:c=e,l=n;break}return{vpX:c*a,vpY:t.height-(l+o)*a}}function Xe(t,e,n,s,o,r){const a=t.scale||1.5,i=t.width/a,u=t.height/a,c=t.convertToPdfPoint(e,n+o*a),l=c[0],p=c[1];let h,f;switch(r){case"top_left":h=l,f=u-p-o;break;case"top_right":h=i-l-s,f=u-p-o;break;case"bottom_right":h=i-l-s,f=p;break;default:h=l,f=p;break}return{xPt:h,yPt:f}}let j=null;const G={};let Ae=null,Pe=!1,Q=1.5;function ut(t){try{return new URL(t,window.location.origin).origin===window.location.origin?t:Z+"?url="+encodeURIComponent(t)}catch{return Z+"?url="+encodeURIComponent(t)}}function dt(){if(!m||!M||m.querySelector(".pdf-viewer-scroll"))return;const e=document.createElement("div");e.id="pdf-thumbnails-strip",e.setAttribute("aria-label","Page thumbnails");const n=document.createElement("div");n.className="pdf-viewer-scroll",n.appendChild(M),m.appendChild(n),m.insertBefore(e,n)}async function Ce(){if(!j||!m)return 1.5;await new Promise(a=>requestAnimationFrame(()=>a()));const e=(await j.getPage(1)).getViewport({scale:1}),n=m.querySelector(".pdf-viewer-scroll"),r=Math.max(0,(n||m).clientWidth-8);return r<=0?1.5:Math.max(.5,r/e.width)}async function ve(t){if(j){Object.keys(G).forEach(e=>delete G[Number(e)]),C.innerHTML="";for(let e=1;e<=j.numPages;e++){Ae&&await Ae;const n=await j.getPage(e),s=n.getViewport({scale:t});G[e]=s;const o=document.createElement("div");o.className="pdf-page-wrapper",o.dataset.page=String(e);const r=document.createElement("canvas"),a=r.getContext("2d");if(!a)continue;r.height=s.height,r.width=s.width,r.dataset.page=String(e);const i=document.createElement("div");i.className="signature-overlays",o.appendChild(r),o.appendChild(i),Ae=n.render({canvasContext:a,viewport:s}).promise,await Ae,C.appendChild(o)}T()}}function pt(){var o;if((o=m==null?void 0:m.querySelector("#pdf-zoom-toolbar"))==null||o.remove(),!m)return;const t=document.createElement("div");t.id="pdf-zoom-toolbar",t.className="pdf-zoom-toolbar",t.setAttribute("role","toolbar"),t.setAttribute("aria-label",b.zoom_fit??"Zoom");const e=document.createElement("button");e.type="button",e.className="pdf-zoom-btn",e.title=b.zoom_out??"Zoom out",e.textContent="-",e.setAttribute("aria-label",b.zoom_out??"Zoom out");const n=document.createElement("button");n.type="button",n.className="pdf-zoom-btn",n.title=b.zoom_in??"Zoom in",n.textContent="+",n.setAttribute("aria-label",b.zoom_in??"Zoom in");const s=document.createElement("button");s.type="button",s.className="pdf-zoom-btn",s.title=b.zoom_fit??"Fit width",s.textContent=b.zoom_fit??"Fit",s.setAttribute("aria-label",b.zoom_fit??"Fit width"),e.addEventListener("click",()=>{Q=Math.max(.5,Q/1.25),ve(Q)}),n.addEventListener("click",()=>{Q=Math.min(3,Q*1.25),ve(Q)}),s.addEventListener("click",async()=>{Q=await Ce(),await ve(Q)}),t.appendChild(e),t.appendChild(n),t.appendChild(s),m.insertBefore(t,m.firstChild)}async function Re(){var r,a;const t=((r=me==null?void 0:me.value)==null?void 0:r.trim())??"";if(!t){$("Load PDF: URL required"),alert(b.alert_url_required);return}const e=ut(t);U("Loading PDF",{url:t,viaProxy:e!==t}),re&&(re.setAttribute("disabled",""),re.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> '+b.loading_state),Ie&&(Ie.style.display="block"),C.style.display="none",C.innerHTML="";const n=m==null?void 0:m.querySelector("#pdf-thumbnails-strip"),s=m==null?void 0:m.querySelector(".pdf-viewer-scroll");s&&M&&M.parentElement===s&&(s.removeChild(M),m==null||m.appendChild(M)),n==null||n.remove(),s==null||s.remove(),(a=m==null?void 0:m.querySelector("#pdf-zoom-toolbar"))==null||a.remove(),de=1,ie={x:0,y:0},M&&(M.style.transform="translate(0px, 0px) scale(1)");const o=document.createElement("div");o.className="pdf-signable-loading-overlay",o.setAttribute("aria-live","polite"),o.setAttribute("aria-busy","true"),o.innerHTML='<div class="text-center"><div class="spinner-border text-primary mb-2" role="status"><span class="visually-hidden">'+b.loading_state+'</span></div><p class="text-muted small mb-0">'+b.loading_state+"</p></div>",m&&m.appendChild(o);try{j=await pdfjsLib.getDocument(e).promise,Object.keys(G).forEach(c=>delete G[Number(c)]),lt(),dt();const i=await Ce();Q=i,await ve(i),Ie&&(Ie.style.display="none"),C.style.display="block",it(),pt(),requestAnimationFrame(()=>{T(),setTimeout(T,100),setTimeout(T,350),setTimeout(T,700)}),U("PDF loaded",{pages:j.numPages,scale:i})}catch(i){U("PDF load failed",i),alert(b.error_load_pdf+(i instanceof Error?i.message:String(i)))}finally{o.remove(),re&&(re.removeAttribute("disabled"),re.innerHTML=b.load_pdf_btn)}}function T(){if(Pe||Object.keys(G).length===0)return;const t=oe(),e=he();C.querySelectorAll(".signature-overlays").forEach(a=>{a.innerHTML=""});const n=E.querySelectorAll(":scope > .signature-box-item"),s={},o={};let r=0;if(n.forEach((a,i)=>{var ye,z,pe,le,qe,Le;const u=parseInt(((ye=a.querySelector(".signature-box-page"))==null?void 0:ye.value)??"1",10),c=parseFloat(((z=a.querySelector(".signature-box-x"))==null?void 0:z.value)??"0"),l=parseFloat(((pe=a.querySelector(".signature-box-y"))==null?void 0:pe.value)??"0"),p=parseFloat(((le=a.querySelector(".signature-box-width"))==null?void 0:le.value)??"150"),h=parseFloat(((qe=a.querySelector(".signature-box-height"))==null?void 0:qe.value)??"40"),f=a.querySelector(".signature-box-angle"),x=K&&f?parseFloat(f.value??"0"):0,X=a.querySelector(".signature-box-signature-data"),_=(Le=X==null?void 0:X.value)==null?void 0:Le.trim(),B=a.querySelector(".signature-box-name"),F=((B==null?void 0:B.value)??"").trim(),P=F===""?"__empty__":F;P in o||(o[P]=r++);const O=o[P];s[F]=(s[F]??0)+1;const g=s[F],d=F===""?"":F+(g>1?` (${g})`:""),y=C.querySelector(`.pdf-page-wrapper[data-page="${u}"] .signature-overlays`),S=G[u];if(!y||!S)return;const I=S.scale||1.5,Y=W(c,t),D=W(l,t),R=W(p,t),A=W(h,t),w=Fe(S,Y,D,R,A,e),V=R*I,ee=A*I,q=document.createElement("div");q.className="signature-box-overlay",q.dataset.boxIndex=String(i),q.style.left=w.vpX+"px",q.style.top=w.vpY+"px",q.style.width=Math.max(V,20)+"px",q.style.height=Math.max(ee,14)+"px";const te=st(O);q.style.borderColor=te.border,q.style.backgroundColor=te.background,q.style.color=te.color,q.style.setProperty("--box-color",te.handle),q.style.transformOrigin="50% 50%",K&&(q.style.transform=`rotate(${x}deg)`);const fe=K?'<span class="rotate-handle" title="Rotate"></span>':"";if(q.innerHTML=(d?'<span class="overlay-label">'+Je(d)+"</span>":"")+fe+'<span class="resize-handle nw" data-handle="nw"></span><span class="resize-handle ne" data-handle="ne"></span><span class="resize-handle sw" data-handle="sw"></span><span class="resize-handle se" data-handle="se"></span>',_&&_.startsWith("data:")){const ce=document.createElement("img");ce.src=_,ce.alt="",ce.setAttribute("aria-hidden","true"),ce.style.cssText="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;pointer-events:none;",q.insertBefore(ce,q.firstChild)}y.appendChild(q)}),se!==null){const a=C.querySelector(`.signature-box-overlay[data-box-index="${se}"]`);a&&a.classList.add("selected")}}const Ne=1,gt=6;function Ye(t){const e=t.getBoundingClientRect();if(e.width<=0||e.height<=0)return;const n=Math.min(window.devicePixelRatio||1,2),s=Math.max(1,Math.round(e.width*n)),o=Math.max(1,Math.round(e.height*n));t.width===s&&t.height===o||(t.width=s,t.height=o)}function Te(){const t=document.querySelector(".nowo-pdf-signable-widget");t&&t.querySelectorAll(".signature-pad-canvas").forEach(e=>{var O;if(e.dataset.padInited==="1")return;const n=e.closest(".signature-box-item"),s=n==null?void 0:n.querySelector(".signature-box-signature-data"),o=(O=e.closest(".signature-pad-wrapper"))==null?void 0:O.querySelector(".signature-pad-clear"),r=n==null?void 0:n.querySelector(".signature-upload-input");if(!s)return;const a=e.getContext("2d");if(!a)return;e.dataset.padInited="1";const i=e.closest(".signature-pad-wrapper"),u=()=>{Ye(e)};typeof ResizeObserver<"u"&&i&&new ResizeObserver(()=>{u()}).observe(i),requestAnimationFrame(u);let c=!1,l=0,p=0,h=0,f=0;const x=g=>{const d=e.getBoundingClientRect(),y=d.width?e.width/d.width:1,S=d.height?e.height/d.height:1;if("touches"in g&&g.touches.length>0){const Y=g.touches[0];return{x:(Y.clientX-d.left)*y,y:(Y.clientY-d.top)*S}}const I=g;return{x:(I.clientX-d.left)*y,y:(I.clientY-d.top)*S}},X=g=>{if("touches"in g&&g.touches.length>0){const y=g.touches[0].force;if(typeof y=="number"&&y>=0)return Math.min(1,y)}const d=g;return typeof d.pressure=="number"&&d.pressure>=0?Math.min(1,d.pressure):.5},_=g=>{const d=X(g),y=Ne+d*(gt-Ne);a.lineWidth=y},B=g=>{g.preventDefault(),Ye(e);const{x:d,y}=x(g);h=l=d,f=p=y,c=!0,a.strokeStyle="#000",_(g),a.lineCap="round",a.lineJoin="round",a.beginPath(),a.moveTo(d,y)},F=g=>{if(g.preventDefault(),!c)return;const{x:d,y}=x(g);_(g);const S=(l+d)/2,I=(p+y)/2;a.beginPath(),a.moveTo(h,f),a.quadraticCurveTo(l,p,S,I),a.stroke(),h=S,f=I,l=d,p=y},P=g=>{if(g.preventDefault(),!c)return;c=!1,e.width>0&&e.height>0&&(s.value=e.toDataURL("image/png"));const d=n==null?void 0:n.querySelector(".signature-box-signed-at");d&&(d.value=new Date().toISOString()),T()};e.addEventListener("mousedown",B),e.addEventListener("mousemove",F),e.addEventListener("mouseup",P),e.addEventListener("mouseleave",P),e.addEventListener("touchstart",B,{passive:!1}),e.addEventListener("touchmove",F,{passive:!1}),e.addEventListener("touchend",P,{passive:!1}),o&&o.addEventListener("click",()=>{const g=e.width,d=e.height;a.clearRect(0,0,g,d),s.value="";const y=n==null?void 0:n.querySelector(".signature-box-signed-at");y&&(y.value=""),T()}),r&&r.addEventListener("change",()=>{var y;const g=(y=r.files)==null?void 0:y[0];if(!g||!g.type.startsWith("image/"))return;const d=new FileReader;d.onload=()=>{if(typeof d.result=="string"){s.value=d.result;const S=n==null?void 0:n.querySelector(".signature-box-signed-at");S&&(S.value=new Date().toISOString()),T()}},d.readAsDataURL(g)})})}function ze(){const t=E.dataset.maxEntries??(ae==null?void 0:ae.dataset.maxEntries)??"";if(t==="")return null;const e=parseInt(t,10);return Number.isNaN(e)?null:e}function Se(){if(!ae)return;const t=ze(),e=E.querySelectorAll(":scope > .signature-box-item").length;t!==null&&e>=t?ae.style.display="none":ae.style.display=""}function _e(t,e,n,s,o){const r=ze(),a=E.querySelectorAll(":scope > .signature-box-item").length;if(r!==null&&a>=r){U("Box add skipped: max_entries reached",{max:r,currentCount:a});return}const i=s??150,u=o??40,c=document.getElementById("signature-boxes-empty");c&&c.classList.add("d-none");const l=E.dataset.prototype??"",p=E.querySelectorAll(":scope > .signature-box-item").length,h=l.replace(/__name__/g,String(p)),f=document.createElement("div");f.innerHTML=h;const x=f.firstElementChild;if(!x)return;x.dataset.index=String(p);const X=x.querySelector(".signature-box-page");X&&(X.value=String(t));const _=G[t],B=oe(),F=he(),P=i,O=u,g=_?_.scale:1.5,d=_?_.width/g:595,y=_?_.height/g:842;let S,I;switch(F){case"top_left":S=e,I=y-n-O;break;case"top_right":S=d-e-P,I=y-n-O;break;case"bottom_right":S=d-e-P,I=n;break;default:S=e,I=n;break}const Y=A=>Math.round(A*100)/100,D=x.querySelector(".signature-box-name");for(const A of["x","y","width","height"]){const w=x.querySelector(".signature-box-"+A);w&&(A==="x"?w.value=String(Y(H(S,B))):A==="y"?w.value=String(Y(H(I,B))):A==="width"?w.value=String(Y(H(P,B))):A==="height"&&(w.value=String(Y(H(O,B)))))}const R=x.querySelector(".signature-box-angle");R&&(R.value="0"),D&&(D.value=b.default_box_name),E.appendChild(x),x.scrollIntoView({behavior:"smooth"}),T(),Te(),Se(),U("Box added",{page:t,x:S,y:I,width:i,height:u,unit:B})}re&&re.addEventListener("click",()=>Re());const He=document.getElementById("unitBadge"),mt={pt:"pt",mm:"mm",cm:"cm",px:"px",in:"in"};function We(){He&&(He.textContent=mt[oe()]??oe())}We();let Ue=oe();if(xe&&xe.addEventListener("change",()=>{const t=Ue,e=oe();We(),E.querySelectorAll(":scope > .signature-box-item").forEach(n=>{for(const s of["x","y","width","height"]){const o=n.querySelector(".signature-box-"+s);if(o!=null&&o.value){const r=parseFloat(o.value);o.value=String(Math.round(H(W(r,t),e)*100)/100)}}}),Ue=e,T()}),E.addEventListener("input",T),E.addEventListener("change",t=>{const e=t.target.closest(".signature-box-item"),n=e==null?void 0:e.querySelector(".signature-box-name");if(n&&t.target===n&&Object.keys(J).length>0){const s=(n.value??"").trim(),o=s?J[s]:null;if(o){const r=(a,i)=>{const u=e==null?void 0:e.querySelector(".signature-box-"+a);u&&i!==void 0&&(u.value=String(i))};r("width",o.width),r("height",o.height),r("x",o.x),r("y",o.y),r("angle",o.angle)}}T()}),be&&be.addEventListener("change",T),E.addEventListener("click",t=>{if(!t.target.closest(".remove-box"))return;const e=t.target.closest(".signature-box-item");if(e){let n=e;for(;n!=null&&n.parentElement&&n.parentElement!==E;)n=n.parentElement;if(n){const s=Array.from(E.querySelectorAll(":scope > .signature-box-item")).indexOf(n);n.remove(),U("Box removed",{index:s})}}if(E.querySelectorAll(":scope > .signature-box-item").length===0){const n=document.getElementById("signature-boxes-empty");n&&n.classList.remove("d-none")}T(),Se()}),m){let t,e=!1,n=0;new ResizeObserver(()=>{if(e)return;const o=(m==null?void 0:m.clientWidth)??0;Math.abs(o-n)<10||(n=o,clearTimeout(t),t=setTimeout(async()=>{if(!(!j||C.style.display==="none")&&!e){e=!0;try{const r=await Ce();Q=r,await ve(r),m&&(n=m.clientWidth)}finally{e=!1}}},200))}).observe(m)}function $e(){var t;(t=me==null?void 0:me.value)!=null&&t.trim()&&(U("Auto-loading PDF (preset URL)"),Re())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{$e(),Te()}):($e(),Te()),C.addEventListener("click",t=>{if(t.target.closest(".signature-box-overlay"))return;we(null);const e=t.target.closest(".pdf-page-wrapper"),n=e==null?void 0:e.querySelector("canvas");if(!n||!j)return;const s=parseInt(n.dataset.page??"1",10),o=G[s];if(!o)return;const r=n.getBoundingClientRect(),a=n.width/r.width,i=n.height/r.height,u=(t.clientX-r.left)*a,c=(t.clientY-r.top)*i,l=40,p=l*(o.scale||1.5),h=o.convertToPdfPoint(u,c+p);_e(s,h[0],h[1],150,l)});function ht(t,e){if(t.page!==e.page)return!1;const n=t.x+t.w,s=e.x+e.w,o=t.y+t.h,r=e.y+e.h;return t.x<s&&e.x<n&&t.y<r&&e.y<o}function je(){const t=E.querySelectorAll(":scope > .signature-box-item"),e=[];return t.forEach(n=>{var c,l,p,h;const s=n.querySelector(".signature-box-page"),o=parseInt((s==null?void 0:s.value)??"1",10),r=parseFloat(((c=n.querySelector(".signature-box-x"))==null?void 0:c.value)??"0"),a=parseFloat(((l=n.querySelector(".signature-box-y"))==null?void 0:l.value)??"0"),i=parseFloat(((p=n.querySelector(".signature-box-width"))==null?void 0:p.value)??"150"),u=parseFloat(((h=n.querySelector(".signature-box-height"))==null?void 0:h.value)??"40");e.push({page:o,x:r,y:a,w:i,h:u})}),e}function ft(t,e){const n=G[t];if(!n)return[];const s=oe(),o=he(),r=n.scale||1.5,a=je(),i=[];return a.forEach((u,c)=>{if(c===e||u.page!==t)return;const l=W(u.x,s),p=W(u.y,s),h=W(u.w,s),f=W(u.h,s),{vpX:x,vpY:X}=Fe(n,l,p,h,f,o);i.push({left:x,top:X,right:x+h*r,bottom:X+f*r})}),i}let k=null,se=null;function we(t){if(se=t,C.querySelectorAll(".signature-box-overlay.selected").forEach(e=>e.classList.remove("selected")),t!==null){const e=C.querySelector(`.signature-box-overlay[data-box-index="${t}"]`);e&&e.classList.add("selected")}}let Ee=null;function Ge(t){if(!Ee)return;const{overlay:e,item:n,centerX:s,centerY:o,startAngle:r,startMouseAngle:a}=Ee;let u=(Math.atan2(t.clientY-o,t.clientX-s)-a)*180/Math.PI,c=r+u;for(;c>180;)c-=360;for(;c<-180;)c+=360;const l=n.querySelector(".signature-box-angle");l&&(l.value=String(Math.round(c*100)/100)),e.style.transform=`rotate(${c}deg)`}function Ve(){Ee&&(document.removeEventListener("mousemove",Ge),document.removeEventListener("mouseup",Ve),Ee=null)}function yt(t){var B,F;const e=t.target.closest(".signature-box-overlay");if(!((B=e==null?void 0:e.dataset)!=null&&B.boxIndex))return;t.preventDefault(),t.stopPropagation();const n=t.target.closest(".rotate-handle");if(K&&n){const P=parseInt(e.dataset.boxIndex,10),O=E.querySelectorAll(":scope > .signature-box-item")[P];if(!O)return;const g=O.querySelector(".signature-box-angle");if(!g)return;const d=e.getBoundingClientRect(),y=d.left+d.width/2,S=d.top+d.height/2,I=parseFloat(g.value)||0,Y=Math.atan2(t.clientY-S,t.clientX-y);Ee={overlay:e,item:O,centerX:y,centerY:S,startAngle:I,startMouseAngle:Y},document.addEventListener("mousemove",Ge),document.addEventListener("mouseup",Ve);return}const s=t.target.closest(".resize-handle"),o=parseInt(e.dataset.boxIndex,10),r=E.querySelectorAll(":scope > .signature-box-item")[o];if(!r)return;const a=e.closest(".pdf-page-wrapper"),i=parseInt(((F=a==null?void 0:a.dataset)==null?void 0:F.page)??"1",10),u=G[i];if(!u)return;const c=parseFloat(e.style.width)||20,l=parseFloat(e.style.height)||14,p=parseFloat(e.style.left)||0,h=parseFloat(e.style.top)||0,f=r.querySelector(".signature-box-x"),x=r.querySelector(".signature-box-y"),X=r.querySelector(".signature-box-width"),_=r.querySelector(".signature-box-height");k={mode:s?"resize":"move",handle:s?s.dataset.handle??null:null,overlay:e,item:r,boxIndex:o,viewport:u,startX:t.clientX,startY:t.clientY,startLeft:p,startTop:h,startRight:p+c,startBottom:h+l,startFormX:f&&parseFloat(f.value)||0,startFormY:x&&parseFloat(x.value)||0,startFormW:X&&parseFloat(X.value)||150,startFormH:_&&parseFloat(_.value)||40},e.classList.add("dragging"),Pe=!0,k.mode==="move"&&we(o),document.addEventListener("mousemove",Ze),document.addEventListener("mouseup",Ke)}function Ze(t){var I,Y;if(!k)return;const{overlay:e,viewport:n,startLeft:s,startTop:o,startRight:r,startBottom:a}=k,i=(t.clientX-k.startX)/de,u=(t.clientY-k.startY)/de,c=20;let l,p,h,f;if(k.mode==="move")l=Math.max(0,Math.min(n.width-(r-s),s+i)),p=Math.max(0,Math.min(n.height-(a-o),o+u)),h=r-s,f=a-o;else{const D=k.handle;let R=s,A=o,w=r,V=a;D==="se"?(w=Math.min(n.width,Math.max(s+c,r+i)),V=Math.min(n.height,Math.max(o+c,a+u))):D==="sw"?(R=Math.max(0,Math.min(r-c,s+i)),V=Math.min(n.height,Math.max(o+c,a+u))):D==="ne"?(w=Math.min(n.width,Math.max(s+c,r+i)),A=Math.max(0,Math.min(a-c,o+u))):D==="nw"&&(R=Math.max(0,Math.min(r-c,s+i)),A=Math.max(0,Math.min(a-c,o+u))),l=R,p=A,h=w-R,f=V-A}const x=n.scale||1.5,X=parseInt(((Y=(I=e.closest(".pdf-page-wrapper"))==null?void 0:I.dataset)==null?void 0:Y.page)??"1",10);if(N>0){const D=h/x,R=f/x,A=Xe(n,l,p,D,R,he()),w=oe();let V=H(A.xPt,w),ee=H(A.yPt,w),q=H(D,w),te=H(R,w);V=Math.round(V/N)*N,ee=Math.round(ee/N)*N,q=Math.round(q/N)*N,te=Math.max(N,Math.round(te/N)*N);const fe=W(V,w),ye=W(ee,w),z=W(q,w),pe=W(te,w),le=Fe(n,fe,ye,z,pe,he());l=le.vpX,p=le.vpY,h=z*x,f=pe*x}if(Be){const D=ft(X,k.boxIndex),R=l+h,A=p+f,w=D.flatMap(z=>[z.left,z.right]),V=D.flatMap(z=>[z.top,z.bottom]),ee=(z,pe)=>{let le=z,qe=Me;for(const Le of pe){const ce=Math.abs(z-Le);ce<qe&&(qe=ce,le=Le)}return le},q=ee(l,w),te=ee(R,w),fe=ee(p,V),ye=ee(A,V);l=q,p=fe,h=Math.max(c,te-q),f=Math.max(c,ye-fe)}e.style.left=l+"px",e.style.top=p+"px",e.style.width=h+"px",e.style.height=f+"px";const _=h/x,B=f/x,F=Xe(n,l,p,_,B,he()),P=oe(),O=D=>Math.round(D*100)/100,g=k.item.querySelector(".signature-box-x"),d=k.item.querySelector(".signature-box-y"),y=k.item.querySelector(".signature-box-width"),S=k.item.querySelector(".signature-box-height");g&&(g.value=String(O(H(F.xPt,P)))),d&&(d.value=String(O(H(F.yPt,P)))),y&&(y.value=String(O(H(_,P)))),S&&(S.value=String(O(H(B,P))))}function Ke(){if(!k)return;const t=k;if(k.overlay.classList.remove("dragging"),Pe=!1,document.removeEventListener("mousemove",Ze),document.removeEventListener("mouseup",Ke),ue){const e=je(),n=e[t.boxIndex];if(n&&e.some((o,r)=>r!==t.boxIndex&&ht(n,o))){const o=l=>Math.round(l*100)/100,r=t.item.querySelector(".signature-box-x"),a=t.item.querySelector(".signature-box-y"),i=t.item.querySelector(".signature-box-width"),u=t.item.querySelector(".signature-box-height");r&&(r.value=String(o(t.startFormX))),a&&(a.value=String(o(t.startFormY))),i&&(i.value=String(o(t.startFormW))),u&&(u.value=String(o(t.startFormH)));const c=b.no_overlap_message??"Signature boxes on the same page cannot overlap.";alert(c)}}k=null,T()}C.addEventListener("mousedown",yt),ae&&ae.addEventListener("click",()=>_e(1,0,0)),Se(),ne.addEventListener("keydown",t=>{const e=t.target;if(!(e!=null&&e.closest("input, select, textarea"))){if(t.ctrlKey&&t.key==="z"){t.preventDefault();const n=E.querySelectorAll(":scope > .signature-box-item");if(n.length>0){const s=n[n.length-1],o=Array.from(E.querySelectorAll(":scope > .signature-box-item")).indexOf(s);if(s.remove(),se===o?we(null):se!==null&&se>o&&we(se-1),E.querySelectorAll(":scope > .signature-box-item").length===0){const r=document.getElementById("signature-boxes-empty");r&&r.classList.remove("d-none")}T(),Se()}return}if(t.key==="Delete"||t.key==="Backspace"){if(se===null)return;const s=E.querySelectorAll(":scope > .signature-box-item")[se];if(s){if(t.preventDefault(),s.remove(),we(null),E.querySelectorAll(":scope > .signature-box-item").length===0){const o=document.getElementById("signature-boxes-empty");o&&o.classList.remove("d-none")}T(),Se()}return}if(t.ctrlKey&&t.shiftKey&&t.key.toLowerCase()==="a"){if(t.preventDefault(),!j)return;const n=1,s=G[n];if(s){const o=s.scale||1.5,r=s.width/o,a=s.height/o;_e(n,(r-150)/2,(a-40)/2,150,40)}else _e(1,0,0)}}}),ne.addEventListener("submit",t=>{t.preventDefault(),E.querySelectorAll(":scope > .signature-box-item").forEach((n,s)=>{n.querySelectorAll("input, select, textarea").forEach(o=>{o.name=o.name.replace(/(\])\[\d+\](\[)/,`$1[${s}]$2`)})}),ne.submit()})}rt()})();
