(function(){"use strict";var ze=document.createElement("style");ze.textContent=`.nowo-pdf-signable-widget .pdf-viewer-outer{display:flex;flex-direction:column;gap:.5rem;max-height:75vh;min-height:400px;border:1px solid #dee2e6;border-radius:.375rem;background:#f8f9fa;overflow:hidden}.nowo-pdf-signable-widget #pdf-viewer-container{flex:1;position:relative;display:flex;min-height:0;gap:.5rem;overflow:hidden;scrollbar-gutter:auto}.nowo-pdf-signable-widget #pdf-thumbnails-strip{width:72px;flex-shrink:0;overflow-y:auto;padding:.25rem;background:#e9ecef}.nowo-pdf-signable-widget #pdf-thumbnails-strip .pdf-thumb{display:block;width:100%;margin-bottom:.25rem;cursor:pointer;border:2px solid transparent;border-radius:.25rem}.nowo-pdf-signable-widget #pdf-thumbnails-strip .pdf-thumb:hover{border-color:#0d6efd}.nowo-pdf-signable-widget #pdf-thumbnails-strip .pdf-thumb.current{border-color:#0d6efd;box-shadow:0 0 0 1px #0d6efd}.nowo-pdf-signable-widget #pdf-thumbnails-strip .pdf-thumb canvas{display:block;width:100%;height:auto}.nowo-pdf-signable-widget #pdf-thumbnails-strip::-webkit-scrollbar{width:6px}.nowo-pdf-signable-widget #pdf-thumbnails-strip::-webkit-scrollbar-thumb{background:#adb5bd;border-radius:3px}.nowo-pdf-signable-widget #pdf-thumbnails-strip::-webkit-scrollbar-thumb:hover{background:#868e96}.nowo-pdf-signable-widget #pdf-thumbnails-strip::-webkit-scrollbar-track{background:transparent}.nowo-pdf-signable-widget .pdf-viewer-scroll{flex:1;min-width:0;display:flex;flex-direction:column;overflow:auto;box-sizing:border-box}.nowo-pdf-signable-widget .pdf-viewer-scroll>.pdf-zoom-toolbar{flex-shrink:0;position:sticky;top:0;z-index:50}.nowo-pdf-signable-widget .pdf-viewer-scroll::-webkit-scrollbar{width:6px;height:6px}.nowo-pdf-signable-widget .pdf-viewer-scroll::-webkit-scrollbar-thumb{background:#adb5bd;border-radius:3px}.nowo-pdf-signable-widget .pdf-viewer-scroll::-webkit-scrollbar-thumb:hover{background:#868e96}.nowo-pdf-signable-widget .pdf-viewer-scroll::-webkit-scrollbar-track{background:transparent}.nowo-pdf-signable-widget #pdf-canvas-wrapper{position:relative;display:block;width:100%;padding:.5rem}.nowo-pdf-signable-widget #pdf-canvas-wrapper canvas{display:block;cursor:crosshair}.nowo-pdf-signable-widget .pdf-page-wrapper{position:relative;display:inline-block;margin-bottom:10px}.nowo-pdf-signable-widget .pdf-grid-overlay{position:absolute;left:0;top:0;pointer-events:none}.nowo-pdf-signable-widget .signature-overlays{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}.nowo-pdf-signable-widget .signature-overlays .signature-box-overlay{pointer-events:auto}.nowo-pdf-signable-widget .signature-box-overlay{position:absolute;border:2px solid var(--box-color, rgba(13, 110, 253, .8));background:var(--box-bg, rgba(13, 110, 253, .12));box-sizing:border-box;font-size:10px;color:var(--box-color, #0d6efd);overflow:hidden;cursor:move;-webkit-user-select:none;user-select:none}.nowo-pdf-signable-widget .signature-box-overlay.dragging{z-index:10;opacity:.9;box-shadow:0 4px 12px #0003}.nowo-pdf-signable-widget .signature-box-overlay.selected{box-shadow:0 0 0 3px #0d6efd99;z-index:5}.nowo-pdf-signable-widget .signature-box-overlay .overlay-label{padding:2px 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle{position:absolute;width:12px;height:12px;background:var(--box-color, rgba(13, 110, 253, .9));border:1px solid #fff;border-radius:3px;pointer-events:auto;z-index:1}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle.nw{top:-6px;left:-6px;cursor:nwse-resize}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle.ne{top:-6px;right:-6px;cursor:nesw-resize}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle.sw{bottom:-6px;left:-6px;cursor:nesw-resize}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle.se{bottom:-6px;right:-6px;cursor:nwse-resize}.nowo-pdf-signable-widget .signature-box-overlay .rotate-handle{position:absolute;top:-14px;left:50%;transform:translate(-50%);width:16px;height:16px;background:var(--box-color, rgba(13, 110, 253, .9));border:1px solid #fff;border-radius:50%;pointer-events:auto;cursor:grab;z-index:2}.nowo-pdf-signable-widget .signature-box-overlay .rotate-handle:active{cursor:grabbing}.nowo-pdf-signable-widget .pdf-signable-loading-overlay{position:absolute;top:0;right:0;bottom:0;left:0;background:#f8f9fae6;display:flex;align-items:center;justify-content:center;z-index:100;border-radius:.375rem}.nowo-pdf-signable-widget .pdf-zoom-toolbar{flex-shrink:0;padding:.25rem .5rem;display:flex;align-items:center;gap:.25rem;background:#fff;border-bottom:1px solid #dee2e6}.nowo-pdf-signable-widget .pdf-zoom-toolbar .pdf-zoom-value{min-width:2.5rem;text-align:center}.nowo-pdf-signable-widget .signature-box-item{border:1px solid #dee2e6;padding:1rem;margin-bottom:.75rem;border-radius:.375rem;background:#fff}.nowo-pdf-signable-widget #signature-boxes-list{max-height:50vh;overflow-y:auto}.nowo-pdf-signable-widget .signature-capture-row,.nowo-pdf-signable-widget .signature-pad-wrapper{width:100%}.nowo-pdf-signable-widget .signature-pad-canvas{width:100%;max-width:100%;height:120px;display:block;box-sizing:border-box;border:1px solid #dee2e6;border-radius:.25rem;touch-action:none}
/*$vite$:1*/`,document.head.appendChild(ze);const Ae=24;function at(y,L){try{return new URL(L,window.location.origin).origin===window.location.origin?L:y+"?url="+encodeURIComponent(L)}catch{return y+"?url="+encodeURIComponent(L)}}function De(y){return y.querySelector(".pdf-viewer-scroll")??y}async function Be(y,L){if(!y||!L)return 1.5;await new Promise(p=>requestAnimationFrame(()=>p()));const te=(await y.getPage(1)).getViewport({scale:1}),O=De(L),F=Math.max(0,O.clientWidth-Ae);return F<=0?1.5:Math.max(.5,F/te.width)}async function st(y,L){if(!y||!L)return 1.5;await new Promise(Z=>requestAnimationFrame(()=>Z()));const te=(await y.getPage(1)).getViewport({scale:1}),O=De(L),F=Math.max(0,O.clientWidth-Ae),p=Math.max(0,O.clientHeight-Ae);if(F<=0||p<=0)return 1.5;const ne=F/te.width,se=p/te.height;return Math.max(.5,Math.min(ne,se))}const Xe={pt:1,mm:25.4/72,cm:2.54/72,in:1/72,px:96/72},rt=220,it=37,lt=65,ct=48;function $(y,L){return y*(Xe[L]??1)}function V(y,L){return y/(Xe[L]??1)}function dt(y){return String(y).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function pt(y,L,P){y=y%360,y<0&&(y+=360);const te=L/100,O=P/100,F=(1-Math.abs(2*O-1))*te,p=F*(1-Math.abs(y/60%2-1)),ne=O-F/2;let se=0,Z=0,oe=0;y<60?(se=F,Z=p):y<120?(se=p,Z=F):y<180?(Z=F,oe=p):y<240?(Z=p,oe=F):y<300?(se=p,oe=F):(se=F,oe=p);const G=Te=>{const Le=Math.round((Te+ne)*255);return(Le<16?"0":"")+Math.min(255,Math.max(0,Le)).toString(16)};return"#"+G(se)+G(Z)+G(oe)}function ut(y){const L=(rt+y*it)%360,P=pt(L,lt,ct),te=parseInt(P.slice(1,3),16),O=parseInt(P.slice(3,5),16),F=parseInt(P.slice(5,7),16);return{border:P,background:`rgba(${te}, ${O}, ${F}, 0.15)`,color:P,handle:P}}function gt(){const y=window.NowoPdfSignableConfig;if(!y){console.warn("[PdfSignable] NowoPdfSignableConfig not found, skipping init");return}const{proxyUrl:L,strings:P,debug:te=!1}=y,O=(...t)=>{te&&console.log("[PdfSignable]",...t)},F=(...t)=>{te&&console.warn("[PdfSignable]",...t)},p=document.querySelector('[data-pdf-signable="widget"]')??document.querySelector(".nowo-pdf-signable-widget"),ne=p==null?void 0:p.closest("form");if(!ne||!p){F("Widget or form not found, skipping init");return}const se=(p==null?void 0:p.dataset.preventBoxOverlap)==="1",Z=(p==null?void 0:p.dataset.enableRotation)==="1";let oe={};try{const t=(p==null?void 0:p.dataset.boxDefaultsByName)??"{}";oe=typeof t=="string"?JSON.parse(t):{}}catch{oe={}}const G=Math.max(0,parseFloat((p==null?void 0:p.dataset.snapGrid)??"0")||0),Te=(p==null?void 0:p.dataset.snapToBoxes)==="1",Le=(p==null?void 0:p.dataset.showGrid)==="1",Re=Math.max(0,parseFloat((p==null?void 0:p.dataset.gridStep)??"10")||0),ft=10,Fe=t=>t.querySelector('[data-pdf-signable="page"]')??t.querySelector('input[name$="[page]"], select[name$="[page]"]');O("Initialized");const me=ne.querySelector('[data-pdf-signable="pdf-url"]'),ie=document.getElementById("loadPdfBtn"),ke=document.getElementById("pdf-placeholder"),He=document.getElementById("pdf-canvas-wrapper"),We=(p==null?void 0:p.querySelector('[data-pdf-signable="boxes-list"]'))??document.getElementById("signature-boxes-list"),le=document.getElementById("addBoxBtn"),xe=ne.querySelector('[data-pdf-signable="unit"]'),ve=ne.querySelector('[data-pdf-signable="origin"]'),h=document.getElementById("pdf-viewer-container"),Ye=document.getElementById("pdfZoomValue");if(!He||!We)return;const H=He,M=We;let fe=1,ce={x:0,y:0},A=null;const ht=80;function mt(){if(!_||!h)return;const t=h.querySelector("#pdf-thumbnails-strip"),e=h.querySelector(".pdf-viewer-scroll");!t||!e||(async()=>{for(let o=1;o<=_.numPages;o++){const a=await _.getPage(o),s=a.getViewport({scale:1}),r=ht/s.width,c=a.getViewport({scale:r}),i=document.createElement("canvas");i.width=c.width,i.height=c.height;const d=i.getContext("2d");if(!d)continue;await a.render({canvasContext:d,viewport:c}).promise;const l=document.createElement("button");l.type="button",l.className="pdf-thumb",l.dataset.page=String(o),l.setAttribute("aria-label","Page "+o),l.appendChild(i),l.addEventListener("click",()=>{const g=H.querySelector('.pdf-page-wrapper[data-page="'+o+'"]');g&&(g.scrollIntoView({behavior:"smooth",block:"start"}),t.querySelectorAll(".pdf-thumb.current").forEach(u=>u.classList.remove("current")),l.classList.add("current"))}),t.appendChild(l)}const n=()=>{const o=t,a=H.querySelectorAll(".pdf-page-wrapper");if(a.length===0)return;const s=e.getBoundingClientRect(),r=s.top+s.height/2;let c=1,i=1/0;a.forEach(l=>{const g=parseInt(l.dataset.page??"1",10),u=l.getBoundingClientRect(),x=u.top+u.height/2,w=Math.abs(x-r);w<i&&(i=w,c=g)}),o.querySelectorAll(".pdf-thumb.current").forEach(l=>l.classList.remove("current"));const d=o.querySelector('.pdf-thumb[data-page="'+c+'"]');d&&d.classList.add("current")};e.addEventListener("scroll",n),requestAnimationFrame(n),t.firstElementChild&&t.firstElementChild.classList.add("current")})()}function bt(){A||!h||(A=document.createElement("div"),A.id="pdf-touch-wrapper",A.style.transformOrigin="0 0",A.style.transform=`translate(${ce.x}px, ${ce.y}px) scale(${fe})`,h.insertBefore(A,H),A.appendChild(H),yt())}function yt(){if(!A)return;let t=0,e=1,n={x:0,y:0},o=0,a=0;A.addEventListener("touchstart",s=>{if(s.touches.length===2){s.preventDefault();const r=s.touches[0],c=s.touches[1];t=Math.hypot(c.clientX-r.clientX,c.clientY-r.clientY),e=fe,n={...ce},o=(r.clientX+c.clientX)/2,a=(r.clientY+c.clientY)/2}},{passive:!1}),A.addEventListener("touchmove",s=>{if(s.touches.length===2&&A){s.preventDefault();const r=s.touches[0],c=s.touches[1],i=Math.hypot(c.clientX-r.clientX,c.clientY-r.clientY),d=Math.max(.25,Math.min(4,e*i/t)),l=(r.clientX+c.clientX)/2,g=(r.clientY+c.clientY)/2;ce.x=n.x+(l-o),ce.y=n.y+(g-a),fe=d,A.style.transform=`translate(${ce.x}px, ${ce.y}px) scale(${fe})`}},{passive:!1})}function ae(){return(xe==null?void 0:xe.value)??(p==null?void 0:p.dataset.unitDefault)??"mm"}function be(){return(ve==null?void 0:ve.value)??(p==null?void 0:p.dataset.originDefault)??"bottom_left"}function _e(t,e,n,o,a,s){const r=t.scale||1.5,c=t.width/r,i=t.height/r;let d,l;switch(s){case"top_left":d=e,l=i-n-a;break;case"top_right":d=c-e-o,l=i-n-a;break;case"bottom_right":d=c-e-o,l=n;break;default:d=e,l=n;break}return{vpX:d*r,vpY:t.height-(l+a)*r}}function Ne(t,e,n,o,a,s){const r=t.scale||1.5,c=t.width/r,i=t.height/r,d=t.convertToPdfPoint(e,n+a*r),l=d[0],g=d[1];let u,x;switch(s){case"top_left":u=l,x=i-g-a;break;case"top_right":u=c-l-o,x=i-g-a;break;case"bottom_right":u=c-l-o,x=g;break;default:u=l,x=g;break}return{xPt:u,yPt:x}}let _=null;const J={};let Ie=null,Ce=!1,Q=1.5;function xt(){if(!h||!A||h.querySelector(".pdf-viewer-scroll"))return;const e=document.createElement("div");e.id="pdf-thumbnails-strip",e.setAttribute("aria-label","Page thumbnails");const n=document.createElement("div");n.className="pdf-viewer-scroll";const o=h.querySelector(".pdf-zoom-toolbar");o&&n.appendChild(o),n.appendChild(A),h.appendChild(n),h.insertBefore(e,n)}function vt(t,e,n,o,a){const s=t.getContext("2d");if(!s)return;const r=e.width/n,c=e.height/n,i=$(r,o),d=$(c,o);s.strokeStyle="rgba(0, 0, 0, 0.15)",s.lineWidth=1;for(let l=0;l<=i;l+=a){const u=V(l,o)*n;s.beginPath(),s.moveTo(u,0),s.lineTo(u,e.height),s.stroke()}for(let l=0;l<=d;l+=a){const g=V(l,o),u=e.height-g*n;s.beginPath(),s.moveTo(0,u),s.lineTo(e.width,u),s.stroke()}}async function ye(t){if(_){Object.keys(J).forEach(e=>delete J[Number(e)]),H.innerHTML="";for(let e=1;e<=_.numPages;e++){Ie&&await Ie;const n=await _.getPage(e),o=n.getViewport({scale:t});J[e]=o;const a=document.createElement("div");a.className="pdf-page-wrapper",a.dataset.page=String(e);const s=document.createElement("canvas"),r=s.getContext("2d");if(!r)continue;s.height=o.height,s.width=o.width,s.dataset.page=String(e);const c=document.createElement("div");if(c.className="signature-overlays",a.appendChild(s),Le&&Re>0){const i=document.createElement("canvas");i.className="pdf-grid-overlay",i.width=o.width,i.height=o.height,i.dataset.page=String(e),vt(i,o,t,ae(),Re),a.appendChild(i)}a.appendChild(c),Ie=n.render({canvasContext:r,viewport:o}).promise,await Ie,H.appendChild(a)}Ye&&(Ye.textContent=Math.round(t*100)+"%"),W()}}function wt(){var t,e,n,o,a;(t=h==null?void 0:h.querySelector("#pdf-zoom-toolbar"))==null||t.remove(),(e=document.getElementById("pdfZoomOut"))==null||e.addEventListener("click",()=>{_&&(Q=Math.max(.5,Q/1.25),ye(Q))}),(n=document.getElementById("pdfZoomIn"))==null||n.addEventListener("click",()=>{_&&(Q=Math.min(4,Q*1.25),ye(Q))}),(o=document.getElementById("pdfFitWidth"))==null||o.addEventListener("click",async()=>{if(!_)return;Q=await Be(_,h),await ye(Q)}),(a=document.getElementById("pdfFitPage"))==null||a.addEventListener("click",async()=>{if(!_)return;Q=await st(_,h),await ye(Q)})}async function Ue(){var r,c;const t=((r=me==null?void 0:me.value)==null?void 0:r.trim())??"";if(!t){F("Load PDF: URL required"),alert(P.alert_url_required);return}const e=at(L,t);O("Loading PDF",{url:t,viaProxy:e!==t}),ie&&(ie.setAttribute("disabled",""),ie.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> '+P.loading_state),ke&&(ke.style.display="block"),H.style.display="none",H.innerHTML="";const n=h==null?void 0:h.querySelector("#pdf-thumbnails-strip"),o=h==null?void 0:h.querySelector(".pdf-viewer-scroll"),a=o==null?void 0:o.querySelector(".pdf-zoom-toolbar");a&&h&&h.insertBefore(a,h.firstChild),o&&A&&A.parentElement===o&&(o.removeChild(A),h==null||h.appendChild(A)),n==null||n.remove(),o==null||o.remove(),(c=h==null?void 0:h.querySelector("#pdf-zoom-toolbar"))==null||c.remove(),fe=1,ce={x:0,y:0},A&&(A.style.transform="translate(0px, 0px) scale(1)");const s=document.createElement("div");s.className="pdf-signable-loading-overlay",s.setAttribute("aria-live","polite"),s.setAttribute("aria-busy","true"),s.innerHTML='<div class="text-center"><div class="spinner-border text-primary mb-2" role="status"><span class="visually-hidden">'+P.loading_state+'</span></div><p class="text-muted small mb-0">'+P.loading_state+"</p></div>",h&&h.appendChild(s);try{_=await pdfjsLib.getDocument(e).promise,Object.keys(J).forEach(l=>delete J[Number(l)]),bt(),xt();const i=await Be(_,h);Q=i,await ye(i),ke&&(ke.style.display="none"),H.style.display="block",mt(),requestAnimationFrame(()=>{W(),setTimeout(W,100),setTimeout(W,350),setTimeout(W,700)}),O("PDF loaded",{pages:_.numPages,scale:i})}catch(i){O("PDF load failed",i),alert(P.error_load_pdf+(i instanceof Error?i.message:String(i)))}finally{s.remove(),ie&&(ie.removeAttribute("disabled"),ie.innerHTML=P.load_pdf_btn)}}function W(){if(Ce||Object.keys(J).length===0)return;const t=ae(),e=be();H.querySelectorAll(".signature-overlays").forEach(r=>{r.innerHTML=""});const n=M.querySelectorAll(':scope > [data-pdf-signable="box-item"]'),o={},a={};let s=0;if(n.forEach((r,c)=>{var pe,j,he,ue,Me,qe;const i=parseInt(((pe=Fe(r))==null?void 0:pe.value)??"1",10),d=parseFloat(((j=r.querySelector('[data-pdf-signable="x"]'))==null?void 0:j.value)??"0"),l=parseFloat(((he=r.querySelector('[data-pdf-signable="y"]'))==null?void 0:he.value)??"0"),g=parseFloat(((ue=r.querySelector('[data-pdf-signable="width"]'))==null?void 0:ue.value)??"150"),u=parseFloat(((Me=r.querySelector('[data-pdf-signable="height"]'))==null?void 0:Me.value)??"40"),x=r.querySelector('[data-pdf-signable="angle"]'),w=Z&&x?parseFloat(x.value??"0"):0,D=r.querySelector('[data-pdf-signable="signature-data"]'),X=(qe=D==null?void 0:D.value)==null?void 0:qe.trim(),C=r.querySelector('[data-pdf-signable="name"]'),q=((C==null?void 0:C.value)??"").trim(),N=q===""?"__empty__":q;N in a||(a[N]=s++);const Y=a[N];o[q]=(o[q]??0)+1;const m=o[q],f=q===""?"":q+(m>1?` (${m})`:""),v=H.querySelector(`.pdf-page-wrapper[data-page="${i}"] .signature-overlays`),k=J[i];if(!v||!k)return;const B=k.scale||1.5,U=V(d,t),E=V(l,t),T=V(g,t),R=V(u,t),b=_e(k,U,E,T,R,e),I=T*B,K=R*B,S=document.createElement("div");S.className="signature-box-overlay",S.dataset.pdfSignable="overlay",S.dataset.boxIndex=String(c),S.style.left=b.vpX+"px",S.style.top=b.vpY+"px",S.style.width=Math.max(I,20)+"px",S.style.height=Math.max(K,14)+"px";const ee=ut(Y);S.style.borderColor=ee.border,S.style.backgroundColor=ee.background,S.style.color=ee.color,S.style.setProperty("--box-color",ee.handle),S.style.transformOrigin="50% 50%",Z&&(S.style.transform=`rotate(${w}deg)`);const de=Z?'<span class="rotate-handle" title="Rotate"></span>':"";if(S.innerHTML=(f?'<span class="overlay-label">'+dt(f)+"</span>":"")+de+'<span class="resize-handle nw" data-handle="nw"></span><span class="resize-handle ne" data-handle="ne"></span><span class="resize-handle sw" data-handle="sw"></span><span class="resize-handle se" data-handle="se"></span>',X&&X.startsWith("data:")){const ge=document.createElement("img");ge.src=X,ge.alt="",ge.setAttribute("aria-hidden","true"),ge.style.cssText="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;pointer-events:none;",S.insertBefore(ge,S.firstChild)}v.appendChild(S)}),re!==null){const r=H.querySelector(`[data-pdf-signable="overlay"][data-box-index="${re}"]`);r&&r.classList.add("selected")}}const $e=1,St=6;function Ve(t){const e=t.getBoundingClientRect();if(e.width<=0||e.height<=0)return;const n=Math.min(window.devicePixelRatio||1,2),o=Math.max(1,Math.round(e.width*n)),a=Math.max(1,Math.round(e.height*n));t.width===o&&t.height===a||(t.width=o,t.height=a)}function Oe(){const t=document.querySelector('[data-pdf-signable="widget"]');t&&t.querySelectorAll(".signature-pad-canvas").forEach(e=>{var Y;if(e.dataset.padInited==="1")return;const n=e.closest('[data-pdf-signable="box-item"]'),o=n==null?void 0:n.querySelector('[data-pdf-signable="signature-data"]'),a=(Y=e.closest(".signature-pad-wrapper"))==null?void 0:Y.querySelector(".signature-pad-clear"),s=n==null?void 0:n.querySelector(".signature-upload-input");if(!o)return;const r=e.getContext("2d");if(!r)return;e.dataset.padInited="1";const c=e.closest(".signature-pad-wrapper"),i=()=>{Ve(e)};typeof ResizeObserver<"u"&&c&&new ResizeObserver(()=>{i()}).observe(c),requestAnimationFrame(i);let d=!1,l=0,g=0,u=0,x=0;const w=m=>{const f=e.getBoundingClientRect(),v=f.width?e.width/f.width:1,k=f.height?e.height/f.height:1;if("touches"in m&&m.touches.length>0){const U=m.touches[0];return{x:(U.clientX-f.left)*v,y:(U.clientY-f.top)*k}}const B=m;return{x:(B.clientX-f.left)*v,y:(B.clientY-f.top)*k}},D=m=>{if("touches"in m&&m.touches.length>0){const v=m.touches[0].force;if(typeof v=="number"&&v>=0)return Math.min(1,v)}const f=m;return typeof f.pressure=="number"&&f.pressure>=0?Math.min(1,f.pressure):.5},X=m=>{const f=D(m),v=$e+f*(St-$e);r.lineWidth=v},C=m=>{m.preventDefault(),Ve(e);const{x:f,y:v}=w(m);u=l=f,x=g=v,d=!0,r.strokeStyle="#000",X(m),r.lineCap="round",r.lineJoin="round",r.beginPath(),r.moveTo(f,v)},q=m=>{if(m.preventDefault(),!d)return;const{x:f,y:v}=w(m);X(m);const k=(l+f)/2,B=(g+v)/2;r.beginPath(),r.moveTo(u,x),r.quadraticCurveTo(l,g,k,B),r.stroke(),u=k,x=B,l=f,g=v},N=m=>{if(m.preventDefault(),!d)return;d=!1,e.width>0&&e.height>0&&(o.value=e.toDataURL("image/png"));const f=n==null?void 0:n.querySelector('[data-pdf-signable="signed-at"]');f&&(f.value=new Date().toISOString()),W()};e.addEventListener("mousedown",C),e.addEventListener("mousemove",q),e.addEventListener("mouseup",N),e.addEventListener("mouseleave",N),e.addEventListener("touchstart",C,{passive:!1}),e.addEventListener("touchmove",q,{passive:!1}),e.addEventListener("touchend",N,{passive:!1}),a&&a.addEventListener("click",()=>{const m=e.width,f=e.height;r.clearRect(0,0,m,f),o.value="";const v=n==null?void 0:n.querySelector('[data-pdf-signable="signed-at"]');v&&(v.value=""),W()}),s&&s.addEventListener("change",()=>{var v;const m=(v=s.files)==null?void 0:v[0];if(!m||!m.type.startsWith("image/"))return;const f=new FileReader;f.onload=()=>{if(typeof f.result=="string"){o.value=f.result;const k=n==null?void 0:n.querySelector('[data-pdf-signable="signed-at"]');k&&(k.value=new Date().toISOString()),W()}},f.readAsDataURL(m)})})}function Ge(){const t=M.dataset.maxEntries??(le==null?void 0:le.dataset.maxEntries)??"";if(t==="")return null;const e=parseInt(t,10);return Number.isNaN(e)?null:e}function we(){if(!le)return;const t=Ge(),e=M.querySelectorAll(':scope > [data-pdf-signable="box-item"]').length;t!==null&&e>=t?le.style.display="none":le.style.display=""}function Pe(t,e,n,o,a){const s=Ge(),r=M.querySelectorAll(':scope > [data-pdf-signable="box-item"]').length;if(s!==null&&r>=s){O("Box add skipped: max_entries reached",{max:s,currentCount:r});return}const c=o??150,i=a??40,d=document.getElementById("signature-boxes-empty");d&&d.classList.add("d-none");const l=M.dataset.prototype??"",g=M.querySelectorAll(':scope > [data-pdf-signable="box-item"]').length,u=l.replace(/__name__/g,String(g)),x=document.createElement("div");x.innerHTML=u;const w=x.firstElementChild;if(!w)return;w.dataset.index=String(g);const D=String(t),X=Fe(w);if(X){if(X instanceof HTMLSelectElement&&!Array.from(X.options).some(b=>b.value===D)){const b=document.createElement("option");b.value=D,b.textContent=D,X.appendChild(b)}X.value=D}const C=J[t],q=ae(),N=be(),Y=c,m=i,f=C?C.scale:1.5,v=C?C.width/f:595,k=C?C.height/f:842;let B,U;switch(N){case"top_left":B=e,U=k-n-m;break;case"top_right":B=v-e-Y,U=k-n-m;break;case"bottom_right":B=v-e-Y,U=n;break;default:B=e,U=n;break}const E=b=>Math.round(b*100)/100,T=w.querySelector('[data-pdf-signable="name"]');for(const b of["x","y","width","height"]){const I=w.querySelector(`[data-pdf-signable="${b}"]`);I&&(b==="x"?I.value=String(E($(B,q))):b==="y"?I.value=String(E($(U,q))):b==="width"?I.value=String(E($(Y,q))):b==="height"&&(I.value=String(E($(m,q)))))}const R=w.querySelector('[data-pdf-signable="angle"]');R&&(R.value="0"),T&&(T.value=P.default_box_name),M.appendChild(w),w.scrollIntoView({behavior:"smooth"}),W(),Oe(),we(),O("Box added",{page:t,x:B,y:U,width:c,height:i,unit:q})}ie&&ie.addEventListener("click",()=>Ue());const je=document.getElementById("unitBadge"),Et={pt:"pt",mm:"mm",cm:"cm",px:"px",in:"in"};function Ze(){je&&(je.textContent=Et[ae()]??ae())}Ze();let Ke=ae();if(xe&&xe.addEventListener("change",()=>{const t=Ke,e=ae();Ze(),M.querySelectorAll(':scope > [data-pdf-signable="box-item"]').forEach(n=>{for(const o of["x","y","width","height"]){const a=n.querySelector(`[data-pdf-signable="${o}"]`);if(a!=null&&a.value){const s=parseFloat(a.value);a.value=String(Math.round($(V(s,t),e)*100)/100)}}}),Ke=e,W()}),M.addEventListener("input",W),M.addEventListener("change",t=>{const e=t.target.closest('[data-pdf-signable="box-item"]'),n=e==null?void 0:e.querySelector('[data-pdf-signable="name"]');if(n&&t.target===n&&Object.keys(oe).length>0){const o=(n.value??"").trim(),a=o?oe[o]:null;if(a){const s=(r,c)=>{const i=e==null?void 0:e.querySelector(`[data-pdf-signable="${r}"]`);i&&c!==void 0&&(i.value=String(c))};s("width",a.width),s("height",a.height),s("x",a.x),s("y",a.y),s("angle",a.angle)}}W()}),ve&&ve.addEventListener("change",W),M.addEventListener("click",t=>{if(!t.target.closest(".remove-box"))return;const e=t.target.closest('[data-pdf-signable="box-item"]');if(e){let n=e;for(;n!=null&&n.parentElement&&n.parentElement!==M;)n=n.parentElement;if(n){const o=Array.from(M.querySelectorAll(':scope > [data-pdf-signable="box-item"]')).indexOf(n);n.remove(),O("Box removed",{index:o})}}if(M.querySelectorAll(':scope > [data-pdf-signable="box-item"]').length===0){const n=document.getElementById("signature-boxes-empty");n&&n.classList.remove("d-none")}W(),we()}),h){let t,e=!1,n=0;new ResizeObserver(()=>{if(e)return;const a=(h==null?void 0:h.clientWidth)??0;Math.abs(a-n)<10||(n=a,clearTimeout(t),t=setTimeout(async()=>{if(!(!_||H.style.display==="none")&&!e){e=!0;try{const s=await Be(_,h);Q=s,await ye(s),h&&(n=h.clientWidth)}finally{e=!1}}},200))}).observe(h)}wt();function Je(){var t;(t=me==null?void 0:me.value)!=null&&t.trim()&&(O("Auto-loading PDF (preset URL)"),Ue())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Je(),Oe()}):(Je(),Oe()),H.addEventListener("click",t=>{if(t.target.closest('[data-pdf-signable="overlay"]'))return;Se(null);const e=t.target.closest(".pdf-page-wrapper"),n=e==null?void 0:e.querySelector("canvas");if(!n||!_)return;const o=parseInt(n.dataset.page??"1",10),a=J[o];if(!a)return;const s=n.getBoundingClientRect(),r=n.width/s.width,c=n.height/s.height,i=(t.clientX-s.left)*r,d=(t.clientY-s.top)*c,l=40,g=l*(a.scale||1.5),u=a.convertToPdfPoint(i,d+g);Pe(o,u[0],u[1],150,l)});function Mt(t,e){if(t.page!==e.page)return!1;const n=t.x+t.w,o=e.x+e.w,a=t.y+t.h,s=e.y+e.h;return t.x<o&&e.x<n&&t.y<s&&e.y<a}function Qe(){const t=M.querySelectorAll(':scope > [data-pdf-signable="box-item"]'),e=[];return t.forEach(n=>{var i,d,l,g,u;const o=parseInt(((i=Fe(n))==null?void 0:i.value)??"1",10),a=parseFloat(((d=n.querySelector('[data-pdf-signable="x"]'))==null?void 0:d.value)??"0"),s=parseFloat(((l=n.querySelector('[data-pdf-signable="y"]'))==null?void 0:l.value)??"0"),r=parseFloat(((g=n.querySelector('[data-pdf-signable="width"]'))==null?void 0:g.value)??"150"),c=parseFloat(((u=n.querySelector('[data-pdf-signable="height"]'))==null?void 0:u.value)??"40");e.push({page:o,x:a,y:s,w:r,h:c})}),e}function qt(t,e,n){const o=n*Math.PI/180,a=Math.abs(Math.cos(o)),s=Math.abs(Math.sin(o));return{aabbW:t*a+e*s,aabbH:t*s+e*a}}function Lt(t,e){const n=J[t];if(!n)return[];const o=ae(),a=be(),s=n.scale||1.5,r=Qe(),c=[];return r.forEach((i,d)=>{if(d===e||i.page!==t)return;const l=V(i.x,o),g=V(i.y,o),u=V(i.w,o),x=V(i.h,o),{vpX:w,vpY:D}=_e(n,l,g,u,x,a);c.push({left:w,top:D,right:w+u*s,bottom:D+x*s})}),c}let z=null,re=null;function Se(t){if(re=t,H.querySelectorAll('[data-pdf-signable="overlay"].selected').forEach(e=>e.classList.remove("selected")),t!==null){const e=H.querySelector(`[data-pdf-signable="overlay"][data-box-index="${t}"]`);e&&e.classList.add("selected")}}let Ee=null;function et(t){if(!Ee)return;const{overlay:e,item:n,centerX:o,centerY:a,startAngle:s,startMouseAngle:r}=Ee;let i=(Math.atan2(t.clientY-a,t.clientX-o)-r)*180/Math.PI,d=s+i;for(;d>180;)d-=360;for(;d<-180;)d+=360;const l=n.querySelector('[data-pdf-signable="angle"]');l&&(l.value=String(Math.round(d*100)/100)),e.style.transform=`rotate(${d}deg)`}function tt(){Ee&&(document.removeEventListener("mousemove",et),document.removeEventListener("mouseup",tt),Ee=null)}function kt(t){var C,q;const e=t.target.closest('[data-pdf-signable="overlay"]');if(!((C=e==null?void 0:e.dataset)!=null&&C.boxIndex))return;t.preventDefault(),t.stopPropagation();const n=t.target.closest(".rotate-handle");if(Z&&n){const N=parseInt(e.dataset.boxIndex,10),Y=M.querySelectorAll(':scope > [data-pdf-signable="box-item"]')[N];if(!Y)return;const m=Y.querySelector('[data-pdf-signable="angle"]');if(!m)return;const f=e.getBoundingClientRect(),v=f.left+f.width/2,k=f.top+f.height/2,B=parseFloat(m.value)||0,U=Math.atan2(t.clientY-k,t.clientX-v);Ee={overlay:e,item:Y,centerX:v,centerY:k,startAngle:B,startMouseAngle:U},document.addEventListener("mousemove",et),document.addEventListener("mouseup",tt);return}const o=t.target.closest(".resize-handle"),a=parseInt(e.dataset.boxIndex,10),s=M.querySelectorAll(':scope > [data-pdf-signable="box-item"]')[a];if(!s)return;const r=e.closest(".pdf-page-wrapper"),c=parseInt(((q=r==null?void 0:r.dataset)==null?void 0:q.page)??"1",10),i=J[c];if(!i)return;const d=parseFloat(e.style.width)||20,l=parseFloat(e.style.height)||14,g=parseFloat(e.style.left)||0,u=parseFloat(e.style.top)||0,x=s.querySelector('[data-pdf-signable="x"]'),w=s.querySelector('[data-pdf-signable="y"]'),D=s.querySelector('[data-pdf-signable="width"]'),X=s.querySelector('[data-pdf-signable="height"]');z={mode:o?"resize":"move",handle:o?o.dataset.handle??null:null,overlay:e,item:s,boxIndex:a,viewport:i,startX:t.clientX,startY:t.clientY,startLeft:g,startTop:u,startRight:g+d,startBottom:u+l,startFormX:x&&parseFloat(x.value)||0,startFormY:w&&parseFloat(w.value)||0,startFormW:D&&parseFloat(D.value)||150,startFormH:X&&parseFloat(X.value)||40},e.classList.add("dragging"),Ce=!0,z.mode==="move"&&Se(a),document.addEventListener("mousemove",nt),document.addEventListener("mouseup",ot)}function nt(t){var B,U;if(!z)return;const{overlay:e,viewport:n,startLeft:o,startTop:a,startRight:s,startBottom:r}=z,c=(t.clientX-z.startX)/fe,i=(t.clientY-z.startY)/fe,d=20;let l,g,u,x;if(z.mode==="move"){const E=s-o,T=r-a,R=z.item.querySelector('[data-pdf-signable="angle"]'),b=Z&&R&&parseFloat(R.value)||0,{aabbW:I,aabbH:K}=qt(E,T,b),S=I/2-E/2,ee=n.width-I/2-E/2,de=K/2-T/2,pe=n.height-K/2-T/2;l=Math.max(S,Math.min(ee,o+c)),g=Math.max(de,Math.min(pe,a+i)),u=E,x=T}else{const E=z.handle;let T=o,R=a,b=s,I=r;E==="se"?(b=Math.min(n.width,Math.max(o+d,s+c)),I=Math.min(n.height,Math.max(a+d,r+i))):E==="sw"?(T=Math.max(0,Math.min(s-d,o+c)),I=Math.min(n.height,Math.max(a+d,r+i))):E==="ne"?(b=Math.min(n.width,Math.max(o+d,s+c)),R=Math.max(0,Math.min(r-d,a+i))):E==="nw"&&(T=Math.max(0,Math.min(s-d,o+c)),R=Math.max(0,Math.min(r-d,a+i))),l=T,g=R,u=b-T,x=I-R}const w=n.scale||1.5,D=parseInt(((U=(B=e.closest(".pdf-page-wrapper"))==null?void 0:B.dataset)==null?void 0:U.page)??"1",10);if(G>0){const E=u/w,T=x/w,R=Ne(n,l,g,E,T,be()),b=ae();let I=$(R.xPt,b),K=$(R.yPt,b),S=$(E,b),ee=$(T,b);I=Math.round(I/G)*G,K=Math.round(K/G)*G,S=Math.round(S/G)*G,ee=Math.max(G,Math.round(ee/G)*G);const de=V(I,b),pe=V(K,b),j=V(S,b),he=V(ee,b),ue=_e(n,de,pe,j,he,be());l=ue.vpX,g=ue.vpY,u=j*w,x=he*w}if(Te){const E=Lt(D,z.boxIndex),T=l+u,R=g+x,b=E.flatMap(j=>[j.left,j.right]),I=E.flatMap(j=>[j.top,j.bottom]),K=(j,he)=>{let ue=j,Me=ft;for(const qe of he){const ge=Math.abs(j-qe);ge<Me&&(Me=ge,ue=qe)}return ue},S=K(l,b),ee=K(T,b),de=K(g,I),pe=K(R,I);l=S,g=de,u=Math.max(d,ee-S),x=Math.max(d,pe-de)}e.style.left=l+"px",e.style.top=g+"px",e.style.width=u+"px",e.style.height=x+"px";const X=u/w,C=x/w,q=Ne(n,l,g,X,C,be()),N=ae(),Y=E=>Math.round(E*100)/100,m=z.item.querySelector('[data-pdf-signable="x"]'),f=z.item.querySelector('[data-pdf-signable="y"]'),v=z.item.querySelector('[data-pdf-signable="width"]'),k=z.item.querySelector('[data-pdf-signable="height"]');m&&(m.value=String(Y($(q.xPt,N)))),f&&(f.value=String(Y($(q.yPt,N)))),v&&(v.value=String(Y($(X,N)))),k&&(k.value=String(Y($(C,N))))}function ot(){if(!z)return;const t=z;if(z.overlay.classList.remove("dragging"),Ce=!1,document.removeEventListener("mousemove",nt),document.removeEventListener("mouseup",ot),se){const e=Qe(),n=e[t.boxIndex];if(n&&e.some((a,s)=>s!==t.boxIndex&&Mt(n,a))){const a=l=>Math.round(l*100)/100,s=t.item.querySelector('[data-pdf-signable="x"]'),r=t.item.querySelector('[data-pdf-signable="y"]'),c=t.item.querySelector('[data-pdf-signable="width"]'),i=t.item.querySelector('[data-pdf-signable="height"]');s&&(s.value=String(a(t.startFormX))),r&&(r.value=String(a(t.startFormY))),c&&(c.value=String(a(t.startFormW))),i&&(i.value=String(a(t.startFormH)));const d=P.no_overlap_message??"Signature boxes on the same page cannot overlap.";alert(d)}}z=null,W()}H.addEventListener("mousedown",kt),le&&le.addEventListener("click",()=>Pe(1,0,0)),we(),ne.addEventListener("keydown",t=>{const e=t.target;if(!(e!=null&&e.closest("input, select, textarea"))){if(t.ctrlKey&&t.key==="z"){t.preventDefault();const n=M.querySelectorAll(':scope > [data-pdf-signable="box-item"]');if(n.length>0){const o=n[n.length-1],a=Array.from(M.querySelectorAll(':scope > [data-pdf-signable="box-item"]')).indexOf(o);if(o.remove(),re===a?Se(null):re!==null&&re>a&&Se(re-1),M.querySelectorAll(':scope > [data-pdf-signable="box-item"]').length===0){const s=document.getElementById("signature-boxes-empty");s&&s.classList.remove("d-none")}W(),we()}return}if(t.key==="Delete"||t.key==="Backspace"){if(re===null)return;const o=M.querySelectorAll(':scope > [data-pdf-signable="box-item"]')[re];if(o){if(t.preventDefault(),o.remove(),Se(null),M.querySelectorAll(':scope > [data-pdf-signable="box-item"]').length===0){const a=document.getElementById("signature-boxes-empty");a&&a.classList.remove("d-none")}W(),we()}return}if(t.ctrlKey&&t.shiftKey&&t.key.toLowerCase()==="a"){if(t.preventDefault(),!_)return;const n=1,o=J[n];if(o){const a=o.scale||1.5,s=o.width/a,r=o.height/a;Pe(n,(s-150)/2,(r-40)/2,150,40)}else Pe(1,0,0)}}}),ne.addEventListener("submit",t=>{t.preventDefault(),M.querySelectorAll(':scope > [data-pdf-signable="box-item"]').forEach((n,o)=>{n.querySelectorAll("input, select, textarea").forEach(a=>{a.name=a.name.replace(/(\])\[\d+\](\[)/,`$1[${o}]$2`)})}),ne.submit()})}gt()})();
