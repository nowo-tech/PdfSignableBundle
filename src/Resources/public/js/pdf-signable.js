(function(){"use strict";const pe={pt:1,mm:.35277777777777775,cm:.035277777777777776,in:.013888888888888888,px:1.3333333333333333};function $(m,Y){return m*(pe[Y]??1)}function ne(m,Y){return m/(pe[Y]??1)}function Be(m){return String(m).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const Pe=220,ke=37,Ae=65,Ce=48;function Oe(m,Y,x){m=m%360,m<0&&(m+=360);const v=Y/100,k=x/100,A=(1-Math.abs(2*k-1))*v,H=A*(1-Math.abs(m/60%2-1)),ee=k-A/2;let C=0,q=0,V=0;m<60?(C=A,q=H):m<120?(C=H,q=A):m<180?(q=A,V=H):m<240?(q=H,V=A):m<300?(C=H,V=A):(C=A,V=H);const te=ie=>{const D=Math.round((ie+ee)*255);return(D<16?"0":"")+Math.min(255,Math.max(0,D)).toString(16)};return"#"+te(C)+te(q)+te(V)}function Te(m){const Y=(Pe+m*ke)%360,x=Oe(Y,Ae,Ce),v=parseInt(x.slice(1,3),16),k=parseInt(x.slice(3,5),16),A=parseInt(x.slice(5,7),16);return{border:x,background:`rgba(${v}, ${k}, ${A}, 0.15)`,color:x,handle:x}}function He(){console.log("[PdfSignable] Script loaded");const m=window.NowoPdfSignableConfig;if(!m){console.warn("[PdfSignable] NowoPdfSignableConfig not found, skipping init");return}const{proxyUrl:Y,strings:x}=m,v=document.querySelector(".nowo-pdf-signable-widget"),k=v==null?void 0:v.closest("form");if(!k){console.warn("[PdfSignable] .nowo-pdf-signable-widget or form not found, skipping init");return}const A=(v==null?void 0:v.dataset.preventBoxOverlap)==="1",H=(v==null?void 0:v.dataset.enableRotation)==="1";let ee={};try{const e=(v==null?void 0:v.dataset.boxDefaultsByName)??"{}";ee=typeof e=="string"?JSON.parse(e):{}}catch{ee={}}console.log("[PdfSignable] Initialized");const C=k.querySelector(".pdf-url-input"),q=document.getElementById("loadPdfBtn"),V=document.getElementById("pdf-placeholder"),te=document.getElementById("pdf-canvas-wrapper"),ie=document.getElementById("signature-boxes-list"),D=document.getElementById("addBoxBtn"),oe=k.querySelector(".unit-selector"),se=k.querySelector(".origin-selector"),N=document.getElementById("pdf-viewer-container");if(!te||!ie)return;const L=te,p=ie;function Q(){return(oe==null?void 0:oe.value)??"mm"}function de(){return(se==null?void 0:se.value)??"bottom_left"}function De(e,t,n,a,o,r){const s=e.scale||1.5,u=e.width/s,c=e.height/s;let l,i;switch(r){case"top_left":l=t,i=c-n-o;break;case"top_right":l=u-t-a,i=c-n-o;break;case"bottom_right":l=u-t-a,i=n;break;default:l=t,i=n;break}return{vpX:l*s,vpY:e.height-(i+o)*s}}function Ne(e,t,n,a,o,r){const s=e.scale||1.5,u=e.width/s,c=e.height/s,l=e.convertToPdfPoint(t,n+o*s),i=l[0],g=l[1];let d,h;switch(r){case"top_left":d=i,h=c-g-o;break;case"top_right":d=u-i-a,h=c-g-o;break;case"bottom_right":d=u-i-a,h=g;break;default:d=i,h=g;break}return{xPt:d,yPt:h}}let R=null;const O={};let G=null,ge=!1;function Re(e){try{return new URL(e,window.location.origin).origin===window.location.origin?e:Y+"?url="+encodeURIComponent(e)}catch{return Y+"?url="+encodeURIComponent(e)}}async function me(){if(!R||!N)return 1.5;const t=(await R.getPage(1)).getViewport({scale:1}),n=N.clientWidth-24;return n<=0?1.5:Math.max(.5,n/t.width)}async function fe(){var a;const e=((a=C==null?void 0:C.value)==null?void 0:a.trim())??"";if(!e){console.warn("[PdfSignable] Load PDF: URL required"),alert(x.alert_url_required);return}const t=Re(e);console.log("[PdfSignable] Loading PDF",{url:e,viaProxy:t!==e}),q&&(q.setAttribute("disabled",""),q.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> '+x.loading_state),V&&(V.style.display="block"),L.style.display="none",L.innerHTML="";const n=document.createElement("div");n.className="pdf-signable-loading-overlay",n.setAttribute("aria-live","polite"),n.setAttribute("aria-busy","true"),n.innerHTML='<div class="text-center"><div class="spinner-border text-primary mb-2" role="status"><span class="visually-hidden">'+x.loading_state+'</span></div><p class="text-muted small mb-0">'+x.loading_state+"</p></div>",N&&N.appendChild(n);try{R=await pdfjsLib.getDocument(t).promise,Object.keys(O).forEach(s=>delete O[Number(s)]);const o=await me();for(let s=1;s<=R.numPages;s++){G&&await G;const u=await R.getPage(s),c=u.getViewport({scale:o});O[s]=c;const l=document.createElement("div");l.className="pdf-page-wrapper",l.dataset.page=String(s);const i=document.createElement("canvas"),g=i.getContext("2d");if(!g)continue;i.height=c.height,i.width=c.width,i.dataset.page=String(s);const d=document.createElement("div");d.className="signature-overlays",l.appendChild(i),l.appendChild(d),G=u.render({canvasContext:g,viewport:c}).promise,await G,L.appendChild(l)}V&&(V.style.display="none"),L.style.display="block",requestAnimationFrame(()=>{I(),setTimeout(I,100),setTimeout(I,350),setTimeout(I,700)}),console.log("[PdfSignable] PDF loaded",{pages:R.numPages,scale:o})}catch(o){console.error("[PdfSignable] PDF load failed",o),alert(x.error_load_pdf+(o instanceof Error?o.message:String(o)))}finally{n.remove(),q&&(q.removeAttribute("disabled"),q.innerHTML=x.load_pdf_btn)}}function I(){if(ge||Object.keys(O).length===0)return;const e=Q(),t=de();L.querySelectorAll(".signature-overlays").forEach(s=>{s.innerHTML=""});const n=p.querySelectorAll(":scope > .signature-box-item"),a={},o={};let r=0;if(n.forEach((s,u)=>{var Le,Ie,Me,_e,Fe;const c=parseInt(((Le=s.querySelector(".signature-box-page"))==null?void 0:Le.value)??"1",10),l=parseFloat(((Ie=s.querySelector(".signature-box-x"))==null?void 0:Ie.value)??"0"),i=parseFloat(((Me=s.querySelector(".signature-box-y"))==null?void 0:Me.value)??"0"),g=parseFloat(((_e=s.querySelector(".signature-box-width"))==null?void 0:_e.value)??"150"),d=parseFloat(((Fe=s.querySelector(".signature-box-height"))==null?void 0:Fe.value)??"40"),h=s.querySelector(".signature-box-angle"),S=H&&h?parseFloat(h.value??"0"):0,T=s.querySelector(".signature-box-name"),f=((T==null?void 0:T.value)??"").trim(),w=f===""?"__empty__":f;w in o||(o[w]=r++);const X=o[w];a[f]=(a[f]??0)+1;const B=a[f],P=f===""?"":f+(B>1?` (${B})`:""),U=L.querySelector(`.pdf-page-wrapper[data-page="${c}"] .signature-overlays`),M=O[c];if(!U||!M)return;const W=M.scale||1.5,y=ne(l,e),E=ne(i,e),_=ne(g,e),j=ne(d,e),K=De(M,y,E,_,j,t),J=_*W,Z=j*W,F=document.createElement("div");F.className="signature-box-overlay",F.dataset.boxIndex=String(u),F.style.left=K.vpX+"px",F.style.top=K.vpY+"px",F.style.width=Math.max(J,20)+"px",F.style.height=Math.max(Z,14)+"px";const ue=Te(X);F.style.borderColor=ue.border,F.style.backgroundColor=ue.background,F.style.color=ue.color,F.style.setProperty("--box-color",ue.handle),F.style.transformOrigin="50% 50%",H&&(F.style.transform=`rotate(${S}deg)`);const Ve=H?'<span class="rotate-handle" title="Rotate"></span>':"";F.innerHTML=(P?'<span class="overlay-label">'+Be(P)+"</span>":"")+Ve+'<span class="resize-handle nw" data-handle="nw"></span><span class="resize-handle ne" data-handle="ne"></span><span class="resize-handle sw" data-handle="sw"></span><span class="resize-handle se" data-handle="se"></span>',U.appendChild(F)}),z!==null){const s=L.querySelector(`.signature-box-overlay[data-box-index="${z}"]`);s&&s.classList.add("selected")}}function he(){const e=p.dataset.maxEntries??(D==null?void 0:D.dataset.maxEntries)??"";if(e==="")return null;const t=parseInt(e,10);return Number.isNaN(t)?null:t}function ae(){if(!D)return;const e=he(),t=p.querySelectorAll(":scope > .signature-box-item").length;e!==null&&t>=e?D.style.display="none":D.style.display=""}function ce(e,t,n,a,o){const r=he(),s=p.querySelectorAll(":scope > .signature-box-item").length;if(r!==null&&s>=r){console.log("[PdfSignable] Box add skipped: max_entries reached",{max:r,currentCount:s});return}const u=a??150,c=o??40,l=document.getElementById("signature-boxes-empty");l&&l.classList.add("d-none");const i=p.dataset.prototype??"",g=p.querySelectorAll(":scope > .signature-box-item").length,d=i.replace(/__name__/g,String(g)),h=document.createElement("div");h.innerHTML=d;const S=h.firstElementChild;if(!S)return;S.dataset.index=String(g);const T=S.querySelector(".signature-box-page");T&&(T.value=String(e));const f=O[e],w=Q(),X=de(),B=u,P=c,U=f?f.scale:1.5,M=f?f.width/U:595,W=f?f.height/U:842;let y,E;switch(X){case"top_left":y=t,E=W-n-P;break;case"top_right":y=M-t-B,E=W-n-P;break;case"bottom_right":y=M-t-B,E=n;break;default:y=t,E=n;break}const _=J=>Math.round(J*100)/100,j=S.querySelector(".signature-box-name");for(const J of["x","y","width","height"]){const Z=S.querySelector(".signature-box-"+J);Z&&(J==="x"?Z.value=String(_($(y,w))):J==="y"?Z.value=String(_($(E,w))):J==="width"?Z.value=String(_($(B,w))):J==="height"&&(Z.value=String(_($(P,w)))))}const K=S.querySelector(".signature-box-angle");K&&(K.value="0"),j&&(j.value=x.default_box_name),p.appendChild(S),S.scrollIntoView({behavior:"smooth"}),I(),ae(),console.log("[PdfSignable] Box added",{page:e,x:y,y:E,width:u,height:c,unit:w})}q&&q.addEventListener("click",()=>fe());const ye=document.getElementById("unitBadge"),Xe={pt:"pt",mm:"mm",cm:"cm",px:"px",in:"in"};function xe(){ye&&(ye.textContent=Xe[Q()]??Q())}xe();let ve=Q();if(oe&&oe.addEventListener("change",()=>{const e=ve,t=Q();xe(),p.querySelectorAll(":scope > .signature-box-item").forEach(n=>{for(const a of["x","y","width","height"]){const o=n.querySelector(".signature-box-"+a);if(o!=null&&o.value){const r=parseFloat(o.value);o.value=String(Math.round($(ne(r,e),t)*100)/100)}}}),ve=t,I()}),p.addEventListener("input",I),p.addEventListener("change",e=>{const t=e.target.closest(".signature-box-item"),n=t==null?void 0:t.querySelector(".signature-box-name");if(n&&e.target===n&&Object.keys(ee).length>0){const a=(n.value??"").trim(),o=a?ee[a]:null;if(o){const r=(s,u)=>{const c=t==null?void 0:t.querySelector(".signature-box-"+s);c&&u!==void 0&&(c.value=String(u))};r("width",o.width),r("height",o.height),r("x",o.x),r("y",o.y),r("angle",o.angle)}}I()}),se&&se.addEventListener("change",I),p.addEventListener("click",e=>{if(!e.target.closest(".remove-box"))return;const t=e.target.closest(".signature-box-item");if(t){let n=t;for(;n!=null&&n.parentElement&&n.parentElement!==p;)n=n.parentElement;if(n){const a=Array.from(p.querySelectorAll(":scope > .signature-box-item")).indexOf(n);n.remove(),console.log("[PdfSignable] Box removed",{index:a})}}if(p.querySelectorAll(":scope > .signature-box-item").length===0){const n=document.getElementById("signature-boxes-empty");n&&n.classList.remove("d-none")}I(),ae()}),N){let e,t=!1,n=0;new ResizeObserver(()=>{if(t)return;const o=(N==null?void 0:N.clientWidth)??0;Math.abs(o-n)<10||(n=o,clearTimeout(e),e=setTimeout(async()=>{if(!(!R||L.style.display==="none")&&!t){t=!0;try{const r=await me();L.innerHTML="",Object.keys(O).forEach(s=>delete O[Number(s)]);for(let s=1;s<=R.numPages;s++){G&&await G;const u=await R.getPage(s),c=u.getViewport({scale:r});O[s]=c;const l=document.createElement("div");l.className="pdf-page-wrapper",l.dataset.page=String(s);const i=document.createElement("canvas"),g=i.getContext("2d");if(!g)continue;i.height=c.height,i.width=c.width,i.dataset.page=String(s);const d=document.createElement("div");d.className="signature-overlays",l.appendChild(i),l.appendChild(d),G=u.render({canvasContext:g,viewport:c}).promise,await G,L.appendChild(l)}I(),N&&(n=N.clientWidth)}finally{t=!1}}},200))}).observe(N)}function be(){var e;(e=C==null?void 0:C.value)!=null&&e.trim()&&(console.log("[PdfSignable] Auto-loading PDF (preset URL)"),fe())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",be):be(),L.addEventListener("click",e=>{if(e.target.closest(".signature-box-overlay"))return;re(null);const t=e.target.closest(".pdf-page-wrapper"),n=t==null?void 0:t.querySelector("canvas");if(!n||!R)return;const a=parseInt(n.dataset.page??"1",10),o=O[a];if(!o)return;const r=n.getBoundingClientRect(),s=n.width/r.width,u=n.height/r.height,c=(e.clientX-r.left)*s,l=(e.clientY-r.top)*u,i=40,g=i*(o.scale||1.5),d=o.convertToPdfPoint(c,l+g);ce(a,d[0],d[1],150,i)});function Ue(e,t){if(e.page!==t.page)return!1;const n=e.x+e.w,a=t.x+t.w,o=e.y+e.h,r=t.y+t.h;return e.x<a&&t.x<n&&e.y<r&&t.y<o}function We(){const e=p.querySelectorAll(":scope > .signature-box-item"),t=[];return e.forEach(n=>{var l,i,g,d;const a=n.querySelector(".signature-box-page"),o=parseInt((a==null?void 0:a.value)??"1",10),r=parseFloat(((l=n.querySelector(".signature-box-x"))==null?void 0:l.value)??"0"),s=parseFloat(((i=n.querySelector(".signature-box-y"))==null?void 0:i.value)??"0"),u=parseFloat(((g=n.querySelector(".signature-box-width"))==null?void 0:g.value)??"150"),c=parseFloat(((d=n.querySelector(".signature-box-height"))==null?void 0:d.value)??"40");t.push({page:o,x:r,y:s,w:u,h:c})}),t}let b=null,z=null;function re(e){if(z=e,L.querySelectorAll(".signature-box-overlay.selected").forEach(t=>t.classList.remove("selected")),e!==null){const t=L.querySelector(`.signature-box-overlay[data-box-index="${e}"]`);t&&t.classList.add("selected")}}let le=null;function Se(e){if(!le)return;const{overlay:t,item:n,centerX:a,centerY:o,startAngle:r,startMouseAngle:s}=le;let c=(Math.atan2(e.clientY-o,e.clientX-a)-s)*180/Math.PI,l=r+c;for(;l>180;)l-=360;for(;l<-180;)l+=360;const i=n.querySelector(".signature-box-angle");i&&(i.value=String(Math.round(l*100)/100)),t.style.transform=`rotate(${l}deg)`}function we(){le&&(document.removeEventListener("mousemove",Se),document.removeEventListener("mouseup",we),le=null)}function Ye(e){var w,X;const t=e.target.closest(".signature-box-overlay");if(!((w=t==null?void 0:t.dataset)!=null&&w.boxIndex))return;e.preventDefault(),e.stopPropagation();const n=e.target.closest(".rotate-handle");if(H&&n){const B=parseInt(t.dataset.boxIndex,10),P=p.querySelectorAll(":scope > .signature-box-item")[B];if(!P)return;const U=P.querySelector(".signature-box-angle");if(!U)return;const M=t.getBoundingClientRect(),W=M.left+M.width/2,y=M.top+M.height/2,E=parseFloat(U.value)||0,_=Math.atan2(e.clientY-y,e.clientX-W);le={overlay:t,item:P,centerX:W,centerY:y,startAngle:E,startMouseAngle:_},document.addEventListener("mousemove",Se),document.addEventListener("mouseup",we);return}const a=e.target.closest(".resize-handle"),o=parseInt(t.dataset.boxIndex,10),r=p.querySelectorAll(":scope > .signature-box-item")[o];if(!r)return;const s=t.closest(".pdf-page-wrapper"),u=parseInt(((X=s==null?void 0:s.dataset)==null?void 0:X.page)??"1",10),c=O[u];if(!c)return;const l=parseFloat(t.style.width)||20,i=parseFloat(t.style.height)||14,g=parseFloat(t.style.left)||0,d=parseFloat(t.style.top)||0,h=r.querySelector(".signature-box-x"),S=r.querySelector(".signature-box-y"),T=r.querySelector(".signature-box-width"),f=r.querySelector(".signature-box-height");b={mode:a?"resize":"move",handle:a?a.dataset.handle??null:null,overlay:t,item:r,boxIndex:o,viewport:c,startX:e.clientX,startY:e.clientY,startLeft:g,startTop:d,startRight:g+l,startBottom:d+i,startFormX:h&&parseFloat(h.value)||0,startFormY:S&&parseFloat(S.value)||0,startFormW:T&&parseFloat(T.value)||150,startFormH:f&&parseFloat(f.value)||40},t.classList.add("dragging"),ge=!0,b.mode==="move"&&re(o),document.addEventListener("mousemove",Ee),document.addEventListener("mouseup",qe)}function Ee(e){if(!b)return;const{overlay:t,viewport:n,startLeft:a,startTop:o,startRight:r,startBottom:s}=b,u=e.clientX-b.startX,c=e.clientY-b.startY,l=20;let i,g,d,h;if(b.mode==="move")i=Math.max(0,Math.min(n.width-(r-a),a+u)),g=Math.max(0,Math.min(n.height-(s-o),o+c)),d=r-a,h=s-o;else{const y=b.handle;let E=a,_=o,j=r,K=s;y==="se"?(j=Math.min(n.width,Math.max(a+l,r+u)),K=Math.min(n.height,Math.max(o+l,s+c))):y==="sw"?(E=Math.max(0,Math.min(r-l,a+u)),K=Math.min(n.height,Math.max(o+l,s+c))):y==="ne"?(j=Math.min(n.width,Math.max(a+l,r+u)),_=Math.max(0,Math.min(s-l,o+c))):y==="nw"&&(E=Math.max(0,Math.min(r-l,a+u)),_=Math.max(0,Math.min(s-l,o+c))),i=E,g=_,d=j-E,h=K-_}t.style.left=i+"px",t.style.top=g+"px",t.style.width=d+"px",t.style.height=h+"px";const S=n.scale||1.5,T=d/S,f=h/S,w=Ne(n,i,g,T,f,de()),X=Q(),B=y=>Math.round(y*100)/100,P=b.item.querySelector(".signature-box-x"),U=b.item.querySelector(".signature-box-y"),M=b.item.querySelector(".signature-box-width"),W=b.item.querySelector(".signature-box-height");P&&(P.value=String(B($(w.xPt,X)))),U&&(U.value=String(B($(w.yPt,X)))),M&&(M.value=String(B($(T,X)))),W&&(W.value=String(B($(f,X))))}function qe(){if(!b)return;const e=b;if(b.overlay.classList.remove("dragging"),ge=!1,document.removeEventListener("mousemove",Ee),document.removeEventListener("mouseup",qe),A){const t=We(),n=t[e.boxIndex];if(n&&t.some((o,r)=>r!==e.boxIndex&&Ue(n,o))){const o=i=>Math.round(i*100)/100,r=e.item.querySelector(".signature-box-x"),s=e.item.querySelector(".signature-box-y"),u=e.item.querySelector(".signature-box-width"),c=e.item.querySelector(".signature-box-height");r&&(r.value=String(o(e.startFormX))),s&&(s.value=String(o(e.startFormY))),u&&(u.value=String(o(e.startFormW))),c&&(c.value=String(o(e.startFormH)));const l=x.no_overlap_message??"Signature boxes on the same page cannot overlap.";alert(l)}}b=null,I()}L.addEventListener("mousedown",Ye),D&&D.addEventListener("click",()=>ce(1,0,0)),ae(),k.addEventListener("keydown",e=>{const t=e.target;if(!(t!=null&&t.closest("input, select, textarea"))){if(e.ctrlKey&&e.key==="z"){e.preventDefault();const n=p.querySelectorAll(":scope > .signature-box-item");if(n.length>0){const a=n[n.length-1],o=Array.from(p.querySelectorAll(":scope > .signature-box-item")).indexOf(a);if(a.remove(),z===o?re(null):z!==null&&z>o&&re(z-1),p.querySelectorAll(":scope > .signature-box-item").length===0){const r=document.getElementById("signature-boxes-empty");r&&r.classList.remove("d-none")}I(),ae()}return}if(e.key==="Delete"||e.key==="Backspace"){if(z===null)return;const a=p.querySelectorAll(":scope > .signature-box-item")[z];if(a){if(e.preventDefault(),a.remove(),re(null),p.querySelectorAll(":scope > .signature-box-item").length===0){const o=document.getElementById("signature-boxes-empty");o&&o.classList.remove("d-none")}I(),ae()}return}if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==="a"){if(e.preventDefault(),!R)return;const n=1,a=O[n];if(a){const o=a.scale||1.5,r=a.width/o,s=a.height/o;ce(n,(r-150)/2,(s-40)/2,150,40)}else ce(1,0,0)}}}),k.addEventListener("submit",e=>{e.preventDefault(),p.querySelectorAll(":scope > .signature-box-item").forEach((n,a)=>{n.querySelectorAll("input, select, textarea").forEach(o=>{o.name=o.name.replace(/(\])\[\d+\](\[)/,`$1[${a}]$2`)})}),k.submit()})}He()})();
