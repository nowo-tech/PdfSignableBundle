(function(){"use strict";const ee={pt:1,mm:.35277777777777775,cm:.035277777777777776,in:.013888888888888888,px:1.3333333333333333};function k(C,z){return C*(ee[z]??1)}function Y(C,z){return C/(ee[z]??1)}function pe(C){return String(C).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function me(){var ge;console.log("[PdfSignable] Script loaded");const C=window.NowoPdfSignableConfig;if(!C){console.warn("[PdfSignable] NowoPdfSignableConfig not found, skipping init");return}const{proxyUrl:z,strings:F}=C,G=document.querySelector(".nowo-pdf-signable-widget"),D=G==null?void 0:G.closest("form");if(!D){console.warn("[PdfSignable] .nowo-pdf-signable-widget or form not found, skipping init");return}console.log("[PdfSignable] Initialized");const X=D.querySelector(".pdf-url-input"),A=document.getElementById("loadPdfBtn"),J=document.getElementById("pdf-placeholder"),te=document.getElementById("pdf-canvas-wrapper"),ne=document.getElementById("signature-boxes-list"),N=document.getElementById("addBoxBtn"),j=D.querySelector(".unit-selector"),$=D.querySelector(".origin-selector"),I=document.getElementById("pdf-viewer-container");if(!te||!ne)return;const w=te,m=ne;function U(){return(j==null?void 0:j.value)??"mm"}function K(){return($==null?void 0:$.value)??"bottom_left"}function fe(e,o,t,s,n,r){const a=e.scale||1.5,c=e.width/a,d=e.height/a;let l,i;switch(r){case"top_left":l=o,i=d-t-n;break;case"top_right":l=c-o-s,i=d-t-n;break;case"bottom_right":l=c-o-s,i=t;break;default:l=o,i=t;break}return{vpX:l*a,vpY:e.height-(i+n)*a}}function he(e,o,t,s,n,r){const a=e.scale||1.5,c=e.width/a,d=e.height/a,l=e.convertToPdfPoint(o,t+n*a),i=l[0],p=l[1];let g,u;switch(r){case"top_left":g=i,u=d-p-n;break;case"top_right":g=c-i-s,u=d-p-n;break;case"bottom_right":g=c-i-s,u=p;break;default:g=i,u=p;break}return{xPt:g,yPt:u}}let M=null;const S={};let H=null,Q=!1;function ye(e){try{return new URL(e,window.location.origin).origin===window.location.origin?e:z+"?url="+encodeURIComponent(e)}catch{return z+"?url="+encodeURIComponent(e)}}async function oe(){if(!M||!I)return 1.5;const o=(await M.getPage(1)).getViewport({scale:1}),t=I.clientWidth-24;return t<=0?1.5:Math.max(.5,t/o.width)}async function ae(){var t;const e=((t=X==null?void 0:X.value)==null?void 0:t.trim())??"";if(!e){console.warn("[PdfSignable] Load PDF: URL required"),alert(F.alert_url_required);return}const o=ye(e);console.log("[PdfSignable] Loading PDF",{url:e,viaProxy:o!==e}),A&&(A.setAttribute("disabled",""),A.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> '+F.loading_state),J&&(J.style.display="block"),w.style.display="none",w.innerHTML="";try{M=await pdfjsLib.getDocument(o).promise,Object.keys(S).forEach(n=>delete S[Number(n)]);const s=await oe();for(let n=1;n<=M.numPages;n++){H&&await H;const r=await M.getPage(n),a=r.getViewport({scale:s});S[n]=a;const c=document.createElement("div");c.className="pdf-page-wrapper",c.dataset.page=String(n);const d=document.createElement("canvas"),l=d.getContext("2d");if(!l)continue;d.height=a.height,d.width=a.width,d.dataset.page=String(n);const i=document.createElement("div");i.className="signature-overlays",c.appendChild(d),c.appendChild(i),H=r.render({canvasContext:l,viewport:a}).promise,await H,w.appendChild(c)}J&&(J.style.display="none"),w.style.display="block",T(),console.log("[PdfSignable] PDF loaded",{pages:M.numPages,scale:s})}catch(s){console.error("[PdfSignable] PDF load failed",s),alert(F.error_load_pdf+(s instanceof Error?s.message:String(s)))}finally{A&&(A.removeAttribute("disabled"),A.innerHTML=F.load_pdf_btn)}}function T(){if(Q||Object.keys(S).length===0)return;const e=U(),o=K();w.querySelectorAll(".signature-overlays").forEach(s=>{s.innerHTML=""}),m.querySelectorAll(".signature-box-item").forEach((s,n)=>{var b,f,x,_,v;const r=parseInt(((b=s.querySelector(".signature-box-page"))==null?void 0:b.value)??"1",10),a=parseFloat(((f=s.querySelector(".signature-box-x"))==null?void 0:f.value)??"0"),c=parseFloat(((x=s.querySelector(".signature-box-y"))==null?void 0:x.value)??"0"),d=parseFloat(((_=s.querySelector(".signature-box-width"))==null?void 0:_.value)??"150"),l=parseFloat(((v=s.querySelector(".signature-box-height"))==null?void 0:v.value)??"40"),i=s.querySelector(".signature-box-name"),p=(i==null?void 0:i.value)??"",g=w.querySelector(`.pdf-page-wrapper[data-page="${r}"] .signature-overlays`),u=S[r];if(!g||!u)return;const O=u.scale||1.5,E=Y(a,e),q=Y(c,e),W=Y(d,e),P=Y(l,e),L=fe(u,E,q,W,P,o),R=W*O,V=P*O,y=document.createElement("div");y.className="signature-box-overlay",y.dataset.boxIndex=String(n),y.style.left=L.vpX+"px",y.style.top=L.vpY+"px",y.style.width=Math.max(R,20)+"px",y.style.height=Math.max(V,14)+"px",y.innerHTML=(p?'<span class="overlay-label">'+pe(p)+"</span>":"")+'<span class="resize-handle nw" data-handle="nw"></span><span class="resize-handle ne" data-handle="ne"></span><span class="resize-handle sw" data-handle="sw"></span><span class="resize-handle se" data-handle="se"></span>',g.appendChild(y)})}function se(){const e=m.dataset.maxEntries??(N==null?void 0:N.dataset.maxEntries)??"";if(e==="")return null;const o=parseInt(e,10);return Number.isNaN(o)?null:o}function Z(){if(!N)return;const e=se(),o=m.querySelectorAll(".signature-box-item").length;e!==null&&o>=e?N.style.display="none":N.style.display=""}function re(e,o,t,s,n){const r=se(),a=m.querySelectorAll(".signature-box-item").length;if(r!==null&&a>=r){console.log("[PdfSignable] Box add skipped: max_entries reached",{max:r,currentCount:a});return}const c=s??150,d=n??40,l=document.getElementById("signature-boxes-empty");l&&l.classList.add("d-none");const i=m.dataset.prototype??"",p=m.querySelectorAll(".signature-box-item").length,g=i.replace(/__name__/g,String(p)),u=document.createElement("div");u.className="signature-box-item",u.dataset.index=String(p),u.innerHTML=g;const O=u.querySelector(".signature-box-page");O&&(O.value=String(e));const E=S[e],q=U(),W=K(),P=c,L=d,R=E?E.scale:1.5,V=E?E.width/R:595,y=E?E.height/R:842;let b,f;switch(W){case"top_left":b=o,f=y-t-L;break;case"top_right":b=V-o-P,f=y-t-L;break;case"bottom_right":b=V-o-P,f=t;break;default:b=o,f=t;break}const x=v=>Math.round(v*100)/100,_=u.querySelector(".signature-box-name");for(const v of["x","y","width","height"]){const B=u.querySelector(".signature-box-"+v);B&&(v==="x"?B.value=String(x(k(b,q))):v==="y"?B.value=String(x(k(f,q))):v==="width"?B.value=String(x(k(P,q))):v==="height"&&(B.value=String(x(k(L,q)))))}_&&(_.value=F.default_box_name),m.appendChild(u),u.scrollIntoView({behavior:"smooth"}),T(),Z(),console.log("[PdfSignable] Box added",{page:e,x:b,y:f,width:c,height:d,unit:q})}A&&A.addEventListener("click",()=>ae());const ie=document.getElementById("unitBadge"),ve={pt:"pt",mm:"mm",cm:"cm",px:"px",in:"in"};function le(){ie&&(ie.textContent=ve[U()]??U())}le();let ce=U();if(j&&j.addEventListener("change",()=>{const e=ce,o=U();le(),m.querySelectorAll(".signature-box-item").forEach(t=>{for(const s of["x","y","width","height"]){const n=t.querySelector(".signature-box-"+s);if(n!=null&&n.value){const r=parseFloat(n.value);n.value=String(Math.round(k(Y(r,e),o)*100)/100)}}}),ce=o,T()}),m.addEventListener("input",T),m.addEventListener("change",T),$&&$.addEventListener("change",T),m.addEventListener("click",e=>{if(!e.target.closest(".remove-box"))return;const o=e.target.closest(".signature-box-item");if(o){const t=Array.from(m.querySelectorAll(".signature-box-item")).indexOf(o);o.remove(),console.log("[PdfSignable] Box removed",{index:t})}if(m.querySelectorAll(".signature-box-item").length===0){const t=document.getElementById("signature-boxes-empty");t&&t.classList.remove("d-none")}T(),Z()}),I){let e,o=!1,t=0;new ResizeObserver(()=>{if(o)return;const n=(I==null?void 0:I.clientWidth)??0;Math.abs(n-t)<10||(t=n,clearTimeout(e),e=setTimeout(async()=>{if(!(!M||w.style.display==="none")&&!o){o=!0;try{const r=await oe();w.innerHTML="",Object.keys(S).forEach(a=>delete S[Number(a)]);for(let a=1;a<=M.numPages;a++){H&&await H;const c=await M.getPage(a),d=c.getViewport({scale:r});S[a]=d;const l=document.createElement("div");l.className="pdf-page-wrapper",l.dataset.page=String(a);const i=document.createElement("canvas"),p=i.getContext("2d");if(!p)continue;i.height=d.height,i.width=d.width,i.dataset.page=String(a);const g=document.createElement("div");g.className="signature-overlays",l.appendChild(i),l.appendChild(g),H=c.render({canvasContext:p,viewport:d}).promise,await H,w.appendChild(l)}T(),I&&(t=I.clientWidth)}finally{o=!1}}},200))}).observe(I)}(ge=X==null?void 0:X.value)!=null&&ge.trim()&&(console.log("[PdfSignable] Auto-loading PDF (preset URL)"),ae()),w.addEventListener("click",e=>{if(e.target.closest(".signature-box-overlay"))return;const o=e.target.closest(".pdf-page-wrapper"),t=o==null?void 0:o.querySelector("canvas");if(!t||!M)return;const s=parseInt(t.dataset.page??"1",10),n=S[s];if(!n)return;const r=t.getBoundingClientRect(),a=t.width/r.width,c=t.height/r.height,d=(e.clientX-r.left)*a,l=(e.clientY-r.top)*c,i=40,p=i*(n.scale||1.5),g=n.convertToPdfPoint(d,l+p);re(s,g[0],g[1],150,i)});let h=null;function be(e){var g,u;const o=e.target.closest(".resize-handle"),t=e.target.closest(".signature-box-overlay");if(!((g=t==null?void 0:t.dataset)!=null&&g.boxIndex))return;e.preventDefault(),e.stopPropagation();const s=parseInt(t.dataset.boxIndex,10),n=m.querySelectorAll(".signature-box-item")[s];if(!n)return;const r=t.closest(".pdf-page-wrapper"),a=parseInt(((u=r==null?void 0:r.dataset)==null?void 0:u.page)??"1",10),c=S[a];if(!c)return;const d=parseFloat(t.style.width)||20,l=parseFloat(t.style.height)||14,i=parseFloat(t.style.left)||0,p=parseFloat(t.style.top)||0;h={mode:o?"resize":"move",handle:o?o.dataset.handle??null:null,overlay:t,item:n,viewport:c,startX:e.clientX,startY:e.clientY,startLeft:i,startTop:p,startRight:i+d,startBottom:p+l},t.classList.add("dragging"),Q=!0,document.addEventListener("mousemove",de),document.addEventListener("mouseup",ue)}function de(e){if(!h)return;const{overlay:o,viewport:t,startLeft:s,startTop:n,startRight:r,startBottom:a}=h,c=e.clientX-h.startX,d=e.clientY-h.startY,l=20;let i,p,g,u;if(h.mode==="move")i=Math.max(0,Math.min(t.width-(r-s),s+c)),p=Math.max(0,Math.min(t.height-(a-n),n+d)),g=r-s,u=a-n;else{const f=h.handle;let x=s,_=n,v=r,B=a;f==="se"?(v=Math.min(t.width,Math.max(s+l,r+c)),B=Math.min(t.height,Math.max(n+l,a+d))):f==="sw"?(x=Math.max(0,Math.min(r-l,s+c)),B=Math.min(t.height,Math.max(n+l,a+d))):f==="ne"?(v=Math.min(t.width,Math.max(s+l,r+c)),_=Math.max(0,Math.min(a-l,n+d))):f==="nw"&&(x=Math.max(0,Math.min(r-l,s+c)),_=Math.max(0,Math.min(a-l,n+d))),i=x,p=_,g=v-x,u=B-_}o.style.left=i+"px",o.style.top=p+"px",o.style.width=g+"px",o.style.height=u+"px";const O=t.scale||1.5,E=g/O,q=u/O,W=he(t,i,p,E,q,K()),P=U(),L=f=>Math.round(f*100)/100,R=h.item.querySelector(".signature-box-x"),V=h.item.querySelector(".signature-box-y"),y=h.item.querySelector(".signature-box-width"),b=h.item.querySelector(".signature-box-height");R&&(R.value=String(L(k(W.xPt,P)))),V&&(V.value=String(L(k(W.yPt,P)))),y&&(y.value=String(L(k(E,P)))),b&&(b.value=String(L(k(q,P))))}function ue(){h&&(h.overlay.classList.remove("dragging"),Q=!1,document.removeEventListener("mousemove",de),document.removeEventListener("mouseup",ue),h=null,T())}w.addEventListener("mousedown",be),N&&N.addEventListener("click",()=>re(1,0,0)),Z(),D.addEventListener("submit",async e=>{e.preventDefault();const o=m.querySelectorAll(".signature-box-item").length;console.log("[PdfSignable] Form submit",{boxes:o}),m.querySelectorAll(".signature-box-item").forEach((n,r)=>{n.querySelectorAll("input, select, textarea").forEach(a=>{a.name=a.name.replace(/(\])\[\d+\](\[)/,`$1${r}$2`)})});const t=new FormData(D),s=D.action||window.location.href;try{const n=await fetch(s,{method:D.method||"POST",body:t,headers:{Accept:"application/json"}});if(!(n.headers.get("content-type")??"").includes("application/json")){alert(F.alert_submit_error);return}const a=await n.json();if(a.success&&a.coordinates){const c=`Coordinates submitted:

`+JSON.stringify({coordinates:a.coordinates,unit:a.unit,origin:a.origin},null,2);alert(c),console.log("[PdfSignable] Coordinates saved",a)}else alert(F.alert_submit_error)}catch(n){console.error("[PdfSignable] Submit failed",n),alert(F.alert_submit_error)}})}me()})();
