(function(){"use strict";const Fe={pt:1,mm:.35277777777777775,cm:.035277777777777776,in:.013888888888888888,px:1.3333333333333333};function X(S,j){return S*(Fe[j]??1)}function D(S,j){return S/(Fe[j]??1)}function je(S){return String(S).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const Ge=220,Ke=37,Je=65,Qe=48;function et(S,j,x){S=S%360,S<0&&(S+=360);const pe=j/100,H=x/100,N=(1-Math.abs(2*H-1))*pe,h=N*(1-Math.abs(S/60%2-1)),Q=H-N/2;let ce=0,G=0,K=0;S<60?(ce=N,G=h):S<120?(ce=h,G=N):S<180?(G=N,K=h):S<240?(G=h,K=N):S<300?(ce=h,K=N):(ce=N,K=h);const F=Ie=>{const Ee=Math.round((Ie+Q)*255);return(Ee<16?"0":"")+Math.min(255,Math.max(0,Ee)).toString(16)};return"#"+F(ce)+F(G)+F(K)}function tt(S){const j=(Ge+S*Ke)%360,x=et(j,Je,Qe),pe=parseInt(x.slice(1,3),16),H=parseInt(x.slice(3,5),16),N=parseInt(x.slice(5,7),16);return{border:x,background:`rgba(${pe}, ${H}, ${N}, 0.15)`,color:x,handle:x}}function nt(){const S=window.NowoPdfSignableConfig;if(!S){console.warn("[PdfSignable] NowoPdfSignableConfig not found, skipping init");return}const{proxyUrl:j,strings:x,debug:pe=!1}=S,H=(...e)=>{pe&&console.log("[PdfSignable]",...e)},N=(...e)=>{pe&&console.warn("[PdfSignable]",...e)},h=document.querySelector(".nowo-pdf-signable-widget"),Q=h==null?void 0:h.closest("form");if(!Q){N(".nowo-pdf-signable-widget or form not found, skipping init");return}const ce=(h==null?void 0:h.dataset.preventBoxOverlap)==="1",G=(h==null?void 0:h.dataset.enableRotation)==="1";let K={};try{const e=(h==null?void 0:h.dataset.boxDefaultsByName)??"{}";K=typeof e=="string"?JSON.parse(e):{}}catch{K={}}const F=Math.max(0,parseFloat((h==null?void 0:h.dataset.snapGrid)??"0")||0),Ie=(h==null?void 0:h.dataset.snapToBoxes)==="1",Ee=10;H("Initialized");const me=Q.querySelector(".pdf-url-input"),oe=document.getElementById("loadPdfBtn"),qe=document.getElementById("pdf-placeholder"),Pe=document.getElementById("pdf-canvas-wrapper"),Ce=document.getElementById("signature-boxes-list"),se=document.getElementById("addBoxBtn"),he=Q.querySelector(".unit-selector"),ye=Q.querySelector(".origin-selector"),d=document.getElementById("pdf-viewer-container");if(!Pe||!Ce)return;const M=Pe,b=Ce;let ie=1,ae={x:0,y:0},w=null;const ot=80;function st(){if(!R||!d)return;const e=d.querySelector("#pdf-thumbnails-strip"),t=d.querySelector(".pdf-viewer-scroll");!e||!t||(async()=>{for(let s=1;s<=R.numPages;s++){const o=await R.getPage(s),a=o.getViewport({scale:1}),r=ot/a.width,l=o.getViewport({scale:r}),u=document.createElement("canvas");u.width=l.width,u.height=l.height;const i=u.getContext("2d");if(!i)continue;await o.render({canvasContext:i,viewport:l}).promise;const c=document.createElement("button");c.type="button",c.className="pdf-thumb",c.dataset.page=String(s),c.setAttribute("aria-label","Page "+s),c.appendChild(u),c.addEventListener("click",()=>{const p=M.querySelector('.pdf-page-wrapper[data-page="'+s+'"]');p&&(p.scrollIntoView({behavior:"smooth",block:"start"}),e.querySelectorAll(".pdf-thumb.current").forEach(m=>m.classList.remove("current")),c.classList.add("current"))}),e.appendChild(c)}const n=()=>{const s=e,o=M.querySelectorAll(".pdf-page-wrapper");if(o.length===0)return;const a=t.getBoundingClientRect(),r=a.top+a.height/2;let l=1,u=1/0;o.forEach(c=>{const p=parseInt(c.dataset.page??"1",10),m=c.getBoundingClientRect(),g=m.top+m.height/2,f=Math.abs(g-r);f<u&&(u=f,l=p)}),s.querySelectorAll(".pdf-thumb.current").forEach(c=>c.classList.remove("current"));const i=s.querySelector('.pdf-thumb[data-page="'+l+'"]');i&&i.classList.add("current")};t.addEventListener("scroll",n),requestAnimationFrame(n),e.firstElementChild&&e.firstElementChild.classList.add("current")})()}function at(){w||!d||(w=document.createElement("div"),w.id="pdf-touch-wrapper",w.style.transformOrigin="0 0",w.style.transform=`translate(${ae.x}px, ${ae.y}px) scale(${ie})`,d.insertBefore(w,M),w.appendChild(M),rt())}function rt(){if(!w)return;let e=0,t=1,n={x:0,y:0},s=0,o=0;w.addEventListener("touchstart",a=>{if(a.touches.length===2){a.preventDefault();const r=a.touches[0],l=a.touches[1];e=Math.hypot(l.clientX-r.clientX,l.clientY-r.clientY),t=ie,n={...ae},s=(r.clientX+l.clientX)/2,o=(r.clientY+l.clientY)/2}},{passive:!1}),w.addEventListener("touchmove",a=>{if(a.touches.length===2&&w){a.preventDefault();const r=a.touches[0],l=a.touches[1],u=Math.hypot(l.clientX-r.clientX,l.clientY-r.clientY),i=Math.max(.25,Math.min(4,t*u/e)),c=(r.clientX+l.clientX)/2,p=(r.clientY+l.clientY)/2;ae.x=n.x+(c-s),ae.y=n.y+(p-o),ie=i,w.style.transform=`translate(${ae.x}px, ${ae.y}px) scale(${ie})`}},{passive:!1})}function ee(){return(he==null?void 0:he.value)??"mm"}function ge(){return(ye==null?void 0:ye.value)??"bottom_left"}function _e(e,t,n,s,o,a){const r=e.scale||1.5,l=e.width/r,u=e.height/r;let i,c;switch(a){case"top_left":i=t,c=u-n-o;break;case"top_right":i=l-t-s,c=u-n-o;break;case"bottom_right":i=l-t-s,c=n;break;default:i=t,c=n;break}return{vpX:i*r,vpY:e.height-(c+o)*r}}function Te(e,t,n,s,o,a){const r=e.scale||1.5,l=e.width/r,u=e.height/r,i=e.convertToPdfPoint(t,n+o*r),c=i[0],p=i[1];let m,g;switch(a){case"top_left":m=c,g=u-p-o;break;case"top_right":m=l-c-s,g=u-p-o;break;case"bottom_right":m=l-c-s,g=p;break;default:m=c,g=p;break}return{xPt:m,yPt:g}}let R=null;const $={};let Le=null,Ae=!1,J=1.5;function lt(e){try{return new URL(e,window.location.origin).origin===window.location.origin?e:j+"?url="+encodeURIComponent(e)}catch{return j+"?url="+encodeURIComponent(e)}}function ct(){if(!d||!w||d.querySelector(".pdf-viewer-scroll"))return;const t=document.createElement("div");t.id="pdf-thumbnails-strip",t.setAttribute("aria-label","Page thumbnails");const n=document.createElement("div");n.className="pdf-viewer-scroll",n.appendChild(w),d.appendChild(n),d.insertBefore(t,n)}async function Be(){if(!R||!d)return 1.5;await new Promise(r=>requestAnimationFrame(()=>r()));const t=(await R.getPage(1)).getViewport({scale:1}),n=d.querySelector(".pdf-viewer-scroll"),a=Math.max(0,(n||d).clientWidth-8);return a<=0?1.5:Math.max(.5,a/t.width)}async function xe(e){if(R){Object.keys($).forEach(t=>delete $[Number(t)]),M.innerHTML="";for(let t=1;t<=R.numPages;t++){Le&&await Le;const n=await R.getPage(t),s=n.getViewport({scale:e});$[t]=s;const o=document.createElement("div");o.className="pdf-page-wrapper",o.dataset.page=String(t);const a=document.createElement("canvas"),r=a.getContext("2d");if(!r)continue;a.height=s.height,a.width=s.width,a.dataset.page=String(t);const l=document.createElement("div");l.className="signature-overlays",o.appendChild(a),o.appendChild(l),Le=n.render({canvasContext:r,viewport:s}).promise,await Le,M.appendChild(o)}P()}}function it(){var o;if((o=d==null?void 0:d.querySelector("#pdf-zoom-toolbar"))==null||o.remove(),!d)return;const e=document.createElement("div");e.id="pdf-zoom-toolbar",e.className="pdf-zoom-toolbar",e.setAttribute("role","toolbar"),e.setAttribute("aria-label",x.zoom_fit??"Zoom");const t=document.createElement("button");t.type="button",t.className="pdf-zoom-btn",t.title=x.zoom_out??"Zoom out",t.textContent="-",t.setAttribute("aria-label",x.zoom_out??"Zoom out");const n=document.createElement("button");n.type="button",n.className="pdf-zoom-btn",n.title=x.zoom_in??"Zoom in",n.textContent="+",n.setAttribute("aria-label",x.zoom_in??"Zoom in");const s=document.createElement("button");s.type="button",s.className="pdf-zoom-btn",s.title=x.zoom_fit??"Fit width",s.textContent="Fit",s.setAttribute("aria-label",x.zoom_fit??"Fit width"),t.addEventListener("click",()=>{J=Math.max(.5,J/1.25),xe(J)}),n.addEventListener("click",()=>{J=Math.min(3,J*1.25),xe(J)}),s.addEventListener("click",async()=>{J=await Be(),await xe(J)}),e.appendChild(t),e.appendChild(n),e.appendChild(s),d.insertBefore(e,d.firstChild)}async function ke(){var a,r;const e=((a=me==null?void 0:me.value)==null?void 0:a.trim())??"";if(!e){N("Load PDF: URL required"),alert(x.alert_url_required);return}const t=lt(e);H("Loading PDF",{url:e,viaProxy:t!==e}),oe&&(oe.setAttribute("disabled",""),oe.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> '+x.loading_state),qe&&(qe.style.display="block"),M.style.display="none",M.innerHTML="";const n=d==null?void 0:d.querySelector("#pdf-thumbnails-strip"),s=d==null?void 0:d.querySelector(".pdf-viewer-scroll");s&&w&&w.parentElement===s&&(s.removeChild(w),d==null||d.appendChild(w)),n==null||n.remove(),s==null||s.remove(),(r=d==null?void 0:d.querySelector("#pdf-zoom-toolbar"))==null||r.remove(),ie=1,ae={x:0,y:0},w&&(w.style.transform="translate(0px, 0px) scale(1)");const o=document.createElement("div");o.className="pdf-signable-loading-overlay",o.setAttribute("aria-live","polite"),o.setAttribute("aria-busy","true"),o.innerHTML='<div class="text-center"><div class="spinner-border text-primary mb-2" role="status"><span class="visually-hidden">'+x.loading_state+'</span></div><p class="text-muted small mb-0">'+x.loading_state+"</p></div>",d&&d.appendChild(o);try{R=await pdfjsLib.getDocument(t).promise,Object.keys($).forEach(i=>delete $[Number(i)]),at(),ct();const l=await Be();J=l,await xe(l),qe&&(qe.style.display="none"),M.style.display="block",st(),it(),requestAnimationFrame(()=>{P(),setTimeout(P,100),setTimeout(P,350),setTimeout(P,700)}),H("PDF loaded",{pages:R.numPages,scale:l})}catch(l){H("PDF load failed",l),alert(x.error_load_pdf+(l instanceof Error?l.message:String(l)))}finally{o.remove(),oe&&(oe.removeAttribute("disabled"),oe.innerHTML=x.load_pdf_btn)}}function P(){if(Ae||Object.keys($).length===0)return;const e=ee(),t=ge();M.querySelectorAll(".signature-overlays").forEach(r=>{r.innerHTML=""});const n=b.querySelectorAll(":scope > .signature-box-item"),s={},o={};let a=0;if(n.forEach((r,l)=>{var le,ue,fe,O,de;const u=parseInt(((le=r.querySelector(".signature-box-page"))==null?void 0:le.value)??"1",10),i=parseFloat(((ue=r.querySelector(".signature-box-x"))==null?void 0:ue.value)??"0"),c=parseFloat(((fe=r.querySelector(".signature-box-y"))==null?void 0:fe.value)??"0"),p=parseFloat(((O=r.querySelector(".signature-box-width"))==null?void 0:O.value)??"150"),m=parseFloat(((de=r.querySelector(".signature-box-height"))==null?void 0:de.value)??"40"),g=r.querySelector(".signature-box-angle"),f=G&&g?parseFloat(g.value??"0"):0,C=r.querySelector(".signature-box-name"),E=((C==null?void 0:C.value)??"").trim(),_=E===""?"__empty__":E;_ in o||(o[_]=a++);const ne=o[_];s[E]=(s[E]??0)+1;const Y=s[E],A=E===""?"":E+(Y>1?` (${Y})`:""),V=M.querySelector(`.pdf-page-wrapper[data-page="${u}"] .signature-overlays`),T=$[u];if(!V||!T)return;const Z=T.scale||1.5,k=D(i,e),z=D(c,e),U=D(p,e),L=D(m,e),B=_e(T,k,z,U,L,t),q=U*Z,v=L*Z,y=document.createElement("div");y.className="signature-box-overlay",y.dataset.boxIndex=String(l),y.style.left=B.vpX+"px",y.style.top=B.vpY+"px",y.style.width=Math.max(q,20)+"px",y.style.height=Math.max(v,14)+"px";const W=tt(ne);y.style.borderColor=W.border,y.style.backgroundColor=W.background,y.style.color=W.color,y.style.setProperty("--box-color",W.handle),y.style.transformOrigin="50% 50%",G&&(y.style.transform=`rotate(${f}deg)`);const re=G?'<span class="rotate-handle" title="Rotate"></span>':"";y.innerHTML=(A?'<span class="overlay-label">'+je(A)+"</span>":"")+re+'<span class="resize-handle nw" data-handle="nw"></span><span class="resize-handle ne" data-handle="ne"></span><span class="resize-handle sw" data-handle="sw"></span><span class="resize-handle se" data-handle="se"></span>',V.appendChild(y)}),te!==null){const r=M.querySelector(`.signature-box-overlay[data-box-index="${te}"]`);r&&r.classList.add("selected")}}function Oe(){const e=b.dataset.maxEntries??(se==null?void 0:se.dataset.maxEntries)??"";if(e==="")return null;const t=parseInt(e,10);return Number.isNaN(t)?null:t}function be(){if(!se)return;const e=Oe(),t=b.querySelectorAll(":scope > .signature-box-item").length;e!==null&&t>=e?se.style.display="none":se.style.display=""}function Me(e,t,n,s,o){const a=Oe(),r=b.querySelectorAll(":scope > .signature-box-item").length;if(a!==null&&r>=a){H("Box add skipped: max_entries reached",{max:a,currentCount:r});return}const l=s??150,u=o??40,i=document.getElementById("signature-boxes-empty");i&&i.classList.add("d-none");const c=b.dataset.prototype??"",p=b.querySelectorAll(":scope > .signature-box-item").length,m=c.replace(/__name__/g,String(p)),g=document.createElement("div");g.innerHTML=m;const f=g.firstElementChild;if(!f)return;f.dataset.index=String(p);const C=f.querySelector(".signature-box-page");C&&(C.value=String(e));const E=$[e],_=ee(),ne=ge(),Y=l,A=u,V=E?E.scale:1.5,T=E?E.width/V:595,Z=E?E.height/V:842;let k,z;switch(ne){case"top_left":k=t,z=Z-n-A;break;case"top_right":k=T-t-Y,z=Z-n-A;break;case"bottom_right":k=T-t-Y,z=n;break;default:k=t,z=n;break}const U=q=>Math.round(q*100)/100,L=f.querySelector(".signature-box-name");for(const q of["x","y","width","height"]){const v=f.querySelector(".signature-box-"+q);v&&(q==="x"?v.value=String(U(X(k,_))):q==="y"?v.value=String(U(X(z,_))):q==="width"?v.value=String(U(X(Y,_))):q==="height"&&(v.value=String(U(X(A,_)))))}const B=f.querySelector(".signature-box-angle");B&&(B.value="0"),L&&(L.value=x.default_box_name),b.appendChild(f),f.scrollIntoView({behavior:"smooth"}),P(),be(),H("Box added",{page:e,x:k,y:z,width:l,height:u,unit:_})}oe&&oe.addEventListener("click",()=>ke());const Xe=document.getElementById("unitBadge"),ut={pt:"pt",mm:"mm",cm:"cm",px:"px",in:"in"};function De(){Xe&&(Xe.textContent=ut[ee()]??ee())}De();let He=ee();if(he&&he.addEventListener("change",()=>{const e=He,t=ee();De(),b.querySelectorAll(":scope > .signature-box-item").forEach(n=>{for(const s of["x","y","width","height"]){const o=n.querySelector(".signature-box-"+s);if(o!=null&&o.value){const a=parseFloat(o.value);o.value=String(Math.round(X(D(a,e),t)*100)/100)}}}),He=t,P()}),b.addEventListener("input",P),b.addEventListener("change",e=>{const t=e.target.closest(".signature-box-item"),n=t==null?void 0:t.querySelector(".signature-box-name");if(n&&e.target===n&&Object.keys(K).length>0){const s=(n.value??"").trim(),o=s?K[s]:null;if(o){const a=(r,l)=>{const u=t==null?void 0:t.querySelector(".signature-box-"+r);u&&l!==void 0&&(u.value=String(l))};a("width",o.width),a("height",o.height),a("x",o.x),a("y",o.y),a("angle",o.angle)}}P()}),ye&&ye.addEventListener("change",P),b.addEventListener("click",e=>{if(!e.target.closest(".remove-box"))return;const t=e.target.closest(".signature-box-item");if(t){let n=t;for(;n!=null&&n.parentElement&&n.parentElement!==b;)n=n.parentElement;if(n){const s=Array.from(b.querySelectorAll(":scope > .signature-box-item")).indexOf(n);n.remove(),H("Box removed",{index:s})}}if(b.querySelectorAll(":scope > .signature-box-item").length===0){const n=document.getElementById("signature-boxes-empty");n&&n.classList.remove("d-none")}P(),be()}),d){let e,t=!1,n=0;new ResizeObserver(()=>{if(t)return;const o=(d==null?void 0:d.clientWidth)??0;Math.abs(o-n)<10||(n=o,clearTimeout(e),e=setTimeout(async()=>{if(!(!R||M.style.display==="none")&&!t){t=!0;try{const a=await Be();J=a,await xe(a),d&&(n=d.clientWidth)}finally{t=!1}}},200))}).observe(d)}function Ne(){var e;(e=me==null?void 0:me.value)!=null&&e.trim()&&(H("Auto-loading PDF (preset URL)"),ke())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ne):Ne(),M.addEventListener("click",e=>{if(e.target.closest(".signature-box-overlay"))return;ve(null);const t=e.target.closest(".pdf-page-wrapper"),n=t==null?void 0:t.querySelector("canvas");if(!n||!R)return;const s=parseInt(n.dataset.page??"1",10),o=$[s];if(!o)return;const a=n.getBoundingClientRect(),r=n.width/a.width,l=n.height/a.height,u=(e.clientX-a.left)*r,i=(e.clientY-a.top)*l,c=40,p=c*(o.scale||1.5),m=o.convertToPdfPoint(u,i+p);Me(s,m[0],m[1],150,c)});function dt(e,t){if(e.page!==t.page)return!1;const n=e.x+e.w,s=t.x+t.w,o=e.y+e.h,a=t.y+t.h;return e.x<s&&t.x<n&&e.y<a&&t.y<o}function Re(){const e=b.querySelectorAll(":scope > .signature-box-item"),t=[];return e.forEach(n=>{var i,c,p,m;const s=n.querySelector(".signature-box-page"),o=parseInt((s==null?void 0:s.value)??"1",10),a=parseFloat(((i=n.querySelector(".signature-box-x"))==null?void 0:i.value)??"0"),r=parseFloat(((c=n.querySelector(".signature-box-y"))==null?void 0:c.value)??"0"),l=parseFloat(((p=n.querySelector(".signature-box-width"))==null?void 0:p.value)??"150"),u=parseFloat(((m=n.querySelector(".signature-box-height"))==null?void 0:m.value)??"40");t.push({page:o,x:a,y:r,w:l,h:u})}),t}function pt(e,t){const n=$[e];if(!n)return[];const s=ee(),o=ge(),a=n.scale||1.5,r=Re(),l=[];return r.forEach((u,i)=>{if(i===t||u.page!==e)return;const c=D(u.x,s),p=D(u.y,s),m=D(u.w,s),g=D(u.h,s),{vpX:f,vpY:C}=_e(n,c,p,m,g,o);l.push({left:f,top:C,right:f+m*a,bottom:C+g*a})}),l}let I=null,te=null;function ve(e){if(te=e,M.querySelectorAll(".signature-box-overlay.selected").forEach(t=>t.classList.remove("selected")),e!==null){const t=M.querySelector(`.signature-box-overlay[data-box-index="${e}"]`);t&&t.classList.add("selected")}}let Se=null;function Ye(e){if(!Se)return;const{overlay:t,item:n,centerX:s,centerY:o,startAngle:a,startMouseAngle:r}=Se;let u=(Math.atan2(e.clientY-o,e.clientX-s)-r)*180/Math.PI,i=a+u;for(;i>180;)i-=360;for(;i<-180;)i+=360;const c=n.querySelector(".signature-box-angle");c&&(c.value=String(Math.round(i*100)/100)),t.style.transform=`rotate(${i}deg)`}function ze(){Se&&(document.removeEventListener("mousemove",Ye),document.removeEventListener("mouseup",ze),Se=null)}function mt(e){var _,ne;const t=e.target.closest(".signature-box-overlay");if(!((_=t==null?void 0:t.dataset)!=null&&_.boxIndex))return;e.preventDefault(),e.stopPropagation();const n=e.target.closest(".rotate-handle");if(G&&n){const Y=parseInt(t.dataset.boxIndex,10),A=b.querySelectorAll(":scope > .signature-box-item")[Y];if(!A)return;const V=A.querySelector(".signature-box-angle");if(!V)return;const T=t.getBoundingClientRect(),Z=T.left+T.width/2,k=T.top+T.height/2,z=parseFloat(V.value)||0,U=Math.atan2(e.clientY-k,e.clientX-Z);Se={overlay:t,item:A,centerX:Z,centerY:k,startAngle:z,startMouseAngle:U},document.addEventListener("mousemove",Ye),document.addEventListener("mouseup",ze);return}const s=e.target.closest(".resize-handle"),o=parseInt(t.dataset.boxIndex,10),a=b.querySelectorAll(":scope > .signature-box-item")[o];if(!a)return;const r=t.closest(".pdf-page-wrapper"),l=parseInt(((ne=r==null?void 0:r.dataset)==null?void 0:ne.page)??"1",10),u=$[l];if(!u)return;const i=parseFloat(t.style.width)||20,c=parseFloat(t.style.height)||14,p=parseFloat(t.style.left)||0,m=parseFloat(t.style.top)||0,g=a.querySelector(".signature-box-x"),f=a.querySelector(".signature-box-y"),C=a.querySelector(".signature-box-width"),E=a.querySelector(".signature-box-height");I={mode:s?"resize":"move",handle:s?s.dataset.handle??null:null,overlay:t,item:a,boxIndex:o,viewport:u,startX:e.clientX,startY:e.clientY,startLeft:p,startTop:m,startRight:p+i,startBottom:m+c,startFormX:g&&parseFloat(g.value)||0,startFormY:f&&parseFloat(f.value)||0,startFormW:C&&parseFloat(C.value)||150,startFormH:E&&parseFloat(E.value)||40},t.classList.add("dragging"),Ae=!0,I.mode==="move"&&ve(o),document.addEventListener("mousemove",We),document.addEventListener("mouseup",$e)}function We(e){var z,U;if(!I)return;const{overlay:t,viewport:n,startLeft:s,startTop:o,startRight:a,startBottom:r}=I,l=(e.clientX-I.startX)/ie,u=(e.clientY-I.startY)/ie,i=20;let c,p,m,g;if(I.mode==="move")c=Math.max(0,Math.min(n.width-(a-s),s+l)),p=Math.max(0,Math.min(n.height-(r-o),o+u)),m=a-s,g=r-o;else{const L=I.handle;let B=s,q=o,v=a,y=r;L==="se"?(v=Math.min(n.width,Math.max(s+i,a+l)),y=Math.min(n.height,Math.max(o+i,r+u))):L==="sw"?(B=Math.max(0,Math.min(a-i,s+l)),y=Math.min(n.height,Math.max(o+i,r+u))):L==="ne"?(v=Math.min(n.width,Math.max(s+i,a+l)),q=Math.max(0,Math.min(r-i,o+u))):L==="nw"&&(B=Math.max(0,Math.min(a-i,s+l)),q=Math.max(0,Math.min(r-i,o+u))),c=B,p=q,m=v-B,g=y-q}const f=n.scale||1.5,C=parseInt(((U=(z=t.closest(".pdf-page-wrapper"))==null?void 0:z.dataset)==null?void 0:U.page)??"1",10);if(F>0){const L=m/f,B=g/f,q=Te(n,c,p,L,B,ge()),v=ee();let y=X(q.xPt,v),W=X(q.yPt,v),re=X(L,v),le=X(B,v);y=Math.round(y/F)*F,W=Math.round(W/F)*F,re=Math.round(re/F)*F,le=Math.max(F,Math.round(le/F)*F);const ue=D(y,v),fe=D(W,v),O=D(re,v),de=D(le,v),we=_e(n,ue,fe,O,de,ge());c=we.vpX,p=we.vpY,m=O*f,g=de*f}if(Ie){const L=pt(C,I.boxIndex),B=c+m,q=p+g,v=L.flatMap(O=>[O.left,O.right]),y=L.flatMap(O=>[O.top,O.bottom]),W=(O,de)=>{let we=O,Ue=Ee;for(const Ve of de){const Ze=Math.abs(O-Ve);Ze<Ue&&(Ue=Ze,we=Ve)}return we},re=W(c,v),le=W(B,v),ue=W(p,y),fe=W(q,y);c=re,p=ue,m=Math.max(i,le-re),g=Math.max(i,fe-ue)}t.style.left=c+"px",t.style.top=p+"px",t.style.width=m+"px",t.style.height=g+"px";const E=m/f,_=g/f,ne=Te(n,c,p,E,_,ge()),Y=ee(),A=L=>Math.round(L*100)/100,V=I.item.querySelector(".signature-box-x"),T=I.item.querySelector(".signature-box-y"),Z=I.item.querySelector(".signature-box-width"),k=I.item.querySelector(".signature-box-height");V&&(V.value=String(A(X(ne.xPt,Y)))),T&&(T.value=String(A(X(ne.yPt,Y)))),Z&&(Z.value=String(A(X(E,Y)))),k&&(k.value=String(A(X(_,Y))))}function $e(){if(!I)return;const e=I;if(I.overlay.classList.remove("dragging"),Ae=!1,document.removeEventListener("mousemove",We),document.removeEventListener("mouseup",$e),ce){const t=Re(),n=t[e.boxIndex];if(n&&t.some((o,a)=>a!==e.boxIndex&&dt(n,o))){const o=c=>Math.round(c*100)/100,a=e.item.querySelector(".signature-box-x"),r=e.item.querySelector(".signature-box-y"),l=e.item.querySelector(".signature-box-width"),u=e.item.querySelector(".signature-box-height");a&&(a.value=String(o(e.startFormX))),r&&(r.value=String(o(e.startFormY))),l&&(l.value=String(o(e.startFormW))),u&&(u.value=String(o(e.startFormH)));const i=x.no_overlap_message??"Signature boxes on the same page cannot overlap.";alert(i)}}I=null,P()}M.addEventListener("mousedown",mt),se&&se.addEventListener("click",()=>Me(1,0,0)),be(),Q.addEventListener("keydown",e=>{const t=e.target;if(!(t!=null&&t.closest("input, select, textarea"))){if(e.ctrlKey&&e.key==="z"){e.preventDefault();const n=b.querySelectorAll(":scope > .signature-box-item");if(n.length>0){const s=n[n.length-1],o=Array.from(b.querySelectorAll(":scope > .signature-box-item")).indexOf(s);if(s.remove(),te===o?ve(null):te!==null&&te>o&&ve(te-1),b.querySelectorAll(":scope > .signature-box-item").length===0){const a=document.getElementById("signature-boxes-empty");a&&a.classList.remove("d-none")}P(),be()}return}if(e.key==="Delete"||e.key==="Backspace"){if(te===null)return;const s=b.querySelectorAll(":scope > .signature-box-item")[te];if(s){if(e.preventDefault(),s.remove(),ve(null),b.querySelectorAll(":scope > .signature-box-item").length===0){const o=document.getElementById("signature-boxes-empty");o&&o.classList.remove("d-none")}P(),be()}return}if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==="a"){if(e.preventDefault(),!R)return;const n=1,s=$[n];if(s){const o=s.scale||1.5,a=s.width/o,r=s.height/o;Me(n,(a-150)/2,(r-40)/2,150,40)}else Me(1,0,0)}}}),Q.addEventListener("submit",e=>{e.preventDefault(),b.querySelectorAll(":scope > .signature-box-item").forEach((n,s)=>{n.querySelectorAll("input, select, textarea").forEach(o=>{o.name=o.name.replace(/(\])\[\d+\](\[)/,`$1[${s}]$2`)})}),Q.submit()})}nt()})();
