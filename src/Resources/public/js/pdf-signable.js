(function(){"use strict";var Xe=document.createElement("style");Xe.textContent=`.nowo-pdf-signable-widget .pdf-viewer-outer{display:flex;flex-direction:column;gap:.5rem;max-height:75vh;min-height:400px;border:1px solid #dee2e6;border-radius:.375rem;background:#f8f9fa;overflow:hidden}.nowo-pdf-signable-widget #pdf-viewer-container{flex:1;position:relative;display:flex;min-height:0;gap:.5rem;overflow:hidden;scrollbar-gutter:auto}.nowo-pdf-signable-widget #pdf-thumbnails-strip{width:72px;flex-shrink:0;overflow-y:auto;padding:.25rem;background:#e9ecef}.nowo-pdf-signable-widget #pdf-thumbnails-strip .pdf-thumb{display:block;width:100%;margin-bottom:.25rem;cursor:pointer;border:2px solid transparent;border-radius:.25rem}.nowo-pdf-signable-widget #pdf-thumbnails-strip .pdf-thumb:hover{border-color:#0d6efd}.nowo-pdf-signable-widget #pdf-thumbnails-strip .pdf-thumb.current{border-color:#0d6efd;box-shadow:0 0 0 1px #0d6efd}.nowo-pdf-signable-widget #pdf-thumbnails-strip .pdf-thumb canvas{display:block;width:100%;height:auto}.nowo-pdf-signable-widget #pdf-thumbnails-strip::-webkit-scrollbar{width:6px}.nowo-pdf-signable-widget #pdf-thumbnails-strip::-webkit-scrollbar-thumb{background:#adb5bd;border-radius:3px}.nowo-pdf-signable-widget #pdf-thumbnails-strip::-webkit-scrollbar-thumb:hover{background:#868e96}.nowo-pdf-signable-widget #pdf-thumbnails-strip::-webkit-scrollbar-track{background:transparent}.nowo-pdf-signable-widget .pdf-viewer-scroll{flex:1;min-width:0;display:flex;flex-direction:column;overflow:auto;box-sizing:border-box}.nowo-pdf-signable-widget .pdf-viewer-scroll>.pdf-zoom-toolbar{flex-shrink:0;position:sticky;top:0;z-index:50}.nowo-pdf-signable-widget .pdf-viewer-scroll::-webkit-scrollbar{width:6px;height:6px}.nowo-pdf-signable-widget .pdf-viewer-scroll::-webkit-scrollbar-thumb{background:#adb5bd;border-radius:3px}.nowo-pdf-signable-widget .pdf-viewer-scroll::-webkit-scrollbar-thumb:hover{background:#868e96}.nowo-pdf-signable-widget .pdf-viewer-scroll::-webkit-scrollbar-track{background:transparent}.nowo-pdf-signable-widget #pdf-canvas-wrapper{position:relative;display:block;width:100%;padding:.5rem}.nowo-pdf-signable-widget #pdf-canvas-wrapper canvas{display:block;cursor:crosshair}.nowo-pdf-signable-widget .pdf-page-wrapper{position:relative;display:inline-block;margin-bottom:10px}.nowo-pdf-signable-widget .pdf-grid-overlay{position:absolute;left:0;top:0;pointer-events:none}.nowo-pdf-signable-widget .signature-overlays{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}.nowo-pdf-signable-widget .signature-overlays .signature-box-overlay{pointer-events:auto}.nowo-pdf-signable-widget .signature-box-overlay{position:absolute;border:2px solid var(--box-color, rgba(13, 110, 253, .8));background:var(--box-bg, rgba(13, 110, 253, .12));box-sizing:border-box;font-size:10px;color:var(--box-color, #0d6efd);overflow:hidden;cursor:move;-webkit-user-select:none;user-select:none}.nowo-pdf-signable-widget .signature-box-overlay.dragging{z-index:10;opacity:.9;box-shadow:0 4px 12px #0003}.nowo-pdf-signable-widget .signature-box-overlay.selected{box-shadow:0 0 0 3px #0d6efd99;z-index:5}.nowo-pdf-signable-widget .signature-box-overlay .overlay-label{padding:2px 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle{position:absolute;width:12px;height:12px;background:var(--box-color, rgba(13, 110, 253, .9));border:1px solid #fff;border-radius:3px;pointer-events:auto;z-index:1}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle.nw{top:-6px;left:-6px;cursor:nwse-resize}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle.ne{top:-6px;right:-6px;cursor:nesw-resize}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle.sw{bottom:-6px;left:-6px;cursor:nesw-resize}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle.se{bottom:-6px;right:-6px;cursor:nwse-resize}.nowo-pdf-signable-widget .signature-box-overlay .rotate-handle{position:absolute;top:-14px;left:50%;transform:translate(-50%);width:16px;height:16px;background:var(--box-color, rgba(13, 110, 253, .9));border:1px solid #fff;border-radius:50%;pointer-events:auto;cursor:grab;z-index:2}.nowo-pdf-signable-widget .signature-box-overlay .rotate-handle:active{cursor:grabbing}.nowo-pdf-signable-widget .pdf-signable-loading-overlay{position:absolute;top:0;right:0;bottom:0;left:0;background:#f8f9fae6;display:flex;align-items:center;justify-content:center;z-index:100;border-radius:.375rem}.nowo-pdf-signable-widget .pdf-zoom-toolbar{flex-shrink:0;padding:.25rem .5rem;display:flex;align-items:center;gap:.25rem;background:#fff;border-bottom:1px solid #dee2e6}.nowo-pdf-signable-widget .pdf-zoom-toolbar .pdf-zoom-value{min-width:2.5rem;text-align:center}.nowo-pdf-signable-widget .signature-box-item{border:1px solid #dee2e6;padding:1rem;margin-bottom:.75rem;border-radius:.375rem;background:#fff}.nowo-pdf-signable-widget #signature-boxes-list{max-height:50vh;overflow-y:auto}.nowo-pdf-signable-widget .signature-capture-row,.nowo-pdf-signable-widget .signature-pad-wrapper{width:100%}.nowo-pdf-signable-widget .signature-pad-canvas{width:100%;max-width:100%;height:120px;display:block;box-sizing:border-box;border:1px solid #dee2e6;border-radius:.25rem;touch-action:none}
/*$vite$:1*/`,document.head.appendChild(Xe);const Ce=24;function rt(y,P){try{return new URL(P,window.location.origin).origin===window.location.origin?P:y+"?url="+encodeURIComponent(P)}catch{return y+"?url="+encodeURIComponent(P)}}function He(y){return y.querySelector(".pdf-viewer-scroll")??y}async function Ae(y,P){if(!y||!P)return 1.5;await new Promise(p=>requestAnimationFrame(()=>p()));const te=(await y.getPage(1)).getViewport({scale:1}),q=He(P),x=Math.max(0,q.clientWidth-Ce);return x<=0?1.5:Math.max(.5,x/te.width)}async function it(y,P){if(!y||!P)return 1.5;await new Promise(Z=>requestAnimationFrame(()=>Z()));const te=(await y.getPage(1)).getViewport({scale:1}),q=He(P),x=Math.max(0,q.clientWidth-Ce),p=Math.max(0,q.clientHeight-Ce);if(x<=0||p<=0)return 1.5;const ne=x/te.width,le=p/te.height;return Math.max(.5,Math.min(ne,le))}const We={pt:1,mm:25.4/72,cm:2.54/72,in:1/72,px:96/72},lt=220,ct=37,dt=65,ut=48;function $(y,P){return y*(We[P]??1)}function V(y,P){return y/(We[P]??1)}function pt(y){return String(y).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function gt(y,P,A){y=y%360,y<0&&(y+=360);const te=P/100,q=A/100,x=(1-Math.abs(2*q-1))*te,p=x*(1-Math.abs(y/60%2-1)),ne=q-x/2;let le=0,Z=0,ae=0;y<60?(le=x,Z=p):y<120?(le=p,Z=x):y<180?(Z=x,ae=p):y<240?(Z=p,ae=x):y<300?(le=p,ae=x):(le=x,ae=p);const G=Te=>{const Le=Math.round((Te+ne)*255);return(Le<16?"0":"")+Math.min(255,Math.max(0,Le)).toString(16)};return"#"+G(le)+G(Z)+G(ae)}function ft(y){const P=(lt+y*ct)%360,A=gt(P,dt,ut),te=parseInt(A.slice(1,3),16),q=parseInt(A.slice(3,5),16),x=parseInt(A.slice(5,7),16);return{border:A,background:`rgba(${te}, ${q}, ${x}, 0.15)`,color:A,handle:A}}function ht(){var st;const y=window.NowoPdfSignableConfig;if(!y){console.warn("[PdfSignable] NowoPdfSignableConfig not found, skipping init");return}const{proxyUrl:P,strings:A,debug:te=!1}=y,q=(...t)=>{te&&console.log("[PdfSignable]",...t)},x=(...t)=>{te&&console.warn("[PdfSignable]",...t)},p=document.querySelector('[data-pdf-signable="widget"]')??document.querySelector(".nowo-pdf-signable-widget"),ne=p==null?void 0:p.closest("form");if(!ne||!p){x("Widget or form not found, skipping init");return}const le=(p==null?void 0:p.dataset.preventBoxOverlap)==="1",Z=(p==null?void 0:p.dataset.enableRotation)==="1";let ae={};try{const t=(p==null?void 0:p.dataset.boxDefaultsByName)??"{}";ae=typeof t=="string"?JSON.parse(t):{}}catch{ae={}}const G=Math.max(0,parseFloat((p==null?void 0:p.dataset.snapGrid)??"0")||0),Te=(p==null?void 0:p.dataset.snapToBoxes)==="1",Le=(p==null?void 0:p.dataset.showGrid)==="1",Ye=Math.max(0,parseFloat((p==null?void 0:p.dataset.gridStep)??"10")||0),mt=10,Fe=t=>t.querySelector('[data-pdf-signable="page"]')??t.querySelector('input[name$="[page]"], select[name$="[page]"]');q("Initialized");const he=ne.querySelector('[data-pdf-signable="pdf-url"]'),pe=document.getElementById("loadPdfBtn"),ke=document.getElementById("pdf-placeholder"),_e=document.getElementById("pdf-canvas-wrapper"),Oe=(p==null?void 0:p.querySelector('[data-pdf-signable="boxes-list"]'))??document.getElementById("signature-boxes-list"),ce=document.getElementById("addBoxBtn"),ye=ne.querySelector('[data-pdf-signable="unit"]'),ve=ne.querySelector('[data-pdf-signable="origin"]'),m=document.getElementById("pdf-viewer-container"),Ne=document.getElementById("pdfZoomValue");if(!_e||!Oe){x("Missing required containers",{pdfCanvasWrapper:!!_e,signatureBoxesList:!!Oe});return}const R=_e,E=Oe;q("DOM resolved",{widget:!!p,boxesList:!!E,hasPrototype:!!((st=E==null?void 0:E.dataset)!=null&&st.prototype),pdfUrlInput:!!he,addBoxBtn:!!ce,unitSelector:!!ye,originSelector:!!ve});const X=':scope > [data-pdf-signable="box-item"], :scope > .signature-box-item';let me=1,ge={x:0,y:0},T=null;const bt=80;function yt(){if(!F||!m)return;const t=m.querySelector("#pdf-thumbnails-strip"),n=m.querySelector(".pdf-viewer-scroll");!t||!n||(async()=>{for(let o=1;o<=F.numPages;o++){const a=await F.getPage(o),s=a.getViewport({scale:1}),r=bt/s.width,l=a.getViewport({scale:r}),c=document.createElement("canvas");c.width=l.width,c.height=l.height;const d=c.getContext("2d");if(!d)continue;await a.render({canvasContext:d,viewport:l}).promise;const i=document.createElement("button");i.type="button",i.className="pdf-thumb",i.dataset.page=String(o),i.setAttribute("aria-label","Page "+o),i.appendChild(c),i.addEventListener("click",()=>{const g=R.querySelector('.pdf-page-wrapper[data-page="'+o+'"]');g&&(g.scrollIntoView({behavior:"smooth",block:"start"}),t.querySelectorAll(".pdf-thumb.current").forEach(u=>u.classList.remove("current")),i.classList.add("current"))}),t.appendChild(i)}const e=()=>{const o=t,a=R.querySelectorAll(".pdf-page-wrapper");if(a.length===0)return;const s=n.getBoundingClientRect(),r=s.top+s.height/2;let l=1,c=1/0;a.forEach(i=>{const g=parseInt(i.dataset.page??"1",10),u=i.getBoundingClientRect(),b=u.top+u.height/2,w=Math.abs(b-r);w<c&&(c=w,l=g)}),o.querySelectorAll(".pdf-thumb.current").forEach(i=>i.classList.remove("current"));const d=o.querySelector('.pdf-thumb[data-page="'+l+'"]');d&&d.classList.add("current")};n.addEventListener("scroll",e),requestAnimationFrame(e),t.firstElementChild&&t.firstElementChild.classList.add("current")})()}function vt(){T||!m||(T=document.createElement("div"),T.id="pdf-touch-wrapper",T.style.transformOrigin="0 0",T.style.transform=`translate(${ge.x}px, ${ge.y}px) scale(${me})`,m.insertBefore(T,R),T.appendChild(R),xt())}function xt(){if(!T)return;let t=0,n=1,e={x:0,y:0},o=0,a=0;T.addEventListener("touchstart",s=>{if(s.touches.length===2){s.preventDefault();const r=s.touches[0],l=s.touches[1];t=Math.hypot(l.clientX-r.clientX,l.clientY-r.clientY),n=me,e={...ge},o=(r.clientX+l.clientX)/2,a=(r.clientY+l.clientY)/2}},{passive:!1}),T.addEventListener("touchmove",s=>{if(s.touches.length===2&&T){s.preventDefault();const r=s.touches[0],l=s.touches[1],c=Math.hypot(l.clientX-r.clientX,l.clientY-r.clientY),d=Math.max(.25,Math.min(4,n*c/t)),i=(r.clientX+l.clientX)/2,g=(r.clientY+l.clientY)/2;ge.x=e.x+(i-o),ge.y=e.y+(g-a),me=d,T.style.transform=`translate(${ge.x}px, ${ge.y}px) scale(${me})`}},{passive:!1})}function se(){return(ye==null?void 0:ye.value)??(p==null?void 0:p.dataset.unitDefault)??"mm"}function xe(){return(ve==null?void 0:ve.value)??(p==null?void 0:p.dataset.originDefault)??"bottom_left"}function De(t,n,e,o,a,s){const r=t.scale||1.5,l=t.width/r,c=t.height/r;let d,i;switch(s){case"top_left":d=n,i=c-e-a;break;case"top_right":d=l-n-o,i=c-e-a;break;case"bottom_right":d=l-n-o,i=e;break;default:d=n,i=e;break}return{vpX:d*r,vpY:t.height-(i+a)*r}}function Ue(t,n,e,o,a,s){const r=t.scale||1.5,l=t.width/r,c=t.height/r,d=t.convertToPdfPoint(n,e+a*r),i=d[0],g=d[1];let u,b;switch(s){case"top_left":u=i,b=c-g-a;break;case"top_right":u=l-i-o,b=c-g-a;break;case"bottom_right":u=l-i-o,b=g;break;default:u=i,b=g;break}return{xPt:u,yPt:b}}let F=null;const K={};let Ie=null,Re=!1,ee=1.5;function wt(){if(!m||!T||m.querySelector(".pdf-viewer-scroll"))return;const n=document.createElement("div");n.id="pdf-thumbnails-strip",n.setAttribute("aria-label","Page thumbnails");const e=document.createElement("div");e.className="pdf-viewer-scroll";const o=m.querySelector(".pdf-zoom-toolbar");o&&e.appendChild(o),e.appendChild(T),m.appendChild(e),m.insertBefore(n,e)}function St(t,n,e,o,a){const s=t.getContext("2d");if(!s)return;const r=n.width/e,l=n.height/e,c=$(r,o),d=$(l,o);s.strokeStyle="rgba(0, 0, 0, 0.15)",s.lineWidth=1;for(let i=0;i<=c;i+=a){const u=V(i,o)*e;s.beginPath(),s.moveTo(u,0),s.lineTo(u,n.height),s.stroke()}for(let i=0;i<=d;i+=a){const g=V(i,o),u=n.height-g*e;s.beginPath(),s.moveTo(0,u),s.lineTo(n.width,u),s.stroke()}}async function we(t){if(!F)return;Object.keys(K).forEach(e=>delete K[Number(e)]),R.innerHTML="";for(let e=1;e<=F.numPages;e++){Ie&&await Ie;const o=await F.getPage(e),a=o.getViewport({scale:t});K[e]=a;const s=document.createElement("div");s.className="pdf-page-wrapper",s.dataset.page=String(e);const r=document.createElement("canvas"),l=r.getContext("2d");if(!l)continue;r.height=a.height,r.width=a.width,r.dataset.page=String(e);const c=document.createElement("div");if(c.className="signature-overlays",s.appendChild(r),Le&&Ye>0){const d=document.createElement("canvas");d.className="pdf-grid-overlay",d.width=a.width,d.height=a.height,d.dataset.page=String(e),St(d,a,t,se(),Ye),s.appendChild(d)}s.appendChild(c),Ie=o.render({canvasContext:l,viewport:a}).promise,await Ie,R.appendChild(s)}const n=R.querySelectorAll(".signature-overlays");q("PDF DOM built",{pages:F.numPages,overlayContainers:n.length}),Ne&&(Ne.textContent=Math.round(t*100)+"%"),H()}function Et(){var t,n,e,o,a;(t=m==null?void 0:m.querySelector("#pdf-zoom-toolbar"))==null||t.remove(),(n=document.getElementById("pdfZoomOut"))==null||n.addEventListener("click",()=>{F&&(ee=Math.max(.5,ee/1.25),we(ee))}),(e=document.getElementById("pdfZoomIn"))==null||e.addEventListener("click",()=>{F&&(ee=Math.min(4,ee*1.25),we(ee))}),(o=document.getElementById("pdfFitWidth"))==null||o.addEventListener("click",async()=>{if(!F)return;ee=await Ae(F,m),await we(ee)}),(a=document.getElementById("pdfFitPage"))==null||a.addEventListener("click",async()=>{if(!F)return;ee=await it(F,m),await we(ee)})}async function $e(){var r,l;const t=((r=he==null?void 0:he.value)==null?void 0:r.trim())??"";if(!t){x("Load PDF: URL required"),alert(A.alert_url_required);return}const n=rt(P,t);q("Loading PDF",{url:t,viaProxy:n!==t}),pe&&(pe.setAttribute("disabled",""),pe.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> '+A.loading_state),ke&&(ke.style.display="block"),R.style.display="none",R.innerHTML="";const e=m==null?void 0:m.querySelector("#pdf-thumbnails-strip"),o=m==null?void 0:m.querySelector(".pdf-viewer-scroll"),a=o==null?void 0:o.querySelector(".pdf-zoom-toolbar");a&&m&&m.insertBefore(a,m.firstChild),o&&T&&T.parentElement===o&&(o.removeChild(T),m==null||m.appendChild(T)),e==null||e.remove(),o==null||o.remove(),(l=m==null?void 0:m.querySelector("#pdf-zoom-toolbar"))==null||l.remove(),me=1,ge={x:0,y:0},T&&(T.style.transform="translate(0px, 0px) scale(1)");const s=document.createElement("div");s.className="pdf-signable-loading-overlay",s.setAttribute("aria-live","polite"),s.setAttribute("aria-busy","true"),s.innerHTML='<div class="text-center"><div class="spinner-border text-primary mb-2" role="status"><span class="visually-hidden">'+A.loading_state+'</span></div><p class="text-muted small mb-0">'+A.loading_state+"</p></div>",m&&m.appendChild(s);try{F=await pdfjsLib.getDocument(n).promise,Object.keys(K).forEach(i=>delete K[Number(i)]),vt(),wt();const c=await Ae(F,m);ee=c,await we(c),ke&&(ke.style.display="none"),R.style.display="block",yt(),requestAnimationFrame(()=>{H(),setTimeout(H,100),setTimeout(H,350),setTimeout(H,700)}),q("PDF loaded",{pages:F.numPages,scale:c})}catch(c){q("PDF load failed",c),alert(A.error_load_pdf+(c instanceof Error?c.message:String(c)))}finally{s.remove(),pe&&(pe.removeAttribute("disabled"),pe.innerHTML=A.load_pdf_btn)}}function H(){if(Re||Object.keys(K).length===0)return;const t=se(),n=xe();R.querySelectorAll(".signature-overlays").forEach(r=>{r.innerHTML=""});const e=E.querySelectorAll(X);q("updateOverlays",{boxItemCount:e.length,pageViewportCount:Object.keys(K).length});const o={},a={};let s=0;if(e.forEach((r,l)=>{var qe;const c=Fe(r),d=parseInt((c==null?void 0:c.value)??"1",10),i=r.querySelector('[data-pdf-signable="x"]'),g=r.querySelector('[data-pdf-signable="y"]'),u=r.querySelector('[data-pdf-signable="width"]'),b=r.querySelector('[data-pdf-signable="height"]');c||x("updateOverlays: box item missing page field",{boxIndex:l}),(!i||!g||!u||!b)&&x("updateOverlays: box item missing coordinate inputs",{boxIndex:l,hasX:!!i,hasY:!!g,hasWidth:!!u,hasHeight:!!b});const w=parseFloat((i==null?void 0:i.value)??"0"),W=parseFloat((g==null?void 0:g.value)??"0"),j=parseFloat((u==null?void 0:u.value)??"150"),Y=parseFloat((b==null?void 0:b.value)??"40"),N=r.querySelector('[data-pdf-signable="angle"]'),J=Z&&N?parseFloat(N.value??"0"):0,_=r.querySelector('[data-pdf-signable="signature-data"]'),U=(qe=_==null?void 0:_.value)==null?void 0:qe.trim(),h=r.querySelector('[data-pdf-signable="name"]'),f=((h==null?void 0:h.value)??"").trim(),v=f===""?"__empty__":f;v in a||(a[v]=s++);const k=a[v];o[f]=(o[f]??0)+1;const O=o[f],M=f===""?"":f+(O>1?` (${O})`:""),B=R.querySelector(`.pdf-page-wrapper[data-page="${d}"] .signature-overlays`),C=K[d];if(!B||!C){x("updateOverlays: no overlay container or viewport for page",{boxIndex:l,pageNum:d,hasOverlaysDiv:!!B,hasViewport:!!C});return}const L=C.scale||1.5,S=V(w,t),D=V(W,t),oe=V(j,t),re=V(Y,t),ue=De(C,S,D,oe,re,n),be=oe*L,Q=re*L,I=document.createElement("div");I.className="signature-box-overlay",I.dataset.pdfSignable="overlay",I.dataset.boxIndex=String(l),I.style.left=ue.vpX+"px",I.style.top=ue.vpY+"px",I.style.width=Math.max(be,20)+"px",I.style.height=Math.max(Q,14)+"px";const ie=ft(k);I.style.borderColor=ie.border,I.style.backgroundColor=ie.background,I.style.color=ie.color,I.style.setProperty("--box-color",ie.handle),I.style.transformOrigin="50% 50%",Z&&(I.style.transform=`rotate(${J}deg)`);const Be=Z?'<span class="rotate-handle" title="Rotate"></span>':"";if(I.innerHTML=(M?'<span class="overlay-label">'+pt(M)+"</span>":"")+Be+'<span class="resize-handle nw" data-handle="nw"></span><span class="resize-handle ne" data-handle="ne"></span><span class="resize-handle sw" data-handle="sw"></span><span class="resize-handle se" data-handle="se"></span>',U&&U.startsWith("data:")){const fe=document.createElement("img");fe.src=U,fe.alt="",fe.setAttribute("aria-hidden","true"),fe.style.cssText="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;pointer-events:none;",I.insertBefore(fe,I.firstChild)}B.appendChild(I)}),de!==null){const r=R.querySelector(`[data-pdf-signable="overlay"][data-box-index="${de}"]`);r&&r.classList.add("selected")}}const Ve=1,Mt=6;function je(t){const n=t.getBoundingClientRect();if(n.width<=0||n.height<=0)return;const e=Math.min(window.devicePixelRatio||1,2),o=Math.max(1,Math.round(n.width*e)),a=Math.max(1,Math.round(n.height*e));t.width===o&&t.height===a||(t.width=o,t.height=a)}function ze(){const t=p??document.querySelector('[data-pdf-signable="widget"]');if(!t){x("initSignaturePads: widget root not found");return}const n=t.querySelectorAll(".signature-pad-canvas");q("initSignaturePads",{canvasCount:n.length}),n.forEach(e=>{var U;if(e.dataset.padInited==="1")return;const o=e.closest('[data-pdf-signable="box-item"], .signature-box-item'),a=o==null?void 0:o.querySelector('[data-pdf-signable="signature-data"]'),s=(U=e.closest(".signature-pad-wrapper"))==null?void 0:U.querySelector(".signature-pad-clear"),r=o==null?void 0:o.querySelector(".signature-upload-input");if(!o){x('initSignaturePads: canvas not inside a box item (data-pdf-signable="box-item" or .signature-box-item)');return}if(!a){x("initSignaturePads: box item has no signature-data input; template may have removed it");return}const l=e.getContext("2d");if(!l)return;e.dataset.padInited="1";const c=e.closest(".signature-pad-wrapper"),d=()=>{je(e)};typeof ResizeObserver<"u"&&c&&new ResizeObserver(()=>{d()}).observe(c),requestAnimationFrame(d);let i=!1,g=0,u=0,b=0,w=0;const W=h=>{const f=e.getBoundingClientRect(),v=f.width?e.width/f.width:1,k=f.height?e.height/f.height:1;if("touches"in h&&h.touches.length>0){const M=h.touches[0];return{x:(M.clientX-f.left)*v,y:(M.clientY-f.top)*k}}const O=h;return{x:(O.clientX-f.left)*v,y:(O.clientY-f.top)*k}},j=h=>{if("touches"in h&&h.touches.length>0){const v=h.touches[0].force;if(typeof v=="number"&&v>=0)return Math.min(1,v)}const f=h;return typeof f.pressure=="number"&&f.pressure>=0?Math.min(1,f.pressure):.5},Y=h=>{const f=j(h),v=Ve+f*(Mt-Ve);l.lineWidth=v},N=h=>{h.preventDefault(),je(e);const{x:f,y:v}=W(h);b=g=f,w=u=v,i=!0,l.strokeStyle="#000",Y(h),l.lineCap="round",l.lineJoin="round",l.beginPath(),l.moveTo(f,v)},J=h=>{if(h.preventDefault(),!i)return;const{x:f,y:v}=W(h);Y(h);const k=(g+f)/2,O=(u+v)/2;l.beginPath(),l.moveTo(b,w),l.quadraticCurveTo(g,u,k,O),l.stroke(),b=k,w=O,g=f,u=v},_=h=>{if(h.preventDefault(),!i)return;i=!1,e.width>0&&e.height>0&&(a.value=e.toDataURL("image/png"));const f=o==null?void 0:o.querySelector('[data-pdf-signable="signed-at"]');f&&(f.value=new Date().toISOString()),H()};e.addEventListener("mousedown",N),e.addEventListener("mousemove",J),e.addEventListener("mouseup",_),e.addEventListener("mouseleave",_),e.addEventListener("touchstart",N,{passive:!1}),e.addEventListener("touchmove",J,{passive:!1}),e.addEventListener("touchend",_,{passive:!1}),s&&s.addEventListener("click",()=>{const h=e.width,f=e.height;l.clearRect(0,0,h,f),a.value="";const v=o==null?void 0:o.querySelector('[data-pdf-signable="signed-at"]');v&&(v.value=""),H()}),r&&r.addEventListener("change",()=>{var v;const h=(v=r.files)==null?void 0:v[0];if(!h||!h.type.startsWith("image/"))return;const f=new FileReader;f.onload=()=>{if(typeof f.result=="string"){a.value=f.result;const k=o==null?void 0:o.querySelector('[data-pdf-signable="signed-at"]');k&&(k.value=new Date().toISOString()),H()}},f.readAsDataURL(h)})})}function Ge(){const t=E.dataset.maxEntries??(ce==null?void 0:ce.dataset.maxEntries)??"";if(t==="")return null;const n=parseInt(t,10);return Number.isNaN(n)?null:n}function Se(){if(!ce)return;const t=Ge(),n=E.querySelectorAll(X).length;t!==null&&n>=t?ce.style.display="none":ce.style.display=""}function Pe(t,n,e,o,a){const s=Ge(),r=E.querySelectorAll(X).length;if(s!==null&&r>=s){q("Box add skipped: max_entries reached",{max:s,currentCount:r});return}const l=o??150,c=a??40,d=document.getElementById("signature-boxes-empty");d&&d.classList.add("d-none");const i=E.dataset.prototype??"";if(!i.trim()){x("addBox: dataset.prototype is empty; check template has data-prototype on the boxes list");return}const g=E.querySelectorAll(X).length,u=i.replace(/__name__/g,String(g)),b=document.createElement("div");b.innerHTML=u;const w=b.firstElementChild;if(!w){x("addBox: prototype HTML produced no root element; check template structure");return}w.dataset.index=String(g);const W=String(t),j=Fe(w);if(!j)x('addBox: new box has no page field (data-pdf-signable="page" or name$="[page]"); overlays may be wrong');else{if(j instanceof HTMLSelectElement&&!Array.from(j.options).some(S=>S.value===W)){const S=document.createElement("option");S.value=W,S.textContent=W,j.appendChild(S)}j.value=W}const Y=K[t],N=se(),J=xe(),_=l,U=c,h=Y?Y.scale:1.5,f=Y?Y.width/h:595,v=Y?Y.height/h:842;let k,O;switch(J){case"top_left":k=n,O=v-e-U;break;case"top_right":k=f-n-_,O=v-e-U;break;case"bottom_right":k=f-n-_,O=e;break;default:k=n,O=e;break}const M=S=>Math.round(S*100)/100,B=w.querySelector('[data-pdf-signable="name"]'),C=[];for(const S of["x","y","width","height"]){const D=w.querySelector(`[data-pdf-signable="${S}"]`);if(!D){C.push(S);continue}S==="x"?D.value=String(M($(k,N))):S==="y"?D.value=String(M($(O,N))):S==="width"?D.value=String(M($(_,N))):S==="height"&&(D.value=String(M($(U,N))))}C.length&&x("addBox: new box missing coordinate inputs (template may have removed them)",{missing:C});const L=w.querySelector('[data-pdf-signable="angle"]');L&&(L.value="0"),B&&(B.value=A.default_box_name),E.appendChild(w),w.scrollIntoView({behavior:"smooth"}),H(),ze(),Se(),q("Box added",{page:t,x:k,y:O,width:l,height:c,unit:N})}pe&&pe.addEventListener("click",()=>$e());const Ze=document.getElementById("unitBadge"),qt={pt:"pt",mm:"mm",cm:"cm",px:"px",in:"in"};function Ke(){Ze&&(Ze.textContent=qt[se()]??se())}Ke();let Je=se();if(ye&&ye.addEventListener("change",()=>{const t=Je,n=se();Ke(),E.querySelectorAll(X).forEach(e=>{for(const o of["x","y","width","height"]){const a=e.querySelector(`[data-pdf-signable="${o}"]`);if(a!=null&&a.value){const s=parseFloat(a.value);a.value=String(Math.round($(V(s,t),n)*100)/100)}}}),Je=n,H()}),E.addEventListener("input",H),E.addEventListener("change",t=>{const n=t.target.closest('[data-pdf-signable="box-item"], .signature-box-item'),e=n==null?void 0:n.querySelector('[data-pdf-signable="name"]');if(e&&t.target===e&&Object.keys(ae).length>0){const o=(e.value??"").trim(),a=o?ae[o]:null;if(a){const s=(r,l)=>{const c=n==null?void 0:n.querySelector(`[data-pdf-signable="${r}"]`);c&&l!==void 0&&(c.value=String(l))};s("width",a.width),s("height",a.height),s("x",a.x),s("y",a.y),s("angle",a.angle)}}H()}),ve&&ve.addEventListener("change",H),E.addEventListener("click",t=>{if(!t.target.closest(".remove-box"))return;const n=t.target.closest('[data-pdf-signable="box-item"], .signature-box-item');if(n){let e=n;for(;e!=null&&e.parentElement&&e.parentElement!==E;)e=e.parentElement;if(e){const o=Array.from(E.querySelectorAll(X)),a=o.indexOf(e);if(a===-1)x("Remove box: clicked item is not a direct box-item child of the list; template structure may be wrong",{topLevelTag:e==null?void 0:e.tagName,listChildCount:E.children.length});else{q("Box removed",{index:a,remainingBeforeRemove:o.length}),e.remove();const s=E.querySelectorAll(X).length;q("Box removed done",{remaining:s})}}else x("Remove box: could not find top-level box item (parent chain does not reach boxesList)")}if(E.querySelectorAll(X).length===0){const e=document.getElementById("signature-boxes-empty");e&&e.classList.remove("d-none")}H(),Se()}),m){let t,n=!1,e=0;new ResizeObserver(()=>{if(n)return;const a=(m==null?void 0:m.clientWidth)??0;Math.abs(a-e)<10||(e=a,clearTimeout(t),t=setTimeout(async()=>{if(!(!F||R.style.display==="none")&&!n){n=!0;try{const s=await Ae(F,m);ee=s,await we(s),m&&(e=m.clientWidth)}finally{n=!1}}},200))}).observe(m)}Et();function Qe(){var t;(t=he==null?void 0:he.value)!=null&&t.trim()&&(q("Auto-loading PDF (preset URL)"),$e())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Qe(),ze()}):(Qe(),ze()),R.addEventListener("click",t=>{if(t.target.closest('[data-pdf-signable="overlay"]'))return;Ee(null);const n=t.target.closest(".pdf-page-wrapper"),e=n==null?void 0:n.querySelector("canvas");if(!e||!F)return;const o=parseInt(e.dataset.page??"1",10),a=K[o];if(!a)return;const s=e.getBoundingClientRect(),r=e.width/s.width,l=e.height/s.height,c=(t.clientX-s.left)*r,d=(t.clientY-s.top)*l,i=40,g=i*(a.scale||1.5),u=a.convertToPdfPoint(c,d+g);Pe(o,u[0],u[1],150,i)});function Lt(t,n){if(t.page!==n.page)return!1;const e=t.x+t.w,o=n.x+n.w,a=t.y+t.h,s=n.y+n.h;return t.x<o&&n.x<e&&t.y<s&&n.y<a}function et(){const t=E.querySelectorAll(X),n=[];return t.forEach(e=>{var c,d,i,g,u;const o=parseInt(((c=Fe(e))==null?void 0:c.value)??"1",10),a=parseFloat(((d=e.querySelector('[data-pdf-signable="x"]'))==null?void 0:d.value)??"0"),s=parseFloat(((i=e.querySelector('[data-pdf-signable="y"]'))==null?void 0:i.value)??"0"),r=parseFloat(((g=e.querySelector('[data-pdf-signable="width"]'))==null?void 0:g.value)??"150"),l=parseFloat(((u=e.querySelector('[data-pdf-signable="height"]'))==null?void 0:u.value)??"40");n.push({page:o,x:a,y:s,w:r,h:l})}),n}function kt(t,n,e){const o=e*Math.PI/180,a=Math.abs(Math.cos(o)),s=Math.abs(Math.sin(o));return{aabbW:t*a+n*s,aabbH:t*s+n*a}}function It(t,n){const e=K[t];if(!e)return[];const o=se(),a=xe(),s=e.scale||1.5,r=et(),l=[];return r.forEach((c,d)=>{if(d===n||c.page!==t)return;const i=V(c.x,o),g=V(c.y,o),u=V(c.w,o),b=V(c.h,o),{vpX:w,vpY:W}=De(e,i,g,u,b,a);l.push({left:w,top:W,right:w+u*s,bottom:W+b*s})}),l}let z=null,de=null;function Ee(t){if(de=t,R.querySelectorAll('[data-pdf-signable="overlay"].selected').forEach(n=>n.classList.remove("selected")),t!==null){const n=R.querySelector(`[data-pdf-signable="overlay"][data-box-index="${t}"]`);n&&n.classList.add("selected")}}let Me=null;function tt(t){if(!Me)return;const{overlay:n,item:e,centerX:o,centerY:a,startAngle:s,startMouseAngle:r}=Me;let c=(Math.atan2(t.clientY-a,t.clientX-o)-r)*180/Math.PI,d=s+c;for(;d>180;)d-=360;for(;d<-180;)d+=360;const i=e.querySelector('[data-pdf-signable="angle"]');i&&(i.value=String(Math.round(d*100)/100)),n.style.transform=`rotate(${d}deg)`}function nt(){Me&&(document.removeEventListener("mousemove",tt),document.removeEventListener("mouseup",nt),Me=null)}function Pt(t){var Y,N;const n=t.target.closest('[data-pdf-signable="overlay"]');if(!((Y=n==null?void 0:n.dataset)!=null&&Y.boxIndex))return;t.preventDefault(),t.stopPropagation();const e=t.target.closest(".rotate-handle");if(Z&&e){const J=parseInt(n.dataset.boxIndex,10),_=E.querySelectorAll(X)[J];if(!_)return;const U=_.querySelector('[data-pdf-signable="angle"]');if(!U)return;const h=n.getBoundingClientRect(),f=h.left+h.width/2,v=h.top+h.height/2,k=parseFloat(U.value)||0,O=Math.atan2(t.clientY-v,t.clientX-f);Me={overlay:n,item:_,centerX:f,centerY:v,startAngle:k,startMouseAngle:O},document.addEventListener("mousemove",tt),document.addEventListener("mouseup",nt);return}const o=t.target.closest(".resize-handle"),a=parseInt(n.dataset.boxIndex,10),s=E.querySelectorAll(X)[a];if(!s)return;const r=n.closest(".pdf-page-wrapper"),l=parseInt(((N=r==null?void 0:r.dataset)==null?void 0:N.page)??"1",10),c=K[l];if(!c)return;const d=parseFloat(n.style.width)||20,i=parseFloat(n.style.height)||14,g=parseFloat(n.style.left)||0,u=parseFloat(n.style.top)||0,b=s.querySelector('[data-pdf-signable="x"]'),w=s.querySelector('[data-pdf-signable="y"]'),W=s.querySelector('[data-pdf-signable="width"]'),j=s.querySelector('[data-pdf-signable="height"]');z={mode:o?"resize":"move",handle:o?o.dataset.handle??null:null,overlay:n,item:s,boxIndex:a,viewport:c,startX:t.clientX,startY:t.clientY,startLeft:g,startTop:u,startRight:g+d,startBottom:u+i,startFormX:b&&parseFloat(b.value)||0,startFormY:w&&parseFloat(w.value)||0,startFormW:W&&parseFloat(W.value)||150,startFormH:j&&parseFloat(j.value)||40},n.classList.add("dragging"),Re=!0,z.mode==="move"&&Ee(a),document.addEventListener("mousemove",ot),document.addEventListener("mouseup",at)}function ot(t){var k,O;if(!z)return;const{overlay:n,viewport:e,startLeft:o,startTop:a,startRight:s,startBottom:r}=z,l=(t.clientX-z.startX)/me,c=(t.clientY-z.startY)/me,d=20;let i,g,u,b;if(z.mode==="move"){const M=s-o,B=r-a,C=z.item.querySelector('[data-pdf-signable="angle"]'),L=Z&&C&&parseFloat(C.value)||0,{aabbW:S,aabbH:D}=kt(M,B,L),oe=S/2-M/2,re=e.width-S/2-M/2,ue=D/2-B/2,be=e.height-D/2-B/2;i=Math.max(oe,Math.min(re,o+l)),g=Math.max(ue,Math.min(be,a+c)),u=M,b=B}else{const M=z.handle;let B=o,C=a,L=s,S=r;M==="se"?(L=Math.min(e.width,Math.max(o+d,s+l)),S=Math.min(e.height,Math.max(a+d,r+c))):M==="sw"?(B=Math.max(0,Math.min(s-d,o+l)),S=Math.min(e.height,Math.max(a+d,r+c))):M==="ne"?(L=Math.min(e.width,Math.max(o+d,s+l)),C=Math.max(0,Math.min(r-d,a+c))):M==="nw"&&(B=Math.max(0,Math.min(s-d,o+l)),C=Math.max(0,Math.min(r-d,a+c))),i=B,g=C,u=L-B,b=S-C}const w=e.scale||1.5,W=parseInt(((O=(k=n.closest(".pdf-page-wrapper"))==null?void 0:k.dataset)==null?void 0:O.page)??"1",10);if(G>0){const M=u/w,B=b/w,C=Ue(e,i,g,M,B,xe()),L=se();let S=$(C.xPt,L),D=$(C.yPt,L),oe=$(M,L),re=$(B,L);S=Math.round(S/G)*G,D=Math.round(D/G)*G,oe=Math.round(oe/G)*G,re=Math.max(G,Math.round(re/G)*G);const ue=V(S,L),be=V(D,L),Q=V(oe,L),I=V(re,L),ie=De(e,ue,be,Q,I,xe());i=ie.vpX,g=ie.vpY,u=Q*w,b=I*w}if(Te){const M=It(W,z.boxIndex),B=i+u,C=g+b,L=M.flatMap(Q=>[Q.left,Q.right]),S=M.flatMap(Q=>[Q.top,Q.bottom]),D=(Q,I)=>{let ie=Q,Be=mt;for(const qe of I){const fe=Math.abs(Q-qe);fe<Be&&(Be=fe,ie=qe)}return ie},oe=D(i,L),re=D(B,L),ue=D(g,S),be=D(C,S);i=oe,g=ue,u=Math.max(d,re-oe),b=Math.max(d,be-ue)}n.style.left=i+"px",n.style.top=g+"px",n.style.width=u+"px",n.style.height=b+"px";const j=u/w,Y=b/w,N=Ue(e,i,g,j,Y,xe()),J=se(),_=M=>Math.round(M*100)/100,U=z.item.querySelector('[data-pdf-signable="x"]'),h=z.item.querySelector('[data-pdf-signable="y"]'),f=z.item.querySelector('[data-pdf-signable="width"]'),v=z.item.querySelector('[data-pdf-signable="height"]');U&&(U.value=String(_($(N.xPt,J)))),h&&(h.value=String(_($(N.yPt,J)))),f&&(f.value=String(_($(j,J)))),v&&(v.value=String(_($(Y,J))))}function at(){if(!z)return;const t=z;if(z.overlay.classList.remove("dragging"),Re=!1,document.removeEventListener("mousemove",ot),document.removeEventListener("mouseup",at),le){const n=et(),e=n[t.boxIndex];if(e&&n.some((a,s)=>s!==t.boxIndex&&Lt(e,a))){const a=i=>Math.round(i*100)/100,s=t.item.querySelector('[data-pdf-signable="x"]'),r=t.item.querySelector('[data-pdf-signable="y"]'),l=t.item.querySelector('[data-pdf-signable="width"]'),c=t.item.querySelector('[data-pdf-signable="height"]');s&&(s.value=String(a(t.startFormX))),r&&(r.value=String(a(t.startFormY))),l&&(l.value=String(a(t.startFormW))),c&&(c.value=String(a(t.startFormH)));const d=A.no_overlap_message??"Signature boxes on the same page cannot overlap.";alert(d)}}z=null,H()}R.addEventListener("mousedown",Pt),ce&&ce.addEventListener("click",()=>Pe(1,0,0)),Se(),ne.addEventListener("keydown",t=>{const n=t.target;if(!(n!=null&&n.closest("input, select, textarea"))){if(t.ctrlKey&&t.key==="z"){t.preventDefault();const e=E.querySelectorAll(X);if(e.length>0){const o=e[e.length-1],a=Array.from(E.querySelectorAll(X)).indexOf(o);if(o.remove(),de===a?Ee(null):de!==null&&de>a&&Ee(de-1),E.querySelectorAll(X).length===0){const s=document.getElementById("signature-boxes-empty");s&&s.classList.remove("d-none")}H(),Se()}return}if(t.key==="Delete"||t.key==="Backspace"){if(de===null)return;const o=E.querySelectorAll(X)[de];if(o){if(t.preventDefault(),o.remove(),Ee(null),E.querySelectorAll(X).length===0){const a=document.getElementById("signature-boxes-empty");a&&a.classList.remove("d-none")}H(),Se()}return}if(t.ctrlKey&&t.shiftKey&&t.key.toLowerCase()==="a"){if(t.preventDefault(),!F)return;const e=1,o=K[e];if(o){const a=o.scale||1.5,s=o.width/a,r=o.height/a;Pe(e,(s-150)/2,(r-40)/2,150,40)}else Pe(1,0,0)}}}),ne.addEventListener("submit",t=>{t.preventDefault(),E.querySelectorAll(X).forEach((e,o)=>{e.querySelectorAll("input, select, textarea").forEach(a=>{a.name=a.name.replace(/(\])\[\d+\](\[)/,`$1[${o}]$2`)})}),ne.submit()})}ht()})();
