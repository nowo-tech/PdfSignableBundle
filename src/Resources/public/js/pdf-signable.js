(function(){"use strict";var Oe=document.createElement("style");Oe.textContent=`.nowo-pdf-signable-widget .pdf-viewer-outer{display:flex;flex-direction:column;gap:.5rem;max-height:75vh;min-height:400px;border:1px solid #dee2e6;border-radius:.375rem;background:#f8f9fa;overflow:hidden}.nowo-pdf-signable-widget #pdf-viewer-container{flex:1;position:relative;display:flex;min-height:0;gap:.5rem;overflow:hidden;scrollbar-gutter:auto}.nowo-pdf-signable-widget #pdf-thumbnails-strip{width:72px;flex-shrink:0;overflow-y:auto;padding:.25rem;background:#e9ecef}.nowo-pdf-signable-widget #pdf-thumbnails-strip .pdf-thumb{display:block;width:100%;margin-bottom:.25rem;cursor:pointer;border:2px solid transparent;border-radius:.25rem}.nowo-pdf-signable-widget #pdf-thumbnails-strip .pdf-thumb:hover{border-color:#0d6efd}.nowo-pdf-signable-widget #pdf-thumbnails-strip .pdf-thumb.current{border-color:#0d6efd;box-shadow:0 0 0 1px #0d6efd}.nowo-pdf-signable-widget #pdf-thumbnails-strip .pdf-thumb canvas{display:block;width:100%;height:auto}.nowo-pdf-signable-widget #pdf-thumbnails-strip::-webkit-scrollbar{width:6px}.nowo-pdf-signable-widget #pdf-thumbnails-strip::-webkit-scrollbar-thumb{background:#adb5bd;border-radius:3px}.nowo-pdf-signable-widget #pdf-thumbnails-strip::-webkit-scrollbar-thumb:hover{background:#868e96}.nowo-pdf-signable-widget #pdf-thumbnails-strip::-webkit-scrollbar-track{background:transparent}.nowo-pdf-signable-widget .pdf-viewer-scroll{flex:1;min-width:0;display:flex;flex-direction:column;overflow:auto;box-sizing:border-box}.nowo-pdf-signable-widget .pdf-viewer-scroll>.pdf-zoom-toolbar{flex-shrink:0;position:sticky;top:0;z-index:50}.nowo-pdf-signable-widget .pdf-viewer-scroll::-webkit-scrollbar{width:6px;height:6px}.nowo-pdf-signable-widget .pdf-viewer-scroll::-webkit-scrollbar-thumb{background:#adb5bd;border-radius:3px}.nowo-pdf-signable-widget .pdf-viewer-scroll::-webkit-scrollbar-thumb:hover{background:#868e96}.nowo-pdf-signable-widget .pdf-viewer-scroll::-webkit-scrollbar-track{background:transparent}.nowo-pdf-signable-widget #pdf-canvas-wrapper{position:relative;display:block;width:100%;padding:.5rem}.nowo-pdf-signable-widget #pdf-canvas-wrapper canvas{display:block;cursor:crosshair}.nowo-pdf-signable-widget .pdf-page-wrapper{position:relative;display:inline-block;margin-bottom:10px}.nowo-pdf-signable-widget .pdf-grid-overlay{position:absolute;left:0;top:0;pointer-events:none}.nowo-pdf-signable-widget .signature-overlays{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}.nowo-pdf-signable-widget .signature-overlays .signature-box-overlay{pointer-events:auto}.nowo-pdf-signable-widget .signature-box-overlay{position:absolute;border:2px solid var(--box-color, rgba(13, 110, 253, .8));background:var(--box-bg, rgba(13, 110, 253, .12));box-sizing:border-box;font-size:10px;color:var(--box-color, #0d6efd);overflow:hidden;cursor:move;-webkit-user-select:none;user-select:none}.nowo-pdf-signable-widget .signature-box-overlay.dragging{z-index:10;opacity:.9;box-shadow:0 4px 12px #0003}.nowo-pdf-signable-widget .signature-box-overlay.selected{box-shadow:0 0 0 3px #0d6efd99;z-index:5}.nowo-pdf-signable-widget .signature-box-overlay .overlay-label{padding:2px 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle{position:absolute;width:12px;height:12px;background:var(--box-color, rgba(13, 110, 253, .9));border:1px solid #fff;border-radius:3px;pointer-events:auto;z-index:1}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle.nw{top:-6px;left:-6px;cursor:nwse-resize}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle.ne{top:-6px;right:-6px;cursor:nesw-resize}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle.sw{bottom:-6px;left:-6px;cursor:nesw-resize}.nowo-pdf-signable-widget .signature-box-overlay .resize-handle.se{bottom:-6px;right:-6px;cursor:nwse-resize}.nowo-pdf-signable-widget .signature-box-overlay .rotate-handle{position:absolute;top:-14px;left:50%;transform:translate(-50%);width:16px;height:16px;background:var(--box-color, rgba(13, 110, 253, .9));border:1px solid #fff;border-radius:50%;pointer-events:auto;cursor:grab;z-index:2}.nowo-pdf-signable-widget .signature-box-overlay .rotate-handle:active{cursor:grabbing}.nowo-pdf-signable-widget .pdf-signable-loading-overlay{position:absolute;top:0;right:0;bottom:0;left:0;background:#f8f9fae6;display:flex;align-items:center;justify-content:center;z-index:100;border-radius:.375rem}.nowo-pdf-signable-widget .pdf-zoom-toolbar{flex-shrink:0;padding:.25rem .5rem;display:flex;align-items:center;gap:.25rem;background:#fff;border-bottom:1px solid #dee2e6}.nowo-pdf-signable-widget .pdf-zoom-toolbar .pdf-zoom-value{min-width:2.5rem;text-align:center}.nowo-pdf-signable-widget .signature-box-item{border:1px solid #dee2e6;padding:1rem;margin-bottom:.75rem;border-radius:.375rem;background:#fff}.nowo-pdf-signable-widget #signature-boxes-list{max-height:50vh;overflow-y:auto}.nowo-pdf-signable-widget .signature-capture-row,.nowo-pdf-signable-widget .signature-pad-wrapper{width:100%}.nowo-pdf-signable-widget .signature-pad-canvas{width:100%;max-width:100%;height:120px;display:block;box-sizing:border-box;border:1px solid #dee2e6;border-radius:.25rem;touch-action:none}
/*$vite$:1*/`,document.head.appendChild(Oe);const Be=24;function ot(b,k){try{return new URL(k,window.location.origin).origin===window.location.origin?k:b+"?url="+encodeURIComponent(k)}catch{return b+"?url="+encodeURIComponent(k)}}function ze(b){return b.querySelector(".pdf-viewer-scroll")??b}async function Ae(b,k){if(!b||!k)return 1.5;await new Promise(m=>requestAnimationFrame(()=>m()));const te=(await b.getPage(1)).getViewport({scale:1}),C=ze(k),T=Math.max(0,C.clientWidth-Be);return T<=0?1.5:Math.max(.5,T/te.width)}async function rt(b,k){if(!b||!k)return 1.5;await new Promise(Z=>requestAnimationFrame(()=>Z()));const te=(await b.getPage(1)).getViewport({scale:1}),C=ze(k),T=Math.max(0,C.clientWidth-Be),m=Math.max(0,C.clientHeight-Be);if(T<=0||m<=0)return 1.5;const ne=T/te.width,se=m/te.height;return Math.max(.5,Math.min(ne,se))}const Xe={pt:1,mm:25.4/72,cm:2.54/72,in:1/72,px:96/72},st=220,at=37,it=65,lt=48;function N(b,k){return b*(Xe[k]??1)}function U(b,k){return b/(Xe[k]??1)}function ct(b){return String(b).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function dt(b,k,I){b=b%360,b<0&&(b+=360);const te=k/100,C=I/100,T=(1-Math.abs(2*C-1))*te,m=T*(1-Math.abs(b/60%2-1)),ne=C-T/2;let se=0,Z=0,oe=0;b<60?(se=T,Z=m):b<120?(se=m,Z=T):b<180?(Z=T,oe=m):b<240?(Z=m,oe=T):b<300?(se=m,oe=T):(se=T,oe=m);const V=Te=>{const Le=Math.round((Te+ne)*255);return(Le<16?"0":"")+Math.min(255,Math.max(0,Le)).toString(16)};return"#"+V(se)+V(Z)+V(oe)}function ut(b){const k=(st+b*at)%360,I=dt(k,it,lt),te=parseInt(I.slice(1,3),16),C=parseInt(I.slice(3,5),16),T=parseInt(I.slice(5,7),16);return{border:I,background:`rgba(${te}, ${C}, ${T}, 0.15)`,color:I,handle:I}}function pt(){const b=window.NowoPdfSignableConfig;if(!b){console.warn("[PdfSignable] NowoPdfSignableConfig not found, skipping init");return}const{proxyUrl:k,strings:I,debug:te=!1}=b,C=(...t)=>{te&&console.log("[PdfSignable]",...t)},T=(...t)=>{te&&console.warn("[PdfSignable]",...t)},m=document.querySelector(".nowo-pdf-signable-widget"),ne=m==null?void 0:m.closest("form");if(!ne){T(".nowo-pdf-signable-widget or form not found, skipping init");return}const se=(m==null?void 0:m.dataset.preventBoxOverlap)==="1",Z=(m==null?void 0:m.dataset.enableRotation)==="1";let oe={};try{const t=(m==null?void 0:m.dataset.boxDefaultsByName)??"{}";oe=typeof t=="string"?JSON.parse(t):{}}catch{oe={}}const V=Math.max(0,parseFloat((m==null?void 0:m.dataset.snapGrid)??"0")||0),Te=(m==null?void 0:m.dataset.snapToBoxes)==="1",Le=(m==null?void 0:m.dataset.showGrid)==="1",Re=Math.max(0,parseFloat((m==null?void 0:m.dataset.gridStep)??"10")||0),gt=10;C("Initialized");const me=ne.querySelector(".pdf-url-input"),ie=document.getElementById("loadPdfBtn"),ke=document.getElementById("pdf-placeholder"),De=document.getElementById("pdf-canvas-wrapper"),He=document.getElementById("signature-boxes-list"),le=document.getElementById("addBoxBtn"),ye=ne.querySelector(".unit-selector"),ve=ne.querySelector(".origin-selector"),f=document.getElementById("pdf-viewer-container"),We=document.getElementById("pdfZoomValue");if(!De||!He)return;const D=De,M=He;let fe=1,ce={x:0,y:0},P=null;const ft=80;function ht(){if(!_||!f)return;const t=f.querySelector("#pdf-thumbnails-strip"),e=f.querySelector(".pdf-viewer-scroll");!t||!e||(async()=>{for(let o=1;o<=_.numPages;o++){const r=await _.getPage(o),s=r.getViewport({scale:1}),a=ft/s.width,c=r.getViewport({scale:a}),l=document.createElement("canvas");l.width=c.width,l.height=c.height;const d=l.getContext("2d");if(!d)continue;await r.render({canvasContext:d,viewport:c}).promise;const i=document.createElement("button");i.type="button",i.className="pdf-thumb",i.dataset.page=String(o),i.setAttribute("aria-label","Page "+o),i.appendChild(l),i.addEventListener("click",()=>{const p=D.querySelector('.pdf-page-wrapper[data-page="'+o+'"]');p&&(p.scrollIntoView({behavior:"smooth",block:"start"}),t.querySelectorAll(".pdf-thumb.current").forEach(u=>u.classList.remove("current")),i.classList.add("current"))}),t.appendChild(i)}const n=()=>{const o=t,r=D.querySelectorAll(".pdf-page-wrapper");if(r.length===0)return;const s=e.getBoundingClientRect(),a=s.top+s.height/2;let c=1,l=1/0;r.forEach(i=>{const p=parseInt(i.dataset.page??"1",10),u=i.getBoundingClientRect(),x=u.top+u.height/2,v=Math.abs(x-a);v<l&&(l=v,c=p)}),o.querySelectorAll(".pdf-thumb.current").forEach(i=>i.classList.remove("current"));const d=o.querySelector('.pdf-thumb[data-page="'+c+'"]');d&&d.classList.add("current")};e.addEventListener("scroll",n),requestAnimationFrame(n),t.firstElementChild&&t.firstElementChild.classList.add("current")})()}function mt(){P||!f||(P=document.createElement("div"),P.id="pdf-touch-wrapper",P.style.transformOrigin="0 0",P.style.transform=`translate(${ce.x}px, ${ce.y}px) scale(${fe})`,f.insertBefore(P,D),P.appendChild(D),bt())}function bt(){if(!P)return;let t=0,e=1,n={x:0,y:0},o=0,r=0;P.addEventListener("touchstart",s=>{if(s.touches.length===2){s.preventDefault();const a=s.touches[0],c=s.touches[1];t=Math.hypot(c.clientX-a.clientX,c.clientY-a.clientY),e=fe,n={...ce},o=(a.clientX+c.clientX)/2,r=(a.clientY+c.clientY)/2}},{passive:!1}),P.addEventListener("touchmove",s=>{if(s.touches.length===2&&P){s.preventDefault();const a=s.touches[0],c=s.touches[1],l=Math.hypot(c.clientX-a.clientX,c.clientY-a.clientY),d=Math.max(.25,Math.min(4,e*l/t)),i=(a.clientX+c.clientX)/2,p=(a.clientY+c.clientY)/2;ce.x=n.x+(i-o),ce.y=n.y+(p-r),fe=d,P.style.transform=`translate(${ce.x}px, ${ce.y}px) scale(${fe})`}},{passive:!1})}function re(){return(ye==null?void 0:ye.value)??"mm"}function be(){return(ve==null?void 0:ve.value)??"bottom_left"}function _e(t,e,n,o,r,s){const a=t.scale||1.5,c=t.width/a,l=t.height/a;let d,i;switch(s){case"top_left":d=e,i=l-n-r;break;case"top_right":d=c-e-o,i=l-n-r;break;case"bottom_right":d=c-e-o,i=n;break;default:d=e,i=n;break}return{vpX:d*a,vpY:t.height-(i+r)*a}}function Ye(t,e,n,o,r,s){const a=t.scale||1.5,c=t.width/a,l=t.height/a,d=t.convertToPdfPoint(e,n+r*a),i=d[0],p=d[1];let u,x;switch(s){case"top_left":u=i,x=l-p-r;break;case"top_right":u=c-i-o,x=l-p-r;break;case"bottom_right":u=c-i-o,x=p;break;default:u=i,x=p;break}return{xPt:u,yPt:x}}let _=null;const J={};let Ie=null,Fe=!1,Q=1.5;function xt(){if(!f||!P||f.querySelector(".pdf-viewer-scroll"))return;const e=document.createElement("div");e.id="pdf-thumbnails-strip",e.setAttribute("aria-label","Page thumbnails");const n=document.createElement("div");n.className="pdf-viewer-scroll";const o=f.querySelector(".pdf-zoom-toolbar");o&&n.appendChild(o),n.appendChild(P),f.appendChild(n),f.insertBefore(e,n)}function yt(t,e,n,o,r){const s=t.getContext("2d");if(!s)return;const a=e.width/n,c=e.height/n,l=N(a,o),d=N(c,o);s.strokeStyle="rgba(0, 0, 0, 0.15)",s.lineWidth=1;for(let i=0;i<=l;i+=r){const u=U(i,o)*n;s.beginPath(),s.moveTo(u,0),s.lineTo(u,e.height),s.stroke()}for(let i=0;i<=d;i+=r){const p=U(i,o),u=e.height-p*n;s.beginPath(),s.moveTo(0,u),s.lineTo(e.width,u),s.stroke()}}async function xe(t){if(_){Object.keys(J).forEach(e=>delete J[Number(e)]),D.innerHTML="";for(let e=1;e<=_.numPages;e++){Ie&&await Ie;const n=await _.getPage(e),o=n.getViewport({scale:t});J[e]=o;const r=document.createElement("div");r.className="pdf-page-wrapper",r.dataset.page=String(e);const s=document.createElement("canvas"),a=s.getContext("2d");if(!a)continue;s.height=o.height,s.width=o.width,s.dataset.page=String(e);const c=document.createElement("div");if(c.className="signature-overlays",r.appendChild(s),Le&&Re>0){const l=document.createElement("canvas");l.className="pdf-grid-overlay",l.width=o.width,l.height=o.height,l.dataset.page=String(e),yt(l,o,t,re(),Re),r.appendChild(l)}r.appendChild(c),Ie=n.render({canvasContext:a,viewport:o}).promise,await Ie,D.appendChild(r)}We&&(We.textContent=Math.round(t*100)+"%"),H()}}function vt(){var t,e,n,o,r;(t=f==null?void 0:f.querySelector("#pdf-zoom-toolbar"))==null||t.remove(),(e=document.getElementById("pdfZoomOut"))==null||e.addEventListener("click",()=>{_&&(Q=Math.max(.5,Q/1.25),xe(Q))}),(n=document.getElementById("pdfZoomIn"))==null||n.addEventListener("click",()=>{_&&(Q=Math.min(4,Q*1.25),xe(Q))}),(o=document.getElementById("pdfFitWidth"))==null||o.addEventListener("click",async()=>{if(!_)return;Q=await Ae(_,f),await xe(Q)}),(r=document.getElementById("pdfFitPage"))==null||r.addEventListener("click",async()=>{if(!_)return;Q=await rt(_,f),await xe(Q)})}async function Ne(){var a,c;const t=((a=me==null?void 0:me.value)==null?void 0:a.trim())??"";if(!t){T("Load PDF: URL required"),alert(I.alert_url_required);return}const e=ot(k,t);C("Loading PDF",{url:t,viaProxy:e!==t}),ie&&(ie.setAttribute("disabled",""),ie.innerHTML='<span class="spinner-border spinner-border-sm me-1"></span> '+I.loading_state),ke&&(ke.style.display="block"),D.style.display="none",D.innerHTML="";const n=f==null?void 0:f.querySelector("#pdf-thumbnails-strip"),o=f==null?void 0:f.querySelector(".pdf-viewer-scroll"),r=o==null?void 0:o.querySelector(".pdf-zoom-toolbar");r&&f&&f.insertBefore(r,f.firstChild),o&&P&&P.parentElement===o&&(o.removeChild(P),f==null||f.appendChild(P)),n==null||n.remove(),o==null||o.remove(),(c=f==null?void 0:f.querySelector("#pdf-zoom-toolbar"))==null||c.remove(),fe=1,ce={x:0,y:0},P&&(P.style.transform="translate(0px, 0px) scale(1)");const s=document.createElement("div");s.className="pdf-signable-loading-overlay",s.setAttribute("aria-live","polite"),s.setAttribute("aria-busy","true"),s.innerHTML='<div class="text-center"><div class="spinner-border text-primary mb-2" role="status"><span class="visually-hidden">'+I.loading_state+'</span></div><p class="text-muted small mb-0">'+I.loading_state+"</p></div>",f&&f.appendChild(s);try{_=await pdfjsLib.getDocument(e).promise,Object.keys(J).forEach(i=>delete J[Number(i)]),mt(),xt();const l=await Ae(_,f);Q=l,await xe(l),ke&&(ke.style.display="none"),D.style.display="block",ht(),requestAnimationFrame(()=>{H(),setTimeout(H,100),setTimeout(H,350),setTimeout(H,700)}),C("PDF loaded",{pages:_.numPages,scale:l})}catch(l){C("PDF load failed",l),alert(I.error_load_pdf+(l instanceof Error?l.message:String(l)))}finally{s.remove(),ie&&(ie.removeAttribute("disabled"),ie.innerHTML=I.load_pdf_btn)}}function H(){if(Fe||Object.keys(J).length===0)return;const t=re(),e=be();D.querySelectorAll(".signature-overlays").forEach(a=>{a.innerHTML=""});const n=M.querySelectorAll(":scope > .signature-box-item"),o={},r={};let s=0;if(n.forEach((a,c)=>{var ue,j,he,pe,Me,qe;const l=parseInt(((ue=a.querySelector(".signature-box-page"))==null?void 0:ue.value)??"1",10),d=parseFloat(((j=a.querySelector(".signature-box-x"))==null?void 0:j.value)??"0"),i=parseFloat(((he=a.querySelector(".signature-box-y"))==null?void 0:he.value)??"0"),p=parseFloat(((pe=a.querySelector(".signature-box-width"))==null?void 0:pe.value)??"150"),u=parseFloat(((Me=a.querySelector(".signature-box-height"))==null?void 0:Me.value)??"40"),x=a.querySelector(".signature-box-angle"),v=Z&&x?parseFloat(x.value??"0"):0,Y=a.querySelector(".signature-box-signature-data"),F=(qe=Y==null?void 0:Y.value)==null?void 0:qe.trim(),z=a.querySelector(".signature-box-name"),X=((z==null?void 0:z.value)??"").trim(),R=X===""?"__empty__":X;R in r||(r[R]=s++);const W=r[R];o[X]=(o[X]??0)+1;const h=o[X],g=X===""?"":X+(h>1?` (${h})`:""),y=D.querySelector(`.pdf-page-wrapper[data-page="${l}"] .signature-overlays`),S=J[l];if(!y||!S)return;const B=S.scale||1.5,G=U(d,t),L=U(i,t),A=U(p,t),q=U(u,t),w=_e(S,G,L,A,q,e),$=A*B,K=q*B,E=document.createElement("div");E.className="signature-box-overlay",E.dataset.boxIndex=String(c),E.style.left=w.vpX+"px",E.style.top=w.vpY+"px",E.style.width=Math.max($,20)+"px",E.style.height=Math.max(K,14)+"px";const ee=ut(W);E.style.borderColor=ee.border,E.style.backgroundColor=ee.background,E.style.color=ee.color,E.style.setProperty("--box-color",ee.handle),E.style.transformOrigin="50% 50%",Z&&(E.style.transform=`rotate(${v}deg)`);const de=Z?'<span class="rotate-handle" title="Rotate"></span>':"";if(E.innerHTML=(g?'<span class="overlay-label">'+ct(g)+"</span>":"")+de+'<span class="resize-handle nw" data-handle="nw"></span><span class="resize-handle ne" data-handle="ne"></span><span class="resize-handle sw" data-handle="sw"></span><span class="resize-handle se" data-handle="se"></span>',F&&F.startsWith("data:")){const ge=document.createElement("img");ge.src=F,ge.alt="",ge.setAttribute("aria-hidden","true"),ge.style.cssText="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;pointer-events:none;",E.insertBefore(ge,E.firstChild)}y.appendChild(E)}),ae!==null){const a=D.querySelector(`.signature-box-overlay[data-box-index="${ae}"]`);a&&a.classList.add("selected")}}const Ue=1,wt=6;function $e(t){const e=t.getBoundingClientRect();if(e.width<=0||e.height<=0)return;const n=Math.min(window.devicePixelRatio||1,2),o=Math.max(1,Math.round(e.width*n)),r=Math.max(1,Math.round(e.height*n));t.width===o&&t.height===r||(t.width=o,t.height=r)}function Ce(){const t=document.querySelector(".nowo-pdf-signable-widget");t&&t.querySelectorAll(".signature-pad-canvas").forEach(e=>{var W;if(e.dataset.padInited==="1")return;const n=e.closest(".signature-box-item"),o=n==null?void 0:n.querySelector(".signature-box-signature-data"),r=(W=e.closest(".signature-pad-wrapper"))==null?void 0:W.querySelector(".signature-pad-clear"),s=n==null?void 0:n.querySelector(".signature-upload-input");if(!o)return;const a=e.getContext("2d");if(!a)return;e.dataset.padInited="1";const c=e.closest(".signature-pad-wrapper"),l=()=>{$e(e)};typeof ResizeObserver<"u"&&c&&new ResizeObserver(()=>{l()}).observe(c),requestAnimationFrame(l);let d=!1,i=0,p=0,u=0,x=0;const v=h=>{const g=e.getBoundingClientRect(),y=g.width?e.width/g.width:1,S=g.height?e.height/g.height:1;if("touches"in h&&h.touches.length>0){const G=h.touches[0];return{x:(G.clientX-g.left)*y,y:(G.clientY-g.top)*S}}const B=h;return{x:(B.clientX-g.left)*y,y:(B.clientY-g.top)*S}},Y=h=>{if("touches"in h&&h.touches.length>0){const y=h.touches[0].force;if(typeof y=="number"&&y>=0)return Math.min(1,y)}const g=h;return typeof g.pressure=="number"&&g.pressure>=0?Math.min(1,g.pressure):.5},F=h=>{const g=Y(h),y=Ue+g*(wt-Ue);a.lineWidth=y},z=h=>{h.preventDefault(),$e(e);const{x:g,y}=v(h);u=i=g,x=p=y,d=!0,a.strokeStyle="#000",F(h),a.lineCap="round",a.lineJoin="round",a.beginPath(),a.moveTo(g,y)},X=h=>{if(h.preventDefault(),!d)return;const{x:g,y}=v(h);F(h);const S=(i+g)/2,B=(p+y)/2;a.beginPath(),a.moveTo(u,x),a.quadraticCurveTo(i,p,S,B),a.stroke(),u=S,x=B,i=g,p=y},R=h=>{if(h.preventDefault(),!d)return;d=!1,e.width>0&&e.height>0&&(o.value=e.toDataURL("image/png"));const g=n==null?void 0:n.querySelector(".signature-box-signed-at");g&&(g.value=new Date().toISOString()),H()};e.addEventListener("mousedown",z),e.addEventListener("mousemove",X),e.addEventListener("mouseup",R),e.addEventListener("mouseleave",R),e.addEventListener("touchstart",z,{passive:!1}),e.addEventListener("touchmove",X,{passive:!1}),e.addEventListener("touchend",R,{passive:!1}),r&&r.addEventListener("click",()=>{const h=e.width,g=e.height;a.clearRect(0,0,h,g),o.value="";const y=n==null?void 0:n.querySelector(".signature-box-signed-at");y&&(y.value=""),H()}),s&&s.addEventListener("change",()=>{var y;const h=(y=s.files)==null?void 0:y[0];if(!h||!h.type.startsWith("image/"))return;const g=new FileReader;g.onload=()=>{if(typeof g.result=="string"){o.value=g.result;const S=n==null?void 0:n.querySelector(".signature-box-signed-at");S&&(S.value=new Date().toISOString()),H()}},g.readAsDataURL(h)})})}function Ve(){const t=M.dataset.maxEntries??(le==null?void 0:le.dataset.maxEntries)??"";if(t==="")return null;const e=parseInt(t,10);return Number.isNaN(e)?null:e}function we(){if(!le)return;const t=Ve(),e=M.querySelectorAll(":scope > .signature-box-item").length;t!==null&&e>=t?le.style.display="none":le.style.display=""}function Pe(t,e,n,o,r){const s=Ve(),a=M.querySelectorAll(":scope > .signature-box-item").length;if(s!==null&&a>=s){C("Box add skipped: max_entries reached",{max:s,currentCount:a});return}const c=o??150,l=r??40,d=document.getElementById("signature-boxes-empty");d&&d.classList.add("d-none");const i=M.dataset.prototype??"",p=M.querySelectorAll(":scope > .signature-box-item").length,u=i.replace(/__name__/g,String(p)),x=document.createElement("div");x.innerHTML=u;const v=x.firstElementChild;if(!v)return;v.dataset.index=String(p);const Y=v.querySelector(".signature-box-page");Y&&(Y.value=String(t));const F=J[t],z=re(),X=be(),R=c,W=l,h=F?F.scale:1.5,g=F?F.width/h:595,y=F?F.height/h:842;let S,B;switch(X){case"top_left":S=e,B=y-n-W;break;case"top_right":S=g-e-R,B=y-n-W;break;case"bottom_right":S=g-e-R,B=n;break;default:S=e,B=n;break}const G=q=>Math.round(q*100)/100,L=v.querySelector(".signature-box-name");for(const q of["x","y","width","height"]){const w=v.querySelector(".signature-box-"+q);w&&(q==="x"?w.value=String(G(N(S,z))):q==="y"?w.value=String(G(N(B,z))):q==="width"?w.value=String(G(N(R,z))):q==="height"&&(w.value=String(G(N(W,z)))))}const A=v.querySelector(".signature-box-angle");A&&(A.value="0"),L&&(L.value=I.default_box_name),M.appendChild(v),v.scrollIntoView({behavior:"smooth"}),H(),Ce(),we(),C("Box added",{page:t,x:S,y:B,width:c,height:l,unit:z})}ie&&ie.addEventListener("click",()=>Ne());const Ge=document.getElementById("unitBadge"),St={pt:"pt",mm:"mm",cm:"cm",px:"px",in:"in"};function je(){Ge&&(Ge.textContent=St[re()]??re())}je();let Ze=re();if(ye&&ye.addEventListener("change",()=>{const t=Ze,e=re();je(),M.querySelectorAll(":scope > .signature-box-item").forEach(n=>{for(const o of["x","y","width","height"]){const r=n.querySelector(".signature-box-"+o);if(r!=null&&r.value){const s=parseFloat(r.value);r.value=String(Math.round(N(U(s,t),e)*100)/100)}}}),Ze=e,H()}),M.addEventListener("input",H),M.addEventListener("change",t=>{const e=t.target.closest(".signature-box-item"),n=e==null?void 0:e.querySelector(".signature-box-name");if(n&&t.target===n&&Object.keys(oe).length>0){const o=(n.value??"").trim(),r=o?oe[o]:null;if(r){const s=(a,c)=>{const l=e==null?void 0:e.querySelector(".signature-box-"+a);l&&c!==void 0&&(l.value=String(c))};s("width",r.width),s("height",r.height),s("x",r.x),s("y",r.y),s("angle",r.angle)}}H()}),ve&&ve.addEventListener("change",H),M.addEventListener("click",t=>{if(!t.target.closest(".remove-box"))return;const e=t.target.closest(".signature-box-item");if(e){let n=e;for(;n!=null&&n.parentElement&&n.parentElement!==M;)n=n.parentElement;if(n){const o=Array.from(M.querySelectorAll(":scope > .signature-box-item")).indexOf(n);n.remove(),C("Box removed",{index:o})}}if(M.querySelectorAll(":scope > .signature-box-item").length===0){const n=document.getElementById("signature-boxes-empty");n&&n.classList.remove("d-none")}H(),we()}),f){let t,e=!1,n=0;new ResizeObserver(()=>{if(e)return;const r=(f==null?void 0:f.clientWidth)??0;Math.abs(r-n)<10||(n=r,clearTimeout(t),t=setTimeout(async()=>{if(!(!_||D.style.display==="none")&&!e){e=!0;try{const s=await Ae(_,f);Q=s,await xe(s),f&&(n=f.clientWidth)}finally{e=!1}}},200))}).observe(f)}vt();function Ke(){var t;(t=me==null?void 0:me.value)!=null&&t.trim()&&(C("Auto-loading PDF (preset URL)"),Ne())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Ke(),Ce()}):(Ke(),Ce()),D.addEventListener("click",t=>{if(t.target.closest(".signature-box-overlay"))return;Se(null);const e=t.target.closest(".pdf-page-wrapper"),n=e==null?void 0:e.querySelector("canvas");if(!n||!_)return;const o=parseInt(n.dataset.page??"1",10),r=J[o];if(!r)return;const s=n.getBoundingClientRect(),a=n.width/s.width,c=n.height/s.height,l=(t.clientX-s.left)*a,d=(t.clientY-s.top)*c,i=40,p=i*(r.scale||1.5),u=r.convertToPdfPoint(l,d+p);Pe(o,u[0],u[1],150,i)});function Et(t,e){if(t.page!==e.page)return!1;const n=t.x+t.w,o=e.x+e.w,r=t.y+t.h,s=e.y+e.h;return t.x<o&&e.x<n&&t.y<s&&e.y<r}function Je(){const t=M.querySelectorAll(":scope > .signature-box-item"),e=[];return t.forEach(n=>{var d,i,p,u;const o=n.querySelector(".signature-box-page"),r=parseInt((o==null?void 0:o.value)??"1",10),s=parseFloat(((d=n.querySelector(".signature-box-x"))==null?void 0:d.value)??"0"),a=parseFloat(((i=n.querySelector(".signature-box-y"))==null?void 0:i.value)??"0"),c=parseFloat(((p=n.querySelector(".signature-box-width"))==null?void 0:p.value)??"150"),l=parseFloat(((u=n.querySelector(".signature-box-height"))==null?void 0:u.value)??"40");e.push({page:r,x:s,y:a,w:c,h:l})}),e}function Mt(t,e,n){const o=n*Math.PI/180,r=Math.abs(Math.cos(o)),s=Math.abs(Math.sin(o));return{aabbW:t*r+e*s,aabbH:t*s+e*r}}function qt(t,e){const n=J[t];if(!n)return[];const o=re(),r=be(),s=n.scale||1.5,a=Je(),c=[];return a.forEach((l,d)=>{if(d===e||l.page!==t)return;const i=U(l.x,o),p=U(l.y,o),u=U(l.w,o),x=U(l.h,o),{vpX:v,vpY:Y}=_e(n,i,p,u,x,r);c.push({left:v,top:Y,right:v+u*s,bottom:Y+x*s})}),c}let O=null,ae=null;function Se(t){if(ae=t,D.querySelectorAll(".signature-box-overlay.selected").forEach(e=>e.classList.remove("selected")),t!==null){const e=D.querySelector(`.signature-box-overlay[data-box-index="${t}"]`);e&&e.classList.add("selected")}}let Ee=null;function Qe(t){if(!Ee)return;const{overlay:e,item:n,centerX:o,centerY:r,startAngle:s,startMouseAngle:a}=Ee;let l=(Math.atan2(t.clientY-r,t.clientX-o)-a)*180/Math.PI,d=s+l;for(;d>180;)d-=360;for(;d<-180;)d+=360;const i=n.querySelector(".signature-box-angle");i&&(i.value=String(Math.round(d*100)/100)),e.style.transform=`rotate(${d}deg)`}function et(){Ee&&(document.removeEventListener("mousemove",Qe),document.removeEventListener("mouseup",et),Ee=null)}function Lt(t){var z,X;const e=t.target.closest(".signature-box-overlay");if(!((z=e==null?void 0:e.dataset)!=null&&z.boxIndex))return;t.preventDefault(),t.stopPropagation();const n=t.target.closest(".rotate-handle");if(Z&&n){const R=parseInt(e.dataset.boxIndex,10),W=M.querySelectorAll(":scope > .signature-box-item")[R];if(!W)return;const h=W.querySelector(".signature-box-angle");if(!h)return;const g=e.getBoundingClientRect(),y=g.left+g.width/2,S=g.top+g.height/2,B=parseFloat(h.value)||0,G=Math.atan2(t.clientY-S,t.clientX-y);Ee={overlay:e,item:W,centerX:y,centerY:S,startAngle:B,startMouseAngle:G},document.addEventListener("mousemove",Qe),document.addEventListener("mouseup",et);return}const o=t.target.closest(".resize-handle"),r=parseInt(e.dataset.boxIndex,10),s=M.querySelectorAll(":scope > .signature-box-item")[r];if(!s)return;const a=e.closest(".pdf-page-wrapper"),c=parseInt(((X=a==null?void 0:a.dataset)==null?void 0:X.page)??"1",10),l=J[c];if(!l)return;const d=parseFloat(e.style.width)||20,i=parseFloat(e.style.height)||14,p=parseFloat(e.style.left)||0,u=parseFloat(e.style.top)||0,x=s.querySelector(".signature-box-x"),v=s.querySelector(".signature-box-y"),Y=s.querySelector(".signature-box-width"),F=s.querySelector(".signature-box-height");O={mode:o?"resize":"move",handle:o?o.dataset.handle??null:null,overlay:e,item:s,boxIndex:r,viewport:l,startX:t.clientX,startY:t.clientY,startLeft:p,startTop:u,startRight:p+d,startBottom:u+i,startFormX:x&&parseFloat(x.value)||0,startFormY:v&&parseFloat(v.value)||0,startFormW:Y&&parseFloat(Y.value)||150,startFormH:F&&parseFloat(F.value)||40},e.classList.add("dragging"),Fe=!0,O.mode==="move"&&Se(r),document.addEventListener("mousemove",tt),document.addEventListener("mouseup",nt)}function tt(t){var B,G;if(!O)return;const{overlay:e,viewport:n,startLeft:o,startTop:r,startRight:s,startBottom:a}=O,c=(t.clientX-O.startX)/fe,l=(t.clientY-O.startY)/fe,d=20;let i,p,u,x;if(O.mode==="move"){const L=s-o,A=a-r,q=O.item.querySelector(".signature-box-angle"),w=Z&&q&&parseFloat(q.value)||0,{aabbW:$,aabbH:K}=Mt(L,A,w),E=$/2-L/2,ee=n.width-$/2-L/2,de=K/2-A/2,ue=n.height-K/2-A/2;i=Math.max(E,Math.min(ee,o+c)),p=Math.max(de,Math.min(ue,r+l)),u=L,x=A}else{const L=O.handle;let A=o,q=r,w=s,$=a;L==="se"?(w=Math.min(n.width,Math.max(o+d,s+c)),$=Math.min(n.height,Math.max(r+d,a+l))):L==="sw"?(A=Math.max(0,Math.min(s-d,o+c)),$=Math.min(n.height,Math.max(r+d,a+l))):L==="ne"?(w=Math.min(n.width,Math.max(o+d,s+c)),q=Math.max(0,Math.min(a-d,r+l))):L==="nw"&&(A=Math.max(0,Math.min(s-d,o+c)),q=Math.max(0,Math.min(a-d,r+l))),i=A,p=q,u=w-A,x=$-q}const v=n.scale||1.5,Y=parseInt(((G=(B=e.closest(".pdf-page-wrapper"))==null?void 0:B.dataset)==null?void 0:G.page)??"1",10);if(V>0){const L=u/v,A=x/v,q=Ye(n,i,p,L,A,be()),w=re();let $=N(q.xPt,w),K=N(q.yPt,w),E=N(L,w),ee=N(A,w);$=Math.round($/V)*V,K=Math.round(K/V)*V,E=Math.round(E/V)*V,ee=Math.max(V,Math.round(ee/V)*V);const de=U($,w),ue=U(K,w),j=U(E,w),he=U(ee,w),pe=_e(n,de,ue,j,he,be());i=pe.vpX,p=pe.vpY,u=j*v,x=he*v}if(Te){const L=qt(Y,O.boxIndex),A=i+u,q=p+x,w=L.flatMap(j=>[j.left,j.right]),$=L.flatMap(j=>[j.top,j.bottom]),K=(j,he)=>{let pe=j,Me=gt;for(const qe of he){const ge=Math.abs(j-qe);ge<Me&&(Me=ge,pe=qe)}return pe},E=K(i,w),ee=K(A,w),de=K(p,$),ue=K(q,$);i=E,p=de,u=Math.max(d,ee-E),x=Math.max(d,ue-de)}e.style.left=i+"px",e.style.top=p+"px",e.style.width=u+"px",e.style.height=x+"px";const F=u/v,z=x/v,X=Ye(n,i,p,F,z,be()),R=re(),W=L=>Math.round(L*100)/100,h=O.item.querySelector(".signature-box-x"),g=O.item.querySelector(".signature-box-y"),y=O.item.querySelector(".signature-box-width"),S=O.item.querySelector(".signature-box-height");h&&(h.value=String(W(N(X.xPt,R)))),g&&(g.value=String(W(N(X.yPt,R)))),y&&(y.value=String(W(N(F,R)))),S&&(S.value=String(W(N(z,R))))}function nt(){if(!O)return;const t=O;if(O.overlay.classList.remove("dragging"),Fe=!1,document.removeEventListener("mousemove",tt),document.removeEventListener("mouseup",nt),se){const e=Je(),n=e[t.boxIndex];if(n&&e.some((r,s)=>s!==t.boxIndex&&Et(n,r))){const r=i=>Math.round(i*100)/100,s=t.item.querySelector(".signature-box-x"),a=t.item.querySelector(".signature-box-y"),c=t.item.querySelector(".signature-box-width"),l=t.item.querySelector(".signature-box-height");s&&(s.value=String(r(t.startFormX))),a&&(a.value=String(r(t.startFormY))),c&&(c.value=String(r(t.startFormW))),l&&(l.value=String(r(t.startFormH)));const d=I.no_overlap_message??"Signature boxes on the same page cannot overlap.";alert(d)}}O=null,H()}D.addEventListener("mousedown",Lt),le&&le.addEventListener("click",()=>Pe(1,0,0)),we(),ne.addEventListener("keydown",t=>{const e=t.target;if(!(e!=null&&e.closest("input, select, textarea"))){if(t.ctrlKey&&t.key==="z"){t.preventDefault();const n=M.querySelectorAll(":scope > .signature-box-item");if(n.length>0){const o=n[n.length-1],r=Array.from(M.querySelectorAll(":scope > .signature-box-item")).indexOf(o);if(o.remove(),ae===r?Se(null):ae!==null&&ae>r&&Se(ae-1),M.querySelectorAll(":scope > .signature-box-item").length===0){const s=document.getElementById("signature-boxes-empty");s&&s.classList.remove("d-none")}H(),we()}return}if(t.key==="Delete"||t.key==="Backspace"){if(ae===null)return;const o=M.querySelectorAll(":scope > .signature-box-item")[ae];if(o){if(t.preventDefault(),o.remove(),Se(null),M.querySelectorAll(":scope > .signature-box-item").length===0){const r=document.getElementById("signature-boxes-empty");r&&r.classList.remove("d-none")}H(),we()}return}if(t.ctrlKey&&t.shiftKey&&t.key.toLowerCase()==="a"){if(t.preventDefault(),!_)return;const n=1,o=J[n];if(o){const r=o.scale||1.5,s=o.width/r,a=o.height/r;Pe(n,(s-150)/2,(a-40)/2,150,40)}else Pe(1,0,0)}}}),ne.addEventListener("submit",t=>{t.preventDefault(),M.querySelectorAll(":scope > .signature-box-item").forEach((n,o)=>{n.querySelectorAll("input, select, textarea").forEach(r=>{r.name=r.name.replace(/(\])\[\d+\](\[)/,`$1[${o}]$2`)})}),ne.submit()})}pt()})();
